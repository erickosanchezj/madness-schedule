<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Madness - Panel de Administrador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; } 
        .attendance-btn.selected-attended { background-color: #10b981; color: white; }
        .attendance-btn.selected-absent { background-color: #f43f5e; color: white; }
    </style>
</head>
<body class="bg-zinc-900 text-white">

    <!-- Pantalla de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-zinc-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h1 class="text-2xl font-bold text-center mb-6">Acceso de Administrador</h1>
            <input type="email" id="email-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Correo de Admin">
            <input type="password" id="password-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Contrase√±a">
            <button onclick="admin.login()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md">Entrar</button>
            <p id="error-message" class="text-rose-400 text-center mt-4 hidden"></p>
        </div>
    </div>

    <!-- Panel Principal -->
    <div id="admin-panel" class="hidden p-4 md:p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
            <button onclick="admin.logout()" class="text-rose-400 hover:text-rose-300 font-semibold">Cerrar Sesi√≥n</button>
        </div>
        <div class="mb-6">
            <button onclick="admin.generateDailyClasses()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg">
                <i data-lucide="calendar-check" class="inline-block -mt-1 mr-2"></i>Generar/Verificar Clases del D√≠a
            </button>
        </div>
        
        <!-- Secciones de Clases Separadas -->
        <div class="space-y-8">
            <div>
                <h2 class="text-2xl font-bold mb-4 text-emerald-400 border-b border-zinc-700 pb-2">Clases de Hoy</h2>
                <div id="today-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
            </div>
            <div>
                <h2 class="text-2xl font-bold mb-4 text-sky-400 border-b border-zinc-700 pb-2">Clases de Ma√±ana</h2>
                <div id="tomorrow-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
            </div>
        </div>

        <!-- Reservas del D√≠a -->
        <div class="mt-8 p-6 bg-zinc-800 rounded-lg">
            <h2 class="text-2xl font-bold mb-4">Reservas del D√≠a</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Hoy</h3>
                    <div id="today-bookings-list" class="space-y-4 text-sm"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-sky-400 mb-3 border-b border-zinc-700 pb-2">Ma√±ana</h3>
                    <div id="tomorrow-bookings-list" class="space-y-4 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n de Usuarios -->
        <div class="mt-8 p-6 bg-zinc-800 rounded-lg">
            <h2 class="text-2xl font-bold mb-4">Gesti√≥n de Usuarios</h2>
            <div>
                <label for="user-email-input" class="block text-sm font-medium text-zinc-300 mb-2">Reinicio de Contrase√±a</label>
                <div class="flex space-x-2">
                    <input type="email" id="user-email-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md" placeholder="Correo del usuario">
                    <button onclick="admin.sendPasswordReset()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Clase y Tomar Asistencia -->
    <div id="class-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-zinc-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4 max-h-screen overflow-y-auto">
            <h2 id="modal-title" class="text-2xl font-bold">Editar Clase</h2>
            <input type="hidden" id="class-id">
            
            <!-- Pesta√±as -->
            <div class="border-b border-zinc-700">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="tab-details" class="px-3 py-2 font-medium text-sm rounded-t-md">Detalles</button>
                    <button id="tab-attendance" class="px-3 py-2 font-medium text-sm rounded-t-md">Asistencia</button>
                </nav>
            </div>

            <!-- Contenido de la Pesta√±a de Detalles -->
            <div id="details-content">
                <input type="text" id="class-name" placeholder="Nombre de la clase" class="w-full bg-zinc-700 p-2 rounded mt-4">
                <input type="text" id="class-instructor" placeholder="Instructor" class="w-full bg-zinc-700 p-2 rounded mt-4">
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <input type="text" id="class-time" placeholder="Hora (ej. 18:00)" class="w-full bg-zinc-700 p-2 rounded">
                    <input type="text" id="class-icon" placeholder="Emoji √çcono (üßò‚Äç‚ôÄÔ∏è)" class="w-full bg-zinc-700 p-2 rounded">
                </div>
                <textarea id="class-description" placeholder="Descripci√≥n" class="w-full bg-zinc-700 p-2 rounded h-24 mt-4"></textarea>
            </div>

            <!-- Contenido de la Pesta√±a de Asistencia -->
            <div id="attendance-content" class="hidden">
                <div id="attendance-status-message" class="text-center text-zinc-400 p-4"></div>
                <div id="attendance-list" class="space-y-2"></div>
                <button id="save-attendance-btn" onclick="admin.saveAttendance()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 hidden">Guardar Asistencia</button>
            </div>

            <div class="flex justify-end space-x-4 pt-4">
                <button id="delete-button" onclick="admin.deleteClass()" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded">Eliminar</button>
                <button onclick="admin.hideClassModal()" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                <button onclick="admin.saveClass()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
    const admin = {
        db: null, auth: null,
        state: { classes: [], bookings: [], weeklySchedule: {}, currentAttendance: {} },
        
        dateHelper: {
            getYYYYMMDD(date) { return date.toISOString().split('T')[0]; },
            get today() { return this.getYYYYMMDD(new Date()); },
            get tomorrow() { const d = new Date(); d.setDate(d.getDate() + 1); return this.getYYYYMMDD(d); }
        },

        init() {
            const firebaseConfig = { 
                apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
                authDomain: "madnessscheds.firebaseapp.com",
                projectId: "madnessscheds",
                storageBucket: "madnessscheds.firebasestorage.app",
                messagingSenderId: "788538690861",
                appId: "1:788538690861:web:ce19ead5929a8867c197a4"
             };
            firebase.initializeApp(firebaseConfig);
            this.db = firebase.firestore();
            this.auth = firebase.auth();
            this.handleAuthState();
            lucide.createIcons();
        },

        handleAuthState() {
            this.auth.onAuthStateChanged(user => {
                if (user) {
                    user.getIdTokenResult().then(idTokenResult => {
                        if (!!idTokenResult.claims.admin) {
                            document.getElementById('login-screen').classList.add('hidden');
                            document.getElementById('admin-panel').classList.remove('hidden');
                            this.loadWeeklyScheduleTemplate().then(() => this.listenToData());
                        } else { this.logout(); alert('Acceso denegado.'); }
                    });
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('admin-panel').classList.add('hidden');
                }
            });
        },

        async loadWeeklyScheduleTemplate() {
            const snapshot = await this.db.collection('schedule_template').get();
            if (snapshot.empty) {
                alert("Error: No se encontr√≥ la plantilla de horario en la base de datos.");
                return;
            }
            snapshot.forEach(doc => {
                this.state.weeklySchedule[doc.id] = doc.data().classes || [];
            });
        },
        
        listenToData() {
            this.db.collection('classes').where('classDate', '>=', this.dateHelper.today).onSnapshot(snap => {
                this.state.classes = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.renderAll();
            });
            this.db.collection('bookings').onSnapshot(snap => {
                this.state.bookings = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                this.renderAll();
            });
        },

        async generateDailyClasses() {
            if (Object.keys(this.state.weeklySchedule).length === 0) {
                alert("La plantilla de horario no se ha cargado.");
                return;
            }
            alert('Verificando y generando clases...');
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(today.getDate() + 1);
            const daysToGenerate = [
                { dateStr: this.dateHelper.today, dayOfWeek: today.getDay() },
                { dateStr: this.dateHelper.tomorrow, dayOfWeek: tomorrow.getDay() }
            ];
            const batch = this.db.batch();
            let classesCreated = 0;
            for (const day of daysToGenerate) {
                const scheduleForDay = this.state.weeklySchedule[day.dayOfWeek] || [];
                if (scheduleForDay.length === 0) continue;
                const existingClassesSnap = await this.db.collection('classes').where('classDate', '==', day.dateStr).get();
                const existingTimes = existingClassesSnap.docs.map(doc => doc.data().time);
                for (const classTemplate of scheduleForDay) {
                    if (!existingTimes.includes(classTemplate.time)) {
                        const newClassRef = this.db.collection('classes').doc();
                        batch.set(newClassRef, { 
                            name: classTemplate.name, 
                            time: classTemplate.time, 
                            instructor: classTemplate.instructor || 'Por Asignar',
                            duration: classTemplate.duration || 60,
                            classDate: day.dateStr, 
                            capacity: 15, 
                            description: `Clase de ${classTemplate.name}`, 
                            icon: 'üí™üèª', 
                            image: `https://placehold.co/400x250/1f2937/ffffff?text=${classTemplate.name}` 
                        });
                        classesCreated++;
                    }
                }
            }
            if (classesCreated > 0) { await batch.commit(); alert(`${classesCreated} nuevas clases generadas.`); }
            else { alert('El horario ya est√° completo.'); }
        },

        renderAll() {
            this.renderClassCards();
            this.renderDailyBookings();
        },

        renderClassCards() {
            const todayContainer = document.getElementById('today-classes-container');
            const tomorrowContainer = document.getElementById('tomorrow-classes-container');
            todayContainer.innerHTML = '';
            tomorrowContainer.innerHTML = '';
            
            const sortedClasses = [...this.state.classes].sort((a,b) => (a.classDate + a.time).localeCompare(b.classDate + b.time));

            for (const cls of sortedClasses) {
                const enrolledCount = this.state.bookings.filter(b => b.classId === cls.id).length;
                const card = document.createElement('div');
                card.className = "bg-zinc-800 p-4 rounded-lg shadow-md cursor-pointer hover:bg-zinc-700 transition-colors";
                card.onclick = () => this.showClassModal(cls);
                card.innerHTML = `<div class="flex justify-between items-start"><div><p class="text-xl font-bold">${cls.name}</p><p class="text-sm text-zinc-400">${cls.instructor}</p></div><span class="text-2xl">${cls.icon || 'üí™'}</span></div><div class="mt-4 flex justify-between items-center text-sm"><span class="font-semibold">a las ${cls.time}</span><span class="font-bold ${enrolledCount >= cls.capacity ? 'text-rose-400' : 'text-white'}">${enrolledCount} / ${cls.capacity}</span></div>`;
                
                if (cls.classDate === this.dateHelper.today) {
                    todayContainer.appendChild(card);
                } else if (cls.classDate === this.dateHelper.tomorrow) {
                    tomorrowContainer.appendChild(card);
                }
            }
             if(todayContainer.innerHTML === '') todayContainer.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para hoy.</p>';
             if(tomorrowContainer.innerHTML === '') tomorrowContainer.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para ma√±ana.</p>';
        },

        renderDailyBookings() {
            const todayList = document.getElementById('today-bookings-list');
            const tomorrowList = document.getElementById('tomorrow-bookings-list');
            todayList.innerHTML = '';
            tomorrowList.innerHTML = '';
            const bookingsByClass = {};
            for (const booking of this.state.bookings) {
                const cls = this.state.classes.find(c => c.id === booking.classId);
                if (!cls) continue;
                if (!bookingsByClass[cls.id]) {
                    bookingsByClass[cls.id] = { ...cls, attendees: [] };
                }
                bookingsByClass[cls.id].attendees.push(booking.userName || 'Usuario An√≥nimo');
            }
            const sortedClassesWithBookings = Object.values(bookingsByClass).sort((a,b) => a.time.localeCompare(b.time));
            let todayHTML = '';
            let tomorrowHTML = '';
            for (const cls of sortedClassesWithBookings) {
                const attendeesHTML = cls.attendees.map(name => `<li class="text-zinc-400 ml-4">- ${name}</li>`).join('');
                const classBlock = `<div class="mb-3"><p class="font-bold text-white">${cls.time} - ${cls.name} (${cls.attendees.length} de ${cls.capacity})</p><ul class="list-none">${attendeesHTML}</ul></div>`;
                if (cls.classDate === this.dateHelper.today) {
                    todayHTML += classBlock;
                } else if (cls.classDate === this.dateHelper.tomorrow) {
                    tomorrowHTML += classBlock;
                }
            }
            todayList.innerHTML = todayHTML || '<p class="text-zinc-500">No hay reservas para hoy.</p>';
            tomorrowList.innerHTML = tomorrowHTML || '<p class="text-zinc-500">No hay reservas para ma√±ana.</p>';
        },
        
        isClassInProgress(cls) {
            if (cls.classDate !== this.dateHelper.today) return false;
            const now = new Date();
            const startTime = new Date(`${cls.classDate}T${cls.time}:00`);
            const durationInMinutes = cls.duration || 60;
            const endTime = new Date(startTime.getTime() + durationInMinutes * 60000);
            return now >= startTime && now <= endTime;
        },

        showClassModal(cls = null) {
            this.state.currentAttendance = {};
            const modal = document.getElementById('class-modal');
            document.getElementById('class-id').value = cls.id;
            document.getElementById('class-name').value = cls.name;
            document.getElementById('class-instructor').value = cls.instructor;
            document.getElementById('class-time').value = cls.time;
            document.getElementById('class-icon').value = cls.icon;
            document.getElementById('class-description').value = cls.description;
            
            const tabDetails = document.getElementById('tab-details');
            const tabAttendance = document.getElementById('tab-attendance');

            this.switchTab('details');

            tabDetails.onclick = () => this.switchTab('details');
            tabAttendance.onclick = () => this.switchTab('attendance');

            if (this.isClassInProgress(cls)) {
                tabAttendance.classList.remove('hidden');
                this.loadAttendeesForAttendance(cls);
            } else {
                tabAttendance.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
        },

        switchTab(tabName) {
            const tabDetails = document.getElementById('tab-details');
            const tabAttendance = document.getElementById('tab-attendance');
            const detailsContent = document.getElementById('details-content');
            const attendanceContent = document.getElementById('attendance-content');

            if (tabName === 'details') {
                tabDetails.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-400');
                tabAttendance.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-400');
                detailsContent.classList.remove('hidden');
                attendanceContent.classList.add('hidden');
            } else {
                tabAttendance.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-400');
                tabDetails.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-400');
                attendanceContent.classList.remove('hidden');
                detailsContent.classList.add('hidden');
            }
        },

        async loadAttendeesForAttendance(cls) {
            const attendanceList = document.getElementById('attendance-list');
            const statusMessage = document.getElementById('attendance-status-message');
            const saveBtn = document.getElementById('save-attendance-btn');
            
            const attendees = this.state.bookings.filter(b => b.classId === cls.id);

            if (attendees.length === 0) {
                statusMessage.textContent = 'No hay usuarios inscritos en esta clase.';
                attendanceList.innerHTML = '';
                saveBtn.classList.add('hidden');
                return;
            }
            
            statusMessage.textContent = `${attendees.length} usuarios inscritos.`;
            attendanceList.innerHTML = attendees.map(user => `
                <div class="flex items-center justify-between bg-zinc-900 p-2 rounded-md">
                    <span class="text-zinc-300">${user.userName}</span>
                    <div class="space-x-2" data-user-id="${user.userId}" data-user-name="${user.userName}">
                        <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md" data-status="attended">Asisti√≥</button>
                        <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md" data-status="absent">Falt√≥</button>
                    </div>
                </div>
            `).join('');
            saveBtn.classList.remove('hidden');

            attendanceList.onclick = (e) => {
                const button = e.target.closest('.attendance-btn');
                if (!button) return;

                const parent = button.parentElement;
                const { userId, userName } = parent.dataset;
                const { status } = button.dataset;

                this.state.currentAttendance[userId] = { status, userName };

                parent.querySelectorAll('.attendance-btn').forEach(btn => btn.classList.remove('selected-attended', 'selected-absent'));
                button.classList.add(status === 'attended' ? 'selected-attended' : 'selected-absent');
            };
        },

        async saveAttendance() {
            const classId = document.getElementById('class-id').value;
            const cls = this.state.classes.find(c => c.id === classId);
            const attendanceData = this.state.currentAttendance;

            if (Object.keys(attendanceData).length === 0) {
                alert("No se ha marcado ninguna asistencia.");
                return;
            }

            if (!confirm("¬øEst√°s seguro de que quieres guardar la asistencia?")) return;

            const batch = this.db.batch();
            for (const userId in attendanceData) {
                const record = attendanceData[userId];
                const attendanceRef = this.db.collection('attendance').doc(`${cls.classDate}_${classId}_${userId}`);
                batch.set(attendanceRef, {
                    classId: classId,
                    className: cls.name,
                    classDate: cls.classDate,
                    userId: userId,
                    userName: record.userName,
                    status: record.status,
                    recordedAt: new Date()
                });
            }

            try {
                await batch.commit();
                alert("¬°Asistencia guardada con √©xito!");
                this.hideClassModal();
            } catch (error) {
                alert("Error al guardar la asistencia: " + error.message);
            }
        },

        sendPasswordReset() {
            const emailInput = document.getElementById('user-email-input');
            const email = emailInput.value;
            if (!email) {
                alert("Por favor, ingresa el correo del usuario.");
                return;
            }
            this.auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert(`Se ha enviado un correo para reiniciar la contrase√±a a ${email}.`);
                    emailInput.value = '';
                })
                .catch((error) => {
                    alert("Error al enviar el correo: " + error.message);
                });
        },
        
        login() {
            const email = document.getElementById('email-input').value;
            const pass = document.getElementById('password-input').value;
            const errorMsg = document.getElementById('error-message');
            errorMsg.classList.add('hidden');
            this.auth.signInWithEmailAndPassword(email, pass).catch(err => {
                errorMsg.innerText = "Error: " + err.message;
                errorMsg.classList.remove('hidden');
            });
        },
        logout() {
            this.auth.signOut();
        },
        hideClassModal() {
            document.getElementById('class-modal').classList.add('hidden');
        },
        async loadBookingsForClass(classId) {
            const bookingsList = document.getElementById('bookings-list');
            const bookingsCount = document.getElementById('bookings-count');
            const snapshot = await this.db.collection('bookings').where('classId', '==', classId).get();
            bookingsCount.innerText = snapshot.size;
            if (snapshot.empty) {
                bookingsList.innerHTML = 'No hay reservas.';
                return;
            }
            bookingsList.innerHTML = snapshot.docs.map(doc => `<div>- ${doc.data().userName || 'An√≥nimo'}</div>`).join('');
        },
        async saveClass() {
            const id = document.getElementById('class-id').value;
            if (!id) return;
            const data = {
                name: document.getElementById('class-name').value,
                instructor: document.getElementById('class-instructor').value,
                time: document.getElementById('class-time').value,
                icon: document.getElementById('class-icon').value,
                description: document.getElementById('class-description').value,
                capacity: 15
            };
            await this.db.collection('classes').doc(id).set(data, { merge: true });
            this.hideClassModal();
        },
        async deleteClass() {
            if (!confirm('¬øEst√°s seguro?')) return;
            const id = document.getElementById('class-id').value;
            if (id) {
                const bookingsSnapshot = await this.db.collection('bookings').where('classId', '==', id).get();
                const batch = this.db.batch();
                bookingsSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                await this.db.collection('classes').doc(id).delete();
            }
            this.hideClassModal();
        }
    };

    admin.init();
    </script>
</body>
</html>