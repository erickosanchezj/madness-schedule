<!-- /admin.html -->
<!-- Admin panel for managing classes, bookings and waitlists -->
<!-- Allows staff to supervise daily operations and user management -->
<!-- RELEVANT FILES: index.html, firebase-config.js, service-worker.js -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Madness - Panel de Administrador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      :focus-visible { outline: 2px solid #818cf8; outline-offset: 2px; border-radius: .5rem; }
      .attendance-btn.selected-attended { background-color: #10b981; color: white; }
      .attendance-btn.selected-absent { background-color: #f43f5e; color: white; }
      #toast-container { pointer-events: none; }
      .toast { pointer-events: auto; }
    </style>
  </head>
  <body class="bg-zinc-900 text-white">
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] space-y-2" aria-live="polite" aria-atomic="true"></div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-zinc-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
        <h1 class="text-2xl font-bold text-center mb-6">Acceso de Administrador</h1>
        <input type="email" id="email-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Correo de Admin" autocomplete="email">
        <input type="password" id="password-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Contrase√±a" autocomplete="current-password">
        <div class="cf-turnstile mb-4" data-sitekey="0x4AAAAAABwCDMFGoF_Z-wjY"></div>
        <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md">Entrar</button>
        <p id="error-message" class="text-rose-400 text-center mt-4 hidden"></p>
      </div>
    </div>

    <div id="admin-panel" class="hidden p-4 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
        <button id="logout-btn" class="text-rose-400 hover:text-rose-300 font-semibold">Cerrar Sesi√≥n</button>
      </div>

      <div class="mb-6 flex flex-wrap gap-3">
        <button id="gen-classes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg">
          <i data-lucide="calendar-check" class="inline-block -mt-1 mr-2"></i>Generar/Verificar Clases (Pr√≥xima Semana)
        </button>
        <button id="create-class-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
          <i data-lucide="plus" class="inline-block -mt-1 mr-2"></i>Crear Nueva Clase
        </button>
      </div>

      <div class="space-y-8">
        <section aria-labelledby="week-title">
          <h2 id="week-title" class="text-2xl font-bold mb-4 text-emerald-400 border-b border-zinc-700 pb-2">Clases de la Semana</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-4">
            <div class="day-column" data-day="monday">
              <h3 class="text-lg font-semibold text-blue-400 mb-3">Lunes</h3>
              <div id="monday-classes-container" class="space-y-3"></div>
            </div>
            <div class="day-column" data-day="tuesday">
              <h3 class="text-lg font-semibold text-blue-400 mb-3">Martes</h3>
              <div id="tuesday-classes-container" class="space-y-3"></div>
            </div>
            <div class="day-column" data-day="wednesday">
              <h3 class="text-lg font-semibold text-blue-400 mb-3">Mi√©rcoles</h3>
              <div id="wednesday-classes-container" class="space-y-3"></div>
            </div>
            <div class="day-column" data-day="thursday">
              <h3 class="text-lg font-semibold text-blue-400 mb-3">Jueves</h3>
              <div id="thursday-classes-container" class="space-y-3"></div>
            </div>
            <div class="day-column" data-day="friday">
              <h3 class="text-lg font-semibold text-blue-400 mb-3">Viernes</h3>
              <div id="friday-classes-container" class="space-y-3"></div>
            </div>
            <div class="day-column" data-day="saturday">
              <h3 class="text-lg font-semibold text-blue-400 mb-3">S√°bado</h3>
              <div id="saturday-classes-container" class="space-y-3"></div>
            </div>
            <div class="day-column" data-day="sunday">
              <h3 class="text-lg font-semibold text-blue-400 mb-3">Domingo</h3>
              <div id="sunday-classes-container" class="space-y-3"></div>
            </div>
          </div>
        </section>
      </div>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="reservas-title">
        <h2 id="reservas-title" class="text-2xl font-bold mb-4">Reservas de la Semana</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-4">
          <div class="day-column" data-day="monday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Lunes</h3>
            <div id="monday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="tuesday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Martes</h3>
            <div id="tuesday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="wednesday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Mi√©rcoles</h3>
            <div id="wednesday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="thursday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Jueves</h3>
            <div id="thursday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="friday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Viernes</h3>
            <div id="friday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="saturday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">S√°bado</h3>
            <div id="saturday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="sunday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Domingo</h3>
            <div id="sunday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
        </div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="asistencia-title">
        <h2 id="asistencia-title" class="text-2xl font-bold mb-2">Reporte de Asistencia y Proyecci√≥n</h2>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs text-zinc-400 mb-3 gap-2">
          <div class="flex items-center gap-4">
            <span id="att-last">√öltima actualizaci√≥n: ‚Äî</span>
            <span id="att-next">Pr√≥xima actualizaci√≥n en: ‚Äî</span>
          </div>
          <button id="att-refresh" class="inline-flex items-center gap-1 text-indigo-400 hover:text-indigo-300">
            <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Actualizar ahora
          </button>
        </div>
        <div class="flex flex-wrap items-center gap-2 mb-4 text-xs">
          <label for="att-start-date">Desde:</label>
          <input type="date" id="att-start-date" class="bg-zinc-700 text-white p-1 rounded-md" />
          <label for="att-end-date">Hasta:</label>
          <input type="date" id="att-end-date" class="bg-zinc-700 text-white p-1 rounded-md" />
          <label for="facility-capacity">Capacidad:</label>
          <input type="number" id="facility-capacity" class="bg-zinc-700 text-white p-1 rounded-md w-20" min="1" />
          <button id="att-export" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-1 px-2 rounded-md">Exportar</button>
        </div>
        <div class="w-full bg-zinc-700 h-2 rounded mb-4">
          <div id="capacity-gauge-fill" class="h-2 bg-emerald-500 rounded" style="width:0%"></div>
        </div>
        <div class="relative">
          <canvas id="attendanceChart"></canvas>
        </div>
        <div id="attendance-details" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm"></div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="usuarios-title">
        <h2 id="usuarios-title" class="text-2xl font-bold mb-4">Gesti√≥n de Usuarios</h2>

        <div>
          <label for="user-email-input" class="block text-sm font-medium text-zinc-300 mb-2">Reinicio de Contrase√±a</label>
          <div class="flex gap-2">
            <input type="email" id="user-email-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md" placeholder="Correo del usuario">
            <button id="send-reset-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
          </div>
        </div>

        <hr class="border-zinc-700 my-6">

        <!-- Buscar por nombre/correo + listar -->
        <div>
          <label for="find-user-query-input" class="block text-sm font-medium text-zinc-300 mb-2">
            Buscar usuario (nombre o correo)
          </label>
          <div class="flex gap-2">
            <input type="text" id="find-user-query-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md"
                   placeholder="Ej: Valery, Erick o alguien@correo.com">
            <button id="find-user-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md">Buscar</button>
            <button id="list-users-btn" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-md">Listar</button>
          </div>

          <p id="user-results-hint" class="text-zinc-400 text-xs mt-2 hidden"></p>
          <div id="user-details-container" class="mt-4 hidden space-y-4"></div>
        </div>
      </section>
      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="notifs-title">
        <h2 id="notifs-title" class="text-2xl font-bold mb-4">√öltimas notificaciones</h2>
        <ul id="recent-notifs" class="space-y-2 text-sm"></ul>
      </section>
    </div>

    <div id="class-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-zinc-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4 max-h-screen overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title" class="text-2xl font-bold">Editar Clase</h2>
        <input type="hidden" id="class-id">
        <div class="border-b border-zinc-700">
          <nav class="flex space-x-4" aria-label="Tabs">
            <button id="tab-details" class="px-3 py-2 font-medium text-sm rounded-t-md" aria-selected="true">Detalles</button>
            <button id="tab-attendance" class="px-3 py-2 font-medium text-sm rounded-t-md hidden" aria-selected="false">Asistencia</button>
          </nav>
        </div>
        <div id="details-content">
          <div class="mt-4">
            <input type="text" id="class-name" placeholder="Nombre de la clase" class="w-full bg-zinc-700 p-2 rounded">
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Escribe el nombre que ver√°n los alumnos en el horario.</p>
          </div>
          <div class="mt-4">
            <input type="text" id="class-instructor" placeholder="Instructor" class="w-full bg-zinc-700 p-2 rounded">
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Indica qui√©n impartir√° la sesi√≥n.</p>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div class="flex flex-col">
              <input type="text" id="class-time" placeholder="Hora (ej. 18:00)" class="w-full bg-zinc-700 p-2 rounded">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Coloca la hora de inicio en formato 24 horas.</p>
            </div>
            <div class="flex flex-col">
              <input type="text" id="class-icon" placeholder="Emoji √çcono (üßò‚Äç‚ôÄÔ∏è)" class="w-full bg-zinc-700 p-2 rounded">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Elige un emoji que represente la clase.</p>
            </div>
          </div>
          <p id="class-time-warning" class="mt-2 text-xs text-amber-400 hidden"></p>
          <div class="mt-4">
            <textarea id="class-description" placeholder="Descripci√≥n" class="w-full bg-zinc-700 p-2 rounded h-24"></textarea>
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Resume la din√°mica o enfoque de la clase.</p>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div class="flex flex-col">
              <input type="date" id="class-date" placeholder="Fecha" class="w-full bg-zinc-700 p-2 rounded">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Selecciona la fecha exacta de la clase.</p>
            </div>
            <div class="flex flex-col">
              <input type="number" id="class-capacity" placeholder="Capacidad" class="w-full bg-zinc-700 p-2 rounded" min="1" max="30">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Define el n√∫mero m√°ximo de asistentes.</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div class="flex flex-col">
              <input type="number" id="class-duration" placeholder="Duraci√≥n (min)" class="w-full bg-zinc-700 p-2 rounded" min="30" max="120">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Indica cu√°nto dura la sesi√≥n en minutos.</p>
            </div>
            <div class="flex flex-col">
              <input type="number" id="class-enrolled" placeholder="Inscritos" class="w-full bg-zinc-700 p-2 rounded" min="0" readonly>
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Consulta cu√°ntos alumnos est√°n inscritos ahora.</p>
            </div>
          </div>
          <div class="mt-4">
            <input type="url" id="class-image" placeholder="URL de imagen" class="w-full bg-zinc-700 p-2 rounded">
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Pega la URL de la foto o banner de la clase.</p>
          </div>
        </div>
        <div id="attendance-content" class="hidden">
          <div id="attendance-status-message" class="text-center text-zinc-400 p-4"></div>
          <div id="attendance-list" class="space-y-2"></div>
          <button id="save-attendance-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 hidden">Guardar Asistencia</button>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button id="delete-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded">Eliminar</button>
          <button id="cancel-button" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
          <button id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
      const AdminPanel = {
        db: null,
        auth: null,
        functions: null,
        FACILITY_MAX_CAPACITY: 75,
        state: {
          classes: [],
          bookingsMap: new Map(),
          waitlistsMap: new Map(),
          weeklySchedule: {},
          weekDates: [],
          recentNotifications: [],
          currentAttendance: {},
          selectedClass: null,
          attendanceChartInstance: null,
          unsubClasses: null,
          unsubBookings: [],
          unsubWaitlists: [],
          unsubRecentNotifs: null,
          attendanceData: null,
          attendanceLastAt: 0,
          unsubCapacity: null,
          attendanceTickTimer: null,
          userSearchResults: []
        },

        // --- Helpers ---
        timeFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', hour:'2-digit',minute:'2-digit',hour12:false }),
        dayFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', weekday:'long',day:'2-digit',month:'short' }),
        dayShortFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', day:'2-digit',month:'short' }),
        dateHelper: {
          ymd(date){ return new Intl.DateTimeFormat('en-CA',{ timeZone: 'America/Mexico_City', year:'numeric', month:'2-digit', day:'2-digit' }).format(date); },
          today(){ return this.ymd(new Date()); },
          tomorrow(){ return this.ymd(new Date(Date.now()+86400000)); },
          yesterday(){ return this.ymd(new Date(Date.now()-86400000)); }
        },
        normalizeStr(s=''){
          return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
        },

        // --- TOASTS ---
        showToast({ title='Hecho', message='', variant='success', timeout=3000 }){
          const color = variant==='error'?'rose': variant==='warn'?'amber':'emerald';
          const wrap = document.getElementById('toast-container');
          const el = document.createElement('div');
          el.className = 'toast max-w-md mx-auto bg-zinc-800 border border-zinc-700 rounded-xl p-4 shadow-lg flex items-start gap-3';
          const safeTitle = DOMPurify.sanitize(title);
          const safeMessage = DOMPurify.sanitize(message);
          el.innerHTML = `
            <div class="w-10 h-10 rounded-lg bg-${color}-500/20 text-${color}-300 flex items-center justify-center shrink-0">
              <i data-lucide="${variant==='error'?'alert-triangle':variant==='warn'?'alert-circle':'check'}" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
              <p class="font-semibold">${safeTitle}</p>
              ${safeMessage?`<p class="text-sm text-zinc-400 mt-0.5">${safeMessage}</p>`:''}
            </div>
            <button class="shrink-0 text-zinc-400 hover:text-zinc-200" aria-label="Cerrar notificaci√≥n">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>`;
          wrap.appendChild(el);
          lucide.createIcons({ attrs:{'aria-hidden':'true'} });
          const close = () => el.remove();
          el.querySelector('button').addEventListener('click', close);
          if (timeout) setTimeout(close, timeout);
        },

        // --- INIT / AUTH ---
        init(){
          const firebaseConfig = {
            apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
            authDomain: "madnessscheds.firebaseapp.com",
            projectId: "madnessscheds",
            storageBucket: "madnessscheds.firebasestorage.app",
            messagingSenderId: "788538690861",
            appId: "1:788538690861:web:ce19ead5929a8867c197a4"
          };
          firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.auth = firebase.auth();
          this.functions = firebase.app().functions('us-central1');

          // Top buttons
          document.getElementById('login-btn').onclick = () => this.login();
          document.getElementById('logout-btn').onclick = () => this.logout();
          document.getElementById('gen-classes-btn').onclick = () => this.generateDailyClasses();
          document.getElementById('create-class-btn').onclick = () => this.showCreateClassModal();
          document.getElementById('send-reset-btn').onclick = () => this.sendPasswordReset();
          document.getElementById('att-refresh').onclick = () => this.fetchAttendanceData(true);

          const range = this.getDefaultAttendanceRange();
          const sEl = document.getElementById('att-start-date');
          const eEl = document.getElementById('att-end-date');
          const capEl = document.getElementById('facility-capacity');
          const exportBtn = document.getElementById('att-export');
          if (sEl && eEl){
            sEl.value = range.start;
            eEl.value = range.end;
            sEl.addEventListener('change',()=>this.fetchAttendanceData(true));
            eEl.addEventListener('change',()=>this.fetchAttendanceData(true));
          }
          if (capEl){
            capEl.value = this.FACILITY_MAX_CAPACITY;
            capEl.addEventListener('change',()=>{
              this.FACILITY_MAX_CAPACITY = Number(capEl.value)||0;
              this.fetchAttendanceData(true);
            });
          }
          if (exportBtn){
            exportBtn.onclick = () => this.exportCapacityReport();
          }

          // Users: find + list
          document.getElementById('find-user-btn').onclick = () => this.findUsersByQuery();
          document.getElementById('list-users-btn').onclick = () => this.listUsersPage();

          this.auth.onAuthStateChanged(async (user) => {
            if (user) {
              const token = await user.getIdTokenResult();
              if (token.claims && token.claims.admin) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                try {
                  await this.loadWeeklyScheduleTemplate();
                  this.listenWeeklyClasses();
                  this.startAttendancePolling();
                  this.listenRecentNotifications();
                } catch(e){
                  this.showToast({ title:'Error al iniciar', message:e.message, variant:'error' });
                }
              } else {
                this.logout();
                this.showToast({ title:'Acceso denegado', message:'Tu cuenta no tiene rol de admin', variant:'error' });
              }
            } else {
              document.getElementById('login-screen').classList.remove('hidden');
              document.getElementById('admin-panel').classList.add('hidden');
              this.teardownBookingsListeners();
              if (this.state.unsubClasses) this.state.unsubClasses();
              this.stopAttendancePolling();
              if (this.state.unsubRecentNotifs) this.state.unsubRecentNotifs();
              this.state.recentNotifications = [];
              this.renderRecentNotifications();
            }
          });

          lucide.createIcons();
        },

        async loadWeeklyScheduleTemplate(){
          const snap = await this.db.collection('schedule_template').get();
          if (snap.empty) throw new Error('No existe la plantilla de horario.');
          snap.forEach(doc => { this.state.weeklySchedule[doc.id] = doc.data().classes || []; });
        },

        // --- LISTENERS (semana completa) ---
        listenWeeklyClasses(){
          const today = new Date();
          today.setHours(0,0,0,0);
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - today.getDay() + 1);

          const weekDates = [];
          for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            weekDates.push(this.dateHelper.ymd(date));
          }

          this.state.weekDates = weekDates;

          if (this.state.unsubClasses) this.state.unsubClasses();

          if (!weekDates.length){
            this.state.classes = [];
            this.mountBookingsListenersForVisibleClasses();
            this.mountWaitlistListenersForVisibleClasses();
            this.renderAll();
            this.renderAttendanceChartFromCache();
            return;
          }

          this.state.unsubClasses = this.db.collection('classes')
            .where('classDate', 'in', weekDates)
            .orderBy('classDate','asc').orderBy('time','asc')
            .onSnapshot((snap)=>{
              this.state.classes = snap.docs.map(d=>{
                const data = { id:d.id, ...d.data() };
                const timeStr = data.time || data.timeUTC;
                if (data.classDate && timeStr){
                  const start = new Date(`${data.classDate}T${timeStr}:00Z`);
                  data.localDate = this.dateHelper.ymd(start);
                  data.localTime = this.timeFmt.format(start);
                }
                return data;
              });
              this.mountBookingsListenersForVisibleClasses();
              this.mountWaitlistListenersForVisibleClasses();
              this.renderAll();
              this.renderAttendanceChartFromCache();
            }, err=>{
              console.error(err);
              this.showToast({ title:'Error listando clases', message: err.message, variant:'error' });
            });
        },

        teardownBookingsListeners(){
          this.state.unsubBookings.forEach(fn=>{ try{ fn&&fn(); }catch{} });
          this.state.unsubBookings = [];
          this.state.bookingsMap.clear();
          this.teardownWaitlistListeners();
        },

        teardownWaitlistListeners(){
          this.state.unsubWaitlists.forEach(fn=>{ try{ fn&&fn(); }catch{} });
          this.state.unsubWaitlists = [];
          this.state.waitlistsMap.clear();
        },

        mountBookingsListenersForVisibleClasses(){
          this.teardownBookingsListeners();
          const classIds = this.state.classes.map(c=>c.id);
          for (let i=0;i<classIds.length;i+=10){
            const batch = classIds.slice(i,i+10);
            const unsub = this.db.collection('bookings')
              .where('classId','in',batch)
              .onSnapshot((snap)=>{
                batch.forEach(cid => this.state.bookingsMap.delete(cid));
                snap.docs.forEach(doc=>{
                  const b = doc.data();
                  const arr = this.state.bookingsMap.get(b.classId) || [];
                  arr.push({ id:doc.id, ...b });
                  this.state.bookingsMap.set(b.classId, arr);
                });
                this.renderAll();
                this.renderAttendanceChartFromCache();
              });
            this.state.unsubBookings.push(unsub);
          }
        },

        mountWaitlistListenersForVisibleClasses(){
          this.teardownWaitlistListeners();
          const classIds = this.state.classes.map(c=>c.id);
          for (let i=0;i<classIds.length;i+=10){
            const batch = classIds.slice(i,i+10);
            const unsub = this.db.collection('waitlists')
              .where('classId','in',batch)
              .onSnapshot(async (snap)=>{
                batch.forEach(cid=>this.state.waitlistsMap.delete(cid));
                const items = await Promise.all(snap.docs.map(async doc=>{
                  const w = doc.data();
                  let userName = '';
                  if (w.userId){
                    try{
                      const uSnap = await this.db.collection('users').doc(w.userId).get();
                      userName = uSnap.data()?.displayName || uSnap.data()?.email || w.userId;
                    }catch{}
                  }
                  return { id:doc.id, ...w, userName };
                }));
                items.forEach(w=>{
                  const arr = this.state.waitlistsMap.get(w.classId) || [];
                  arr.push(w);
                  this.state.waitlistsMap.set(w.classId, arr);
                });
                this.renderAll();
              });
            this.state.unsubWaitlists.push(unsub);
          }
        },

        // --- NOTIFICATIONS ---
        listenRecentNotifications(){
          if (this.state.unsubRecentNotifs) this.state.unsubRecentNotifs();
          this.state.unsubRecentNotifs = this.db.collection('notifications')
            .orderBy('sentAt','desc').limit(10)
            .onSnapshot(async (snap)=>{
              const notifs = await Promise.all(snap.docs.map(async d=>{
                const data = d.data();
                const [cls, usr] = await Promise.all([
                  data.classId ? this.db.collection('classes').doc(data.classId).get() : Promise.resolve(null),
                  data.userId ? this.db.collection('users').doc(data.userId).get() : Promise.resolve(null)
                ]);
                return {
                  id: d.id,
                  ...data,
                  className: cls?.data()?.name || cls?.data()?.title || data.classId || '',
                  userName: usr?.data()?.displayName || usr?.data()?.email || data.userId || ''
                };
              }));
              this.state.recentNotifications = notifs;
              this.renderRecentNotifications();
            }, err=>{
              console.error(err);
              this.showToast({ title:'Error cargando notificaciones', message:err.message, variant:'error' });
            });
        },

          renderRecentNotifications(){
            const list = document.getElementById('recent-notifs');
            if (!list) return;
            if (!this.state.recentNotifications.length){
              list.innerHTML = '<li class="text-zinc-500">No hay notificaciones.</li>';
              return;
            }
            list.innerHTML = this.state.recentNotifications.map(n=>{
              const sent = n.sentAt?.toDate ? n.sentAt.toDate() : null;
              const when = sent ? `${this.dayShortFmt.format(sent)} ${this.timeFmt.format(sent)}` : '‚Äî';
              const safeWhen = DOMPurify.sanitize(when);
              const safeClass = DOMPurify.sanitize(n.className || n.classId || '');
              const safeUser = DOMPurify.sanitize(n.userName || n.userId || '');
              const safeType = DOMPurify.sanitize(n.type || 'Notificaci√≥n');
              const safeTitle = DOMPurify.sanitize(n.title || '');
              const safeBody = DOMPurify.sanitize(n.body || '');
              const tokensUsed = Array.isArray(n.tokensUsed) ? n.tokensUsed : [];
              const successCount = typeof n.successCount === 'number' ? n.successCount : null;
              const failureCount = typeof n.failureCount === 'number' ? n.failureCount : null;
              const totalFromCounts = (successCount !== null || failureCount !== null)
                ? (Number(successCount || 0) + Number(failureCount || 0))
                : null;
              const totalDevicesRaw = Number.isFinite(n.totalTokens)
                ? n.totalTokens
                : (tokensUsed.length > 0 ? tokensUsed.length : (totalFromCounts ?? 0));
              const safeTotalDevices = DOMPurify.sanitize(String(totalDevicesRaw));
              const safeSuccess = successCount !== null ? DOMPurify.sanitize(String(successCount)) : '';
              const safeFailure = failureCount !== null ? DOMPurify.sanitize(String(failureCount)) : '';
              const infoLines = [];
              if (safeClass) infoLines.push(`<span class="text-xs text-zinc-300">Clase: ${safeClass}</span>`);
              if (safeUser) infoLines.push(`<span class="text-xs text-zinc-400">Usuario: ${safeUser}</span>`);
              if (n.interval){
                const safeInterval = DOMPurify.sanitize(`${n.interval}m`);
                infoLines.push(`<span class="text-xs text-zinc-500">Intervalo: ${safeInterval}</span>`);
              }
              const statsBadges = [];
              statsBadges.push(`<span class="px-2 py-1 rounded-md bg-zinc-900 text-xs text-zinc-200 border border-zinc-700">Dispositivos: ${safeTotalDevices}</span>`);
              if (successCount !== null){
                statsBadges.push(`<span class="px-2 py-1 rounded-md bg-emerald-500/10 text-xs text-emerald-400 border border-emerald-500/40">√âxitos: ${safeSuccess}</span>`);
              }
              if (failureCount !== null){
                statsBadges.push(`<span class="px-2 py-1 rounded-md bg-rose-500/10 text-xs text-rose-400 border border-rose-500/40">Fallos: ${safeFailure}</span>`);
              }
              const failedTokens = Array.isArray(n.failedTokens) ? n.failedTokens : [];
              const failedDetails = failedTokens.length ? (()=>{
                const safeFailedCount = DOMPurify.sanitize(String(failedTokens.length));
                const items = failedTokens.map(ft=>{
                  const tokenDisplay = ft?.token ? `${String(ft.token).substring(0,30)}‚Ä¶` : 'Token desconocido';
                  const safeTokenDisplay = DOMPurify.sanitize(tokenDisplay);
                  const safeError = DOMPurify.sanitize(ft?.errorCode || 'unknown');
                  return `<li class="py-2 border-t border-zinc-800 first:border-t-0">
                    <p class="text-xs text-zinc-300 font-mono break-all">${safeTokenDisplay}</p>
                    <p class="text-[11px] text-rose-400 mt-1">Error: ${safeError}</p>
                  </li>`;
                }).join('');
                return `<details class="mt-3 bg-zinc-900/60 rounded-lg border border-zinc-700/60">
                  <summary class="cursor-pointer px-3 py-2 text-xs text-zinc-200">Ver tokens fallidos (${safeFailedCount})</summary>
                  <ul class="px-3 pb-3">${items}</ul>
                </details>`;
              })() : '';
              const bodySection = safeBody ? `<p class="text-sm text-zinc-300">${safeBody}</p>` : '';
              const titleSection = safeTitle ? `<h4 class="text-sm font-semibold text-white">${safeTitle}</h4>` : '';
              const infoSection = infoLines.length ? `<div class="flex flex-wrap gap-3">${infoLines.join('')}</div>` : '';
              return `
                <li class="mb-3">
                  <div class="p-4 bg-zinc-700/50 rounded-lg border border-zinc-600/40 space-y-3">
                    <div class="flex flex-col gap-1">
                      <p class="text-[11px] uppercase tracking-wide text-zinc-400">${safeType}</p>
                      ${titleSection}
                      <p class="text-xs text-zinc-400">${safeWhen}</p>
                    </div>
                    ${bodySection}
                    ${infoSection}
                    <div class="flex flex-wrap gap-2">${statsBadges.join('')}</div>
                    ${failedDetails}
                  </div>
                </li>`;
            }).join('');
          },

        // --- GENERACI√ìN (startAt/endAt) ---
        _buildStartEnd(dateStr, timeStr, duration=60){
          const start = new Date(`${dateStr}T${timeStr}:00-06:00`);
          const end = new Date(start.getTime() + (Number(duration||60)*60000));
          return {
            startAt: firebase.firestore.Timestamp.fromDate(start),
            endAt: firebase.firestore.Timestamp.fromDate(end),
            classDate: start.toISOString().slice(0,10),
            timeUTC: start.toISOString().slice(11,16)
          };
        },

        async generateDailyClasses(){
          if (!Object.keys(this.state.weeklySchedule).length) {
            this.showToast({ title:'Plantilla no cargada', variant:'warn' });
            return;
          }
          const today = new Date();
          const tomorrow = new Date(); tomorrow.setDate(today.getDate()+1);
          const days = [
            { dateStr: this.dateHelper.ymd(today), dow: today.getDay() },
            { dateStr: this.dateHelper.ymd(tomorrow), dow: tomorrow.getDay() }
          ];
          const batch = this.db.batch();
          let created = 0;
          const createdList = [];

          for (const d of days){
            const tpl = this.state.weeklySchedule[String(d.dow)] || [];
            if (!tpl.length) continue;
            const base = new Date(`${d.dateStr}T00:00:00-06:00`);
            const storedDate = base.toISOString().slice(0,10);
            const storedNext = new Date(base.getTime()+86400000).toISOString().slice(0,10);
            const existingSnap = await this.db.collection('classes').where('classDate','in',[storedDate, storedNext]).get();
            const existingTimes = new Set(existingSnap.docs.map(x=>{
              const data = x.data();
              const start = new Date(`${data.classDate}T${data.time}:00Z`);
              return this.timeFmt.format(start);
            }));
            for (const c of tpl){
              if (!existingTimes.has(c.time)){
                const ref = this.db.collection('classes').doc();
                const { startAt, endAt, classDate, timeUTC } = this._buildStartEnd(d.dateStr, c.time, c.duration||60);
                const isTRX = /trx/i.test(c.name || "");
                const capacity = (typeof c.capacity === "number") ? c.capacity : (isTRX ? 13 : 15);
                batch.set(ref,{
                  name: c.name,
                  time: timeUTC,
                  instructor: c.instructor || 'Por Asignar',
                  duration: c.duration || 60,
                  classDate,
                  capacity,
                  enrolledCount: 0,
                  startAt,
                  endAt,
                  description:`Clase de ${c.name}`,
                  icon:'üí™',
                  image:`https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(c.name)}`
                });
                createdList.push({ date: d.dateStr, time: c.time, name: c.name });
                created++;
              }
            }
          }

          if (created>0){
            await batch.commit();
            console.log('Clases generadas:', createdList);
            this.showToast({ title:'Clases generadas', message:`Se crearon ${created} clases` });
          } else {
            this.showToast({ title:'Horario al d√≠a', message:'No hay clases nuevas por crear', variant:'warn' });
          }
        },

        // --- RENDER ---
        renderAll(){ this.renderClassCards(); this.renderDailyBookings(); },

        isClassRunningNow(cls){
          if (!cls || !cls.classDate || !cls.time) return false;
          const todayStr = this.dateHelper.today();
          if (cls.localDate !== todayStr) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00Z`).getTime();
          const end   = start + (Number(cls.duration||60)*60000);
          const now = Date.now();
          return now>=start && now<=end;
        },

        renderClassCards(){
          const dayContainers = {
            1: document.getElementById('monday-classes-container'),
            2: document.getElementById('tuesday-classes-container'),
            3: document.getElementById('wednesday-classes-container'),
            4: document.getElementById('thursday-classes-container'),
            5: document.getElementById('friday-classes-container'),
            6: document.getElementById('saturday-classes-container'),
            0: document.getElementById('sunday-classes-container')
          };

          Object.values(dayContainers).forEach(container => {
            if (container) container.innerHTML = '';
          });

          const sorted = [...this.state.classes].sort((a,b)=>{
            const sa = new Date(`${a.classDate}T${a.time}:00Z`).getTime();
            const sb = new Date(`${b.classDate}T${b.time}:00Z`).getTime();
            return sa - sb;
          });

          for (const cls of sorted){
            const localDateStr = cls.localDate || cls.classDate;
            if (!localDateStr) continue;
            const localDate = new Date(`${localDateStr}T00:00:00`);
            const dayOfWeek = Number.isNaN(localDate.getTime()) ? null : localDate.getDay();
            const container = (dayOfWeek !== null) ? dayContainers[dayOfWeek] : null;
            if (!container) continue;

            const isRunning = this.isClassRunningNow(cls);
            const style = isRunning ? 'bg-emerald-900 border border-emerald-600' : 'bg-zinc-800';
            const enrolled = Number(cls.enrolledCount||0);
            const capacity = Number(cls.capacity||0);
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg shadow-md cursor-pointer hover:bg-zinc-700 transition-colors ${style}`;
            card.setAttribute('role','button');
            const safeName = DOMPurify.sanitize(cls.name || '');
            const safeInstructor = DOMPurify.sanitize(cls.instructor || '');
            const safeIcon = DOMPurify.sanitize(cls.icon || 'üí™');
            const safeTime = DOMPurify.sanitize(cls.localTime || cls.time || '');
            card.setAttribute('aria-label', `Editar ${safeName} a las ${safeTime}`);
            card.onclick = () => this.showClassModal(cls);
            card.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-xl font-bold">${safeName}</p>
                  <p class="text-sm text-zinc-400">${safeInstructor}</p>
                </div>
                <span class="text-2xl">${safeIcon}</span>
              </div>
              <div class="mt-4 flex justify-between items-center text-sm">
                <span class="font-semibold">a las ${safeTime}</span>
                <span class="font-bold ${enrolled>=capacity?'text-rose-400':'text-white'}">${enrolled} / ${capacity}</span>
              </div>`;
            container.appendChild(card);
          }

          Object.values(dayContainers).forEach(container => {
            if (!container) return;
            if (!container.children.length){
              container.innerHTML = '<p class="text-zinc-500 text-sm">No hay clases programadas.</p>';
            }
          });
        },

        renderDailyBookings(){
          const dayContainers = {
            1: document.getElementById('monday-bookings-list'),
            2: document.getElementById('tuesday-bookings-list'),
            3: document.getElementById('wednesday-bookings-list'),
            4: document.getElementById('thursday-bookings-list'),
            5: document.getElementById('friday-bookings-list'),
            6: document.getElementById('saturday-bookings-list'),
            0: document.getElementById('sunday-bookings-list')
          };

          Object.values(dayContainers).forEach(container => {
            if (container) container.innerHTML = '';
          });

          const groupedByDay = {};
          const sorted = [...this.state.classes].sort((a,b)=>{
            const sa = new Date(`${a.classDate}T${a.time}:00Z`).getTime();
            const sb = new Date(`${b.classDate}T${b.time}:00Z`).getTime();
            return sa - sb;
          });

          for (const cls of sorted){
            const localDateStr = cls.localDate || cls.classDate;
            if (!localDateStr) continue;
            const localDate = new Date(`${localDateStr}T00:00:00`);
            const dayOfWeek = Number.isNaN(localDate.getTime()) ? null : localDate.getDay();
            if (dayOfWeek === null) continue;
            if (!groupedByDay[dayOfWeek]) groupedByDay[dayOfWeek] = [];
            groupedByDay[dayOfWeek].push(cls);
          }

          Object.entries(dayContainers).forEach(([dayKey, container]) => {
            if (!container) return;
            const classesArr = groupedByDay[dayKey] || [];
            if (!classesArr.length){
              container.innerHTML = '<p class="text-zinc-500 text-sm">No hay reservas.</p>';
              return;
            }

            const blocks = classesArr.map(cls=>{
              const attendees = (this.state.bookingsMap.get(cls.id)||[]).map(b=>b.userName||'An√≥nimo');
              const waiters = (this.state.waitlistsMap.get(cls.id)||[])
                .sort((a,b)=>(a.position||0)-(b.position||0))
                .map(w=>w.userName||w.userId||'An√≥nimo');
              const enrolled = Number(cls.enrolledCount||0);
              const cap = Number(cls.capacity||0);
              const names = attendees.map(n=>`<li class="text-zinc-400 ml-4">- ${DOMPurify.sanitize(n)}</li>`).join('');
              const waitNames = waiters.map(n=>`<li class="text-zinc-400 ml-4">- ${DOMPurify.sanitize(n)}</li>`).join('');
              const safeTime = DOMPurify.sanitize(cls.localTime || cls.time || '');
              const safeName = DOMPurify.sanitize(cls.name || '');
              const waitHTML = waiters.length ? `
                  <p class="text-sm text-amber-400 mt-2">Lista de espera (${waiters.length})</p>
                  <ul class="list-none">${waitNames}</ul>
              ` : '';
              return `
                <div class="mb-3">
                  <p class="font-bold">${safeTime} - ${safeName} (${enrolled} de ${cap})</p>
                  <ul class="list-none">${names}</ul>
                  ${waitHTML}
                </div>`;
            });

            container.innerHTML = blocks.join('') || '<p class="text-zinc-500 text-sm">No hay reservas.</p>';
          });
        },

        // ====== ASISTENCIA (POLLING CADA 15 MIN) ======
        getDefaultAttendanceRange(){
          const today = this.dateHelper.today();
          const end = new Date(`${today}T00:00:00-06:00`);
          end.setDate(end.getDate()+1);
          const start = new Date(end);
          start.setDate(start.getDate()-3);
          return { start: this.dateHelper.ymd(start), end: this.dateHelper.ymd(end) };
        },
        getSelectedAttendanceRange(){
          const def = this.getDefaultAttendanceRange();
          const sEl = document.getElementById('att-start-date');
          const eEl = document.getElementById('att-end-date');
          let start = sEl?.value;
          let end = eEl?.value;
          if (!start || !end || start > end){
            start = def.start;
            end = def.end;
            if (sEl) sEl.value = start;
            if (eEl) eEl.value = end;
          }
          return { start, end };
        },

        startAttendancePolling(){
          this.fetchAttendanceData(true);
          this.stopAttendancePolling();
          this.state.unsubCapacity = this.db.collection('bookings').onSnapshot(()=>{
            this.fetchAttendanceData(true);
          });
          this.state.attendanceTickTimer = setInterval(()=>{ this.updateAttendanceLegend(); }, 1000);
        },
        stopAttendancePolling(){
          if (this.state.unsubCapacity){ this.state.unsubCapacity(); this.state.unsubCapacity=null; }
          if (this.state.attendanceTickTimer){ clearInterval(this.state.attendanceTickTimer); this.state.attendanceTickTimer=null; }
        },

        async fetchAttendanceData(){
          const now = Date.now();
          const { start, end } = this.getSelectedAttendanceRange();
          const report = {};
          const labels = [];
          // Parse selected range in Mexico City time to avoid UTC date shifts
          const startDate = new Date(`${start}T00:00:00-06:00`);
          const endDate = new Date(`${end}T00:00:00-06:00`);
          for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate()+1)){
            const d = this.dateHelper.ymd(dt);
            report[d] = { attended:0, absent:0, booked:0, totalCapacity:0, utilizationRate:0, warning:'', details:{ attended:{}, absent:{}, booked:{} } };
            labels.push({ date:d, label:this.dayShortFmt.format(new Date(dt)) });
          }
          try {
            const [attendanceSnap, classesSnap, bookingsSnap] = await Promise.all([
              this.db.collection('attendance')
                .where('classDate','>=',start)
                .where('classDate','<=',end)
                .get(),
              this.db.collection('classes')
                .where('classDate','>=',start)
                .where('classDate','<=',end)
                .get(),
              this.db.collection('bookings')
                .where('classDate','>=',start)
                .where('classDate','<=',end)
                .get()
            ]);

            attendanceSnap.forEach(doc=>{
              const r = doc.data();
              if (!report[r.classDate]) return;
              const cat = r.status==='attended' ? 'attended' : 'absent';
              report[r.classDate][cat]++;
              const labelBase = r.classTime ?? r.className;
              const key = `${labelBase} - ${r.className}`;
              if (!report[r.classDate].details[cat][key]) report[r.classDate].details[cat][key] = [];
              report[r.classDate].details[cat][key].push(r.userName);
            });

            const classesByDay = {};
            classesSnap.forEach(doc=>{
              const data = { id:doc.id, ...doc.data() };
              if (!data.classDate || !report[data.classDate]) return;
              if (data.classDate && data.time){
                const startAt = new Date(`${data.classDate}T${data.time}:00Z`);
                data.localDate = this.dateHelper.ymd(startAt);
                data.localTime = this.timeFmt.format(startAt);
              }
              if (!classesByDay[data.classDate]) classesByDay[data.classDate] = [];
              classesByDay[data.classDate].push(data);
            });

            const listenerClassesByDay = {};
            this.state.classes.forEach(cls=>{
              const day = cls.localDate || cls.classDate;
              if (!day || !report[day]) return;
              if (!listenerClassesByDay[day]) listenerClassesByDay[day] = [];
              listenerClassesByDay[day].push({ ...cls });
            });

            const bookingsByClass = {};
            bookingsSnap.forEach(doc=>{
              const data = { id:doc.id, ...doc.data() };
              if (!data.classId) return;
              if (!bookingsByClass[data.classId]) bookingsByClass[data.classId] = [];
              bookingsByClass[data.classId].push(data);
            });

            const effectiveClassesByDay = {};
            Object.keys(report).forEach(day=>{
              if (classesByDay[day]?.length){
                effectiveClassesByDay[day] = classesByDay[day];
              } else if (listenerClassesByDay[day]?.length){
                effectiveClassesByDay[day] = listenerClassesByDay[day];
              } else {
                effectiveClassesByDay[day] = [];
              }
            });

            Object.entries(effectiveClassesByDay).forEach(([day, classList])=>{
              const r = report[day];
              if (!r) return;
              let dayCapacity = 0;
              let dayBooked = 0;
              const bookedDetails = {};
              classList.forEach(cls=>{
                dayCapacity += Number(cls.capacity||0);
                const liveBookings = this.state.bookingsMap.get(cls.id) || [];
                const storedBookings = bookingsByClass[cls.id] || [];
                const rosterSource = liveBookings.length ? liveBookings : storedBookings;
                const rosterNames = rosterSource.map(x=>x.userName || x.userEmail || x.userId || 'An√≥nimo');
                if (rosterNames.length){
                  const fallbackTime = (cls.classDate && cls.time)
                    ? this.timeFmt.format(new Date(`${cls.classDate}T${cls.time}:00Z`))
                    : (cls.time || '');
                  const labelTime = cls.localTime || fallbackTime;
                  const labelName = cls.name || 'Clase';
                  const label = `${labelTime} - ${labelName}`.trim();
                  bookedDetails[label] = rosterNames;
                }
                dayBooked += rosterNames.length;
              });
              r.totalCapacity = dayCapacity;
              r.booked = dayBooked;
              r.details.booked = bookedDetails;
              const utilization = dayCapacity>0 ? Math.round((dayBooked/dayCapacity)*100) : 0;
              r.utilizationRate = utilization;
              if (utilization>85) r.warning='Capacidad cr√≠tica';
              else if (utilization>60) r.warning='Capacidad alta';
              else r.warning='Capacidad estable';
            });

            this.state.attendanceData = { report, labels, classesByDay: effectiveClassesByDay, bookingsByClass };
            this.state.attendanceLastAt = now;
            this.updateAttendanceLegend();
            this.renderAttendanceChartFromCache();
            this.updateCapacityGauge();
            console.log('Proyecciones:', this.calculateCapacityProjections());
          } catch(e){ console.error('Error leyendo asistencia:', e); }
        },

        updateAttendanceLegend(){
          const lastEl = document.getElementById('att-last');
          const nextEl = document.getElementById('att-next');
          if (!lastEl || !nextEl) return;
          if (this.state.attendanceLastAt){
            const fmt = new Intl.DateTimeFormat('es-MX',{timeZone:'America/Mexico_City',hour:'2-digit',minute:'2-digit'});
            lastEl.textContent = `√öltima actualizaci√≥n: ${fmt.format(new Date(this.state.attendanceLastAt))}`;
          } else lastEl.textContent = '√öltima actualizaci√≥n: ‚Äî';
          nextEl.textContent = 'Actualizaci√≥n en vivo';
        },

        updateCapacityGauge(){
          const fill = document.getElementById('capacity-gauge-fill');
          if (!fill || !this.state.attendanceData) return;
          const today = this.dateHelper.today();
          const d = this.state.attendanceData.report[today];
          if (!d){ fill.style.width = '0%'; return; }
          const fallbackRate = Math.round((d.booked/Math.max(d.totalCapacity||0,1))*100);
          const rate = (d.utilizationRate ?? fallbackRate);
          fill.style.width = Math.min(rate,100)+'%';
          fill.classList.remove('bg-emerald-500','bg-amber-500','bg-rose-500');
          if (rate>85) fill.classList.add('bg-rose-500');
          else if (rate>60) fill.classList.add('bg-amber-500');
          else fill.classList.add('bg-emerald-500');
        },

        calculateCapacityProjections(){
          const rep = this.state.attendanceData?.report || {};
          const arr = Object.values(rep);
          const values = arr.map(d=>{
            if (typeof d.utilizationRate === 'number') return d.utilizationRate;
            return Math.round((d.booked/Math.max(d.totalCapacity||0,1))*100);
          });
          const avg = values.reduce((s,val)=>s+val,0)/(values.length||1);
          const suggestion = avg>85?'A√±adir m√°s clases': avg>60?'Monitorear capacidad':'Capacidad adecuada';
          return { averageUtilization: Math.round(avg), suggestion };
        },

        // Update report with current bookings before rendering
        injectBookingsIntoReport(){
          const data = this.state.attendanceData;
          if (!data) return;
          const { report, classesByDay, bookingsByClass } = data;
          Object.keys(report).forEach(day=>{
            const classList = (classesByDay && classesByDay[day]) || [];
            if (!classList.length){
              report[day].booked = 0;
              report[day].details.booked = {};
              report[day].utilizationRate = 0;
              report[day].warning = 'Capacidad estable';
              return;
            }
            let totalBooked = 0;
            let totalCapacity = 0;
            const bookedDetails = {};
            classList.forEach(cls=>{
              totalCapacity += Number(cls.capacity||0);
              const live = this.state.bookingsMap.get(cls.id) || [];
              const fallback = bookingsByClass?.[cls.id] || [];
              const source = live.length ? live : fallback;
              const names = source.map(x=>x.userName || x.userEmail || x.userId || 'An√≥nimo');
              if (names.length){
                const labelTime = cls.localTime || cls.time || '';
                const labelName = cls.name || 'Clase';
                const label = `${labelTime} - ${labelName}`.trim();
                bookedDetails[label] = names;
              }
              totalBooked += names.length;
            });
            report[day].totalCapacity = totalCapacity;
            report[day].booked = totalBooked;
            report[day].details.booked = bookedDetails;
            const utilization = totalCapacity>0 ? Math.round((totalBooked/totalCapacity)*100) : 0;
            report[day].utilizationRate = utilization;
            if (utilization>85) report[day].warning='Capacidad cr√≠tica';
            else if (utilization>60) report[day].warning='Capacidad alta';
            else report[day].warning='Capacidad estable';
          });
        },

        exportCapacityReport(){
          const data = this.state.attendanceData;
          if (!data) return;
          const rows = [['Fecha','Asistieron','Faltaron','Reservaron','Capacidad','Utilizaci√≥n %']];
          Object.entries(data.report).forEach(([date,d])=>{
            rows.push([date,d.attended,d.absent,d.booked,d.totalCapacity,d.utilizationRate]);
          });
          const csv = rows.map(r=>r.join(',')).join('\n');
          const blob = new Blob([csv],{type:'text/csv'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'capacity-report.csv'; a.click();
          URL.revokeObjectURL(url);
        },

        renderAttendanceChartFromCache(){
          const ctx = document.getElementById('attendanceChart')?.getContext('2d');
          const details = document.getElementById('attendance-details');
          if (!ctx || !details) return;
          const dataCache = this.state.attendanceData;
          if (!dataCache){
            details.innerHTML = `<div class="bg-zinc-900 p-3 rounded-md text-zinc-400">Cargando reporte‚Ä¶ se actualizar√° autom√°ticamente.</div>`;
            return;
          }
          this.injectBookingsIntoReport();
          const { report, labels } = dataCache;
          const lbls = labels.map(l=>l.label);
          const attendedData = labels.map(l=>report[l.date].attended||0);
          const absentData   = labels.map(l=>report[l.date].absent||0);
          const bookedData   = labels.map(l=>report[l.date].booked||0);
          const utilData     = labels.map(l=>report[l.date].utilizationRate||0);
          const utilColors   = utilData.map(u=>u>85?'rgba(248,113,113,1)':u>60?'rgba(251,191,36,1)':'rgba(52,211,153,1)');
          const capLine      = labels.map(()=>this.FACILITY_MAX_CAPACITY);

          const includeBooked = bookedData.some(v => v > 0);
          const datasets = [
            { label:'Asistieron', data:attendedData, backgroundColor:'rgba(16,185,129,.6)' },
            { label:'Faltaron', data:absentData, backgroundColor:'rgba(244,63,94,.6)' }
          ];
          if (includeBooked){
            datasets.push({ label:'Reservaron', data:bookedData, backgroundColor:'rgba(59,130,246,.6)' });
          }
          datasets.push({ label:'Utilizaci√≥n %', data:utilData, type:'line', yAxisID:'y1', borderColor:'#818cf8', pointBackgroundColor:utilColors, fill:false, tension:0.1 });
          datasets.push({ label:`Capacidad ${this.FACILITY_MAX_CAPACITY}`, data:capLine, type:'line', borderColor:'#fcd34d', borderDash:[5,5], pointRadius:0 });

          if (this.state.attendanceChartInstance) this.state.attendanceChartInstance.destroy();
          this.state.attendanceChartInstance = new Chart(ctx,{
            type:'bar',
            data:{ labels: lbls, datasets },
            options:{
              scales:{
                y:{ beginAtZero:true, ticks:{ color:'#a1a1aa', stepSize:1 }, grid:{ color:'#3f3f46' }, suggestedMax:this.FACILITY_MAX_CAPACITY },
                y1:{ beginAtZero:true, position:'right', ticks:{ color:'#a1a1aa', callback:v=>v+'%' }, grid:{ drawOnChartArea:false } },
                x:{ ticks:{ color:'#a1a1aa', autoSkip:true, maxRotation:45 }, grid:{ color:'#3f3f46' } }
              },
              plugins:{ legend:{ labels:{ color:'#d4d4d8' } } }
            }
          });

          const renderList = (obj)=>{
            const names = Object.keys(obj||{}).sort();
            if (!names.length) return '<ul class="list-disc list-inside text-zinc-400"><li>Nadie</li></ul>';
            return names.map(n=>{
              const safeName = DOMPurify.sanitize(n);
              const people = (obj[n]||[]).map(p=>`<li>${DOMPurify.sanitize(p)}</li>`).join('');
              return `
              <div class="font-semibold text-zinc-300 mt-1">${safeName}:</div>
              <ul class="list-disc list-inside text-zinc-400">${people}</ul>
            `;}).join('');
          };

          details.innerHTML = labels.map(l=>{
            const d = report[l.date];
            let html = `
              <div class="bg-zinc-900 p-3 rounded-md">
                <h4 class="font-bold text-lg mb-2">${DOMPurify.sanitize(l.label)}</h4>`;

            if (d.booked){
              html += `
                <div class="font-semibold text-blue-400">Reservaron (${d.booked||0})</div>
                ${renderList(d.details.booked)}`;
            }

            const warnColor = d.utilizationRate>85?'text-rose-400': d.utilizationRate>60?'text-amber-400':'text-emerald-400';
            const peak = Object.entries(d.details.booked||{}).map(([k,v])=>({k,v:v.length})).reduce((a,b)=> b.v>(a?.v||0)?b:a,null);
            const peakLabel = peak?peak.k:'‚Äî';
            const revenue = d.booked*100;

            html += `
                <div class="text-sm mt-2">Capacidad total: ${d.totalCapacity||0}</div>
                <div class="text-sm">Utilizaci√≥n: ${d.utilizationRate||0}%</div>
                <div class="${warnColor} text-sm">${DOMPurify.sanitize(d.warning||'')}</div>
                <div class="text-sm mt-1">Hora pico: ${DOMPurify.sanitize(peakLabel)}</div>
                <div class="text-sm">Ingresos estimados: $${revenue}</div>
                <div class="font-semibold text-emerald-400 mt-2">Asistieron (${d.attended||0})</div>
                ${renderList(d.details.attended)}
                <div class="font-semibold text-rose-400 mt-2">Faltaron (${d.absent||0})</div>
                ${renderList(d.details.absent)}
              </div>`;
            return html;
          }).join('');
        },

        // --- MODAL / Asistencia ---
        isClassInProgressWindow(cls){
          if (!cls || !cls.classDate || !cls.time) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00Z`).getTime();
          const now = Date.now();
          const lower = now - (15*60*60*1000);
          const upper = now + (30*60*1000);
          return (start>=lower) && (start<=upper);
        },

        showCreateClassModal(){
          this.state.currentAttendance = {};
          this.state.selectedClass = null;
          document.getElementById('class-id').value = '';
          document.getElementById('class-name').value = '';
          document.getElementById('class-instructor').value = '';
          document.getElementById('class-time').value = '';
          document.getElementById('class-icon').value = 'üí™';
          document.getElementById('class-description').value = '';
          document.getElementById('class-date').value = this.dateHelper.today();
          document.getElementById('class-capacity').value = '15';
          document.getElementById('class-duration').value = '60';
          document.getElementById('class-enrolled').value = '0';
          document.getElementById('class-image').value = '';

          const timeInput = document.getElementById('class-time');
          if (timeInput){
            timeInput.readOnly = false;
            timeInput.classList.remove('cursor-not-allowed','opacity-60');
            timeInput.removeAttribute('aria-readonly');
          }
          const warning = document.getElementById('class-time-warning');
          if (warning){
            warning.textContent = '';
            warning.classList.add('hidden');
          }

          const tabDetails = document.getElementById('tab-details');
          if (tabDetails) tabDetails.onclick = () => this.switchTab('details');
          const tabAttendance = document.getElementById('tab-attendance');
          if (tabAttendance){
            tabAttendance.classList.add('hidden');
            tabAttendance.onclick = null;
          }
          this.switchTab('details');

          document.getElementById('modal-title').textContent = 'Crear Nueva Clase';
          document.getElementById('save-button').textContent = 'Crear Clase';
          document.getElementById('delete-button').style.display = 'none';

          document.getElementById('cancel-button').onclick = () => this.hideClassModal();
          document.getElementById('save-button').onclick = () => this.saveClass();

          document.getElementById('class-modal').classList.remove('hidden');
          document.getElementById('class-name').focus();
        },

        async createClass(){
          const data = {
            name: document.getElementById('class-name').value.trim(),
            instructor: document.getElementById('class-instructor').value.trim() || 'Por Asignar',
            time: document.getElementById('class-time').value.trim(),
            icon: document.getElementById('class-icon').value || 'üí™',
            description: document.getElementById('class-description').value.trim(),
            classDate: document.getElementById('class-date').value.trim(),
            capacity: Number(document.getElementById('class-capacity').value) || 15,
            duration: Number(document.getElementById('class-duration').value) || 60,
            enrolledCount: 0,
            image: document.getElementById('class-image').value.trim()
          };

          if (!data.name || !data.time || !data.classDate){
            this.showToast({ title:'Campos requeridos', message:'Nombre, hora y fecha son obligatorios', variant:'error' });
            return;
          }

          const safeCapacity = Math.round(Math.min(30, Math.max(1, Number(data.capacity) || 15)));
          const safeDuration = Math.round(Math.min(120, Math.max(30, Number(data.duration) || 60)));
          data.capacity = safeCapacity;
          data.duration = safeDuration;

          const { startAt, endAt, classDate, timeUTC } = this._buildStartEnd(data.classDate, data.time, data.duration);

          if (!data.image){
            data.image = `https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(data.name)}`;
          }

          data.startAt = startAt;
          data.endAt = endAt;
          data.classDate = classDate;
          data.time = timeUTC;

          try{
            await this.db.collection('classes').add(data);
            this.showToast({ title:'Clase creada', message:`${data.name} creada exitosamente` });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'Error al crear', message:e.message, variant:'error' });
          }
        },

        async showClassModal(cls){
          this.state.currentAttendance = {};
          this.state.selectedClass = cls ? { ...cls } : null;
          const baseDate = (cls.classDate && cls.time) ? new Date(`${cls.classDate}T${cls.time}:00Z`) : null;
          const localTime = cls.localTime || (baseDate ? this.timeFmt.format(baseDate) : cls.time || '');
          const localDate = cls.localDate || (baseDate ? this.dateHelper.ymd(baseDate) : cls.classDate || '');
          document.getElementById('class-id').value = cls.id;
          document.getElementById('class-name').value = cls.name || '';
          document.getElementById('class-instructor').value = cls.instructor || '';
          document.getElementById('class-time').value = localTime;
          document.getElementById('class-icon').value = cls.icon || '';
          document.getElementById('class-description').value = cls.description || '';
          document.getElementById('class-date').value = localDate;
          document.getElementById('class-capacity').value = (cls.capacity ?? 15);
          document.getElementById('class-duration').value = (cls.duration ?? 60);
          const enrolledVal = Number.isFinite(cls.enrolledCount) ? cls.enrolledCount : (this.state.bookingsMap.get(cls.id)?.length || 0);
          document.getElementById('class-enrolled').value = enrolledVal;
          document.getElementById('class-image').value = cls.image || '';

          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          this.switchTab('details');
          tabD.onclick = () => this.switchTab('details');
          if (this.isClassInProgressWindow(cls)){
            tabA.classList.remove('hidden');
            tabA.onclick = () => this.switchTab('attendance');
            this.loadAttendeesForAttendance(cls);
          } else {
            tabA.classList.add('hidden'); tabA.onclick = null;
          }

          // Event handlers for modal buttons
          document.getElementById('delete-button').onclick = () => {
            if (confirm('¬øEst√°s seguro de eliminar esta clase?')) {
              this.deleteClass();
            }
          };
          document.getElementById('cancel-button').onclick = () => this.hideClassModal();
          document.getElementById('save-button').onclick = () => this.saveClass();
          const modal = document.getElementById('class-modal');
          const saveBtnEl = document.getElementById('save-button');
          const timeEl = document.getElementById('class-time');
          if (timeEl){
            timeEl.readOnly = true;
            timeEl.classList.add('cursor-not-allowed','opacity-60');
          }
          if (modal) modal.classList.remove('hidden');
          saveBtnEl?.focus();
          await this.refreshClassTimeLock(cls);
          document.getElementById('modal-title').textContent = 'Editar Clase';
          document.getElementById('save-button').textContent = 'Guardar Cambios';
          document.getElementById('delete-button').style.display = 'block';
        },

        hideClassModal(){
          document.getElementById('class-modal').classList.add('hidden');
          this.state.selectedClass = null;
        },

        async refreshClassTimeLock(cls){
          const timeInput = document.getElementById('class-time');
          const warning = document.getElementById('class-time-warning');
          if (!timeInput) return;

          timeInput.readOnly = false;
          timeInput.classList.remove('cursor-not-allowed','opacity-60');
          timeInput.removeAttribute('aria-readonly');
          if (warning){
            warning.textContent = '';
            warning.classList.add('hidden');
          }

          if (!cls?.id){
            return;
          }

          try{
            const snap = await this.db.collection('attendance').where('classId','==',cls.id).limit(1).get();
            const hasAttendance = !snap.empty;
            if (hasAttendance){
              timeInput.value = cls.localTime || cls.time || '';
              timeInput.readOnly = true;
              timeInput.classList.add('cursor-not-allowed','opacity-60');
              timeInput.setAttribute('aria-readonly','true');
              if (warning){
                warning.textContent = 'Esta clase tiene asistencia registrada. La hora no se puede modificar.';
                warning.classList.remove('hidden');
              }
            }
          }catch(err){
            console.error('No se pudo verificar asistencia', err);
            timeInput.readOnly = true;
            timeInput.classList.add('cursor-not-allowed','opacity-60');
            timeInput.setAttribute('aria-readonly','true');
            if (warning){
              warning.textContent = 'No pudimos verificar la asistencia. Evita cambiar la hora.';
              warning.classList.remove('hidden');
            }
          }
        },

        switchTab(tab){
          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          const contD = document.getElementById('details-content');
          const contA = document.getElementById('attendance-content');
          const saveBtn = document.getElementById('save-button');
          if (tab==='details'){
            tabD.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','true');
            tabA.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','false');
            contD.classList.remove('hidden'); contA.classList.add('hidden');
            if (saveBtn) saveBtn.classList.remove('hidden');
          } else {
            tabA.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','true');
            tabD.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','false');
            contA.classList.remove('hidden'); contD.classList.add('hidden');
            if (saveBtn) saveBtn.classList.add('hidden');
          }
        },

        async loadAttendeesForAttendance(cls){
          const list = document.getElementById('attendance-list');
          const msg  = document.getElementById('attendance-status-message');
          const save = document.getElementById('save-attendance-btn');

          const currentBookings = this.state.bookingsMap.get(cls.id) || [];
          const attSnap = await this.db.collection('attendance').where('classId','==',cls.id).get();
          const existing = {};
          attSnap.forEach(doc=>{ const d=doc.data(); existing[d.userId] = d.status; });

          this.state.currentAttendance = {};
          currentBookings.forEach(b=>{
            if (existing[b.userId]){
              this.state.currentAttendance[b.userId] = { status: existing[b.userId], userName: b.userName };
            }
          });

          if (!currentBookings.length){
            msg.textContent = 'No hay usuarios inscritos en esta clase.';
            list.innerHTML=''; save.classList.add('hidden');
            return;
          }

          msg.textContent = `${currentBookings.length} usuarios inscritos.`;
          list.innerHTML = currentBookings.map(b=>{
            const st = existing[b.userId];
            const selA = st==='attended' ? 'selected-attended':'';
            const selF = st==='absent'   ? 'selected-absent':'';
            const safeName = DOMPurify.sanitize(b.userName || 'An√≥nimo');
            const safeId = DOMPurify.sanitize(b.userId);
            return `
              <div class="flex items-center justify-between bg-zinc-900 p-2 rounded-md">
                <span class="text-zinc-300">${safeName}</span>
                <div class="space-x-2" data-user-id="${safeId}" data-user-name="${safeName}">
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selA}" data-status="attended">Asisti√≥</button>
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selF}" data-status="absent">Falt√≥</button>
                </div>
              </div>`;
          }).join('');

          save.classList.remove('hidden');
          list.onclick = (e)=>{
            const btn = e.target.closest('.attendance-btn'); if(!btn) return;
            const parent = btn.parentElement;
            const { userId, userName } = parent.dataset;
            const { status } = btn.dataset;
            this.state.currentAttendance[userId] = { status, userName };
            parent.querySelectorAll('.attendance-btn').forEach(x=>x.classList.remove('selected-attended','selected-absent'));
            btn.classList.add(status==='attended'?'selected-attended':'selected-absent');
          };
          save.onclick = () => this.saveAttendance();
        },

        async saveAttendance(){
          const clsId = document.getElementById('class-id')?.value;
          const cls = this.state.selectedClass || this.state.classes.find(c=>c.id===clsId);
          if (!cls){
            this.showToast({ title:'Clase no disponible', message:'No pudimos cargar la clase para guardar asistencia.', variant:'error' });
            return;
          }
          const data = this.state.currentAttendance;
          if (!Object.keys(data).length){
            this.showToast({ title:'Sin cambios', message:'No marcaste asistencia', variant:'warn' });
            return;
          }
          const classDate = cls.classDate || cls.localDate || '';
          if (!classDate){
            this.showToast({ title:'Clase sin fecha', message:'No se pudo identificar la fecha de la clase.', variant:'error' });
            return;
          }
          let classTimeLocal = cls.localTime || '';
          if (!classTimeLocal && cls.time){
            const baseTime = new Date(`${classDate}T${cls.time}:00Z`);
            classTimeLocal = this.timeFmt.format(baseTime);
          }
          const batch = this.db.batch();
          Object.keys(data).forEach(uid=>{
            const rec = data[uid];
            const ref = this.db.collection('attendance').doc(`${classDate}_${cls.id}_${uid}`);
            batch.set(ref,{
              classId: cls.id, className: cls.name, classDate,
              classTime: classTimeLocal,
              userId: uid, userName: rec.userName, status: rec.status, recordedAt: new Date()
            },{ merge:true });
          });
          try{
            await batch.commit();
            this.showToast({ title:'Asistencia guardada' });
            this.fetchAttendanceData(true);
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'Error al guardar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Password reset ----
        async sendPasswordReset(){
          const input = document.getElementById('user-email-input');
          const email = input.value.trim();
          if (!email){ this.showToast({ title:'Falta correo', variant:'warn' }); return; }
          try{
            await this.auth.sendPasswordResetEmail(email);
            this.showToast({ title:'Correo enviado', message:`Revisa ${email}` });
            input.value='';
          }catch(e){
            this.showToast({ title:'No se pudo enviar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Buscar por nombre o correo ----
        async findUsersByQuery(){
          const input = document.getElementById('find-user-query-input');
          const raw = (input.value||'').trim();
          const q = this.normalizeStr(raw);
          const container = document.getElementById('user-details-container');
          const hint = document.getElementById('user-results-hint');

          container.innerHTML=''; container.classList.add('hidden'); hint.classList.add('hidden');
          if (!raw){ this.showToast({ title:'Falta texto de b√∫squeda', variant:'warn' }); return; }

          try{
            const results = [];

            if (raw.includes('@')) {
              // correo exacto
              const snap = await this.db.collection('users').where('emailLower','==',q).limit(10).get();
              snap.forEach(d=>results.push(d));
              if (!results.length){
                const snap2 = await this.db.collection('users').where('email','==',raw).limit(10).get();
                snap2.forEach(d=>results.push(d));
              }
            } else {
              // nombre (prefijo, si existe √≠ndice) o fallback local
              let triedPrefix=false;
              try{
                const start=q, end=q+'\uf8ff';
                const byName = await this.db.collection('users').orderBy('displayNameLower').startAt(start).endAt(end).limit(20).get();
                byName.forEach(d=>results.push(d));
                triedPrefix=true;
              }catch(_){ /* falta √≠ndice */ }

              if (!results.length){
                const page = await this.db.collection('users').limit(300).get();
                page.forEach(d=>{
                  const data=d.data()||{};
                  const emailL=this.normalizeStr(data.email||'');
                  const nameL=this.normalizeStr(data.displayName||'');
                  if (emailL.includes(q) || nameL.includes(q)) results.push(d);
                });
                if (!triedPrefix && results.length){
                  hint.textContent='Resultado por b√∫squeda local (sin √≠ndice). Considera guardar displayNameLower y crear √≠ndice.';
                  hint.classList.remove('hidden');
                }
              }
            }

            if (!results.length){
              this.showToast({ title:'Sin resultados', message:`No encontramos "${raw}"`, variant:'warn' });
              return;
            }

            this.state.userSearchResults = results;
            container.innerHTML = results.map((doc, idx)=> this.userCardHTML(doc, idx)).join('');
            container.classList.remove('hidden');
            this.wireUserCardButtons();
          }catch(e){
            this.showToast({ title:'Error al buscar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Listar primera p√°gina ----
        async listUsersPage(){
          const container = document.getElementById('user-details-container');
          const hint = document.getElementById('user-results-hint');
          container.innerHTML='';
          container.classList.add('hidden');
          hint.classList.add('hidden');

          try{
            const snap = await this.db.collection('users').get();
            if (snap.empty){
              this.showToast({ title:'Sin usuarios', variant:'warn' });
              return;
            }

            container.innerHTML = snap.docs.map(doc => {
              const data = doc.data() || {};
              const safeName = DOMPurify.sanitize(data.displayName || 'Usuario sin nombre');
              const safeEmail = DOMPurify.sanitize(data.email || '');
              return `
            <div class="p-4 bg-zinc-700/50 rounded-lg">
              <h4 class="font-bold">${safeName}</h4>
              <p class="text-sm text-zinc-400">${safeEmail}</p>
            </div>`;
            }).join('');
            container.classList.remove('hidden');
            hint.textContent = `Mostrando ${snap.size} usuarios.`;
            hint.classList.remove('hidden');
          }catch(e){
            this.showToast({ title:'Error listando', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Render tarjeta + cableado ----
        userCardHTML(userDoc, indexBase=0){
          const userData = userDoc.data() || {};
          const tokenEntries = userData.fcmTokens ? Object.entries(userData.fcmTokens) : [];
          const safeName = DOMPurify.sanitize(userData.displayName || 'Usuario sin nombre');
          const safeEmail = DOMPurify.sanitize(userData.email || '');
          const head = `
            <div class="p-4 bg-zinc-700/50 rounded-lg">
              <h4 class="font-bold">${safeName}</h4>
              <p class="text-sm text-zinc-400">${safeEmail}</p>
          `;
          if (!tokenEntries.length){
            return head + `<p class="text-sm text-zinc-400 mt-3">Sin dispositivos registrados.</p></div>`;
          }
          const bodies = tokenEntries.map(([token, rawMeta],i)=>{
            const safeToken = DOMPurify.sanitize(token);
            const displayToken = DOMPurify.sanitize(safeToken.substring(0,30));
            const safeUid = DOMPurify.sanitize(userDoc.id);
            const meta = rawMeta && typeof rawMeta === 'object' ? rawMeta : null;

            let registeredAtStr = '';
            if (meta?.registeredAt){
              const dateObj = meta.registeredAt.toDate ? meta.registeredAt.toDate() : new Date(meta.registeredAt);
              if (dateObj instanceof Date && !Number.isNaN(dateObj.getTime())){
                registeredAtStr = new Intl.DateTimeFormat('es-MX',{ dateStyle:'short', timeStyle:'short' }).format(dateObj);
              }
            }

            const metaRows = [];
            if (meta?.userAgent){
              const ua = DOMPurify.sanitize(String(meta.userAgent));
              metaRows.push(`<p class="text-xs text-zinc-400 break-words">UA: ${ua}</p>`);
            }
            if (meta?.platform){
              const platform = DOMPurify.sanitize(String(meta.platform));
              metaRows.push(`<p class="text-xs text-zinc-400">Plataforma: ${platform}</p>`);
            }
            if (registeredAtStr){
              const safeRegistered = DOMPurify.sanitize(registeredAtStr);
              metaRows.push(`<p class="text-xs text-zinc-500">Registrado: ${safeRegistered}</p>`);
            }
            const screenInfo = meta?.screen || meta?.screenResolution;
            if (screenInfo){
              const safeScreen = DOMPurify.sanitize(String(screenInfo));
              metaRows.push(`<p class="text-xs text-zinc-500">Pantalla: ${safeScreen}</p>`);
            }
            if (meta?.timezone){
              const safeTz = DOMPurify.sanitize(String(meta.timezone));
              metaRows.push(`<p class="text-xs text-zinc-500">Zona horaria: ${safeTz}</p>`);
            }
            if (meta?.browser){
              const safeBrowser = DOMPurify.sanitize(String(meta.browser));
              metaRows.push(`<p class="text-xs text-zinc-500">Navegador: ${safeBrowser}</p>`);
            }
            if (meta?.language){
              const safeLang = DOMPurify.sanitize(String(meta.language));
              metaRows.push(`<p class="text-xs text-zinc-500">Idioma: ${safeLang}</p>`);
            }
            if (!metaRows.length){
              metaRows.push('<p class="text-xs text-zinc-500">Sin metadata disponible.</p>');
            }

            return `
            <div class="token-row p-3 bg-zinc-900 rounded-lg border border-zinc-700 mt-3">
              <p class="text-xs text-zinc-400 font-mono break-all">Dispositivo ${i+1}: ${displayToken}...</p>
              <div class="mt-2 space-y-1">${metaRows.join('')}</div>
              <div class="mt-3 space-y-2">
                <input type="text" id="noti-title-${indexBase}_${i}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm" placeholder="T√≠tulo de la notificaci√≥n">
                <textarea id="noti-body-${indexBase}_${i}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm h-16" placeholder="Cuerpo del mensaje"></textarea>
                <div class="flex gap-2">
                  <button data-token="${safeToken}" data-index="${indexBase}_${i}" data-uid="${safeUid}"
                          class="send-noti-btn flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md text-sm">
                    Enviar a este Dispositivo
                  </button>
                  <button data-token="${safeToken}" data-uid="${safeUid}"
                          class="prune-token-btn px-3 bg-zinc-700 hover:bg-zinc-600 text-white font-semibold rounded-md text-sm">
                    Prune
                  </button>
                </div>
              </div>
            </div>
          `;}).join('');
          return head + `<div class="mt-4 space-y-3">${bodies}</div></div>`;
        },

        wireUserCardButtons(){
          document.querySelectorAll('.send-noti-btn').forEach(btn=>{
            btn.onclick = (event)=> this.sendDirectNotification(event);
          });
          document.querySelectorAll('.prune-token-btn').forEach(btn=>{
            btn.onclick = (event)=> this.pruneTokenManually(event);
          });
        },

        // ---- USERS: Env√≠o + AUTOPRUNE ----
        async sendDirectNotification(event){
          const btn = event.target;
          const { token, index, uid } = btn.dataset;
          const title = document.getElementById(`noti-title-${index}`)?.value.trim();
          const body  = document.getElementById(`noti-body-${index}`)?.value.trim();

          if (!title || !body){
            this.showToast({ title:'Faltan datos', message:'El t√≠tulo y el cuerpo son requeridos.', variant:'warn' });
            return;
          }

          btn.disabled = true;
          btn.textContent = 'Enviando...';

          try{
            if (this.auth.currentUser) await this.auth.currentUser.getIdToken(true);
            const send = this.functions.httpsCallable('sendDirectNotification');
            const result = await send({ token, title, body });

            if (result.data?.success){
              this.showToast({ title:'Notificaci√≥n enviada', message:'Dispositivo notificado ‚úÖ' });
            } else {
              throw new Error(result.data?.error || 'El servidor devolvi√≥ un error.');
            }
          }catch(e){
            const msg = String(e?.message || e);
            this.showToast({ title:'Error al enviar', message: msg, variant:'error' });

            // Heur√≠stica de token inv√°lido/no registrado
            const looksInvalid = /not[-\s]?registered|unregistered|invalid[-\s]?registration|registration[-\s]?token|mismatch/i.test(msg);
            if (looksInvalid && uid && token){
              const ok = confirm('Este token parece inv√°lido. ¬øQuieres eliminarlo del perfil del usuario?');
              if (ok){
                try{
                  await this.db.collection('users').doc(uid).set({
                    fcmTokens: { [token]: firebase.firestore.FieldValue.delete() }
                  }, { merge:true });
                  this.showToast({ title:'Token eliminado', message:'Se removi√≥ el token inv√°lido.' });
                }catch(pruneErr){
                  this.showToast({ title:'No se pudo eliminar token', message: pruneErr.message, variant:'error' });
                }
              }
            }
          }finally{
            btn.disabled = false;
            btn.textContent = 'Enviar a este Dispositivo';
          }
        },

        async pruneTokenManually(event){
          const btn = event.target;
          const { token, uid } = btn.dataset;
          if (!uid || !token) return;
          const ok = confirm('¬øEliminar este token del usuario?');
          if (!ok) return;
          btn.disabled = true;
          try{
            await this.db.collection('users').doc(uid).set({
              fcmTokens: { [token]: firebase.firestore.FieldValue.delete() }
            }, { merge:true });
            this.showToast({ title:'Token eliminado' });
            const freshDoc = await this.db.collection('users').doc(uid).get();
            const idx = this.state.userSearchResults.findIndex(d=>d.id===uid);
            if (idx !== -1) this.state.userSearchResults[idx] = freshDoc;
            const card = btn.closest('.p-4');
            if (card){
              card.outerHTML = this.userCardHTML(freshDoc, idx === -1 ? 0 : idx);
              this.wireUserCardButtons();
            }
          }catch(e){
            this.showToast({ title:'No se pudo eliminar', message:e.message, variant:'error' });
          }finally{
            btn.disabled = false;
          }
        },

        // ---- AUTH ----
        login() {
            // 1. Get the Turnstile token from the widget
            const turnstileToken = turnstile.getResponse();

            const email = document.getElementById('email-input').value.trim();
            const pass  = document.getElementById('password-input').value;
            const errEl = document.getElementById('error-message');
            errEl.classList.add('hidden');

            // 2. Check if the token exists
            if (!turnstileToken) {
                errEl.textContent = 'Por favor, completa la verificaci√≥n de seguridad.';
                errEl.classList.remove('hidden');
                return; // Stop the login attempt if no token
            }

            // 3. If token exists, proceed with Firebase auth
            this.auth.signInWithEmailAndPassword(email, pass).catch(err => {
                errEl.textContent = 'Error: ' + err.message;
                errEl.classList.remove('hidden');
                // Reset the widget if login fails so the user can try again
                turnstile.reset();
            });
        },
        logout(){ this.auth.signOut(); this.showToast({ title:'Sesi√≥n cerrada' }); },

        // ---- CRUD Clase ----
        async saveClass(){
          const id = document.getElementById('class-id').value.trim();

          if (!id){
            await this.createClass();
            return;
          }

          const name = document.getElementById('class-name').value.trim();
          const instructor = document.getElementById('class-instructor').value.trim();
          const icon = document.getElementById('class-icon').value.trim();
          const description = document.getElementById('class-description').value.trim();
          const imageInput = document.getElementById('class-image').value.trim();
          const timeInputEl = document.getElementById('class-time');
          const timeInputValue = (timeInputEl?.value || '').trim();
          const dateInputEl = document.getElementById('class-date');
          const dateInputValue = (dateInputEl?.value || '').trim();
          const capacityRaw = Number(document.getElementById('class-capacity').value);
          const durationEl = document.getElementById('class-duration');
          const durationRaw = Number(durationEl?.value);
          const enrolledEl = document.getElementById('class-enrolled');

          try{
            const cls = this.state.classes.find(c=>c.id===id);
            if (!cls){
              this.showToast({ title:'Clase no encontrada', message:'No pudimos ubicar la clase seleccionada.', variant:'error' });
              return;
            }

            const baseDate = (cls.classDate && cls.time) ? new Date(`${cls.classDate}T${cls.time}:00Z`) : null;
            const currentDateLocal = cls.localDate || (baseDate ? this.dateHelper.ymd(baseDate) : '');
            let currentTimeLocal = cls.localTime || '';
            if (!currentTimeLocal && baseDate){
              currentTimeLocal = this.timeFmt.format(baseDate);
            }
            const originalDuration = Number(cls.duration || 60);

            const effectiveDate = dateInputValue || currentDateLocal;
            const effectiveTime = timeInputValue || currentTimeLocal;
            const capacityBase = Number.isFinite(capacityRaw) ? capacityRaw : Number(cls.capacity || 15) || 15;
            const durationBase = Number.isFinite(durationRaw) ? durationRaw : originalDuration || 60;
            const capacity = Math.max(1, Math.min(30, Math.round(capacityBase)));
            const duration = Math.max(30, Math.min(120, Math.round(durationBase)));

            if (!name || !effectiveTime || !effectiveDate){
              this.showToast({ title:'Campos requeridos', message:'Nombre, hora y fecha son obligatorios', variant:'error' });
              return;
            }

            const data = {
              name,
              instructor: instructor || 'Por Asignar',
              icon: icon || 'üí™',
              description,
              image: imageInput,
              capacity,
              duration
            };

            if (!data.image){
              data.image = cls.image || `https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(name)}`;
            }

            if (enrolledEl){
              const enrolledCount = Number(enrolledEl.value);
              if (Number.isFinite(enrolledCount)) data.enrolledCount = enrolledCount;
            }

            const wantsScheduleChange = (
              (effectiveDate && effectiveDate !== currentDateLocal) ||
              (effectiveTime && effectiveTime !== currentTimeLocal) ||
              (duration !== originalDuration)
            );

            let canApplyScheduleChange = wantsScheduleChange;

            if (wantsScheduleChange){
              try{
                const attSnap = await this.db.collection('attendance').where('classId','==',id).limit(1).get();
                if (!attSnap.empty){
                  canApplyScheduleChange = false;
                  if (timeInputEl) timeInputEl.value = currentTimeLocal;
                  if (dateInputEl) dateInputEl.value = currentDateLocal;
                  if (enrolledEl) enrolledEl.value = Number.isFinite(cls.enrolledCount) ? cls.enrolledCount : enrolledEl.value;
                  if (durationEl) durationEl.value = originalDuration;
                  await this.refreshClassTimeLock(cls);
                  this.showToast({ title:'Hora bloqueada', message:'Esta clase ya tiene asistencia registrada. No puedes cambiar la hora.', variant:'warn' });
                }
              }catch(err){
                console.error('Error validando asistencia antes de cambiar hora', err);
                canApplyScheduleChange = false;
                if (timeInputEl) timeInputEl.value = currentTimeLocal;
                if (dateInputEl) dateInputEl.value = currentDateLocal;
                if (durationEl) durationEl.value = originalDuration;
                await this.refreshClassTimeLock(cls);
                this.showToast({ title:'No se pudo verificar asistencia', message:'Guardamos los dem√°s cambios, pero deja la hora igual.', variant:'warn' });
              }
            }

            if (canApplyScheduleChange){
              const { startAt, endAt, classDate, timeUTC } = this._buildStartEnd(effectiveDate, effectiveTime, duration);
              data.startAt = startAt;
              data.endAt = endAt;
              data.classDate = classDate;
              data.time = timeUTC;
            } else if (wantsScheduleChange){
              data.duration = originalDuration;
            }

            await this.db.collection('classes').doc(id).set(data,{ merge:true });
            this.showToast({ title:'Clase actualizada' });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'No se guard√≥', message:e.message, variant:'error' });
          }
        },

        async deleteClass(){
          const id = document.getElementById('class-id').value; if(!id) return;
          try{
            const snap = await this.db.collection('bookings').where('classId','==',id).get();
            const batch = this.db.batch();
            snap.forEach(doc=>batch.delete(doc.ref));
            await batch.commit();
            await this.db.collection('classes').doc(id).delete();
            this.showToast({ title:'Clase eliminada', message:`Se borraron ${snap.size} reservas` });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'No se pudo eliminar', message:e.message, variant:'error' });
          }
        },
      };

      AdminPanel.init();
    </script>
  </body>
</html>
