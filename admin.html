<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Madness - Panel de Administrador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      :focus-visible { outline: 2px solid #818cf8; outline-offset: 2px; border-radius: .5rem; }
      .attendance-btn.selected-attended { background-color: #10b981; color: white; }
      .attendance-btn.selected-absent { background-color: #f43f5e; color: white; }
      #toast-container { pointer-events: none; }
      .toast { pointer-events: auto; }
    </style>
  </head>
  <body class="bg-zinc-900 text-white">
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] space-y-2" aria-live="polite" aria-atomic="true"></div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-zinc-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
        <h1 class="text-2xl font-bold text-center mb-6">Acceso de Administrador</h1>
        <input type="email" id="email-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Correo de Admin" autocomplete="email">
        <input type="password" id="password-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Contrase√±a" autocomplete="current-password">
        <div class="cf-turnstile mb-4" data-sitekey="0x4AAAAAABwCDMFGoF_Z-wjY"></div>
        <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md">Entrar</button>
        <p id="error-message" class="text-rose-400 text-center mt-4 hidden"></p>
      </div>
    </div>

    <div id="admin-panel" class="hidden p-4 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
        <button id="logout-btn" class="text-rose-400 hover:text-rose-300 font-semibold">Cerrar Sesi√≥n</button>
      </div>

      <div class="mb-6 flex flex-wrap gap-3">
        <button id="gen-classes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg">
          <i data-lucide="calendar-check" class="inline-block -mt-1 mr-2"></i>Generar/Verificar Clases (Hoy/Ma√±ana)
        </button>
      </div>

      <div class="space-y-8">
        <section aria-labelledby="hoy-title">
          <h2 id="hoy-title" class="text-2xl font-bold mb-4 text-emerald-400 border-b border-zinc-700 pb-2">Clases de Hoy</h2>
          <div id="today-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
        </section>
        <section aria-labelledby="maniana-title">
          <h2 id="maniana-title" class="text-2xl font-bold mb-4 text-sky-400 border-b border-zinc-700 pb-2">Clases de Ma√±ana</h2>
          <div id="tomorrow-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
        </section>
      </div>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="reservas-title">
        <h2 id="reservas-title" class="text-2xl font-bold mb-4">Reservas del D√≠a</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div>
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Hoy</h3>
            <div id="today-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-sky-400 mb-3 border-b border-zinc-700 pb-2">Ma√±ana</h3>
            <div id="tomorrow-bookings-list" class="space-y-4 text-sm"></div>
          </div>
        </div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="asistencia-title">
        <h2 id="asistencia-title" class="text-2xl font-bold mb-2">Reporte de Asistencia y Proyecci√≥n</h2>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs text-zinc-400 mb-3 gap-2">
          <div class="flex items-center gap-4">
            <span id="att-last">√öltima actualizaci√≥n: ‚Äî</span>
            <span id="att-next">Pr√≥xima actualizaci√≥n en: ‚Äî</span>
          </div>
          <button id="att-refresh" class="inline-flex items-center gap-1 text-indigo-400 hover:text-indigo-300">
            <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Actualizar ahora
          </button>
        </div>
        <div class="flex flex-wrap items-center gap-2 mb-4 text-xs">
          <label for="att-start-date">Desde:</label>
          <input type="date" id="att-start-date" class="bg-zinc-700 text-white p-1 rounded-md" />
          <label for="att-end-date">Hasta:</label>
          <input type="date" id="att-end-date" class="bg-zinc-700 text-white p-1 rounded-md" />
        </div>
        <div class="relative">
          <canvas id="attendanceChart"></canvas>
        </div>
        <div id="attendance-details" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm"></div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="usuarios-title">
        <h2 id="usuarios-title" class="text-2xl font-bold mb-4">Gesti√≥n de Usuarios</h2>

        <div>
          <label for="user-email-input" class="block text-sm font-medium text-zinc-300 mb-2">Reinicio de Contrase√±a</label>
          <div class="flex gap-2">
            <input type="email" id="user-email-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md" placeholder="Correo del usuario">
            <button id="send-reset-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
          </div>
        </div>

        <hr class="border-zinc-700 my-6">

        <!-- Buscar por nombre/correo + listar -->
        <div>
          <label for="find-user-query-input" class="block text-sm font-medium text-zinc-300 mb-2">
            Buscar usuario (nombre o correo)
          </label>
          <div class="flex gap-2">
            <input type="text" id="find-user-query-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md"
                   placeholder="Ej: Valery, Erick o alguien@correo.com">
            <button id="find-user-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md">Buscar</button>
            <button id="list-users-btn" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-md">Listar</button>
          </div>

          <p id="user-results-hint" class="text-zinc-400 text-xs mt-2 hidden"></p>
          <div id="user-details-container" class="mt-4 hidden space-y-4"></div>
        </div>
      </section>
      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="notifs-title">
        <h2 id="notifs-title" class="text-2xl font-bold mb-4">√öltimas notificaciones</h2>
        <ul id="recent-notifs" class="space-y-2 text-sm"></ul>
      </section>
    </div>

    <div id="class-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-zinc-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4 max-h-screen overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title" class="text-2xl font-bold">Editar Clase</h2>
        <input type="hidden" id="class-id">
        <div class="border-b border-zinc-700">
          <nav class="flex space-x-4" aria-label="Tabs">
            <button id="tab-details" class="px-3 py-2 font-medium text-sm rounded-t-md" aria-selected="true">Detalles</button>
            <button id="tab-attendance" class="px-3 py-2 font-medium text-sm rounded-t-md hidden" aria-selected="false">Asistencia</button>
          </nav>
        </div>
        <div id="details-content">
          <input type="text" id="class-name" placeholder="Nombre de la clase" class="w-full bg-zinc-700 p-2 rounded mt-4">
          <input type="text" id="class-instructor" placeholder="Instructor" class="w-full bg-zinc-700 p-2 rounded mt-4">
          <div class="grid grid-cols-2 gap-4 mt-4">
            <input type="text" id="class-time" placeholder="Hora (ej. 18:00)" class="w-full bg-zinc-700 p-2 rounded">
            <input type="text" id="class-icon" placeholder="Emoji √çcono (üßò‚Äç‚ôÄÔ∏è)" class="w-full bg-zinc-700 p-2 rounded">
          </div>
          <textarea id="class-description" placeholder="Descripci√≥n" class="w-full bg-zinc-700 p-2 rounded h-24 mt-4"></textarea>
        </div>
        <div id="attendance-content" class="hidden">
          <div id="attendance-status-message" class="text-center text-zinc-400 p-4"></div>
          <div id="attendance-list" class="space-y-2"></div>
          <button id="save-attendance-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 hidden">Guardar Asistencia</button>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button id="delete-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded">Eliminar</button>
          <button id="cancel-button" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
          <button id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
      const AdminPanel = {
        db: null,
        auth: null,
        functions: null,
        state: {
          classes: [],
          bookingsMap: new Map(),
          weeklySchedule: {},
          recentNotifications: [],
          currentAttendance: {},
          attendanceChartInstance: null,
          unsubClasses: null,
          unsubBookings: [],
          unsubRecentNotifs: null,
          attendanceData: null,
          attendanceNextAt: 0,
          attendanceLastAt: 0,
          attendancePollTimer: null,
          attendanceTickTimer: null,
          userSearchResults: []
        },

        // --- Helpers ---
        timeFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', hour:'2-digit',minute:'2-digit',hour12:false }),
        dayFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', weekday:'long',day:'2-digit',month:'short' }),
        dayShortFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', day:'2-digit',month:'short' }),
        dateHelper: {
          ymd(date){ return new Intl.DateTimeFormat('en-CA',{ timeZone: 'America/Mexico_City', year:'numeric', month:'2-digit', day:'2-digit' }).format(date); },
          today(){ return this.ymd(new Date()); },
          tomorrow(){ return this.ymd(new Date(Date.now()+86400000)); },
          yesterday(){ return this.ymd(new Date(Date.now()-86400000)); }
        },
        normalizeStr(s=''){
          return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
        },

        // --- TOASTS ---
        showToast({ title='Hecho', message='', variant='success', timeout=3000 }){
          const color = variant==='error'?'rose': variant==='warn'?'amber':'emerald';
          const wrap = document.getElementById('toast-container');
          const el = document.createElement('div');
          el.className = 'toast max-w-md mx-auto bg-zinc-800 border border-zinc-700 rounded-xl p-4 shadow-lg flex items-start gap-3';
          const safeTitle = DOMPurify.sanitize(title);
          const safeMessage = DOMPurify.sanitize(message);
          el.innerHTML = `
            <div class="w-10 h-10 rounded-lg bg-${color}-500/20 text-${color}-300 flex items-center justify-center shrink-0">
              <i data-lucide="${variant==='error'?'alert-triangle':variant==='warn'?'alert-circle':'check'}" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
              <p class="font-semibold">${safeTitle}</p>
              ${safeMessage?`<p class="text-sm text-zinc-400 mt-0.5">${safeMessage}</p>`:''}
            </div>
            <button class="shrink-0 text-zinc-400 hover:text-zinc-200" aria-label="Cerrar notificaci√≥n">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>`;
          wrap.appendChild(el);
          lucide.createIcons({ attrs:{'aria-hidden':'true'} });
          const close = () => el.remove();
          el.querySelector('button').addEventListener('click', close);
          if (timeout) setTimeout(close, timeout);
        },

        // --- INIT / AUTH ---
        init(){
          const firebaseConfig = {
            apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
            authDomain: "madnessscheds.firebaseapp.com",
            projectId: "madnessscheds",
            storageBucket: "madnessscheds.firebasestorage.app",
            messagingSenderId: "788538690861",
            appId: "1:788538690861:web:ce19ead5929a8867c197a4"
          };
          firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.auth = firebase.auth();
          this.functions = firebase.app().functions('us-central1');

          // Top buttons
          document.getElementById('login-btn').onclick = () => this.login();
          document.getElementById('logout-btn').onclick = () => this.logout();
          document.getElementById('gen-classes-btn').onclick = () => this.generateDailyClasses();
          document.getElementById('send-reset-btn').onclick = () => this.sendPasswordReset();
          document.getElementById('att-refresh').onclick = () => this.fetchAttendanceData(true);

          const range = this.getDefaultAttendanceRange();
          const sEl = document.getElementById('att-start-date');
          const eEl = document.getElementById('att-end-date');
          if (sEl && eEl){
            sEl.value = range.start;
            eEl.value = range.end;
            sEl.addEventListener('change',()=>this.fetchAttendanceData(true));
            eEl.addEventListener('change',()=>this.fetchAttendanceData(true));
          }

          // Users: find + list
          document.getElementById('find-user-btn').onclick = () => this.findUsersByQuery();
          document.getElementById('list-users-btn').onclick = () => this.listUsersPage();

          this.auth.onAuthStateChanged(async (user) => {
            if (user) {
              const token = await user.getIdTokenResult();
              if (token.claims && token.claims.admin) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                try {
                  await this.loadWeeklyScheduleTemplate();
                  this.listenClassesTodayTomorrow();
                  this.startAttendancePolling();
                  this.listenRecentNotifications();
                } catch(e){
                  this.showToast({ title:'Error al iniciar', message:e.message, variant:'error' });
                }
              } else {
                this.logout();
                this.showToast({ title:'Acceso denegado', message:'Tu cuenta no tiene rol de admin', variant:'error' });
              }
            } else {
              document.getElementById('login-screen').classList.remove('hidden');
              document.getElementById('admin-panel').classList.add('hidden');
              this.teardownBookingsListeners();
              if (this.state.unsubClasses) this.state.unsubClasses();
              this.stopAttendancePolling();
              if (this.state.unsubRecentNotifs) this.state.unsubRecentNotifs();
              this.state.recentNotifications = [];
              this.renderRecentNotifications();
            }
          });

          lucide.createIcons();
        },

        async loadWeeklyScheduleTemplate(){
          const snap = await this.db.collection('schedule_template').get();
          if (snap.empty) throw new Error('No existe la plantilla de horario.');
          snap.forEach(doc => { this.state.weeklySchedule[doc.id] = doc.data().classes || []; });
        },

        // --- LISTENERS (ayer/hoy/ma√±ana) ---
        listenClassesTodayTomorrow(){
          const yesterday = this.dateHelper.yesterday();
          const today = this.dateHelper.today();
          const tomorrow = this.dateHelper.tomorrow();

          if (this.state.unsubClasses) this.state.unsubClasses();
          this.state.unsubClasses = this.db.collection('classes')
            .where('classDate', 'in', [yesterday, today, tomorrow])
            .orderBy('classDate','asc').orderBy('time','asc')
            .onSnapshot((snap)=>{
              this.state.classes = snap.docs.map(d=>{
                const data = { id:d.id, ...d.data() };
                if (data.classDate && data.time){
                  const start = new Date(`${data.classDate}T${data.time}:00Z`);
                  data.localDate = this.dateHelper.ymd(start);
                  data.localTime = this.timeFmt.format(start);
                }
                return data;
              });
              this.mountBookingsListenersForVisibleClasses();
              this.renderAll();
              this.renderAttendanceChartFromCache();
            }, err=>{
              console.error(err);
              this.showToast({ title:'Error listando clases', message: err.message, variant:'error' });
            });
        },

        teardownBookingsListeners(){
          this.state.unsubBookings.forEach(fn=>{ try{ fn&&fn(); }catch{} });
          this.state.unsubBookings = [];
          this.state.bookingsMap.clear();
        },

        mountBookingsListenersForVisibleClasses(){
          this.teardownBookingsListeners();
          const classIds = this.state.classes.map(c=>c.id);
          for (let i=0;i<classIds.length;i+=10){
            const batch = classIds.slice(i,i+10);
            const unsub = this.db.collection('bookings')
              .where('classId','in',batch)
              .onSnapshot((snap)=>{
                batch.forEach(cid => this.state.bookingsMap.delete(cid));
                snap.docs.forEach(doc=>{
                  const b = doc.data();
                  const arr = this.state.bookingsMap.get(b.classId) || [];
                  arr.push({ id:doc.id, ...b });
                  this.state.bookingsMap.set(b.classId, arr);
                });
                this.renderAll();
                this.renderAttendanceChartFromCache();
              });
            this.state.unsubBookings.push(unsub);
          }
        },

        // --- NOTIFICATIONS ---
        listenRecentNotifications(){
          if (this.state.unsubRecentNotifs) this.state.unsubRecentNotifs();
          this.state.unsubRecentNotifs = this.db.collection('notifications')
            .orderBy('sentAt','desc').limit(10)
            .onSnapshot((snap)=>{
              this.state.recentNotifications = snap.docs.map(d=>({ id:d.id, ...d.data() }));
              this.renderRecentNotifications();
            }, err=>{
              console.error(err);
              this.showToast({ title:'Error cargando notificaciones', message:err.message, variant:'error' });
            });
        },

        renderRecentNotifications(){
          const list = document.getElementById('recent-notifs');
          if (!list) return;
          list.innerHTML = this.state.recentNotifications.map(n=>{
            const sent = n.sentAt?.toDate ? n.sentAt.toDate() : null;
            const when = sent ? `${this.dayShortFmt.format(sent)} ${this.timeFmt.format(sent)}` : '‚Äî';
            const safeWhen = DOMPurify.sanitize(when);
            const safeClass = DOMPurify.sanitize(n.classId || '');
            const safeUser = DOMPurify.sanitize(n.userId || '');
            const safeInterval = DOMPurify.sanitize(n.interval || '');
            return `<li>${safeWhen} - ${safeClass} - ${safeUser} - ${safeInterval}</li>`;
          }).join('') || '<li class="text-zinc-500">No hay notificaciones.</li>';
        },

        // --- GENERACI√ìN (startAt/endAt) ---
        _buildStartEnd(dateStr, timeStr, duration=60){
          const start = new Date(`${dateStr}T${timeStr}:00-06:00`);
          const end = new Date(start.getTime() + (Number(duration||60)*60000));
          return {
            startAt: firebase.firestore.Timestamp.fromDate(start),
            endAt: firebase.firestore.Timestamp.fromDate(end),
            classDate: start.toISOString().slice(0,10),
            timeUTC: start.toISOString().slice(11,16)
          };
        },

        async generateDailyClasses(){
          if (!Object.keys(this.state.weeklySchedule).length) {
            this.showToast({ title:'Plantilla no cargada', variant:'warn' });
            return;
          }
          const today = new Date();
          const tomorrow = new Date(); tomorrow.setDate(today.getDate()+1);
          const days = [
            { dateStr: this.dateHelper.ymd(today), dow: today.getDay() },
            { dateStr: this.dateHelper.ymd(tomorrow), dow: tomorrow.getDay() }
          ];
          const batch = this.db.batch();
          let created = 0;
          const createdList = [];

          for (const d of days){
            const tpl = this.state.weeklySchedule[String(d.dow)] || [];
            if (!tpl.length) continue;
            const existingSnap = await this.db.collection('classes').where('classDate','==',d.dateStr).get();
            const existingTimes = new Set(existingSnap.docs.map(x=> this.timeFmt.format(new Date(`${d.dateStr}T${x.data().time}:00Z`)) ));
            for (const c of tpl){
              if (!existingTimes.has(c.time)){
                const ref = this.db.collection('classes').doc();
                const { startAt, endAt, classDate, timeUTC } = this._buildStartEnd(d.dateStr, c.time, c.duration||60);
                const isTRX = /trx/i.test(c.name || "");
                const capacity = (typeof c.capacity === "number") ? c.capacity : (isTRX ? 13 : 15);
                batch.set(ref,{
                  name: c.name,
                  time: timeUTC,
                  instructor: c.instructor || 'Por Asignar',
                  duration: c.duration || 60,
                  classDate,
                  capacity,
                  enrolledCount: 0,
                  startAt,
                  endAt,
                  description:`Clase de ${c.name}`,
                  icon:'üí™',
                  image:`https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(c.name)}`
                });
                createdList.push({ date: d.dateStr, time: c.time, name: c.name });
                created++;
              }
            }
          }

          if (created>0){
            await batch.commit();
            console.log('Clases generadas:', createdList);
            this.showToast({ title:'Clases generadas', message:`Se crearon ${created} clases` });
          } else {
            this.showToast({ title:'Horario al d√≠a', message:'No hay clases nuevas por crear', variant:'warn' });
          }
        },

        // --- RENDER ---
        renderAll(){ this.renderClassCards(); this.renderDailyBookings(); },

        isClassRunningNow(cls){
          if (!cls || !cls.classDate || !cls.time) return false;
          const todayStr = this.dateHelper.today();
          if (cls.localDate !== todayStr) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00Z`).getTime();
          const end   = start + (Number(cls.duration||60)*60000);
          const now = Date.now();
          return now>=start && now<=end;
        },

        renderClassCards(){
          const todayC = document.getElementById('today-classes-container');
          const tomorrowC = document.getElementById('tomorrow-classes-container');
          todayC.innerHTML=''; tomorrowC.innerHTML='';

          const sorted = [...this.state.classes].sort((a,b)=>{
            const sa = new Date(`${a.classDate}T${a.time}:00Z`).getTime();
            const sb = new Date(`${b.classDate}T${b.time}:00Z`).getTime();
            return sa - sb;
          });
          for (const cls of sorted){
            const isRunning = this.isClassRunningNow(cls);
            const style = isRunning ? 'bg-emerald-900 border border-emerald-600' : 'bg-zinc-800';
            const enrolled = Number(cls.enrolledCount||0);
            const capacity = Number(cls.capacity||0);
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg shadow-md cursor-pointer hover:bg-zinc-700 transition-colors ${style}`;
            card.setAttribute('role','button');
            const safeName = DOMPurify.sanitize(cls.name || '');
            const safeInstructor = DOMPurify.sanitize(cls.instructor || '');
            const safeIcon = DOMPurify.sanitize(cls.icon || 'üí™');
            const safeTime = DOMPurify.sanitize(cls.localTime || cls.time || '');
            card.setAttribute('aria-label', `Editar ${safeName} a las ${safeTime}`);
            card.onclick = () => this.showClassModal(cls);
            card.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-xl font-bold">${safeName}</p>
                  <p class="text-sm text-zinc-400">${safeInstructor}</p>
                </div>
                <span class="text-2xl">${safeIcon}</span>
              </div>
              <div class="mt-4 flex justify-between items-center text-sm">
                <span class="font-semibold">a las ${safeTime}</span>
                <span class="font-bold ${enrolled>=capacity?'text-rose-400':'text-white'}">${enrolled} / ${capacity}</span>
              </div>`;
            if (cls.localDate === this.dateHelper.today()) todayC.appendChild(card);
            else if (cls.localDate === this.dateHelper.tomorrow()) tomorrowC.appendChild(card);
          }
          if (!todayC.children.length) todayC.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para hoy.</p>';
          if (!tomorrowC.children.length) tomorrowC.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para ma√±ana.</p>';
        },

        renderDailyBookings(){
          const todayList = document.getElementById('today-bookings-list');
          const tomList = document.getElementById('tomorrow-bookings-list');
          todayList.innerHTML=''; tomList.innerHTML='';

          const byDate = { [this.dateHelper.today()]:[], [this.dateHelper.tomorrow()]:[] };
          this.state.classes.forEach(c=>{ if(byDate[c.localDate]) byDate[c.localDate].push(c); });

          const buildHTML = (classesArr)=>{
            const blocks = classesArr.map(cls=>{
              const attendees = (this.state.bookingsMap.get(cls.id)||[]).map(b=>b.userName||'An√≥nimo');
              const enrolled = Number(cls.enrolledCount||0);
              const cap = Number(cls.capacity||0);
              const names = attendees.map(n=>`<li class="text-zinc-400 ml-4">- ${DOMPurify.sanitize(n)}</li>`).join('');
              const safeTime = DOMPurify.sanitize(cls.localTime || cls.time || '');
              const safeName = DOMPurify.sanitize(cls.name || '');
              return `
                <div class="mb-3">
                  <p class="font-bold">${safeTime} - ${safeName} (${enrolled} de ${cap})</p>
                  <ul class="list-none">${names}</ul>
                </div>`;
            });
            return blocks.join('') || '<p class="text-zinc-500">No hay reservas.</p>';
          };
          todayList.innerHTML = buildHTML(byDate[this.dateHelper.today()]);
          tomList.innerHTML   = buildHTML(byDate[this.dateHelper.tomorrow()]);
        },

        // ====== ASISTENCIA (POLLING CADA 15 MIN) ======
        getDefaultAttendanceRange(){
          const end = new Date();
          end.setDate(end.getDate()+1);
          const start = new Date(end);
          start.setDate(start.getDate()-3);
          return { start: this.dateHelper.ymd(start), end: this.dateHelper.ymd(end) };
        },
        getSelectedAttendanceRange(){
          const def = this.getDefaultAttendanceRange();
          const sEl = document.getElementById('att-start-date');
          const eEl = document.getElementById('att-end-date');
          let start = sEl?.value;
          let end = eEl?.value;
          if (!start || !end || start > end){
            start = def.start;
            end = def.end;
            if (sEl) sEl.value = start;
            if (eEl) eEl.value = end;
          }
          return { start, end };
        },

        startAttendancePolling(){
          this.fetchAttendanceData(true);
          this.stopAttendancePolling();
          this.state.attendancePollTimer = setInterval(()=>{ this.fetchAttendanceData(true); }, 15*60*1000);
          this.state.attendanceTickTimer = setInterval(()=>{ this.updateAttendanceLegend(); }, 1000);
        },
        stopAttendancePolling(){
          if (this.state.attendancePollTimer){ clearInterval(this.state.attendancePollTimer); this.state.attendancePollTimer=null; }
          if (this.state.attendanceTickTimer){ clearInterval(this.state.attendanceTickTimer); this.state.attendanceTickTimer=null; }
        },

        async fetchAttendanceData(force=false){
          const now = Date.now();
          if (!force && this.state.attendanceNextAt && now < this.state.attendanceNextAt) return;
          const { start, end } = this.getSelectedAttendanceRange();
          const report = {};
          const labels = [];
          const startDate = new Date(start);
          const endDate = new Date(end);
          for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate()+1)){
            const d = this.dateHelper.ymd(dt);
            // initializer (merged)
            report[d] = { attended:0, absent:0, booked:0, details:{ attended:{}, absent:{}, booked:{} } };
            labels.push({ date:d, label:this.dayShortFmt.format(new Date(dt)) });
          }
          try {
            const snap = await this.db.collection('attendance')
              .where('classDate','>=',start)
              .where('classDate','<=',end)
              .get();
            snap.forEach(doc=>{
              const r = doc.data();
              if (!report[r.classDate]) return;
              const cat = r.status==='attended' ? 'attended' : 'absent';
              report[r.classDate][cat]++;
              const key = `${r.className}`;
              if (!report[r.classDate].details[cat][key]) report[r.classDate].details[cat][key] = [];
              report[r.classDate].details[cat][key].push(r.userName);
            });

            // compute booked for today/tomorrow (merged)
            const todayStr = this.dateHelper.today();
            const tomorrowStr = this.dateHelper.tomorrow();

            if (report[todayStr]){
              let booked = 0; const det = {};
              this.state.classes.filter(c=>c.classDate===todayStr).forEach(c=>{
                const arr = this.state.bookingsMap.get(c.id)||[];
                if (arr.length){
                  booked += arr.length;
                  const label = `${c.time} - ${c.name}`;
                  det[label] = arr.map(x=>x.userName||'An√≥nimo');
                }
              });
              report[todayStr].booked = booked;
              report[todayStr].details.booked = det;
            }

            if (report[tomorrowStr]){
              let booked = 0; const det = {};
              this.state.classes.filter(c=>c.classDate===tomorrowStr).forEach(c=>{
                const arr = this.state.bookingsMap.get(c.id)||[];
                if (arr.length){
                  booked += arr.length;
                  const label = `${c.time} - ${c.name}`;
                  det[label] = arr.map(x=>x.userName||'An√≥nimo');
                }
              });
              report[tomorrowStr].booked = booked;
              report[tomorrowStr].details.booked = det;
            }

            this.state.attendanceData = { report, labels };
            this.state.attendanceLastAt = now;
            this.state.attendanceNextAt = now + 15*60*1000;
            this.updateAttendanceLegend();
            this.renderAttendanceChartFromCache();
          } catch(e){ console.error('Error leyendo asistencia:', e); }
        },

        updateAttendanceLegend(){
          const lastEl = document.getElementById('att-last');
          const nextEl = document.getElementById('att-next');
          if (!lastEl || !nextEl) return;
          if (this.state.attendanceLastAt){
            const fmt = new Intl.DateTimeFormat('es-MX',{hour:'2-digit',minute:'2-digit'});
            lastEl.textContent = `√öltima actualizaci√≥n: ${fmt.format(new Date(this.state.attendanceLastAt))}`;
          } else lastEl.textContent = '√öltima actualizaci√≥n: ‚Äî';

          if (this.state.attendanceNextAt){
            const ms = Math.max(0, this.state.attendanceNextAt - Date.now());
            const mm = Math.floor(ms/60000);
            const ss = Math.floor((ms%60000)/1000);
            nextEl.textContent = `Pr√≥xima actualizaci√≥n en: ${mm}m ${String(ss).padStart(2,'0')}s`;
          } else nextEl.textContent = 'Pr√≥xima actualizaci√≥n en: ‚Äî';
        },

        renderAttendanceChartFromCache(){
          const ctx = document.getElementById('attendanceChart')?.getContext('2d');
          const details = document.getElementById('attendance-details');
          if (!ctx || !details) return;
          const dataCache = this.state.attendanceData;
          if (!dataCache){
            details.innerHTML = `<div class="bg-zinc-900 p-3 rounded-md text-zinc-400">Cargando reporte‚Ä¶ se actualizar√° autom√°ticamente.</div>`;
            return;
          }
          const { report, labels } = dataCache;
          const lbls = labels.map(l=>l.label);
          const attendedData = labels.map(l=>report[l.date].attended||0);
          const absentData   = labels.map(l=>report[l.date].absent||0);
          const bookedData   = labels.map(l=>report[l.date].booked||0);

          const includeBooked = bookedData.some(v => v > 0);
          const datasets = [
            { label:'Asistieron', data:attendedData, backgroundColor:'rgba(16,185,129,.6)' },
            { label:'Faltaron', data:absentData, backgroundColor:'rgba(244,63,94,.6)' }
          ];
          if (includeBooked){
            datasets.push({ label:'Reservaron', data:bookedData, backgroundColor:'rgba(59,130,246,.6)' });
          }

          if (this.state.attendanceChartInstance) this.state.attendanceChartInstance.destroy();
          this.state.attendanceChartInstance = new Chart(ctx,{
            type:'bar',
            data:{ labels: lbls, datasets },
            options:{
              scales:{
                y:{ beginAtZero:true, ticks:{ color:'#a1a1aa', stepSize:1 }, grid:{ color:'#3f3f46' } },
                x:{ ticks:{ color:'#a1a1aa', autoSkip:true, maxRotation:45 }, grid:{ color:'#3f3f46' } }
              },
              plugins:{ legend:{ labels:{ color:'#d4d4d8' } } }
            }
          });

          const renderList = (obj)=>{
            const names = Object.keys(obj||{}).sort();
            if (!names.length) return '<ul class="list-disc list-inside text-zinc-400"><li>Nadie</li></ul>';
            return names.map(n=>{
              const safeName = DOMPurify.sanitize(n);
              const people = (obj[n]||[]).map(p=>`<li>${DOMPurify.sanitize(p)}</li>`).join('');
              return `
              <div class="font-semibold text-zinc-300 mt-1">${safeName}:</div>
              <ul class="list-disc list-inside text-zinc-400">${people}</ul>
            `;}).join('');
          };

          const todayStr = this.dateHelper.today();
          const tomorrowStr = this.dateHelper.tomorrow();

          details.innerHTML = labels.map(l=>{
            const d = report[l.date];
            // Card header
            let html = `
              <div class="bg-zinc-900 p-3 rounded-md">
                <h4 class="font-bold text-lg mb-2">${DOMPurify.sanitize(l.label)}</h4>`;

            // Show booked for today/tomorrow if present
            if (d.booked && (l.date === todayStr || l.date === tomorrowStr)) {
              html += `
                <div class="font-semibold text-blue-400">Reservaron (${d.booked||0})</div>
                ${renderList(d.details.booked)}`;
            }

            html += `
                <div class="font-semibold text-emerald-400 mt-2">Asistieron (${d.attended||0})</div>
                ${renderList(d.details.attended)}
                <div class="font-semibold text-rose-400 mt-2">Faltaron (${d.absent||0})</div>
                ${renderList(d.details.absent)}
              </div>`;
            return html;
          }).join('');
        },

        // --- MODAL / Asistencia ---
        isClassInProgressWindow(cls){
          if (!cls || !cls.classDate || !cls.time) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00Z`).getTime();
          const now = Date.now();
          const lower = now - (15*60*60*1000);
          const upper = now + (30*60*1000);
          return (start>=lower) && (start<=upper);
        },

        showClassModal(cls){
          this.state.currentAttendance = {};
          document.getElementById('class-id').value = cls.id;
          document.getElementById('class-name').value = cls.name || '';
          document.getElementById('class-instructor').value = cls.instructor || '';
          document.getElementById('class-time').value = cls.localTime || cls.time || '';
          document.getElementById('class-icon').value = cls.icon || '';
          document.getElementById('class-description').value = cls.description || '';

          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          this.switchTab('details');
          tabD.onclick = () => this.switchTab('details');
          if (this.isClassInProgressWindow(cls)){
            tabA.classList.remove('hidden');
            tabA.onclick = () => this.switchTab('attendance');
            this.loadAttendeesForAttendance(cls);
          } else {
            tabA.classList.add('hidden'); tabA.onclick = null;
          }

          // Event handlers for modal buttons
          document.getElementById('delete-button').onclick = () => {
            if (confirm('¬øEst√°s seguro de eliminar esta clase?')) {
              this.deleteClass();
            }
          };
          document.getElementById('cancel-button').onclick = () => this.hideClassModal();
          document.getElementById('save-button').onclick = () => this.saveClass();

          const modal = document.getElementById('class-modal');
          modal.classList.remove('hidden');
          document.getElementById('save-button').focus();
        },

        hideClassModal(){ document.getElementById('class-modal').classList.add('hidden'); },

        switchTab(tab){
          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          const contD = document.getElementById('details-content');
          const contA = document.getElementById('attendance-content');
          if (tab==='details'){
            tabD.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','true');
            tabA.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','false');
            contD.classList.remove('hidden'); contA.classList.add('hidden');
          } else {
            tabA.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','true');
            tabD.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','false');
            contA.classList.remove('hidden'); contD.classList.add('hidden');
          }
        },

        async loadAttendeesForAttendance(cls){
          const list = document.getElementById('attendance-list');
          const msg  = document.getElementById('attendance-status-message');
          const save = document.getElementById('save-attendance-btn');

          const currentBookings = this.state.bookingsMap.get(cls.id) || [];
          const attSnap = await this.db.collection('attendance').where('classId','==',cls.id).get();
          const existing = {};
          attSnap.forEach(doc=>{ const d=doc.data(); existing[d.userId] = d.status; });

          this.state.currentAttendance = {};
          currentBookings.forEach(b=>{
            if (existing[b.userId]){
              this.state.currentAttendance[b.userId] = { status: existing[b.userId], userName: b.userName };
            }
          });

          if (!currentBookings.length){
            msg.textContent = 'No hay usuarios inscritos en esta clase.';
            list.innerHTML=''; save.classList.add('hidden');
            return;
          }

          msg.textContent = `${currentBookings.length} usuarios inscritos.`;
          list.innerHTML = currentBookings.map(b=>{
            const st = existing[b.userId];
            const selA = st==='attended' ? 'selected-attended':'';
            const selF = st==='absent'   ? 'selected-absent':'';
            const safeName = DOMPurify.sanitize(b.userName || 'An√≥nimo');
            const safeId = DOMPurify.sanitize(b.userId);
            return `
              <div class="flex items-center justify-between bg-zinc-900 p-2 rounded-md">
                <span class="text-zinc-300">${safeName}</span>
                <div class="space-x-2" data-user-id="${safeId}" data-user-name="${safeName}">
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selA}" data-status="attended">Asisti√≥</button>
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selF}" data-status="absent">Falt√≥</button>
                </div>
              </div>`;
          }).join('');

          save.classList.remove('hidden');
          list.onclick = (e)=>{
            const btn = e.target.closest('.attendance-btn'); if(!btn) return;
            const parent = btn.parentElement;
            const { userId, userName } = parent.dataset;
            const { status } = btn.dataset;
            this.state.currentAttendance[userId] = { status, userName };
            parent.querySelectorAll('.attendance-btn').forEach(x=>x.classList.remove('selected-attended','selected-absent'));
            btn.classList.add(status==='attended'?'selected-attended':'selected-absent');
          };
          save.onclick = () => this.saveAttendance(cls);
        },

        async saveAttendance(cls){
          const data = this.state.currentAttendance;
          if (!Object.keys(data).length){
            this.showToast({ title:'Sin cambios', message:'No marcaste asistencia', variant:'warn' });
            return;
          }
          const batch = this.db.batch();
          Object.keys(data).forEach(uid=>{
            const rec = data[uid];
            const ref = this.db.collection('attendance').doc(`${cls.classDate}_${cls.id}_${uid}`);
            batch.set(ref,{
              classId: cls.id, className: cls.name, classDate: cls.classDate,
              userId: uid, userName: rec.userName, status: rec.status, recordedAt: new Date()
            },{ merge:true });
          });
          try{
            await batch.commit();
            this.showToast({ title:'Asistencia guardada' });
            this.fetchAttendanceData(true);
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'Error al guardar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Password reset ----
        async sendPasswordReset(){
          const input = document.getElementById('user-email-input');
          const email = input.value.trim();
          if (!email){ this.showToast({ title:'Falta correo', variant:'warn' }); return; }
          try{
            await this.auth.sendPasswordResetEmail(email);
            this.showToast({ title:'Correo enviado', message:`Revisa ${email}` });
            input.value='';
          }catch(e){
            this.showToast({ title:'No se pudo enviar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Buscar por nombre o correo ----
        async findUsersByQuery(){
          const input = document.getElementById('find-user-query-input');
          const raw = (input.value||'').trim();
          const q = this.normalizeStr(raw);
          const container = document.getElementById('user-details-container');
          const hint = document.getElementById('user-results-hint');

          container.innerHTML=''; container.classList.add('hidden'); hint.classList.add('hidden');
          if (!raw){ this.showToast({ title:'Falta texto de b√∫squeda', variant:'warn' }); return; }

          try{
            const results = [];

            if (raw.includes('@')) {
              // correo exacto
              const snap = await this.db.collection('users').where('emailLower','==',q).limit(10).get();
              snap.forEach(d=>results.push(d));
              if (!results.length){
                const snap2 = await this.db.collection('users').where('email','==',raw).limit(10).get();
                snap2.forEach(d=>results.push(d));
              }
            } else {
              // nombre (prefijo, si existe √≠ndice) o fallback local
              let triedPrefix=false;
              try{
                const start=q, end=q+'\uf8ff';
                const byName = await this.db.collection('users').orderBy('displayNameLower').startAt(start).endAt(end).limit(20).get();
                byName.forEach(d=>results.push(d));
                triedPrefix=true;
              }catch(_){ /* falta √≠ndice */ }

              if (!results.length){
                const page = await this.db.collection('users').limit(300).get();
                page.forEach(d=>{
                  const data=d.data()||{};
                  const emailL=this.normalizeStr(data.email||'');
                  const nameL=this.normalizeStr(data.displayName||'');
                  if (emailL.includes(q) || nameL.includes(q)) results.push(d);
                });
                if (!triedPrefix && results.length){
                  hint.textContent='Resultado por b√∫squeda local (sin √≠ndice). Considera guardar displayNameLower y crear √≠ndice.';
                  hint.classList.remove('hidden');
                }
              }
            }

            if (!results.length){
              this.showToast({ title:'Sin resultados', message:`No encontramos "${raw}"`, variant:'warn' });
              return;
            }

            this.state.userSearchResults = results;
            container.innerHTML = results.map((doc, idx)=> this.userCardHTML(doc, idx)).join('');
            container.classList.remove('hidden');
            this.wireUserCardButtons();
          }catch(e){
            this.showToast({ title:'Error al buscar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Listar primera p√°gina ----
        async listUsersPage(){
          const container = document.getElementById('user-details-container');
          const hint = document.getElementById('user-results-hint');
          container.innerHTML='';
          container.classList.add('hidden');
          hint.classList.add('hidden');

          try{
            const snap = await this.db.collection('users').get();
            if (snap.empty){
              this.showToast({ title:'Sin usuarios', variant:'warn' });
              return;
            }

            container.innerHTML = snap.docs.map(doc => {
              const data = doc.data() || {};
              const safeName = DOMPurify.sanitize(data.displayName || 'Usuario sin nombre');
              const safeEmail = DOMPurify.sanitize(data.email || '');
              return `
            <div class="p-4 bg-zinc-700/50 rounded-lg">
              <h4 class="font-bold">${safeName}</h4>
              <p class="text-sm text-zinc-400">${safeEmail}</p>
            </div>`;
            }).join('');
            container.classList.remove('hidden');
            hint.textContent = `Mostrando ${snap.size} usuarios.`;
            hint.classList.remove('hidden');
          }catch(e){
            this.showToast({ title:'Error listando', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Render tarjeta + cableado ----
        userCardHTML(userDoc, indexBase=0){
          const userData = userDoc.data() || {};
          const tokens = userData.fcmTokens ? Object.keys(userData.fcmTokens) : [];
          const safeName = DOMPurify.sanitize(userData.displayName || 'Usuario sin nombre');
          const safeEmail = DOMPurify.sanitize(userData.email || '');
          const head = `
            <div class="p-4 bg-zinc-700/50 rounded-lg">
              <h4 class="font-bold">${safeName}</h4>
              <p class="text-sm text-zinc-400">${safeEmail}</p>
          `;
          if (!tokens.length){
            return head + `<p class="text-sm text-zinc-400 mt-3">Sin dispositivos registrados.</p></div>`;
          }
          const bodies = tokens.map((token,i)=>{
            const safeToken = DOMPurify.sanitize(token);
            const displayToken = DOMPurify.sanitize(safeToken.substring(0,30));
            const safeUid = DOMPurify.sanitize(userDoc.id);
            return `
            <div class="token-row p-3 bg-zinc-900 rounded-lg border border-zinc-700 mt-3">
              <p class="text-xs text-zinc-400 font-mono break-all">Dispositivo ${i+1}: ${displayToken}...</p>
              <div class="mt-3 space-y-2">
                <input type="text" id="noti-title-${indexBase}_${i}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm" placeholder="T√≠tulo de la notificaci√≥n">
                <textarea id="noti-body-${indexBase}_${i}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm h-16" placeholder="Cuerpo del mensaje"></textarea>
                <div class="flex gap-2">
                  <button data-token="${safeToken}" data-index="${indexBase}_${i}" data-uid="${safeUid}"
                          class="send-noti-btn flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md text-sm">
                    Enviar a este Dispositivo
                  </button>
                  <button data-token="${safeToken}" data-uid="${safeUid}"
                          class="prune-token-btn px-3 bg-zinc-700 hover:bg-zinc-600 text-white font-semibold rounded-md text-sm">
                    Prune
                  </button>
                </div>
              </div>
            </div>
          `;}).join('');
          return head + `<div class="mt-4 space-y-3">${bodies}</div></div>`;
        },

        wireUserCardButtons(){
          document.querySelectorAll('.send-noti-btn').forEach(btn=>{
            btn.onclick = (event)=> this.sendDirectNotification(event);
          });
          document.querySelectorAll('.prune-token-btn').forEach(btn=>{
            btn.onclick = (event)=> this.pruneTokenManually(event);
          });
        },

        // ---- USERS: Env√≠o + AUTOPRUNE ----
        async sendDirectNotification(event){
          const btn = event.target;
          const { token, index, uid } = btn.dataset;
          const title = document.getElementById(`noti-title-${index}`)?.value.trim();
          const body  = document.getElementById(`noti-body-${index}`)?.value.trim();

          if (!title || !body){
            this.showToast({ title:'Faltan datos', message:'El t√≠tulo y el cuerpo son requeridos.', variant:'warn' });
            return;
          }

          btn.disabled = true;
          btn.textContent = 'Enviando...';

          try{
            if (this.auth.currentUser) await this.auth.currentUser.getIdToken(true);
            const send = this.functions.httpsCallable('sendDirectNotification');
            const result = await send({ token, title, body });

            if (result.data?.success){
              this.showToast({ title:'Notificaci√≥n enviada', message:'Dispositivo notificado ‚úÖ' });
            } else {
              throw new Error(result.data?.error || 'El servidor devolvi√≥ un error.');
            }
          }catch(e){
            const msg = String(e?.message || e);
            this.showToast({ title:'Error al enviar', message: msg, variant:'error' });

            // Heur√≠stica de token inv√°lido/no registrado
            const looksInvalid = /not[-\s]?registered|unregistered|invalid[-\s]?registration|registration[-\s]?token|mismatch/i.test(msg);
            if (looksInvalid && uid && token){
              const ok = confirm('Este token parece inv√°lido. ¬øQuieres eliminarlo del perfil del usuario?');
              if (ok){
                try{
                  await this.db.collection('users').doc(uid).set({
                    fcmTokens: { [token]: firebase.firestore.FieldValue.delete() }
                  }, { merge:true });
                  this.showToast({ title:'Token eliminado', message:'Se removi√≥ el token inv√°lido.' });
                }catch(pruneErr){
                  this.showToast({ title:'No se pudo eliminar token', message: pruneErr.message, variant:'error' });
                }
              }
            }
          }finally{
            btn.disabled = false;
            btn.textContent = 'Enviar a este Dispositivo';
          }
        },

        async pruneTokenManually(event){
          const btn = event.target;
          const { token, uid } = btn.dataset;
          if (!uid || !token) return;
          const ok = confirm('¬øEliminar este token del usuario?');
          if (!ok) return;
          btn.disabled = true;
          try{
            await this.db.collection('users').doc(uid).set({
              fcmTokens: { [token]: firebase.firestore.FieldValue.delete() }
            }, { merge:true });
            this.showToast({ title:'Token eliminado' });
            const freshDoc = await this.db.collection('users').doc(uid).get();
            const idx = this.state.userSearchResults.findIndex(d=>d.id===uid);
            if (idx !== -1) this.state.userSearchResults[idx] = freshDoc;
            const card = btn.closest('.p-4');
            if (card){
              card.outerHTML = this.userCardHTML(freshDoc, idx === -1 ? 0 : idx);
              this.wireUserCardButtons();
            }
          }catch(e){
            this.showToast({ title:'No se pudo eliminar', message:e.message, variant:'error' });
          }finally{
            btn.disabled = false;
          }
        },

        // ---- AUTH ----
        login() {
            // 1. Get the Turnstile token from the widget
            const turnstileToken = turnstile.getResponse();

            const email = document.getElementById('email-input').value.trim();
            const pass  = document.getElementById('password-input').value;
            const errEl = document.getElementById('error-message');
            errEl.classList.add('hidden');

            // 2. Check if the token exists
            if (!turnstileToken) {
                errEl.textContent = 'Por favor, completa la verificaci√≥n de seguridad.';
                errEl.classList.remove('hidden');
                return; // Stop the login attempt if no token
            }

            // 3. If token exists, proceed with Firebase auth
            this.auth.signInWithEmailAndPassword(email, pass).catch(err => {
                errEl.textContent = 'Error: ' + err.message;
                errEl.classList.remove('hidden');
                // Reset the widget if login fails so the user can try again
                turnstile.reset();
            });
        },
        logout(){ this.auth.signOut(); this.showToast({ title:'Sesi√≥n cerrada' }); },

        // ---- CRUD Clase ----
        async saveClass(){
          const id = document.getElementById('class-id').value; if(!id) return;
          const data = {
            name: document.getElementById('class-name').value,
            instructor: document.getElementById('class-instructor').value,
            time: document.getElementById('class-time').value,
            icon: document.getElementById('class-icon').value,
            description: document.getElementById('class-description').value,
          };
          try{
            const cls = this.state.classes.find(c=>c.id===id);
            if (cls && data.time && data.time !== (cls.localTime || cls.time)){
              const start = new Date(`${cls.localDate||cls.classDate}T${data.time}:00-06:00`);
              const end = new Date(start.getTime() + (Number(cls.duration||60)*60000));
              data.startAt = firebase.firestore.Timestamp.fromDate(start);
              data.endAt = firebase.firestore.Timestamp.fromDate(end);
              data.classDate = start.toISOString().slice(0,10);
              data.time = start.toISOString().slice(11,16);
            }
            await this.db.collection('classes').doc(id).set(data,{ merge:true });
            this.showToast({ title:'Clase actualizada' });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'No se guard√≥', message:e.message, variant:'error' });
          }
        },

        async deleteClass(){
          const id = document.getElementById('class-id').value; if(!id) return;
          try{
            const snap = await this.db.collection('bookings').where('classId','==',id).get();
            const batch = this.db.batch();
            snap.forEach(doc=>batch.delete(doc.ref));
            await batch.commit();
            await this.db.collection('classes').doc(id).delete();
            this.showToast({ title:'Clase eliminada', message:`Se borraron ${snap.size} reservas` });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'No se pudo eliminar', message:e.message, variant:'error' });
          }
        },
      };

      AdminPanel.init();
    </script>
  </body>
</html>
