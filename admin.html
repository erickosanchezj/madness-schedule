<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Madness - Panel de Administrador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      :focus-visible { outline: 2px solid #818cf8; outline-offset: 2px; border-radius: .5rem; }
      .attendance-btn.selected-attended { background-color: #10b981; color: white; }
      .attendance-btn.selected-absent { background-color: #f43f5e; color: white; }
      #toast-container { pointer-events: none; }
      .toast { pointer-events: auto; }
    </style>
  </head>
  <body class="bg-zinc-900 text-white">
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] space-y-2" aria-live="polite" aria-atomic="true"></div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-zinc-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
        <h1 class="text-2xl font-bold text-center mb-6">Acceso de Administrador</h1>
        <input type="email" id="email-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Correo de Admin" autocomplete="email">
        <input type="password" id="password-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Contrase√±a" autocomplete="current-password">
        <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md">Entrar</button>
        <p id="error-message" class="text-rose-400 text-center mt-4 hidden"></p>
      </div>
    </div>

    <div id="admin-panel" class="hidden p-4 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
        <button id="logout-btn" class="text-rose-400 hover:text-rose-300 font-semibold">Cerrar Sesi√≥n</button>
      </div>

      <div class="mb-6 flex flex-wrap gap-3">
        <button id="gen-classes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg">
          <i data-lucide="calendar-check" class="inline-block -mt-1 mr-2"></i>Generar/Verificar Clases (Hoy/Ma√±ana)
        </button>
        <span id="panel-hint" class="text-zinc-400 self-center text-sm">Las clases nuevas se crean con <code>enrolledCount: 0</code>.</span>
      </div>

      <div class="space-y-8">
        <section aria-labelledby="hoy-title">
          <h2 id="hoy-title" class="text-2xl font-bold mb-4 text-emerald-400 border-b border-zinc-700 pb-2">Clases de Hoy</h2>
          <div id="today-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
        </section>

        <section aria-labelledby="maniana-title">
          <h2 id="maniana-title" class="text-2xl font-bold mb-4 text-sky-400 border-b border-zinc-700 pb-2">Clases de Ma√±ana</h2>
          <div id="tomorrow-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
        </section>
      </div>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="reservas-title">
        <h2 id="reservas-title" class="text-2xl font-bold mb-4">Reservas del D√≠a</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div>
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Hoy</h3>
            <div id="today-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-sky-400 mb-3 border-b border-zinc-700 pb-2">Ma√±ana</h3>
            <div id="tomorrow-bookings-list" class="space-y-4 text-sm"></div>
          </div>
        </div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="asistencia-title">
        <h2 id="asistencia-title" class="text-2xl font-bold mb-2">Reporte de Asistencia y Proyecci√≥n</h2>
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs text-zinc-400 mb-3 gap-2">
          <div class="flex items-center gap-4">
            <span id="att-last">√öltima actualizaci√≥n: ‚Äî</span>
            <span id="att-next">Pr√≥xima actualizaci√≥n en: ‚Äî</span>
          </div>
          <button id="att-refresh" class="inline-flex items-center gap-1 text-indigo-400 hover:text-indigo-300">
            <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Actualizar ahora
          </button>
        </div>
        <div class="relative">
          <canvas id="attendanceChart"></canvas>
        </div>
        <div id="attendance-details" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm"></div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="usuarios-title">
        <h2 id="usuarios-title" class="text-2xl font-bold mb-4">Gesti√≥n de Usuarios</h2>

        <!-- Reset -->
        <div>
          <label for="user-email-input" class="block text-sm font-medium text-zinc-300 mb-2">Reinicio de Contrase√±a</label>
          <div class="flex gap-2">
            <input type="email" id="user-email-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md" placeholder="Correo del usuario">
            <button id="send-reset-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
          </div>
        </div>

        <hr class="border-zinc-700 my-6">

        <!-- Buscar por correo + enviar noti -->
        <div>
          <label for="find-user-email-input" class="block text-sm font-medium text-zinc-300 mb-2">Enviar Notificaci√≥n Directa</label>
          <div class="flex flex-wrap gap-2">
            <input type="email" id="find-user-email-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md" placeholder="Correo del usuario a notificar">
            <button id="find-user-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md">Buscar</button>
          </div>
          <div id="user-details-container" class="mt-4 hidden space-y-4"></div>
        </div>

        <hr class="border-zinc-700 my-6">

        <!-- NUEVO: Lista de usuarios -->
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-semibold">Lista de Usuarios</h3>
          <div class="flex gap-2">
            <input id="users-search-input" type="text" placeholder="Buscar nombre o correo" class="bg-zinc-700 text-white p-2 rounded-md text-sm w-56">
            <button id="list-users-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white font-semibold px-3 rounded-md text-sm">Listar</button>
          </div>
        </div>

        <div id="users-list" class="space-y-3"></div>

        <div class="flex justify-end gap-2 mt-3">
          <button id="users-prev-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white font-semibold px-3 py-2 rounded-md text-sm" disabled>Anterior</button>
          <button id="users-next-btn" class="bg-zinc-700 hover:bg-zinc-600 text-white font-semibold px-3 py-2 rounded-md text-sm" disabled>Siguiente</button>
        </div>
      </section>
    </div>

    <!-- Modal edici√≥n clase -->
    <div id="class-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-zinc-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4 max-h-screen overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title" class="text-2xl font-bold">Editar Clase</h2>
        <input type="hidden" id="class-id">
        <div class="border-b border-zinc-700">
          <nav class="flex space-x-4" aria-label="Tabs">
            <button id="tab-details" class="px-3 py-2 font-medium text-sm rounded-t-md" aria-selected="true">Detalles</button>
            <button id="tab-attendance" class="px-3 py-2 font-medium text-sm rounded-t-md hidden" aria-selected="false">Asistencia</button>
          </nav>
        </div>
        <div id="details-content">
          <input type="text" id="class-name" placeholder="Nombre de la clase" class="w-full bg-zinc-700 p-2 rounded mt-4">
          <input type="text" id="class-instructor" placeholder="Instructor" class="w-full bg-zinc-700 p-2 rounded mt-4">
          <div class="grid grid-cols-2 gap-4 mt-4">
            <input type="text" id="class-time" placeholder="Hora (ej. 18:00)" class="w-full bg-zinc-700 p-2 rounded">
            <input type="text" id="class-icon" placeholder="Emoji √çcono (üßò‚Äç‚ôÄÔ∏è)" class="w-full bg-zinc-700 p-2 rounded">
          </div>
          <textarea id="class-description" placeholder="Descripci√≥n" class="w-full bg-zinc-700 p-2 rounded h-24 mt-4"></textarea>
        </div>
        <div id="attendance-content" class="hidden">
          <div id="attendance-status-message" class="text-center text-zinc-400 p-4"></div>
          <div id="attendance-list" class="space-y-2"></div>
          <button id="save-attendance-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 hidden">Guardar Asistencia</button>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button id="delete-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded">Eliminar</button>
          <button id="cancel-button" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
          <button id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
      const AdminPanel = {
        db: null,
        auth: null,
        functions: null,
        state: {
          classes: [],
          bookingsMap: new Map(),
          weeklySchedule: {},
          currentAttendance: {},
          attendanceChartInstance: null,
          unsubClasses: null,
          unsubBookings: [],
          attendanceData: null,
          attendanceNextAt: 0,
          attendanceLastAt: 0,
          attendancePollTimer: null,
          attendanceTickTimer: null
        },

        // ===== Listado de usuarios (paginaci√≥n) =====
        usersPaging: {
          size: 20,
          stack: [],     // para volver atr√°s
          cursor: null,  // √∫ltimo doc de la p√°gina actual
          current: []    // docs actuales
        },

        timeFmt: new Intl.DateTimeFormat('es-MX', { hour: '2-digit', minute: '2-digit' }),
        dayFmt: new Intl.DateTimeFormat('es-MX', { weekday: 'long', day: '2-digit', month: 'short' }),
        dateHelper: {
          ymd(date) {
            const y = date.getFullYear(), m = String(date.getMonth()+1).padStart(2,'0'), d = String(date.getDate()).padStart(2,'0');
            return `${y}-${m}-${d}`;
          },
          today() { return this.ymd(new Date()); },
          tomorrow() { const t=new Date(); t.setDate(t.getDate()+1); return this.ymd(t); },
          yesterday() { const t=new Date(); t.setDate(t.getDate()-1); return this.ymd(t); }
        },

        showToast({ title='Hecho', message='', variant='success', timeout=3000 }) {
          const color = variant === 'error' ? 'rose' : variant === 'warn' ? 'amber' : 'emerald';
          const wrap = document.getElementById('toast-container');
          const el = document.createElement('div');
          el.className = 'toast max-w-md mx-auto bg-zinc-800 border border-zinc-700 rounded-xl p-4 shadow-lg flex items-start gap-3';
          el.innerHTML = `
            <div class="w-10 h-10 rounded-lg bg-${color}-500/20 text-${color}-300 flex items-center justify-center shrink-0">
              <i data-lucide="${variant==='error'?'alert-triangle':variant==='warn'?'alert-circle':'check'}" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
              <p class="font-semibold">${title}</p>
              ${message?`<p class="text-sm text-zinc-400 mt-0.5">${message}</p>`:''}
            </div>
            <button class="shrink-0 text-zinc-400 hover:text-zinc-200" aria-label="Cerrar notificaci√≥n">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>`;
          wrap.appendChild(el);
          lucide.createIcons({attrs:{'aria-hidden':'true'}});
          const close = () => el.remove();
          el.querySelector('button').addEventListener('click', close);
          if (timeout) setTimeout(close, timeout);
        },

        init() {
          const firebaseConfig = {
            apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
            authDomain: "madnessscheds.firebaseapp.com",
            projectId: "madnessscheds",
            storageBucket: "madnessscheds.firebasestorage.app",
            messagingSenderId: "788538690861",
            appId: "1:788538690861:web:ce19ead5929a8867c197a4"
          };
          firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.auth = firebase.auth();
          this.functions = firebase.app().functions('us-central1');

          document.getElementById('login-btn').onclick = () => this.login();
          document.getElementById('logout-btn').onclick = () => this.logout();
          document.getElementById('gen-classes-btn').onclick = () => this.generateDailyClasses();
          document.getElementById('send-reset-btn').onclick = () => this.sendPasswordReset();
          document.getElementById('find-user-btn').onclick = () => this.findUserByEmail();
          document.getElementById('delete-button').onclick = () => this.deleteClass();
          document.getElementById('cancel-button').onclick = () => this.hideClassModal();
          document.getElementById('save-button').onclick = () => this.saveClass();
          document.getElementById('att-refresh').onclick = () => this.fetchAttendanceData(true);

          // NUEVO: UI de usuarios
          this.attachUsersUI();

          this.auth.onAuthStateChanged(async (user) => {
            if (user) {
              const token = await user.getIdTokenResult();
              if (token.claims && token.claims.admin) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                try {
                  await this.loadWeeklyScheduleTemplate();
                  this.listenClassesTodayTomorrow();
                  this.startAttendancePolling();
                } catch (e) {
                  this.showToast({ title: 'Error al iniciar', message: e.message, variant: 'error' });
                }
              } else {
                this.logout();
                this.showToast({ title: 'Acceso denegado', message: 'Tu cuenta no tiene rol de admin', variant: 'error' });
              }
            } else {
              document.getElementById('login-screen').classList.remove('hidden');
              document.getElementById('admin-panel').classList.add('hidden');
              this.teardownBookingsListeners();
              if (this.state.unsubClasses) this.state.unsubClasses();
              this.stopAttendancePolling();
            }
          });
          lucide.createIcons();
        },

        // ===== Lista de usuarios =====
        attachUsersUI() {
          const btnList = document.getElementById('list-users-btn');
          const btnPrev = document.getElementById('users-prev-btn');
          const btnNext = document.getElementById('users-next-btn');
          const inputSearch = document.getElementById('users-search-input');
          if (!btnList || !btnPrev || !btnNext) return;

          btnList.onclick = () => this.loadUsersPage(true);
          btnNext.onclick = () => this.loadUsersPage(false);
          btnPrev.onclick = () => this.loadPrevUsersPage();
          inputSearch.onkeydown = (e) => { if (e.key === 'Enter') this.loadUsersPage(true); };
        },

        async loadUsersPage(reset = false) {
          const listEl = document.getElementById('users-list');
          const btnPrev = document.getElementById('users-prev-btn');
          const btnNext = document.getElementById('users-next-btn');
          const qText = (document.getElementById('users-search-input')?.value || '').trim().toLowerCase();

          btnPrev.disabled = true; btnNext.disabled = true;
          listEl.innerHTML = `<div class="bg-zinc-900 p-3 rounded-lg text-zinc-400">Cargando usuarios‚Ä¶</div>`;

          try {
            let query = this.db.collection('users');

            // B√∫squeda naive: si escribes, filtramos por email o displayName (prefijo) usando orderBy + startAt/endAt.
            if (qText) {
              // Intento 1: por email
              let snap = await query
                .orderBy('email')
                .startAt(qText)
                .endAt(qText + '\uf8ff')
                .limit(this.usersPaging.size)
                .get();

              // Si no hay resultados, intento por displayName
              if (snap.empty) {
                snap = await query
                  .orderBy('displayName')
                  .startAt(qText)
                  .endAt(qText + '\uf8ff')
                  .limit(this.usersPaging.size)
                  .get();
              }

              // Reinicia el stack de paginaci√≥n en modo b√∫squeda
              this.usersPaging.stack = [];
              this.usersPaging.cursor = snap.docs[snap.docs.length - 1] || null;
              this.usersPaging.current = snap.docs;
              this.renderUsersPage();
              btnPrev.disabled = true; // sin prev en b√∫squeda
              btnNext.disabled = !this.usersPaging.cursor; // si hay cursor, quiz√° hay m√°s (pero necesitaremos repetir la misma b√∫squeda con startAfter)
              // Para simplicidad, en b√∫squeda dejamos una sola p√°gina (mejor UX: ‚Äúcargar m√°s‚Äù con mismo filtro ‚Üí requiere m√°s l√≥gica).
            } else {
              // Listado normal por displayName, paginado
              if (reset) {
                this.usersPaging.stack = [];
                this.usersPaging.cursor = null;
              }

              let base = query.orderBy('displayName').limit(this.usersPaging.size);
              if (this.usersPaging.cursor) base = base.startAfter(this.usersPaging.cursor);
              const snap = await base.get();

              if (reset) this.usersPaging.stack = [];
              if (this.usersPaging.current.length) {
                // Apila el √∫ltimo de la p√°gina actual para poder volver
                const lastDoc = this.usersPaging.current[this.usersPaging.current.length - 1];
                if (lastDoc) this.usersPaging.stack.push(lastDoc);
              }
              this.usersPaging.current = snap.docs;
              this.usersPaging.cursor = snap.docs[snap.docs.length - 1] || null;

              this.renderUsersPage();
              btnPrev.disabled = this.usersPaging.stack.length === 0;
              btnNext.disabled = !this.usersPaging.cursor;
            }
          } catch (e) {
            listEl.innerHTML = `<div class="bg-zinc-900 p-3 rounded-lg text-rose-400">Error: ${e.message}</div>`;
          }
        },

        async loadPrevUsersPage() {
          const listEl = document.getElementById('users-list');
          const btnPrev = document.getElementById('users-prev-btn');
          const btnNext = document.getElementById('users-next-btn');

          btnPrev.disabled = true; btnNext.disabled = true;
          listEl.innerHTML = `<div class="bg-zinc-900 p-3 rounded-lg text-zinc-400">Cargando‚Ä¶</div>`;

          try {
            if (this.usersPaging.stack.length === 0) {
              this.renderUsersPage();
              btnPrev.disabled = true;
              btnNext.disabled = !this.usersPaging.cursor;
              return;
            }

            const backCursor = this.usersPaging.stack[this.usersPaging.stack.length - 2]; // el ‚Äú√∫ltimo de la p√°gina anterior‚Äù
            let base = this.db.collection('users').orderBy('displayName').limit(this.usersPaging.size);
            if (backCursor) base = base.startAfter(backCursor);
            const snap = await base.get();

            // Mueve el stack hacia atr√°s
            this.usersPaging.stack.pop();
            this.usersPaging.current = snap.docs;
            this.usersPaging.cursor = snap.docs[snap.docs.length - 1] || null;

            this.renderUsersPage();
            btnPrev.disabled = this.usersPaging.stack.length === 0;
            btnNext.disabled = !this.usersPaging.cursor;
          } catch (e) {
            listEl.innerHTML = `<div class="bg-zinc-900 p-3 rounded-lg text-rose-400">Error: ${e.message}</div>`;
          }
        },

        renderUsersPage() {
          const listEl = document.getElementById('users-list');
          if (!this.usersPaging.current.length) {
            listEl.innerHTML = `<div class="bg-zinc-900 p-3 rounded-lg text-zinc-400">No hay usuarios.</div>`;
            return;
          }
          listEl.innerHTML = this.usersPaging.current.map(doc => {
            const u = doc.data() || {};
            const tokens = u.fcmTokens ? Object.keys(u.fcmTokens) : [];
            const tokenBadges = tokens.length
              ? `<span class="text-xs bg-indigo-500/30 text-indigo-300 px-2 py-0.5 rounded">FCM: ${tokens.length}</span>`
              : `<span class="text-xs bg-zinc-600/40 text-zinc-300 px-2 py-0.5 rounded">Sin FCM</span>`;

            // Tarjeta con bot√≥n para ver detalle y enviar
            return `
              <div class="p-4 bg-zinc-900 rounded-lg border border-zinc-700">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="font-semibold">${u.displayName || u.email || 'Sin nombre'}</p>
                    <p class="text-sm text-zinc-400">${u.email || ''}</p>
                  </div>
                  <div class="flex items-center gap-2">
                    ${tokenBadges}
                    <button class="text-xs bg-zinc-700 hover:bg-zinc-600 px-2 py-1 rounded"
                            data-action="open-user-detail" data-user-id="${doc.id}">Ver</button>
                  </div>
                </div>
              </div>`;
          }).join('');
          // Wire botones "Ver"
          listEl.querySelectorAll('[data-action="open-user-detail"]').forEach(btn => {
            btn.onclick = async (e) => {
              const uid = e.currentTarget.dataset.userId;
              const userDoc = await this.db.collection('users').doc(uid).get();
              if (userDoc.exists) this.renderUserDetails(userDoc);
            };
          });
        },

        // ===== Clases y reservas =====
        async loadWeeklyScheduleTemplate() {
          const snap = await this.db.collection('schedule_template').get();
          if (snap.empty) throw new Error('No existe la plantilla de horario.');
          snap.forEach(doc => { this.state.weeklySchedule[doc.id] = doc.data().classes || []; });
        },

        listenClassesTodayTomorrow() {
          const yesterday = this.dateHelper.yesterday();
          const today = this.dateHelper.today();
          const tomorrow = this.dateHelper.tomorrow();
          if (this.state.unsubClasses) this.state.unsubClasses();
          this.state.unsubClasses = this.db.collection('classes')
            .where('classDate', 'in', [yesterday, today, tomorrow])
            .orderBy('classDate', 'asc').orderBy('time', 'asc')
            .onSnapshot((snap) => {
              this.state.classes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              this.mountBookingsListenersForVisibleClasses();
              this.renderAll();
              this.renderAttendanceChartFromCache();
            }, (err) => this.showToast({ title:'Error listando clases', message: err.message, variant:'error' }));
        },

        teardownBookingsListeners() {
          this.state.unsubBookings.forEach(fn => { try { fn && fn(); } catch {} });
          this.state.unsubBookings = [];
          this.state.bookingsMap.clear();
        },

        mountBookingsListenersForVisibleClasses() {
          this.teardownBookingsListeners();
          const classIds = this.state.classes.map(c => c.id);
          for (let i = 0; i < classIds.length; i += 10) {
            const batch = classIds.slice(i, i + 10);
            const unsub = this.db.collection('bookings').where('classId', 'in', batch).onSnapshot((snap) => {
              batch.forEach(cid => this.state.bookingsMap.delete(cid));
              snap.docs.forEach(doc => {
                const b = doc.data();
                const arr = this.state.bookingsMap.get(b.classId) || [];
                arr.push({ id: doc.id, ...b });
                this.state.bookingsMap.set(b.classId, arr);
              });
              this.renderAll();
              this.renderAttendanceChartFromCache();
            });
            this.state.unsubBookings.push(unsub);
          }
        },

        _buildStartEnd(dateStr, timeStr, duration = 60) {
          const start = new Date(`${dateStr}T${timeStr}:00`);
          const end = new Date(start.getTime() + (Number(duration||60) * 60000));
          return {
            startAt: firebase.firestore.Timestamp.fromDate(start),
            endAt: firebase.firestore.Timestamp.fromDate(end)
          };
        },

        async generateDailyClasses() {
          if (!Object.keys(this.state.weeklySchedule).length) {
            this.showToast({ title:'Plantilla no cargada', variant:'warn' }); return;
          }
          const today = new Date();
          const tomorrow = new Date(); tomorrow.setDate(today.getDate() + 1);
          const days = [
            { dateStr: this.dateHelper.ymd(today), dow: today.getDay() },
            { dateStr: this.dateHelper.ymd(tomorrow), dow: tomorrow.getDay() }
          ];
          const batch = this.db.batch(); let created = 0;
          for (const d of days) {
            const tpl = this.state.weeklySchedule[String(d.dow)] || [];
            if (!tpl.length) continue;
            const existingSnap = await this.db.collection('classes').where('classDate', '==', d.dateStr).get();
            const existingTimes = new Set(existingSnap.docs.map(x => x.data().time));
            for (const c of tpl) {
              if (!existingTimes.has(c.time)) {
                const ref = this.db.collection('classes').doc();
                const { startAt, endAt } = this._buildStartEnd(d.dateStr, c.time, c.duration || 60);
                const isTRX = /trx/i.test(c.name || "");
                const capacity = (typeof c.capacity === "number") ? c.capacity : (isTRX ? 13 : 15);
                batch.set(ref, {
                  name: c.name, time: c.time, instructor: c.instructor || 'Por Asignar',
                  duration: c.duration || 60, classDate: d.dateStr, capacity,
                  enrolledCount: 0, startAt, endAt, description: `Clase de ${c.name}`,
                  icon: 'üí™', image: `https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(c.name)}`
                });
                created++;
              }
            }
          }
          if (created > 0) {
            await batch.commit();
            this.showToast({ title:'Clases generadas', message:`Se crearon ${created} clases` });
          } else {
            this.showToast({ title:'Horario al d√≠a', message:'No hay clases nuevas por crear', variant:'warn' });
          }
        },

        renderAll() { this.renderClassCards(); this.renderDailyBookings(); },

        isClassRunningNow(cls) {
          if (!cls || !cls.classDate) return false;
          const todayStr = this.dateHelper.today();
          if (cls.classDate !== todayStr) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00`).getTime();
          const end = start + (Number(cls.duration || 60) * 60000);
          const now = Date.now();
          return now >= start && now <= end;
        },

        renderClassCards() {
          const todayC = document.getElementById('today-classes-container');
          const tomorrowC = document.getElementById('tomorrow-classes-container');
          todayC.innerHTML = ''; tomorrowC.innerHTML = '';
          const sorted = [...this.state.classes].sort((a,b)=>(a.classDate+a.time).localeCompare(b.classDate+b.time));
          for (const cls of sorted) {
            const isRunning = this.isClassRunningNow(cls);
            const style = isRunning ? 'bg-emerald-900 border border-emerald-600' : 'bg-zinc-800';
            const enrolled = Number(cls.enrolledCount || 0);
            const capacity = Number(cls.capacity || 0);
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg shadow-md cursor-pointer hover:bg-zinc-700 transition-colors ${style}`;
            card.setAttribute('role','button');
            card.setAttribute('aria-label',`Editar ${cls.name} a las ${cls.time}`);
            card.onclick = () => this.showClassModal(cls);
            card.innerHTML = `
              <div class="flex justify-between items-start">
                <div>
                  <p class="text-xl font-bold">${cls.name}</p>
                  <p class="text-sm text-zinc-400">${cls.instructor}</p>
                </div>
                <span class="text-2xl">${cls.icon || 'üí™'}</span>
              </div>
              <div class="mt-4 flex justify-between items-center text-sm">
                <span class="font-semibold">a las ${cls.time}</span>
                <span class="font-bold ${enrolled>=capacity?'text-rose-400':'text-white'}">${enrolled} / ${capacity}</span>
              </div>`;
            if (cls.classDate === this.dateHelper.today()) todayC.appendChild(card);
            else if (cls.classDate === this.dateHelper.tomorrow()) tomorrowC.appendChild(card);
          }
          if (!todayC.children.length) todayC.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para hoy.</p>';
          if (!tomorrowC.children.length) tomorrowC.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para ma√±ana.</p>';
        },

        renderDailyBookings() {
          const todayList = document.getElementById('today-bookings-list');
          const tomList = document.getElementById('tomorrow-bookings-list');
          todayList.innerHTML = ''; tomList.innerHTML = '';
          const byDate = { [this.dateHelper.today()]: [], [this.dateHelper.tomorrow()]: [] };
          this.state.classes.forEach(c => { if (byDate[c.classDate]) byDate[c.classDate].push(c); });
          const buildHTML = (classesArr) => {
            const blocks = classesArr.map(cls => {
              const attendees = (this.state.bookingsMap.get(cls.id) || []).map(b => b.userName || 'An√≥nimo');
              const enrolled = Number(cls.enrolledCount || 0);
              const cap = Number(cls.capacity || 0);
              const names = attendees.map(n => `<li class="text-zinc-400 ml-4">- ${n}</li>`).join('');
              return `
                <div class="mb-3">
                  <p class="font-bold">${cls.time} - ${cls.name} (${enrolled} de ${cap})</p>
                  <ul class="list-none">${names}</ul>
                </div>`;
            });
            return blocks.join('') || '<p class="text-zinc-500">No hay reservas.</p>';
          };
          todayList.innerHTML = buildHTML(byDate[this.dateHelper.today()]);
          tomList.innerHTML = buildHTML(byDate[this.dateHelper.tomorrow()]);
        },

        // ====== Asistencia ======
        getAttendanceDateMap() {
          const today = new Date();
          const d1 = new Date(); d1.setDate(today.getDate()-2);
          const d2 = new Date(); d2.setDate(today.getDate()-1);
          const d3 = today;
          const d4 = new Date(); d4.setDate(today.getDate()+1);
          const ymd = (dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
          return {
            dayBefore:{date: ymd(d1), label:'Hace 2 d√≠as'},
            yesterday:{date: ymd(d2), label:'Ayer'},
            today:{date: ymd(d3), label:'Hoy'},
            tomorrow:{date: ymd(d4), label:'Ma√±ana'}
          };
        },

        startAttendancePolling() {
          this.fetchAttendanceData(true);
          this.stopAttendancePolling();
          this.state.attendancePollTimer = setInterval(()=>{ this.fetchAttendanceData(true); }, 15*60*1000);
          this.state.attendanceTickTimer = setInterval(()=>{ this.updateAttendanceLegend(); }, 1000);
        },

        stopAttendancePolling() {
          if (this.state.attendancePollTimer) { clearInterval(this.state.attendancePollTimer); this.state.attendancePollTimer = null; }
          if (this.state.attendanceTickTimer) { clearInterval(this.state.attendanceTickTimer); this.state.attendanceTickTimer = null; }
        },

        async fetchAttendanceData(force=false) {
          const now = Date.now();
          if (!force && this.state.attendanceNextAt && now < this.state.attendanceNextAt) return;
          const dates = this.getAttendanceDateMap();
          const daysToRead = [dates.dayBefore.date, dates.yesterday.date, dates.today.date];
          try {
            const snap = await this.db.collection('attendance').where('classDate','in', daysToRead).get();
            const report = {};
            Object.values(dates).forEach(d => {
              report[d.date] = { attended:0, absent:0, booked:0, details:{attended:{}, absent:{}, booked:{}} };
            });
            snap.forEach(doc => {
              const r = doc.data();
              if (!report[r.classDate]) return;
              const cat = r.status === 'attended' ? 'attended' : 'absent';
              report[r.classDate][cat]++;
              const key = `${r.className}`;
              if (!report[r.classDate].details[cat][key]) report[r.classDate].details[cat][key] = [];
              report[r.classDate].details[cat][key].push(r.userName);
            });
            this.state.attendanceData = { report, dates };
            this.state.attendanceLastAt = now;
            this.state.attendanceNextAt = now + 15*60*1000;
            this.updateAttendanceLegend();
            this.renderAttendanceChartFromCache();
          } catch(e){ console.error('Error leyendo asistencia:', e); }
        },

        updateAttendanceLegend() {
          const lastEl = document.getElementById('att-last');
          const nextEl = document.getElementById('att-next');
          if (!lastEl || !nextEl) return;
          if (this.state.attendanceLastAt) {
            const fmt = new Intl.DateTimeFormat('es-MX',{hour:'2-digit', minute:'2-digit'});
            lastEl.textContent = `√öltima actualizaci√≥n: ${fmt.format(new Date(this.state.attendanceLastAt))}`;
          } else lastEl.textContent = '√öltima actualizaci√≥n: ‚Äî';
          if (this.state.attendanceNextAt) {
            const ms = Math.max(0, this.state.attendanceNextAt - Date.now());
            const mm = Math.floor(ms/60000), ss = Math.floor((ms%60000)/1000);
            nextEl.textContent = `Pr√≥xima actualizaci√≥n en: ${mm}m ${String(ss).padStart(2,'0')}s`;
          } else nextEl.textContent = 'Pr√≥xima actualizaci√≥n en: ‚Äî';
        },

        renderAttendanceChartFromCache() {
          const ctx = document.getElementById('attendanceChart')?.getContext('2d');
          const details = document.getElementById('attendance-details');
          if (!ctx || !details) return;
          const dataCache = this.state.attendanceData;
          if (!dataCache) {
            details.innerHTML = `<div class="bg-zinc-900 p-3 rounded-md text-zinc-400">Cargando reporte‚Ä¶ se actualizar√° autom√°ticamente.</div>`;
            return;
          }
          const {report, dates} = dataCache;
          const keys = ['dayBefore','yesterday','today','tomorrow'];
          const labels = keys.map(k => dates[k].label);

          // ‚ÄúReservas Ma√±ana‚Äù desde bookingsMap
          const classesTomorrow = this.state.classes.filter(c => c.classDate === dates.tomorrow.date);
          let bookedTomorrow = 0; const bookedDetails = {};
          classesTomorrow.forEach(c => {
            const arr = this.state.bookingsMap.get(c.id) || [];
            if (arr.length) {
              bookedTomorrow += arr.length;
              const label = `${c.time} - ${c.name}`;
              bookedDetails[label] = arr.map(x => x.userName || 'An√≥nimo');
            }
          });
          report[dates.tomorrow.date].booked = bookedTomorrow;
          report[dates.tomorrow.date].details.booked = bookedDetails;

          const attendedData = keys.map(k => report[dates[k].date].attended || 0);
          const absentData   = keys.map(k => report[dates[k].date].absent || 0);
          const bookedData   = keys.map(k => report[dates[k].date].booked || 0);

          if (this.state.attendanceChartInstance) this.state.attendanceChartInstance.destroy();
          this.state.attendanceChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [
              { label:'Asistieron', data:attendedData, backgroundColor:'rgba(16,185,129,.6)' },
              { label:'Faltaron',   data:absentData,   backgroundColor:'rgba(244,63,94,.6)' },
              { label:'Reservas Ma√±ana', data:bookedData, backgroundColor:'rgba(59,130,246,.6)' }
            ]},
            options: {
              scales: {
                y:{ beginAtZero:true, ticks:{ color:'#a1a1aa', stepSize:1 }, grid:{ color:'#3f3f46' } },
                x:{ ticks:{ color:'#a1a1aa' }, grid:{ color:'#3f3f46' } }
              },
              plugins:{ legend:{ labels:{ color:'#d4d4d8' } } }
            }
          });

          const renderList = (obj) => {
            const names = Object.keys(obj || {}).sort();
            if (!names.length) return '<ul class="list-disc list-inside text-zinc-400"><li>Nadie</li></ul>';
            return names.map(n => `
              <div class="font-semibold text-zinc-300 mt-1">${n}:</div>
              <ul class="list-disc list-inside text-zinc-400">${obj[n].map(p=>`<li>${p}</li>`).join('')}</ul>`).join('');
          };
          details.innerHTML = keys.map(k => {
            const d = report[dates[k].date];
            if (k !== 'tomorrow') {
              return `
                <div class="bg-zinc-900 p-3 rounded-md">
                  <h4 class="font-bold text-lg mb-2">${dates[k].label}</h4>
                  <div class="font-semibold text-emerald-400">Asistieron (${d.attended||0})</div>${renderList(d.details.attended)}
                  <div class="font-semibold text-rose-400 mt-2">Faltaron (${d.absent||0})</div>${renderList(d.details.absent)}
                </div>`;
            }
            return `
              <div class="bg-zinc-900 p-3 rounded-md">
                <h4 class="font-bold text-lg mb-2">${dates[k].label}</h4>
                <div class="font-semibold text-blue-400">Reservaron (${d.booked||0})</div>${renderList(d.details.booked)}
              </div>`;
          }).join('');
        },

        // ===== Modal / asistencia
        isClassInProgressWindow(cls) {
          if (!cls || !cls.classDate || !cls.time) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00`).getTime();
          const now = Date.now();
          const lower = now - (15*60*60*1000);
          const upper = now + (30*60*1000);
          return (start >= lower) && (start <= upper);
        },

        showClassModal(cls) {
          this.state.currentAttendance = {};
          document.getElementById('class-id').value = cls.id;
          document.getElementById('class-name').value = cls.name || '';
          document.getElementById('class-instructor').value = cls.instructor || '';
          document.getElementById('class-time').value = cls.time || '';
          document.getElementById('class-icon').value = cls.icon || '';
          document.getElementById('class-description').value = cls.description || '';
          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          this.switchTab('details');
          tabD.onclick = () => this.switchTab('details');
          if (this.isClassInProgressWindow(cls)) {
            tabA.classList.remove('hidden');
            tabA.onclick = () => this.switchTab('attendance');
            this.loadAttendeesForAttendance(cls);
          } else {
            tabA.classList.add('hidden');
            tabA.onclick = null;
          }
          document.getElementById('class-modal').classList.remove('hidden');
          document.getElementById('save-button').focus();
        },

        hideClassModal(){ document.getElementById('class-modal').classList.add('hidden'); },

        switchTab(tab) {
          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          const contD = document.getElementById('details-content');
          const contA = document.getElementById('attendance-content');
          if (tab==='details') {
            tabD.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','true');
            tabA.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','false');
            contD.classList.remove('hidden'); contA.classList.add('hidden');
          } else {
            tabA.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','true');
            tabD.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','false');
            contA.classList.remove('hidden'); contD.classList.add('hidden');
          }
        },

        async loadAttendeesForAttendance(cls) {
          const list = document.getElementById('attendance-list');
          const msg = document.getElementById('attendance-status-message');
          const save = document.getElementById('save-attendance-btn');
          const currentBookings = this.state.bookingsMap.get(cls.id) || [];
          const attSnap = await this.db.collection('attendance').where('classId','==',cls.id).get();
          const existing = {};
          attSnap.forEach(doc => { const d=doc.data(); existing[d.userId] = d.status; });

          this.state.currentAttendance = {};
          currentBookings.forEach(b => {
            if (existing[b.userId]) {
              this.state.currentAttendance[b.userId] = { status: existing[b.userId], userName: b.userName };
            }
          });

          if (!currentBookings.length) {
            msg.textContent = 'No hay usuarios inscritos en esta clase.';
            list.innerHTML = ''; save.classList.add('hidden'); return;
          }
          msg.textContent = `${currentBookings.length} usuarios inscritos.`;
          list.innerHTML = currentBookings.map(b => {
            const st = existing[b.userId];
            const selA = st==='attended' ? 'selected-attended' : '';
            const selF = st==='absent' ? 'selected-absent' : '';
            return `
              <div class="flex items-center justify-between bg-zinc-900 p-2 rounded-md">
                <span class="text-zinc-300">${b.userName || 'An√≥nimo'}</span>
                <div class="space-x-2" data-user-id="${b.userId}" data-user-name="${b.userName||'An√≥nimo'}">
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selA}" data-status="attended">Asisti√≥</button>
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selF}" data-status="absent">Falt√≥</button>
                </div>
              </div>`;
          }).join('');
          save.classList.remove('hidden');
          list.onclick = (e) => {
            const btn = e.target.closest('.attendance-btn'); if (!btn) return;
            const parent = btn.parentElement;
            const { userId, userName } = parent.dataset; const { status } = btn.dataset;
            this.state.currentAttendance[userId] = { status, userName };
            parent.querySelectorAll('.attendance-btn').forEach(x=>x.classList.remove('selected-attended','selected-absent'));
            btn.classList.add(status==='attended' ? 'selected-attended' : 'selected-absent');
          };
          save.onclick = () => this.saveAttendance(cls);
        },

        async saveAttendance(cls) {
          const data = this.state.currentAttendance;
          if (!Object.keys(data).length) { this.showToast({ title:'Sin cambios', message:'No marcaste asistencia', variant:'warn' }); return; }
          const batch = this.db.batch();
          Object.keys(data).forEach(uid => {
            const rec = data[uid];
            const ref = this.db.collection('attendance').doc(`${cls.classDate}_${cls.id}_${uid}`);
            batch.set(ref, {
              classId: cls.id, className: cls.name, classDate: cls.classDate, userId: uid, userName: rec.userName,
              status: rec.status, recordedAt: new Date()
            }, { merge:true });
          });
          try {
            await batch.commit();
            this.showToast({ title:'Asistencia guardada' });
            this.fetchAttendanceData(true);
            this.hideClassModal();
          } catch(e){ this.showToast({ title:'Error al guardar', message:e.message, variant:'error' }); }
        },

        // ===== Usuarios: reset / b√∫squeda puntual / detalle + notificaci√≥n =====
        async sendPasswordReset() {
          const input = document.getElementById('user-email-input');
          const email = input.value.trim();
          if (!email) { this.showToast({ title:'Falta correo', variant:'warn' }); return; }
          try {
            await this.auth.sendPasswordResetEmail(email);
            this.showToast({ title:'Correo enviado', message:`Revisa ${email}` });
            input.value = '';
          } catch(e){ this.showToast({ title:'No se pudo enviar', message:e.message, variant:'error' }); }
        },

        async findUserByEmail() {
          const input = document.getElementById('find-user-email-input');
          const email = input.value.trim().toLowerCase();
          const container = document.getElementById('user-details-container');
          container.innerHTML = ''; container.classList.add('hidden');
          if (!email) { this.showToast({ title:'Falta correo', variant:'warn' }); return; }

          try {
            const userSnap = await this.db.collection('users').where('email','==',email).limit(1).get();
            if (userSnap.empty) {
              this.showToast({ title:'Usuario no encontrado', message:`No se encontr√≥ un perfil para ${email}`, variant:'warn' });
              return;
            }
            const userDoc = userSnap.docs[0];
            this.renderUserDetails(userDoc);
          } catch(e){ this.showToast({ title:'Error al buscar', message:e.message, variant:'error' }); }
        },

        renderUserDetails(userDoc) {
          const userData = userDoc.data();
          const container = document.getElementById('user-details-container');
          const uid = userDoc.id;
          const tokens = userData.fcmTokens ? Object.keys(userData.fcmTokens) : [];

          let tokensHTML = '<p class="text-sm text-zinc-400">Este usuario no tiene dispositivos registrados para recibir notificaciones.</p>';
          if (tokens.length > 0) {
            tokensHTML = tokens.map((token, index) => `
              <div class="p-3 bg-zinc-900 rounded-lg border border-zinc-700">
                <p class="text-xs text-zinc-400 font-mono break-all">Dispositivo ${index + 1}: ${token.substring(0, 30)}...</p>
                <div class="mt-3 space-y-2">
                  <input type="text" id="noti-title-${index}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm" placeholder="T√≠tulo de la notificaci√≥n">
                  <textarea id="noti-body-${index}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm h-16" placeholder="Cuerpo del mensaje"></textarea>
                  <div class="flex gap-2">
                    <button data-token="${token}" data-index="${index}" data-uid="${uid}"
                            class="send-noti-btn flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md text-sm">Enviar</button>
                    <button data-token="${token}" data-uid="${uid}"
                            class="prune-token-btn bg-zinc-700 hover:bg-zinc-600 text-white font-semibold px-3 rounded-md text-sm">Prune</button>
                  </div>
                </div>
              </div>
            `).join('');
          }

          container.innerHTML = `
            <div class="p-4 bg-zinc-700/50 rounded-lg">
              <h4 class="font-bold">${userData.displayName || 'Usuario sin nombre'}</h4>
              <p class="text-sm text-zinc-400">${userData.email || ''}</p>
              <div class="mt-4 space-y-3">${tokensHTML}</div>
            </div>`;
          container.classList.remove('hidden');

          container.querySelectorAll('.send-noti-btn').forEach(btn => {
            btn.onclick = (event) => this.sendDirectNotification(event);
          });
          container.querySelectorAll('.prune-token-btn').forEach(btn => {
            btn.onclick = (event) => this.pruneTokenManual(event);
          });
        },

        // ===== Notificaci√≥n directa + PRUNE de tokens inv√°lidos =====
        async sendDirectNotification(event) {
          const btn = event.target;
          const { token, index, uid } = btn.dataset;
          const title = document.getElementById(`noti-title-${index}`)?.value.trim() || '(sin t√≠tulo)';
          const body  = document.getElementById(`noti-body-${index}`)?.value.trim() || '';

          if (!body) {
            this.showToast({ title:'Faltan datos', message:'El cuerpo es requerido.', variant:'warn' });
            return;
          }

          btn.disabled = true; const prev = btn.textContent; btn.textContent = 'Enviando‚Ä¶';
          try {
            if (this.auth.currentUser) { await this.auth.currentUser.getIdToken(true); }
            const send = this.functions.httpsCallable('sendDirectNotification');
            const result = await send({ token, title, body });

            if (result.data?.success) {
              this.showToast({ title:'Notificaci√≥n enviada', message:'Dispositivo notificado.' });
            } else {
              throw new Error(result.data?.error || 'El servidor devolvi√≥ un error.');
            }
          } catch (e) {
            const msg = String(e?.message || '');
            // Detecta token inv√°lido y lo elimina de Firestore
            if (/registration-token-not-registered|Requested entity was not found/i.test(msg)) {
              try {
                await this.db.collection('users').doc(uid).set({
                  [`fcmTokens.${token}`]: firebase.firestore.FieldValue.delete()
                }, { merge: true });
                this.showToast({ title:'Token inv√°lido eliminado', message:'Se purg√≥ de Firestore.', variant:'warn' });
                // refrescar detalles
                const userDoc = await this.db.collection('users').doc(uid).get();
                if (userDoc.exists) this.renderUserDetails(userDoc);
              } catch (delErr) {
                this.showToast({ title:'No se pudo eliminar token', message: delErr.message, variant:'error' });
              }
            } else {
              this.showToast({ title:'Error al enviar', message: msg, variant:'error' });
            }
          } finally {
            btn.disabled = false; btn.textContent = prev;
          }
        },

        // Bot√≥n "Prune" manual por token (sin enviar notificaci√≥n)
        async pruneTokenManual(event) {
          const btn = event.target;
          const { token, uid } = btn.dataset;
          btn.disabled = true; const prev = btn.textContent; btn.textContent = 'Eliminando‚Ä¶';
          try {
            await this.db.collection('users').doc(uid).set({
              [`fcmTokens.${token}`]: firebase.firestore.FieldValue.delete()
            }, { merge: true });
            this.showToast({ title:'Token eliminado', message:'Se removi√≥ de Firestore.' });
            const userDoc = await this.db.collection('users').doc(uid).get();
            if (userDoc.exists) this.renderUserDetails(userDoc);
          } catch (e) {
            this.showToast({ title:'No se pudo eliminar token', message: e.message, variant:'error' });
          } finally {
            btn.disabled = false; btn.textContent = prev;
          }
        },

        // ===== Auth =====
        login() {
          const email = document.getElementById('email-input').value.trim();
          const pass  = document.getElementById('password-input').value;
          const errEl = document.getElementById('error-message');
          errEl.classList.add('hidden');
          this.auth.signInWithEmailAndPassword(email, pass).catch(err => {
            errEl.textContent = 'Error: ' + err.message;
            errEl.classList.remove('hidden');
          });
        },

        logout() {
          this.auth.signOut();
          this.showToast({ title:'Sesi√≥n cerrada' });
        },

        async saveClass() {
          const id = document.getElementById('class-id').value;
          if (!id) return;
          const data = {
            name: document.getElementById('class-name').value,
            instructor: document.getElementById('class-instructor').value,
            time: document.getElementById('class-time').value,
            icon: document.getElementById('class-icon').value,
            description: document.getElementById('class-description').value,
          };
          try {
            const cls = this.state.classes.find(c => c.id === id);
            if (cls && data.time && data.time !== cls.time) {
              const { startAt, endAt } = this._buildStartEnd(cls.classDate, data.time, cls.duration || 60);
              data.startAt = startAt; data.endAt = endAt;
            }
            await this.db.collection('classes').doc(id).set(data, { merge:true });
            this.showToast({ title:'Clase actualizada' });
            this.hideClassModal();
          } catch (e) {
            this.showToast({ title:'No se guard√≥', message:e.message, variant:'error' });
          }
        },

        async deleteClass() {
          const id = document.getElementById('class-id').value;
          if (!id) return;
          try {
            const snap = await this.db.collection('bookings').where('classId','==',id).get();
            const batch = this.db.batch();
            snap.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            await this.db.collection('classes').doc(id).delete();
            this.showToast({ title:'Clase eliminada', message:`Se borraron ${snap.size} reservas` });
            this.hideClassModal();
          } catch (e) {
            this.showToast({ title:'No se pudo eliminar', message:e.message, variant:'error' });
          }
        },
      };

      AdminPanel.init();
    </script>
  </body>
</html>