<!-- /admin.html -->
<!-- Admin panel for managing classes, bookings and waitlists -->
<!-- Allows staff to supervise daily operations and user management -->
<!-- RELEVANT FILES: index.html, firebase-config.js, service-worker.js -->
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
    <title>Madness - Panel de Administrador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      :focus-visible { outline: 2px solid #818cf8; outline-offset: 2px; border-radius: .5rem; }
      .attendance-btn.selected-attended { background-color: #10b981; color: white; }
      .attendance-btn.selected-absent { background-color: #f43f5e; color: white; }
      #toast-container { pointer-events: none; }
      .toast { pointer-events: auto; }
      :root { --hour-height: 64px; }
      .calendar-header {
        display: grid;
        grid-template-columns: 70px repeat(7, minmax(0, 1fr));
        gap: 0.5rem;
        align-items: stretch;
      }
      .calendar-header .day-label {
        text-align: center;
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        background: rgba(39, 39, 42, 0.8);
        border: 1px solid rgba(63, 63, 70, 0.6);
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: 70px repeat(7, minmax(0, 1fr));
        gap: 0.5rem;
        align-items: stretch;
        position: relative;
      }
      .time-column {
        position: relative;
        padding-top: 0.5rem;
      }
      .time-slot {
        height: var(--hour-height);
        font-size: 0.75rem;
        color: #a1a1aa;
        display: flex;
        align-items: flex-start;
        justify-content: flex-end;
        padding-right: 0.5rem;
      }
      .time-slot::after {
        content: '';
        position: relative;
        display: block;
        width: 8px;
        height: 1px;
        margin-top: 0.5rem;
        margin-left: 0.5rem;
        background: rgba(113, 113, 122, 0.5);
      }
      .day-grid {
        position: relative;
        min-height: calc(var(--hour-height) * 16);
        background: rgba(24, 24, 27, 0.7);
        border: 1px solid rgba(63, 63, 70, 0.8);
        border-radius: 0.75rem;
        overflow: hidden;
      }
      .day-grid::before {
        content: '';
        position: absolute;
        inset: 0;
        background-image: repeating-linear-gradient(
          to bottom,
          rgba(63, 63, 70, 0.6) 0px,
          rgba(63, 63, 70, 0.6) 1px,
          transparent 1px,
          transparent var(--hour-height)
        );
        pointer-events: none;
      }
      .current-time-line {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, transparent 5%, rgba(129, 140, 248, 0.9) 35%, rgba(16, 185, 129, 0.95) 65%, transparent 95%);
        box-shadow: 0 0 12px rgba(59, 130, 246, 0.35);
        z-index: 5;
        pointer-events: none;
      }
      .current-time-line::before {
        content: '';
        position: absolute;
        left: var(--current-time-indicator-x, 12px);
        top: 50%;
        transform: translateY(-50%);
        width: 10px;
        height: 10px;
        border-radius: 9999px;
        background: #22d3ee;
        border: 2px solid rgba(24, 24, 27, 0.9);
        box-shadow: 0 0 8px rgba(34, 211, 238, 0.55);
      }
      .class-block {
        position: absolute;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.9), rgba(129, 140, 248, 0.85));
        border: 1px solid rgba(129, 140, 248, 0.6);
        padding: 0.5rem;
        color: #f4f4f5;
        font-size: 0.75rem;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .class-block:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 18px rgba(15, 23, 42, 0.35);
      }
      .class-block.running {
        border: 2px solid rgba(16, 185, 129, 0.9);
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3);
      }
      .class-block .class-meta {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 0.25rem;
      }
      .class-block .class-meta span {
        font-size: 0.7rem;
        color: rgba(228, 228, 231, 0.95);
      }
      .empty-day-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #71717a;
        font-size: 0.75rem;
        text-align: center;
        pointer-events: none;
      }
      .today-column {
        background: rgba(67, 56, 202, 0.16);
        border-color: rgba(99, 102, 241, 0.7);
        box-shadow: inset 0 0 0 2px rgba(129, 140, 248, 0.35);
      }
      .day-label.today-label {
        background: rgba(67, 56, 202, 0.35);
        border-color: rgba(99, 102, 241, 0.7);
        color: #e0e7ff;
      }
      @media (max-width: 1024px) {
        .calendar-header,
        .calendar-grid {
          grid-template-columns: 70px repeat(7, 180px);
        }
      }
      @media (max-width: 768px) {
        .calendar-container .min-w-[960px] {
          min-width: 0;
        }
        .calendar-header,
        .calendar-grid {
          grid-template-columns: 60px 1fr;
        }
        .calendar-header .day-label {
          display: none;
        }
        .calendar-header .day-label.today-label {
          display: block;
        }
        .calendar-grid .day-grid {
          display: none;
        }
        .calendar-grid .day-grid.today-column {
          display: block;
        }
      }
      @media (max-width: 640px) {
        :root { --hour-height: 52px; }
        .calendar-header,
        .calendar-grid {
          grid-template-columns: 60px 1fr;
        }
        .class-block {
          font-size: 0.7rem;
          padding: 0.4rem;
        }
      }
    </style>
  </head>
  <body class="bg-zinc-900 text-white">
    <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] space-y-2" aria-live="polite" aria-atomic="true"></div>

    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
      <div class="bg-zinc-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
        <h1 class="text-2xl font-bold text-center mb-6">Acceso de Administrador</h1>
        <input type="email" id="email-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Correo de Admin" autocomplete="email">
        <input type="password" id="password-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Contraseña" autocomplete="current-password">
        <div class="cf-turnstile mb-4" data-sitekey="0x4AAAAAABwCDMFGoF_Z-wjY"></div>
        <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md">Entrar</button>
        <p id="error-message" class="text-rose-400 text-center mt-4 hidden"></p>
      </div>
    </div>

    <div id="admin-panel" class="hidden p-4 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Panel de Administración</h1>
        <button id="logout-btn" class="text-rose-400 hover:text-rose-300 font-semibold">Cerrar Sesión</button>
      </div>

      <div class="mb-6 flex flex-wrap gap-3">
        <button id="gen-classes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg">
          <i data-lucide="calendar-check" class="inline-block -mt-1 mr-2"></i>Generar/Verificar Clases (Próxima Semana)
        </button>
        <button id="create-class-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
          <i data-lucide="plus" class="inline-block -mt-1 mr-2"></i>Crear Nueva Clase
        </button>
      </div>

      <div class="space-y-6">
        <section aria-labelledby="week-title">
          <h2 id="week-title" class="text-2xl font-bold mb-4 text-emerald-400 border-b border-zinc-700 pb-2">Clases de la Semana</h2>
          <div class="calendar-container space-y-4">
            <div class="overflow-x-auto pb-2">
              <div class="min-w-[960px] space-y-2">
                <div class="calendar-header text-xs font-semibold uppercase tracking-wide text-zinc-400">
                  <div class="text-right pr-2">Hora</div>
                  <div class="day-label">Lunes</div>
                  <div class="day-label">Martes</div>
                  <div class="day-label">Miércoles</div>
                  <div class="day-label">Jueves</div>
                  <div class="day-label">Viernes</div>
                  <div class="day-label">Sábado</div>
                  <div class="day-label">Domingo</div>
                </div>
                <div class="calendar-grid">
                  <div class="time-column">
                    <div class="time-slot">06:00</div>
                    <div class="time-slot">07:00</div>
                    <div class="time-slot">08:00</div>
                    <div class="time-slot">09:00</div>
                    <div class="time-slot">10:00</div>
                    <div class="time-slot">11:00</div>
                    <div class="time-slot">12:00</div>
                    <div class="time-slot">13:00</div>
                    <div class="time-slot">14:00</div>
                    <div class="time-slot">15:00</div>
                    <div class="time-slot">16:00</div>
                    <div class="time-slot">17:00</div>
                    <div class="time-slot">18:00</div>
                    <div class="time-slot">19:00</div>
                    <div class="time-slot">20:00</div>
                    <div class="time-slot">21:00</div>
                    <div class="time-slot">22:00</div>
                  </div>
                  <div id="monday-grid" class="day-grid" data-day-index="1" aria-label="Clases del lunes"></div>
                  <div id="tuesday-grid" class="day-grid" data-day-index="2" aria-label="Clases del martes"></div>
                  <div id="wednesday-grid" class="day-grid" data-day-index="3" aria-label="Clases del miércoles"></div>
                  <div id="thursday-grid" class="day-grid" data-day-index="4" aria-label="Clases del jueves"></div>
                  <div id="friday-grid" class="day-grid" data-day-index="5" aria-label="Clases del viernes"></div>
                  <div id="saturday-grid" class="day-grid" data-day-index="6" aria-label="Clases del sábado"></div>
                  <div id="sunday-grid" class="day-grid" data-day-index="0" aria-label="Clases del domingo"></div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="reservas-title">
        <h2 id="reservas-title" class="text-2xl font-bold mb-4">Reservas de la Semana</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-7 gap-4">
          <div class="day-column" data-day="monday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Lunes</h3>
            <div id="monday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="tuesday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Martes</h3>
            <div id="tuesday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="wednesday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Miércoles</h3>
            <div id="wednesday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="thursday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Jueves</h3>
            <div id="thursday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="friday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Viernes</h3>
            <div id="friday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="saturday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Sábado</h3>
            <div id="saturday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
          <div class="day-column" data-day="sunday">
            <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Domingo</h3>
            <div id="sunday-bookings-list" class="space-y-4 text-sm"></div>
          </div>
        </div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="asistencia-title">
        <div class="flex items-center justify-between gap-4 mb-2">
          <h2 id="asistencia-title" class="text-2xl font-bold">Reporte de Asistencia y Proyección</h2>
          <button
            type="button"
            class="toggle-section inline-flex items-center gap-1 text-xs font-semibold text-indigo-400 hover:text-indigo-300"
            data-toggle-target="attendance-section-body"
            data-expanded-label="Colapsar"
            data-collapsed-label="Expandir"
            aria-controls="attendance-section-body"
            aria-expanded="false"
          >
            <span data-toggle-label>Expandir</span>
          </button>
        </div>
        <div id="attendance-section-body" class="space-y-4 hidden">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between text-xs text-zinc-400 gap-2">
            <div class="flex items-center gap-4">
              <span id="att-last">Última actualización: —</span>
              <span id="att-next">Próxima actualización en: —</span>
            </div>
            <button id="att-refresh" class="inline-flex items-center gap-1 text-indigo-400 hover:text-indigo-300">
              <i data-lucide="refresh-ccw" class="w-4 h-4"></i> Actualizar ahora
            </button>
          </div>
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-3 text-xs">
            <div class="flex flex-wrap items-center gap-2">
              <label for="att-start-date">Desde:</label>
              <input type="date" id="att-start-date" class="bg-zinc-700 text-white p-1 rounded-md" />
              <label for="att-end-date">Hasta:</label>
              <input type="date" id="att-end-date" class="bg-zinc-700 text-white p-1 rounded-md" />
              <label for="att-period">Periodo:</label>
              <select id="att-period" class="bg-zinc-700 text-white p-1 rounded-md">
                <option value="range">Rango seleccionado</option>
                <option value="daily">Diario</option>
                <option value="weekly">Semanal</option>
                <option value="monthly">Mensual</option>
              </select>
              <label for="facility-capacity">Capacidad:</label>
              <input type="number" id="facility-capacity" class="bg-zinc-700 text-white p-1 rounded-md w-20" min="1" />
            </div>
            <div class="flex flex-wrap items-center gap-2">
              <label for="class-filter">Tipo de clase:</label>
              <select id="class-filter" class="bg-zinc-700 text-white p-1 rounded-md min-w-[8rem]">
                <option value="all">Todas</option>
              </select>
              <label for="instructor-filter">Instructor:</label>
              <select id="instructor-filter" class="bg-zinc-700 text-white p-1 rounded-md min-w-[8rem]">
                <option value="all">Todos</option>
              </select>
              <label for="att-export-format">Exportar:</label>
              <select id="att-export-format" class="bg-zinc-700 text-white p-1 rounded-md">
                <option value="capacity">Capacidad</option>
                <option value="demographics">Demográficos</option>
                <option value="instructors">Instructores</option>
                <option value="revenue">Ingresos</option>
                <option value="optimization">Optimización</option>
                <option value="custom-range">Rango personalizado</option>
              </select>
              <button id="att-export" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-1 px-2 rounded-md">Exportar</button>
            </div>
            <div class="flex flex-wrap items-center gap-2 xl:col-span-2">
              <span>Métricas:</span>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" id="metric-attended" class="bg-zinc-700" checked /> Asistencias
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" id="metric-absent" class="bg-zinc-700" checked /> Ausencias
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" id="metric-booked" class="bg-zinc-700" checked /> Reservas
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" id="metric-utilization" class="bg-zinc-700" checked /> Utilización
              </label>
              <label class="inline-flex items-center gap-1">
                <input type="checkbox" id="metric-revenue" class="bg-zinc-700" checked /> Ingresos
              </label>
            </div>
          </div>
          <div id="dashboard-loading" class="hidden bg-zinc-900 border border-zinc-700 text-zinc-300 text-sm p-3 rounded-md">
            Calculando métricas avanzadas…
          </div>
          <div class="bg-zinc-900/60 border border-zinc-700 rounded-lg p-4 space-y-4">
            <div class="w-full bg-zinc-700 h-2 rounded">
              <div id="capacity-gauge-fill" class="h-2 bg-emerald-500 rounded" style="width:0%"></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-zinc-300">
              <div>
                <p class="text-zinc-500">Tendencia 7 días</p>
                <p id="capacity-trend" class="font-semibold">—</p>
              </div>
              <div>
                <p class="text-zinc-500">Alertas</p>
                <p id="capacity-alert" class="font-semibold">—</p>
              </div>
              <div>
                <p class="text-zinc-500">Vs. semana pasada</p>
                <p id="capacity-compare" class="font-semibold">—</p>
              </div>
              <div>
                <p class="text-zinc-500">Proyección día</p>
                <p id="capacity-projection" class="font-semibold">—</p>
              </div>
            </div>
          </div>
          <div class="space-y-4">
            <div class="bg-zinc-900/60 border border-zinc-700 rounded-lg p-4">
              <canvas id="attendanceTrendChart"></canvas>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="bg-zinc-900/60 border border-zinc-700 rounded-lg p-4">
                <div id="capacity-heatmap" class="grid grid-cols-1 gap-2 text-xs text-zinc-300 min-h-[180px]"></div>
              </div>
              <div class="bg-zinc-900/60 border border-zinc-700 rounded-lg p-4">
                <canvas id="revenueChart"></canvas>
              </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div class="bg-zinc-900/60 border border-zinc-700 rounded-lg p-4">
                <canvas id="retentionChart"></canvas>
              </div>
              <div class="bg-zinc-900/60 border border-zinc-700 rounded-lg p-4">
                <canvas id="popularityChart"></canvas>
              </div>
            </div>
          </div>
          <div id="attendance-details" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm"></div>
        </div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="notifs-title">
        <div class="flex items-center justify-between gap-4 mb-4">
          <h2 id="notifs-title" class="text-2xl font-bold">Últimas 10 notificaciones</h2>
          <button
            type="button"
            class="toggle-section inline-flex items-center gap-1 text-xs font-semibold text-indigo-400 hover:text-indigo-300"
            data-toggle-target="recent-notifs"
            data-expanded-label="Colapsar"
            data-collapsed-label="Expandir"
            aria-controls="recent-notifs"
            aria-expanded="false"
          >
            <span data-toggle-label>Expandir</span>
          </button>
        </div>
        <ul id="recent-notifs" class="space-y-2 text-sm hidden"></ul>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="daily-message-title">
        <div class="flex items-center justify-between gap-4 mb-4">
          <h2 id="daily-message-title" class="text-2xl font-bold">Mensaje del Día</h2>
        </div>
        <form id="daily-message-form" class="space-y-4">
          <input type="hidden" id="daily-message-id">
          <div>
            <label for="daily-message-text" class="block text-sm font-medium text-zinc-300 mb-2">Mensaje para los alumnos</label>
            <textarea id="daily-message-text" class="w-full bg-zinc-700 text-white p-3 rounded-md h-28" placeholder="Ej: Está lloviendo hoy, maneja con cuidado." required></textarea>
            <p id="daily-message-form-status" class="text-xs text-indigo-300 mt-2 hidden"></p>
          </div>
          <label class="inline-flex items-center gap-2 text-sm text-zinc-300">
            <input type="checkbox" id="daily-message-active" class="w-4 h-4 accent-indigo-600" checked>
            Mostrar mensaje en la app
          </label>
          <div class="flex flex-wrap gap-2">
            <button type="submit" id="daily-message-submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md">Guardar Mensaje</button>
            <button type="button" id="daily-message-reset" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-md">Limpiar</button>
          </div>
        </form>
        <div id="daily-messages-list" class="mt-6 space-y-4 text-sm"></div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="usuarios-title">
        <h2 id="usuarios-title" class="text-2xl font-bold mb-4">Gestión de Usuarios</h2>

        <div>
          <label for="user-email-input" class="block text-sm font-medium text-zinc-300 mb-2">Reinicio de Contraseña</label>
          <div class="flex gap-2">
            <input type="email" id="user-email-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md" placeholder="Correo del usuario">
            <button id="send-reset-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
          </div>
        </div>

        <hr class="border-zinc-700 my-6">

        <!-- Buscar por nombre/correo + listar -->
        <div>
          <label for="find-user-query-input" class="block text-sm font-medium text-zinc-300 mb-2">
            Buscar usuario (nombre o correo)
          </label>
          <div class="flex gap-2">
            <input type="text" id="find-user-query-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md"
                   placeholder="Ej: Valery, Erick o alguien@correo.com">
            <button id="find-user-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md">Buscar</button>
            <button id="list-users-btn" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded-md">Listar</button>
          </div>

          <p id="user-results-hint" class="text-zinc-400 text-xs mt-2 hidden"></p>
          <div id="user-details-container" class="mt-4 hidden space-y-4"></div>
        </div>
      </section>

      <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="blacklist-title">
        <h2 id="blacklist-title" class="text-2xl font-bold mb-2">Gestión de Lista Negra</h2>
        <p class="text-sm text-zinc-400 mb-4">Revisa usuarios bloqueados por cancelaciones tardías y rehabilítalos cuando sea necesario.</p>
        <div class="flex flex-wrap gap-2">
          <button id="list-blacklisted-btn" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded-md">Listar usuarios en lista negra</button>
        </div>
        <p id="blacklisted-users-feedback" class="text-xs text-zinc-400 mt-3 hidden"></p>
        <div id="blacklisted-users-container" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
      </section>
    </div>

    <div id="class-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
      <div class="bg-zinc-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4 max-h-screen overflow-y-auto" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <h2 id="modal-title" class="text-2xl font-bold">Editar Clase</h2>
        <input type="hidden" id="class-id">
        <div class="border-b border-zinc-700">
          <nav class="flex space-x-4" aria-label="Tabs">
            <button id="tab-details" class="px-3 py-2 font-medium text-sm rounded-t-md" aria-selected="true">Detalles</button>
            <button id="tab-attendance" class="px-3 py-2 font-medium text-sm rounded-t-md hidden" aria-selected="false">Asistencia</button>
          </nav>
        </div>
        <div id="details-content">
          <div class="mt-4">
            <input type="text" id="class-name" placeholder="Nombre de la clase" class="w-full bg-zinc-700 p-2 rounded">
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Escribe el nombre que verán los alumnos en el horario.</p>
          </div>
          <div class="mt-4">
            <input type="text" id="class-instructor" placeholder="Instructor" class="w-full bg-zinc-700 p-2 rounded">
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Indica quién impartirá la sesión.</p>
          </div>
          <div class="mt-4">
            <input type="text" id="class-time" placeholder="Hora (ej. 18:00)" class="w-full bg-zinc-700 p-2 rounded">
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Coloca la hora de inicio en formato 24 horas.</p>
          </div>
          <p id="class-time-warning" class="mt-2 text-xs text-amber-400 hidden"></p>
          <div class="mt-4">
            <textarea id="class-description" placeholder="Descripción" class="w-full bg-zinc-700 p-2 rounded h-24"></textarea>
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Resume la dinámica o enfoque de la clase.</p>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div class="flex flex-col">
              <input type="date" id="class-date" placeholder="Fecha" class="w-full bg-zinc-700 p-2 rounded">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Selecciona la fecha exacta de la clase.</p>
            </div>
            <div class="flex flex-col">
              <input type="number" id="class-capacity" placeholder="Capacidad" class="w-full bg-zinc-700 p-2 rounded" min="1" max="30">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Define el número máximo de asistentes.</p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div class="flex flex-col">
              <input type="number" id="class-duration" placeholder="Duración (min)" class="w-full bg-zinc-700 p-2 rounded" min="30" max="120">
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Indica cuánto dura la sesión en minutos.</p>
            </div>
            <div class="flex flex-col">
              <input type="number" id="class-enrolled" placeholder="Inscritos" class="w-full bg-zinc-700 p-2 rounded" min="0" readonly>
              <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Consulta cuántos alumnos están inscritos ahora.</p>
            </div>
          </div>
          <div class="mt-4">
            <input type="url" id="class-image" placeholder="URL de imagen" class="w-full bg-zinc-700 p-2 rounded">
            <p class="text-xs text-zinc-400 mt-1 text-left sm:text-right">Pega la URL de la foto o banner de la clase.</p>
          </div>
          <div class="mt-4 p-4 bg-zinc-700 rounded-lg border border-zinc-600">
            <h3 class="text-lg font-semibold mb-3">Reservas Manuales (WhatsApp)</h3>
            <div class="flex gap-3 items-end">
              <div class="flex-1">
                <label for="manual-bookings-count" class="block text-sm font-medium text-zinc-300 mb-2">
                  Número de reservas recibidas por WhatsApp
                </label>
                <input
                  type="number"
                  id="manual-bookings-count"
                  placeholder="Ej: 5"
                  class="w-full bg-zinc-600 p-2 rounded"
                  min="0"
                  max="30"
                >
              </div>
              <button
                id="generate-manual-bookings-btn"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded"
              >
                Generar Reservas
              </button>
            </div>
            <p class="text-xs text-zinc-400 mt-2">
              Esto creará reservas de prueba con emails placeholder para simular las reservas recibidas por WhatsApp.
            </p>
          </div>
        </div>
        <div id="attendance-content" class="hidden">
          <div id="attendance-status-message" class="text-center text-zinc-400 p-4"></div>
          <div id="attendance-list" class="space-y-2"></div>
          <button id="save-attendance-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 hidden">Guardar Asistencia</button>
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button id="delete-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded">Eliminar</button>
          <button id="cancel-button" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
          <button id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Guardar Cambios</button>
        </div>
      </div>
    </div>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>

    <script>
      const AdminPanel = {
        db: null,
        auth: null,
        functions: null,
        FACILITY_MAX_CAPACITY: 75,
        DEFAULT_TICKET_PRICE: 120,
        calendarStartHour: 6,
        calendarEndHour: 22,
        currentTimeTicker: null,
        state: {
          classes: [],
          bookingsMap: new Map(),
          waitlistsMap: new Map(),
          weeklySchedule: {},
          weekDates: [],
          recentNotifications: [],
          currentAttendance: {},
          selectedClass: null,
          attendanceCharts: {},
          unsubClasses: null,
          unsubBookings: [],
          unsubWaitlists: [],
          unsubRecentNotifs: null,
          attendanceData: null,
          attendanceLastAt: 0,
          unsubCapacity: null,
          attendanceTickTimer: null,
          userSearchResults: [],
          blacklistedUsers: [],
          analyticsTracker: {
            bookingTimeline: {},
            userBehavior: {},
            cancellationTimeline: [],
            switches: []
          },
          selectedMetrics: new Set(['attended','absent','booked','utilization','revenue']),
          selectedPeriod: 'range',
          selectedClassType: 'all',
          selectedInstructor: 'all',
          selectedExportFormat: 'capacity',
          dailyMessages: [],
          unsubDailyMessages: null,
          userCache: new Map()
        },

        // --- Helpers ---
        timeFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', hour:'2-digit',minute:'2-digit',hour12:false }),
        timePartsFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', hour:'2-digit',minute:'2-digit',hour12:false }),
        dayFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', weekday:'long',day:'2-digit',month:'short' }),
        dayShortFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', day:'2-digit',month:'short' }),
        weekdayNameFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', weekday:'long' }),
        weekdayShortFmt: new Intl.DateTimeFormat('es-MX',{ timeZone: 'America/Mexico_City', weekday:'short' }),
        dateHelper: {
          ymd(date){ return new Intl.DateTimeFormat('en-CA',{ timeZone: 'America/Mexico_City', year:'numeric', month:'2-digit', day:'2-digit' }).format(date); },
          today(){ return this.ymd(new Date()); },
          tomorrow(){ return this.ymd(new Date(Date.now()+86400000)); },
          yesterday(){ return this.ymd(new Date(Date.now()-86400000)); }
        },
        normalizeStr(s=''){
          return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
        },
        formatWeekdayLabel(dateStr=''){
          // Converts an ISO date into "Lunes - 26" so the calendar headers show the active day number.
          if (!dateStr) return null;
          const base = new Date(`${dateStr}T00:00:00`);
          if (Number.isNaN(base.getTime())) return null;
          const weekdayRaw = this.weekdayNameFmt.format(base) || '';
          const prettyWeekday = weekdayRaw ? `${weekdayRaw.charAt(0).toUpperCase()}${weekdayRaw.slice(1)}` : '';
          return `${prettyWeekday} - ${base.getDate()}`.trim();
        },

        formatWeekdayShortLabel(dateStr=''){
          // Returns a short weekday string (e.g. "Lun") for chart labels.
          if (!dateStr) return '';
          const base = new Date(`${dateStr}T00:00:00-06:00`);
          if (Number.isNaN(base.getTime())) return '';
          const raw = this.weekdayShortFmt.format(base) || '';
          const cleaned = raw.replace('.', '');
          if (!cleaned) return '';
          return `${cleaned.charAt(0).toUpperCase()}${cleaned.slice(1)}`;
        },

        setupSectionToggles(){
          const buttons = document.querySelectorAll('[data-toggle-target]');
          buttons.forEach((btn) => {
            const targetId = btn.dataset.toggleTarget;
            if (!targetId) return;
            const target = document.getElementById(targetId);
            if (!target) return;
            const labelEl = btn.querySelector('[data-toggle-label]');
            const expandedLabel = btn.dataset.expandedLabel || 'Colapsar';
            const collapsedLabel = btn.dataset.collapsedLabel || 'Expandir';

            const updateState = (expanded) => {
              btn.setAttribute('aria-expanded', String(expanded));
              if (labelEl) labelEl.textContent = expanded ? expandedLabel : collapsedLabel;
            };

            const isInitiallyHidden = target.classList.contains('hidden');
            updateState(!isInitiallyHidden);

            btn.addEventListener('click', () => {
              const isExpanded = btn.getAttribute('aria-expanded') === 'true';
              if (isExpanded) {
                target.classList.add('hidden');
                updateState(false);
              } else {
                target.classList.remove('hidden');
                updateState(true);
              }
            });
          });
        },

        // --- TOASTS ---
        showToast({ title='Hecho', message='', variant='success', timeout=3000 }){
          const color = variant==='error'?'rose': variant==='warn'?'amber':'emerald';
          const wrap = document.getElementById('toast-container');
          const el = document.createElement('div');
          el.className = 'toast max-w-md mx-auto bg-zinc-800 border border-zinc-700 rounded-xl p-4 shadow-lg flex items-start gap-3';
          const safeTitle = DOMPurify.sanitize(title);
          const safeMessage = DOMPurify.sanitize(message);
          el.innerHTML = `
            <div class="w-10 h-10 rounded-lg bg-${color}-500/20 text-${color}-300 flex items-center justify-center shrink-0">
              <i data-lucide="${variant==='error'?'alert-triangle':variant==='warn'?'alert-circle':'check'}" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
              <p class="font-semibold">${safeTitle}</p>
              ${safeMessage?`<p class="text-sm text-zinc-400 mt-0.5">${safeMessage}</p>`:''}
            </div>
            <button class="shrink-0 text-zinc-400 hover:text-zinc-200" aria-label="Cerrar notificación">
              <i data-lucide="x" class="w-5 h-5"></i>
            </button>`;
          wrap.appendChild(el);
          lucide.createIcons({ attrs:{'aria-hidden':'true'} });
          const close = () => el.remove();
          el.querySelector('button').addEventListener('click', close);
          if (timeout) setTimeout(close, timeout);
        },

        // --- INIT / AUTH ---
        init(){
          const firebaseConfig = {
            apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
            authDomain: "madnessscheds.firebaseapp.com",
            projectId: "madnessscheds",
            storageBucket: "madnessscheds.firebasestorage.app",
            messagingSenderId: "788538690861",
            appId: "1:788538690861:web:ce19ead5929a8867c197a4"
          };
          firebase.initializeApp(firebaseConfig);
          this.db = firebase.firestore();
          this.auth = firebase.auth();
          this.functions = firebase.app().functions('us-central1');

          // Top buttons
          document.getElementById('login-btn').onclick = () => this.login();
          document.getElementById('logout-btn').onclick = () => this.logout();
          document.getElementById('gen-classes-btn').onclick = () => this.generateDailyClasses();
          document.getElementById('create-class-btn').onclick = () => this.showCreateClassModal();
          document.getElementById('send-reset-btn').onclick = () => this.sendPasswordReset();
          document.getElementById('att-refresh').onclick = () => this.fetchAttendanceData(true);
          const blacklistBtn = document.getElementById('list-blacklisted-btn');
          if (blacklistBtn) blacklistBtn.onclick = () => this.listBlacklistedUsers();
          const manualBookingsBtn = document.getElementById('generate-manual-bookings-btn');
          if (manualBookingsBtn) manualBookingsBtn.onclick = () => this.generateManualBookings();

          const range = this.getDefaultAttendanceRange();
          const sEl = document.getElementById('att-start-date');
          const eEl = document.getElementById('att-end-date');
          const capEl = document.getElementById('facility-capacity');
          const exportBtn = document.getElementById('att-export');
          const periodEl = document.getElementById('att-period');
          const classFilter = document.getElementById('class-filter');
          const instructorFilter = document.getElementById('instructor-filter');
          const exportFormatEl = document.getElementById('att-export-format');
          const dailyForm = document.getElementById('daily-message-form');
          const dailyResetBtn = document.getElementById('daily-message-reset');
          const dailyList = document.getElementById('daily-messages-list');
          const metricCheckboxes = [
            { id:'metric-attended', key:'attended' },
            { id:'metric-absent', key:'absent' },
            { id:'metric-booked', key:'booked' },
            { id:'metric-utilization', key:'utilization' },
            { id:'metric-revenue', key:'revenue' }
          ];
          if (sEl && eEl){
            sEl.value = range.start;
            eEl.value = range.end;
            sEl.addEventListener('change',()=>this.fetchAttendanceData(true));
            eEl.addEventListener('change',()=>this.fetchAttendanceData(true));
          }
          if (capEl){
            capEl.value = this.FACILITY_MAX_CAPACITY;
            capEl.addEventListener('change',()=>{
              this.FACILITY_MAX_CAPACITY = Number(capEl.value)||0;
              this.fetchAttendanceData(true);
            });
          }
          if (periodEl){
            periodEl.addEventListener('change',()=>{
              this.state.selectedPeriod = periodEl.value;
              this.fetchAttendanceData(true);
            });
          }
          if (classFilter){
            classFilter.addEventListener('change',()=>{
              this.state.selectedClassType = classFilter.value;
              this.fetchAttendanceData(true);
            });
          }
          if (instructorFilter){
            instructorFilter.addEventListener('change',()=>{
              this.state.selectedInstructor = instructorFilter.value;
              this.fetchAttendanceData(true);
            });
          }
          metricCheckboxes.forEach(meta=>{
            const el = document.getElementById(meta.id);
            if (!el) return;
            el.addEventListener('change',()=>{
              if (el.checked){ this.state.selectedMetrics.add(meta.key); }
              else this.state.selectedMetrics.delete(meta.key);
              this.renderAttendanceDashboardFromCache();
            });
          });
          if (exportFormatEl){
            exportFormatEl.addEventListener('change',()=>{
              this.state.selectedExportFormat = exportFormatEl.value;
            });
          }
          if (exportBtn){
            exportBtn.onclick = () => this.exportCapacityReport();
          }

          if (dailyForm){
            dailyForm.addEventListener('submit', (e)=>this.submitDailyMessage(e));
          }
          if (dailyResetBtn){
            dailyResetBtn.addEventListener('click', ()=>this.resetDailyMessageForm());
          }
          if (dailyList){
            dailyList.addEventListener('click', (e)=>this.handleDailyMessageListClick(e));
          }

          this.resetDailyMessageForm();

          this.setupSectionToggles();

          // Users: find + list
          document.getElementById('find-user-btn').onclick = () => this.findUsersByQuery();
          document.getElementById('list-users-btn').onclick = () => this.listUsersPage();

          this.auth.onAuthStateChanged(async (user) => {
            if (user) {
              const token = await user.getIdTokenResult();
              if (token.claims && token.claims.admin) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                try {
                  await this.loadWeeklyScheduleTemplate();
                  this.listenWeeklyClasses();
                  this.startAttendancePolling();
                  this.listenRecentNotifications();
                  this.listenDailyMessages();
                } catch(e){
                  this.showToast({ title:'Error al iniciar', message:e.message, variant:'error' });
                }
              } else {
                this.logout();
                this.showToast({ title:'Acceso denegado', message:'Tu cuenta no tiene rol de admin', variant:'error' });
              }
            } else {
              document.getElementById('login-screen').classList.remove('hidden');
              document.getElementById('admin-panel').classList.add('hidden');
              this.teardownBookingsListeners();
              if (this.state.unsubClasses) this.state.unsubClasses();
              this.stopAttendancePolling();
              if (this.state.unsubRecentNotifs) this.state.unsubRecentNotifs();
              if (this.state.unsubDailyMessages) this.state.unsubDailyMessages();
              this.state.unsubDailyMessages = null;
              this.state.recentNotifications = [];
              this.renderRecentNotifications();
              this.state.dailyMessages = [];
              this.renderDailyMessages();
              this.resetDailyMessageForm();
              this.stopCurrentTimeTicker();
            }
          });

          lucide.createIcons();
        },

        async loadWeeklyScheduleTemplate(){
          const snap = await this.db.collection('schedule_template').get();
          if (snap.empty) throw new Error('No existe la plantilla de horario.');
          snap.forEach(doc => { this.state.weeklySchedule[doc.id] = doc.data().classes || []; });
        },

        // --- LISTENERS (semana completa) ---
        listenWeeklyClasses(){
          const today = new Date();
          today.setHours(0,0,0,0);
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - today.getDay() + 1);

          const weekDates = [];
          for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            weekDates.push(this.dateHelper.ymd(date));
          }

          this.state.weekDates = weekDates;

          if (this.state.unsubClasses) this.state.unsubClasses();

          if (!weekDates.length){
            this.state.classes = [];
            this.mountBookingsListenersForVisibleClasses();
            this.mountWaitlistListenersForVisibleClasses();
            this.renderAll();
            this.renderAttendanceDashboardFromCache();
            return;
          }

          this.state.unsubClasses = this.db.collection('classes')
            .where('classDate', 'in', weekDates)
            .orderBy('classDate','asc').orderBy('time','asc')
            .onSnapshot((snap)=>{
              this.state.classes = snap.docs.map(d=>{
                const data = { id:d.id, ...d.data() };
                const timeStr = data.time || data.timeUTC;
                if (data.classDate && timeStr){
                  const start = new Date(`${data.classDate}T${timeStr}:00Z`);
                  data.localDate = this.dateHelper.ymd(start);
                  data.localTime = this.timeFmt.format(start);
                }
                return data;
              });
              this.mountBookingsListenersForVisibleClasses();
              this.mountWaitlistListenersForVisibleClasses();
              this.renderAll();
              this.refreshAttendanceFilters();
              this.renderAttendanceDashboardFromCache();
            }, err=>{
              console.error(err);
              this.showToast({ title:'Error listando clases', message: err.message, variant:'error' });
            });
        },

        teardownBookingsListeners(){
          this.state.unsubBookings.forEach(fn=>{ try{ fn&&fn(); }catch{} });
          this.state.unsubBookings = [];
          this.state.bookingsMap.clear();
          this.teardownWaitlistListeners();
        },

        teardownWaitlistListeners(){
          this.state.unsubWaitlists.forEach(fn=>{ try{ fn&&fn(); }catch{} });
          this.state.unsubWaitlists = [];
          this.state.waitlistsMap.clear();
        },

        mountBookingsListenersForVisibleClasses(){
          this.teardownBookingsListeners();
          const classIds = this.state.classes.map(c=>c.id);
          for (let i=0;i<classIds.length;i+=10){
            const batch = classIds.slice(i,i+10);
            const unsub = this.db.collection('bookings')
              .where('classId','in',batch)
              .onSnapshot((snap)=>{
                const tracker = this.state.analyticsTracker;
                batch.forEach(cid => {
                  this.state.bookingsMap.delete(cid);
                  tracker.bookingTimeline[cid] = [];
                });
                snap.docs.forEach(doc=>{
                  const b = doc.data();
                  const arr = this.state.bookingsMap.get(b.classId) || [];
                  const record = { id:doc.id, ...b };
                  arr.push(record);
                  this.state.bookingsMap.set(b.classId, arr);
                  const createdAt = b.createdAt?.toDate ? b.createdAt.toDate() : (b.createdAt ? new Date(b.createdAt) : null);
                  if (!tracker.bookingTimeline[b.classId]) tracker.bookingTimeline[b.classId] = [];
                  if (createdAt && !Number.isNaN(createdAt.getTime())){
                    tracker.bookingTimeline[b.classId].push(createdAt.getTime());
                  }
                  const userKey = b.userId || b.userEmail || b.userName || doc.id;
                  if (!tracker.userBehavior[userKey]){
                    tracker.userBehavior[userKey] = { bookingsSet:new Set(), cancellationIds:new Set(), switchIds:new Set(), bookings:0, cancellations:0, switches:0, lastClassId:null };
                  }
                  tracker.userBehavior[userKey].bookingsSet.add(doc.id);
                  tracker.userBehavior[userKey].bookings = tracker.userBehavior[userKey].bookingsSet.size;
                  if ((b.status && b.status==='cancelled') || b.cancelledAt){
                    tracker.userBehavior[userKey].cancellationIds.add(doc.id);
                    tracker.userBehavior[userKey].cancellations = tracker.userBehavior[userKey].cancellationIds.size;
                    this.recordCancellationTiming(b);
                  }
                  if (b.previousClassId && b.previousClassId !== b.classId){
                    tracker.userBehavior[userKey].switchIds.add(`${doc.id}:${b.previousClassId}->${b.classId}`);
                    tracker.userBehavior[userKey].switches = tracker.userBehavior[userKey].switchIds.size;
                    this.recordClassSwitch(b);
                  }
                  tracker.userBehavior[userKey].lastClassId = b.classId;
                });
                this.renderAll();
                this.renderAttendanceDashboardFromCache();
              });
            this.state.unsubBookings.push(unsub);
          }
        },

        mountWaitlistListenersForVisibleClasses(){
          this.teardownWaitlistListeners();
          const classIds = this.state.classes.map(c=>c.id);
          for (let i=0;i<classIds.length;i+=10){
            const batch = classIds.slice(i,i+10);
            const unsub = this.db.collection('waitlists')
              .where('classId','in',batch)
              .onSnapshot(async (snap)=>{
                batch.forEach(cid=>this.state.waitlistsMap.delete(cid));
                const items = await Promise.all(snap.docs.map(async doc=>{
                  const w = doc.data();
                  let userName = '';
                  if (w.userId){
                    try{
                      const uSnap = await this.db.collection('users').doc(w.userId).get();
                      userName = uSnap.data()?.displayName || uSnap.data()?.email || w.userId;
                    }catch{}
                  }
                  return { id:doc.id, ...w, userName };
                }));
                items.forEach(w=>{
                  const arr = this.state.waitlistsMap.get(w.classId) || [];
                  arr.push(w);
                  this.state.waitlistsMap.set(w.classId, arr);
                });
                this.renderAll();
              });
            this.state.unsubWaitlists.push(unsub);
          }
        },

        recordCancellationTiming(booking){
          const tracker = this.state.analyticsTracker;
          if (!tracker) return;
          const cancelledAtRaw = booking.cancelledAt?.toDate ? booking.cancelledAt.toDate() : (booking.cancelledAt ? new Date(booking.cancelledAt) : null);
          const createdAtRaw = booking.createdAt?.toDate ? booking.createdAt.toDate() : (booking.createdAt ? new Date(booking.createdAt) : null);
          const classDate = booking.classDate || '';
          const classTime = booking.classTime || booking.time || '';
          let classStart = null;
          if (classDate && classTime){
            classStart = new Date(`${classDate}T${(classTime.length===5?classTime:classTime.slice(0,5))}:00Z`);
          }
          let hoursBefore = null;
          if (cancelledAtRaw && classStart && !Number.isNaN(cancelledAtRaw.getTime()) && !Number.isNaN(classStart.getTime())){
            const diff = (classStart.getTime() - cancelledAtRaw.getTime()) / 3600000;
            hoursBefore = Math.round(diff*10)/10;
          }
          tracker.cancellationTimeline.push({
            classId: booking.classId,
            classDate,
            cancelledAt: cancelledAtRaw ? cancelledAtRaw.toISOString() : null,
            createdAt: createdAtRaw ? createdAtRaw.toISOString() : null,
            hoursBefore
          });
          if (tracker.cancellationTimeline.length>200) tracker.cancellationTimeline.shift();
        },

        recordClassSwitch(booking){
          const tracker = this.state.analyticsTracker;
          if (!tracker) return;
          const createdAtRaw = booking.createdAt?.toDate ? booking.createdAt.toDate() : (booking.createdAt ? new Date(booking.createdAt) : null);
          tracker.switches.push({
            from: booking.previousClassId,
            to: booking.classId,
            when: createdAtRaw ? createdAtRaw.toISOString() : null
          });
          if (tracker.switches.length>200) tracker.switches.shift();
        },

        // --- NOTIFICATIONS ---
        listenRecentNotifications(){
          if (this.state.unsubRecentNotifs) this.state.unsubRecentNotifs();
          this.state.unsubRecentNotifs = this.db.collection('notifications')
            .orderBy('sentAt','desc').limit(10)
            .onSnapshot(async (snap)=>{
              const notifs = await Promise.all(snap.docs.map(async d=>{
                const data = d.data();
                const [cls, usr] = await Promise.all([
                  data.classId ? this.db.collection('classes').doc(data.classId).get() : Promise.resolve(null),
                  data.userId ? this.db.collection('users').doc(data.userId).get() : Promise.resolve(null)
                ]);
                return {
                  id: d.id,
                  ...data,
                  className: cls?.data()?.name || cls?.data()?.title || data.classId || '',
                  userName: usr?.data()?.displayName || usr?.data()?.email || data.userId || ''
                };
              }));
              this.state.recentNotifications = notifs;
              this.renderRecentNotifications();
            }, err=>{
              console.error(err);
              this.showToast({ title:'Error cargando notificaciones', message:err.message, variant:'error' });
            });
        },

          renderRecentNotifications(){
            const list = document.getElementById('recent-notifs');
            if (!list) return;
            if (!this.state.recentNotifications.length){
              list.innerHTML = '<li class="text-zinc-500">No hay notificaciones.</li>';
              return;
            }
            list.innerHTML = this.state.recentNotifications.map(n=>{
              const sent = n.sentAt?.toDate ? n.sentAt.toDate() : null;
              const when = sent ? `${this.dayShortFmt.format(sent)} ${this.timeFmt.format(sent)}` : '—';
              const safeWhen = DOMPurify.sanitize(when);
              const safeClass = DOMPurify.sanitize(n.className || n.classId || '');
              const safeUser = DOMPurify.sanitize(n.userName || n.userId || '');
              const safeType = DOMPurify.sanitize(n.type || 'Notificación');
              const safeTitle = DOMPurify.sanitize(n.title || '');
              const safeBody = DOMPurify.sanitize(n.body || '');
              const tokensUsed = Array.isArray(n.tokensUsed) ? n.tokensUsed : [];
              const successCount = typeof n.successCount === 'number' ? n.successCount : null;
              const failureCount = typeof n.failureCount === 'number' ? n.failureCount : null;
              const totalFromCounts = (successCount !== null || failureCount !== null)
                ? (Number(successCount || 0) + Number(failureCount || 0))
                : null;
              const totalDevicesRaw = Number.isFinite(n.totalTokens)
                ? n.totalTokens
                : (tokensUsed.length > 0 ? tokensUsed.length : (totalFromCounts ?? 0));
              const safeTotalDevices = DOMPurify.sanitize(String(totalDevicesRaw));
              const safeSuccess = successCount !== null ? DOMPurify.sanitize(String(successCount)) : '';
              const safeFailure = failureCount !== null ? DOMPurify.sanitize(String(failureCount)) : '';
              const infoLines = [];
              if (safeClass) infoLines.push(`<span class="text-xs text-zinc-300">Clase: ${safeClass}</span>`);
              if (safeUser) infoLines.push(`<span class="text-xs text-zinc-400">Usuario: ${safeUser}</span>`);
              if (n.interval){
                const safeInterval = DOMPurify.sanitize(`${n.interval}m`);
                infoLines.push(`<span class="text-xs text-zinc-500">Intervalo: ${safeInterval}</span>`);
              }
              const statsBadges = [];
              statsBadges.push(`<span class="px-2 py-1 rounded-md bg-zinc-900 text-xs text-zinc-200 border border-zinc-700">Dispositivos: ${safeTotalDevices}</span>`);
              if (successCount !== null){
                statsBadges.push(`<span class="px-2 py-1 rounded-md bg-emerald-500/10 text-xs text-emerald-400 border border-emerald-500/40">Éxitos: ${safeSuccess}</span>`);
              }
              if (failureCount !== null){
                statsBadges.push(`<span class="px-2 py-1 rounded-md bg-rose-500/10 text-xs text-rose-400 border border-rose-500/40">Fallos: ${safeFailure}</span>`);
              }
              const failedTokens = Array.isArray(n.failedTokens) ? n.failedTokens : [];
              const failedDetails = failedTokens.length ? (()=>{
                const safeFailedCount = DOMPurify.sanitize(String(failedTokens.length));
                const items = failedTokens.map(ft=>{
                  const tokenDisplay = ft?.token ? `${String(ft.token).substring(0,30)}…` : 'Token desconocido';
                  const safeTokenDisplay = DOMPurify.sanitize(tokenDisplay);
                  const safeError = DOMPurify.sanitize(ft?.errorCode || 'unknown');
                  return `<li class="py-2 border-t border-zinc-800 first:border-t-0">
                    <p class="text-xs text-zinc-300 font-mono break-all">${safeTokenDisplay}</p>
                    <p class="text-[11px] text-rose-400 mt-1">Error: ${safeError}</p>
                  </li>`;
                }).join('');
                return `<details class="mt-3 bg-zinc-900/60 rounded-lg border border-zinc-700/60">
                  <summary class="cursor-pointer px-3 py-2 text-xs text-zinc-200">Ver tokens fallidos (${safeFailedCount})</summary>
                  <ul class="px-3 pb-3">${items}</ul>
                </details>`;
              })() : '';
              const bodySection = safeBody ? `<p class="text-sm text-zinc-300">${safeBody}</p>` : '';
              const titleSection = safeTitle ? `<h4 class="text-sm font-semibold text-white">${safeTitle}</h4>` : '';
              const infoSection = infoLines.length ? `<div class="flex flex-wrap gap-3">${infoLines.join('')}</div>` : '';
              return `
                <li class="mb-3">
                  <div class="p-4 bg-zinc-700/50 rounded-lg border border-zinc-600/40 space-y-4">
                    <div class="flex flex-col gap-1">
                      <p class="text-[11px] uppercase tracking-wide text-zinc-400">${safeType}</p>
                      ${titleSection}
                      <p class="text-xs text-zinc-400">${safeWhen}</p>
                    </div>
                    ${bodySection}
                    ${infoSection}
                    <div class="flex flex-wrap gap-2">${statsBadges.join('')}</div>
                    ${failedDetails}
                  </div>
                </li>`;
            }).join('');
          },

        listenDailyMessages(){
          if (this.state.unsubDailyMessages) { this.state.unsubDailyMessages(); this.state.unsubDailyMessages = null; }
          this.state.unsubDailyMessages = this.db.collection('dailyMessages')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .onSnapshot(async (snap)=>{
              // We reuse cached user names to avoid repeated fetches.
              const cache = this.state.userCache instanceof Map ? this.state.userCache : new Map();
              this.state.userCache = cache;
              const messages = await Promise.all(snap.docs.map(async (doc)=>{
                const data = doc.data() || {};
                const message = { id: doc.id, ...data };
                const storedName = typeof data.createdByName === 'string' && data.createdByName.trim() ? data.createdByName.trim() : '';
                if (storedName) {
                  message.creatorName = storedName;
                  if (data.createdBy) cache.set(data.createdBy, storedName);
                  return message;
                }
                const uid = typeof data.createdBy === 'string' ? data.createdBy : '';
                if (!uid) {
                  message.creatorName = '';
                  return message;
                }
                if (cache.has(uid)) {
                  message.creatorName = cache.get(uid) || uid;
                  return message;
                }
                try {
                  const userSnap = await this.db.collection('users').doc(uid).get();
                  const userData = userSnap.exists ? userSnap.data() || {} : {};
                  const resolvedName = [userData.displayName, userData.name, userData.email].find(value => typeof value === 'string' && value.trim()) || '';
                  const finalName = resolvedName || uid;
                  cache.set(uid, finalName);
                  message.creatorName = finalName;
                } catch (fetchErr) {
                  // We fall back to the UID when the lookup fails.
                  console.warn('No se pudo resolver el nombre del usuario', fetchErr);
                  cache.set(uid, uid);
                  message.creatorName = uid;
                }
                return message;
              }));
              this.state.dailyMessages = messages;
              this.renderDailyMessages();
            }, err=>{
              console.error(err);
              this.showToast({ title:'Error cargando mensajes diarios', message: err.message, variant:'error' });
            });
        },

        renderDailyMessages(){
          const list = document.getElementById('daily-messages-list');
          if (!list) return;
          if (!this.state.dailyMessages.length){
            list.innerHTML = '<p class="text-sm text-zinc-400">No hay mensajes guardados.</p>';
            return;
          }
          list.innerHTML = this.state.dailyMessages.map(msg=>{
            const safeId = DOMPurify.sanitize(msg.id || '');
            const sanitized = DOMPurify.sanitize(msg.message || '');
            const formatted = sanitized.replace(/\n/g,'<br>') || '<span class="text-zinc-400">(Sin contenido)</span>';
            const createdAt = msg.createdAt?.toDate ? msg.createdAt.toDate() : null;
            const createdLabel = createdAt ? `${this.dayShortFmt.format(createdAt)} ${this.timeFmt.format(createdAt)}` : 'Sin fecha';
            const safeCreated = DOMPurify.sanitize(createdLabel);
            const rawCreator = typeof msg.creatorName === 'string' && msg.creatorName.trim()
              ? msg.creatorName
              : (msg.createdBy ? String(msg.createdBy) : '');
            const creator = rawCreator ? DOMPurify.sanitize(rawCreator) : '';
            const statusBadge = msg.isActive
              ? '<span class="px-2 py-1 rounded-md bg-emerald-500/20 text-emerald-300 text-xs">Activo</span>'
              : '<span class="px-2 py-1 rounded-md bg-zinc-700 text-zinc-300 text-xs">Inactivo</span>';
            const creatorLine = creator ? `<span class="text-xs text-zinc-500">Creado por: ${creator}</span>` : '';
            return `
              <article class="bg-zinc-900/60 border border-zinc-700 rounded-lg p-4 space-y-4">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1 space-y-2">
                    <p class="text-sm leading-relaxed text-zinc-100">${formatted}</p>
                    <div class="flex flex-wrap gap-3 text-xs text-zinc-400">
                      <span>${safeCreated}</span>
                      ${creatorLine}
                    </div>
                  </div>
                  ${statusBadge}
                </div>
                <div class="flex flex-wrap gap-2">
                  <button type="button" class="bg-zinc-700 hover:bg-zinc-600 text-white font-semibold py-1 px-3 rounded-md" data-daily-action="edit" data-id="${safeId}">Editar</button>
                  <button type="button" class="${msg.isActive ? 'bg-rose-600 hover:bg-rose-700' : 'bg-emerald-600 hover:bg-emerald-700'} text-white font-semibold py-1 px-3 rounded-md" data-daily-action="toggle" data-id="${safeId}" data-active="${msg.isActive?'true':'false'}">${msg.isActive ? 'Desactivar' : 'Activar'}</button>
                  <button type="button" class="bg-zinc-800 hover:bg-zinc-700 text-white font-semibold py-1 px-3 rounded-md" data-daily-action="delete" data-id="${safeId}">Eliminar</button>
                </div>
              </article>`;
          }).join('');
        },

        resetDailyMessageForm(){
          const idInput = document.getElementById('daily-message-id');
          const textArea = document.getElementById('daily-message-text');
          const activeInput = document.getElementById('daily-message-active');
          const statusEl = document.getElementById('daily-message-form-status');
          const submitBtn = document.getElementById('daily-message-submit');
          if (idInput) idInput.value = '';
          if (textArea) textArea.value = '';
          if (activeInput) activeInput.checked = true;
          if (statusEl){
            statusEl.textContent = '';
            statusEl.classList.add('hidden');
          }
          if (submitBtn) submitBtn.textContent = 'Guardar Mensaje';
        },

        populateDailyMessageForm(msg){
          const idInput = document.getElementById('daily-message-id');
          const textArea = document.getElementById('daily-message-text');
          const activeInput = document.getElementById('daily-message-active');
          const statusEl = document.getElementById('daily-message-form-status');
          const submitBtn = document.getElementById('daily-message-submit');
          if (!idInput || !textArea || !activeInput || !submitBtn) return;
          if (!msg){
            this.resetDailyMessageForm();
            return;
          }
          idInput.value = msg.id || '';
          textArea.value = msg.message || '';
          activeInput.checked = !!msg.isActive;
          if (submitBtn) submitBtn.textContent = 'Actualizar Mensaje';
          if (statusEl){
            const createdAt = msg.createdAt?.toDate ? msg.createdAt.toDate() : null;
            const label = createdAt ? `${this.dayShortFmt.format(createdAt)} ${this.timeFmt.format(createdAt)}` : 'Sin fecha';
            statusEl.textContent = `Editando mensaje (${label})`;
            statusEl.classList.remove('hidden');
          }
        },

        handleDailyMessageListClick(event){
          const btn = event.target.closest('[data-daily-action]');
          if (!btn) return;
          const id = btn.dataset.id;
          if (!id) return;
          const action = btn.dataset.dailyAction;
          if (action === 'edit'){
            const msg = this.state.dailyMessages.find(m=>m.id===id);
            if (msg) this.populateDailyMessageForm(msg);
          } else if (action === 'toggle'){
            const active = btn.dataset.active === 'true';
            this.toggleDailyMessage(id, active);
          } else if (action === 'delete'){
            const confirmed = window.confirm('¿Eliminar este mensaje? Esta acción no se puede deshacer.');
            if (confirmed) this.deleteDailyMessage(id);
          }
        },

        async toggleDailyMessage(id, currentlyActive){
          try{
            await this.db.collection('dailyMessages').doc(id).update({
              isActive: !currentlyActive,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            this.showToast({ title: !currentlyActive ? 'Mensaje activado' : 'Mensaje desactivado' });
          }catch(err){
            console.error(err);
            this.showToast({ title:'Error actualizando mensaje', message: err.message, variant:'error' });
          }
        },

        async deleteDailyMessage(id){
          try{
            await this.db.collection('dailyMessages').doc(id).delete();
            this.showToast({ title:'Mensaje eliminado' });
          }catch(err){
            console.error(err);
            this.showToast({ title:'Error eliminando mensaje', message: err.message, variant:'error' });
          }
        },

        async submitDailyMessage(event){
          event.preventDefault();
          const idInput = document.getElementById('daily-message-id');
          const textArea = document.getElementById('daily-message-text');
          const activeInput = document.getElementById('daily-message-active');
          if (!textArea || !activeInput) return;
          const docId = idInput?.value.trim();
          const message = textArea.value.trim();
          const isActive = !!activeInput.checked;
          if (!message){
            this.showToast({ title:'Escribe un mensaje', variant:'warn' });
            return;
          }
          const payload = {
            message,
            isActive,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          try{
            if (docId){
              await this.db.collection('dailyMessages').doc(docId).update(payload);
              this.showToast({ title:'Mensaje actualizado' });
            } else {
              const createData = {
                ...payload,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: this.auth.currentUser?.uid || '',
                createdByName: this.auth.currentUser?.displayName || this.auth.currentUser?.email || ''
              };
              await this.db.collection('dailyMessages').add(createData);
              this.showToast({ title:'Mensaje creado' });
            }
            this.resetDailyMessageForm();
          }catch(err){
            console.error(err);
            this.showToast({ title:'Error guardando mensaje', message: err.message, variant:'error' });
          }
        },

        // --- GENERACIÓN (startAt/endAt) ---
        _buildStartEnd(dateStr, timeStr, duration=60){
          const start = new Date(`${dateStr}T${timeStr}:00-06:00`);
          const end = new Date(start.getTime() + (Number(duration||60)*60000));
          return {
            startAt: firebase.firestore.Timestamp.fromDate(start),
            endAt: firebase.firestore.Timestamp.fromDate(end),
            classDate: start.toISOString().slice(0,10),
            timeUTC: start.toISOString().slice(11,16)
          };
        },

        async generateDailyClasses(){
          if (!Object.keys(this.state.weeklySchedule).length) {
            this.showToast({ title:'Plantilla no cargada', variant:'warn' });
            return;
          }

          // We anchor the calculation to midnight in Mexico City time to avoid timezone drift.
          const todayLocalStr = this.dateHelper.today();
          const localMidnight = new Date(`${todayLocalStr}T00:00:00-06:00`);
          const todayDow = localMidnight.getUTCDay();
          const daysUntilSaturday = (6 - todayDow + 7) % 7;

          const days = [];
          for (let offset = 0; offset <= daysUntilSaturday; offset++) {
            const cursor = new Date(localMidnight.getTime() + (offset * 86400000));
            const dateStr = cursor.toISOString().slice(0,10);
            days.push({ dateStr, dow: cursor.getUTCDay() });
          }

          if (!days.length) {
            this.showToast({ title:'Sin rango válido', variant:'warn' });
            return;
          }

          const batch = this.db.batch();
          let created = 0;
          const createdList = [];

          for (const d of days){
            const tpl = this.state.weeklySchedule[String(d.dow)] || [];
            if (!tpl.length) continue;

            // We only compare against classes stored for the same calendar day.
            const existingSnap = await this.db.collection('classes')
              .where('classDate','==', d.dateStr)
              .get();
            const existingKeys = new Set(existingSnap.docs.map(x => {
              const data = x.data();
              return `${data.classDate}|${data.time}`;
            }));

            for (const c of tpl){
              const { startAt, endAt, classDate, timeUTC } = this._buildStartEnd(d.dateStr, c.time, c.duration||60);
              const classKey = `${classDate}|${timeUTC}`;
              if (existingKeys.has(classKey)) continue;

              const ref = this.db.collection('classes').doc();
              const isTRX = /trx/i.test(c.name || "");
              const capacity = (typeof c.capacity === "number") ? c.capacity : (isTRX ? 13 : 15);
              batch.set(ref,{
                name: c.name,
                time: timeUTC,
                instructor: c.instructor || 'Por Asignar',
                duration: c.duration || 60,
                classDate,
                capacity,
                enrolledCount: 0,
                startAt,
                endAt,
                description:`Clase de ${c.name}`,
                image:`https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(c.name)}`
              });
              existingKeys.add(classKey);
              createdList.push({ date: d.dateStr, time: c.time, name: c.name });
              created++;
            }
          }

          if (created>0){
            await batch.commit();
            console.log('Clases generadas:', createdList);
            this.showToast({ title:'Clases generadas', message:`Se crearon ${created} clases` });
          } else {
            this.showToast({ title:'Horario al día', message:'No hay clases nuevas por crear', variant:'warn' });
          }
        },

        // --- RENDER ---
        renderAll(){ this.renderCalendarGrid(); this.renderDailyBookings(); },

        isClassRunningNow(cls){
          if (!cls || !cls.classDate || !cls.time) return false;
          const todayStr = this.dateHelper.today();
          if (cls.localDate !== todayStr) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00Z`).getTime();
          const end   = start + (Number(cls.duration||60)*60000);
          const now = Date.now();
          return now>=start && now<=end;
        },

        getLocalTimeParts(cls){
          if (!cls) return { hour:null, minutes:null };
          const localMatch = /^(\d{2}):(\d{2})/.exec(cls.localTime || '');
          if (localMatch){
            return { hour:Number(localMatch[1]), minutes:Number(localMatch[2]) };
          }
          if (cls.classDate && cls.time){
            const base = new Date(`${cls.classDate}T${cls.time}:00Z`);
            if (!Number.isNaN(base.getTime())){
              const parts = this.timePartsFmt.formatToParts(base);
              const hour = Number(parts.find(p=>p.type==='hour')?.value || '0');
              const minutes = Number(parts.find(p=>p.type==='minute')?.value || '0');
              if (!Number.isNaN(hour) && !Number.isNaN(minutes)){
                return { hour, minutes };
              }
            }
          }
          return { hour:null, minutes:null };
        },

        getCalendarDayContainers(){
          return {
            1: document.getElementById('monday-grid'),
            2: document.getElementById('tuesday-grid'),
            3: document.getElementById('wednesday-grid'),
            4: document.getElementById('thursday-grid'),
            5: document.getElementById('friday-grid'),
            6: document.getElementById('saturday-grid'),
            0: document.getElementById('sunday-grid')
          };
        },

        highlightTodayColumn(){
          const todayStr = this.dateHelper.today();
          const today = new Date(`${todayStr}T00:00:00-06:00`);
          const dow = Number.isNaN(today.getTime()) ? -1 : today.getUTCDay();
          const headerOrder = [1, 2, 3, 4, 5, 6, 0];
          const headerLabels = document.querySelectorAll('.calendar-header .day-label');
          headerLabels.forEach((label, index) => {
            const labelDay = headerOrder[index] ?? null;
            if (dow >= 0 && labelDay === dow) label.classList.add('today-label');
            else label.classList.remove('today-label');
          });
          document.querySelectorAll('.day-grid').forEach(grid => {
            const index = Number(grid.dataset.dayIndex);
            if (index === dow){ grid.classList.add('today-column'); }
            else { grid.classList.remove('today-column'); }
          });
        },

        // Keeps the current-time indicator aligned with the Mexico City schedule.
        updateCurrentTimeIndicator(){
          const calendarGrid = document.querySelector('.calendar-grid');
          if (!calendarGrid) return;

          const existing = calendarGrid.querySelector('.current-time-line');
          if (existing) existing.remove();

          const todayStr = this.dateHelper.today();
          if (!todayStr) return;

          const today = new Date(`${todayStr}T00:00:00-06:00`);
          const dow = Number.isNaN(today.getTime()) ? null : today.getUTCDay();
          const timeParts = this.timePartsFmt.formatToParts(new Date());
          const hourPart = timeParts.find(p => p.type === 'hour');
          const minutePart = timeParts.find(p => p.type === 'minute');
          const hour = hourPart ? Number(hourPart.value) : NaN;
          const minutes = minutePart ? Number(minutePart.value) : NaN;
          if (!Number.isFinite(hour) || !Number.isFinite(minutes)) return;

          const minutesFromStart = ((hour * 60) + minutes) - (this.calendarStartHour * 60);
          const totalMinutes = (this.calendarEndHour - this.calendarStartHour) * 60;
          if (minutesFromStart < 0 || minutesFromStart > totalMinutes) return;

          const hourHeightRaw = getComputedStyle(document.documentElement).getPropertyValue('--hour-height');
          const hourHeight = Number.parseFloat(hourHeightRaw) || 64;
          const offsetPx = (minutesFromStart / 60) * hourHeight;

          const line = document.createElement('div');
          line.className = 'current-time-line';
          line.style.top = `${offsetPx}px`;
          line.setAttribute('aria-hidden', 'true');
          if (dow !== null){
            const dayContainers = this.getCalendarDayContainers();
            const todayContainer = dayContainers[dow];
            if (todayContainer){
              const gridRect = calendarGrid.getBoundingClientRect();
              const dayRect = todayContainer.getBoundingClientRect();
              const dotOffset = dayRect && gridRect ? (dayRect.left - gridRect.left) + (dayRect.width / 2) : 12;
              line.style.setProperty('--current-time-indicator-x', `${Math.max(dotOffset, 12)}px`);
            }
          }

          calendarGrid.appendChild(line);
        },

        ensureCurrentTimeTicker(){
          if (this.currentTimeTicker) return;
          this.currentTimeTicker = setInterval(() => {
            this.highlightTodayColumn();
            this.updateCurrentTimeIndicator();
          }, 60000);
        },

        stopCurrentTimeTicker(){
          if (this.currentTimeTicker){
            clearInterval(this.currentTimeTicker);
            this.currentTimeTicker = null;
          }
          const calendarGrid = document.querySelector('.calendar-grid');
          if (calendarGrid){
            const indicator = calendarGrid.querySelector('.current-time-line');
            if (indicator) indicator.remove();
          }
        },

        renderCalendarGrid(){
          const headerLabels = document.querySelectorAll('.calendar-header .day-label');
          if (headerLabels.length){
            const fallbackLabels = ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo'];
            headerLabels.forEach((label, index) => {
              const labelText = this.formatWeekdayLabel(this.state.weekDates[index]) || fallbackLabels[index] || label.textContent;
              label.textContent = labelText;
            });
          }

          const dayContainers = this.getCalendarDayContainers();

          const dayEvents = {};
          Object.values(dayContainers).forEach(container => {
            if (container){
              container.innerHTML = '';
              container.classList.remove('today-column');
            }
          });

          const sorted = [...this.state.classes].sort((a,b)=>{
            const sa = new Date(`${a.classDate}T${a.time}:00Z`).getTime();
            const sb = new Date(`${b.classDate}T${b.time}:00Z`).getTime();
            return sa - sb;
          });

          const START_HOUR = this.calendarStartHour;
          const END_HOUR = this.calendarEndHour;
          const TOTAL_MINUTES = Math.max((END_HOUR - START_HOUR) * 60, 1);
          const hourHeight = Number.parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hour-height')) || 64;

          for (const cls of sorted){
            const localDateStr = cls.localDate || cls.classDate;
            if (!localDateStr) continue;
            const localDate = new Date(`${localDateStr}T00:00:00`);
            const dayOfWeek = Number.isNaN(localDate.getTime()) ? null : localDate.getDay();
            const container = dayOfWeek !== null ? dayContainers[dayOfWeek] : null;
            if (!container) continue;

            const startDate = new Date(`${cls.classDate}T${cls.time}:00Z`);
            if (Number.isNaN(startDate.getTime())) continue;
            const durationRaw = Number(cls.duration || 60);
            const durationMinutes = Number.isFinite(durationRaw) ? durationRaw : 60;
            const { hour, minutes } = this.getLocalTimeParts(cls);
            if (hour === null || minutes === null) continue;
            const startMinutesFromStart = ((hour * 60) + minutes) - (START_HOUR * 60);
            const event = {
              cls,
              startMs: startDate.getTime(),
              endMs: startDate.getTime() + (durationMinutes * 60000),
              durationMinutes,
              startMinutesFromStart,
              column: 0,
              overlapSpan: 1
            };
            if (!dayEvents[dayOfWeek]) dayEvents[dayOfWeek] = [];
            dayEvents[dayOfWeek].push(event);
          }

          Object.entries(dayContainers).forEach(([dayKey, container]) => {
            if (!container) return;
            const events = (dayEvents[dayKey] || []).sort((a,b)=>a.startMs - b.startMs);
            if (!events.length){
              container.innerHTML = '<div class="empty-day-message">Sin clases</div>';
              return;
            }

            const columns = [];
            const active = [];
            events.forEach(event => {
              for (let i = active.length - 1; i >= 0; i--){
                if (active[i].endMs <= event.startMs){ active.splice(i,1); }
              }
              let columnIndex = columns.findIndex(end => end <= event.startMs);
              if (columnIndex === -1){
                columnIndex = columns.length;
                columns.push(event.endMs);
              } else {
                columns[columnIndex] = event.endMs;
              }
              event.column = columnIndex;
              event.overlapSpan = Math.max(active.length + 1, 1);
              active.push(event);
              const overlapSize = active.length;
              active.forEach(item => {
                item.overlapSpan = Math.max(item.overlapSpan || 1, overlapSize);
              });
            });

            const fragment = document.createDocumentFragment();
            events.forEach(event => {
              const { cls } = event;
              const eventStart = event.startMinutesFromStart;
              const eventEnd = event.startMinutesFromStart + event.durationMinutes;
              const visibleStart = Math.max(eventStart, 0);
              const visibleEnd = Math.min(eventEnd, TOTAL_MINUTES);
              if (visibleEnd <= 0 || visibleStart >= TOTAL_MINUTES) return;

              const topPx = (visibleStart / 60) * hourHeight;
              const heightPx = Math.max(((visibleEnd - visibleStart) / 60) * hourHeight, 34);
              const widthPercent = 100 / Math.max(event.overlapSpan || 1, 1);
              const leftPercent = widthPercent * event.column;

              const block = document.createElement('div');
              block.className = 'class-block';
              if (this.isClassRunningNow(cls)) block.classList.add('running');
              block.style.top = `${topPx}px`;
              block.style.height = `${heightPx}px`;
              block.style.left = `calc(${leftPercent}% + 3px)`;
              block.style.width = `calc(${widthPercent}% - 6px)`;
              block.setAttribute('role','button');
              block.tabIndex = 0;

              const enrolled = Number(cls.enrolledCount || 0);
              const capacity = Number(cls.capacity || 0);
              const safeName = DOMPurify.sanitize(cls.name || '');
              const safeInstructor = DOMPurify.sanitize(cls.instructor || '');
              const startLabel = DOMPurify.sanitize(this.timeFmt.format(new Date(event.startMs)));
              const endLabel = DOMPurify.sanitize(this.timeFmt.format(new Date(event.endMs)));
              const capacityClass = enrolled >= capacity && capacity > 0 ? 'text-rose-200' : 'text-emerald-200';
              block.setAttribute('aria-label', `Editar ${safeName} de ${startLabel} a ${endLabel}`);

              block.innerHTML = `
                <div class="class-meta">
                  <strong class="text-sm text-white leading-tight">${safeName} (${startLabel} - ${endLabel})</strong>
                </div>
                <span class="text-xs font-semibold ${capacityClass}">${safeInstructor || 'Instructor por asignar'} - ${enrolled} / ${capacity || '—'}</span>
              `;
              block.onclick = () => this.showClassModal(cls);
              block.onkeydown = (evt) => {
                if (evt.key === 'Enter' || evt.key === ' '){
                  evt.preventDefault();
                  this.showClassModal(cls);
                }
              };
              fragment.appendChild(block);
            });

            container.appendChild(fragment);
            if (!container.children.length){
              container.innerHTML = '<div class="empty-day-message">Sin clases</div>';
            }
          });

          this.highlightTodayColumn();
          this.updateCurrentTimeIndicator();
          this.ensureCurrentTimeTicker();
        },

        renderDailyBookings(){
          const dayContainers = {
            1: document.getElementById('monday-bookings-list'),
            2: document.getElementById('tuesday-bookings-list'),
            3: document.getElementById('wednesday-bookings-list'),
            4: document.getElementById('thursday-bookings-list'),
            5: document.getElementById('friday-bookings-list'),
            6: document.getElementById('saturday-bookings-list'),
            0: document.getElementById('sunday-bookings-list')
          };

          Object.values(dayContainers).forEach(container => {
            if (container) container.innerHTML = '';
          });

          const groupedByDay = {};
          const sorted = [...this.state.classes].sort((a,b)=>{
            const sa = new Date(`${a.classDate}T${a.time}:00Z`).getTime();
            const sb = new Date(`${b.classDate}T${b.time}:00Z`).getTime();
            return sa - sb;
          });

          for (const cls of sorted){
            const localDateStr = cls.localDate || cls.classDate;
            if (!localDateStr) continue;
            const localDate = new Date(`${localDateStr}T00:00:00`);
            const dayOfWeek = Number.isNaN(localDate.getTime()) ? null : localDate.getDay();
            if (dayOfWeek === null) continue;
            if (!groupedByDay[dayOfWeek]) groupedByDay[dayOfWeek] = [];
            groupedByDay[dayOfWeek].push(cls);
          }

          Object.entries(dayContainers).forEach(([dayKey, container]) => {
            if (!container) return;
            const classesArr = groupedByDay[dayKey] || [];
            if (!classesArr.length){
              container.innerHTML = '<p class="text-zinc-500 text-sm">No hay reservas.</p>';
              return;
            }

            const blocks = classesArr.map(cls=>{
              const attendees = this.state.bookingsMap.get(cls.id)||[];
              const waiters = (this.state.waitlistsMap.get(cls.id)||[])
                .sort((a,b)=>(a.position||0)-(b.position||0))
                .map(w=>w.userName||w.userId||'Anónimo');
              const enrolled = Number(cls.enrolledCount||0);
              const cap = Number(cls.capacity||0);
              const names = attendees.map(booking=>{
                const safeName = DOMPurify.sanitize(booking.userName || 'Anónimo');
                const manualBadge = booking.isManualBooking ? '<span class="ml-2 inline-flex items-center gap-1 text-emerald-300 text-xs" title="Reserva manual (WhatsApp)">📱</span>' : '';
                return `<li class="text-zinc-400 ml-4 flex items-center">- <span>${safeName}</span>${manualBadge}</li>`;
              }).join('');
              const waitNames = waiters.map(n=>`<li class="text-zinc-400 ml-4">- ${DOMPurify.sanitize(n)}</li>`).join('');
              const safeTime = DOMPurify.sanitize(cls.localTime || cls.time || '');
              const safeName = DOMPurify.sanitize(cls.name || '');
              const waitHTML = waiters.length ? `
                  <p class="text-sm text-amber-400 mt-2">Lista de espera (${waiters.length})</p>
                  <ul class="list-none">${waitNames}</ul>
              ` : '';
              return `
                <div class="mb-3">
                  <p class="font-bold">${safeTime} - ${safeName} (${enrolled} de ${cap})</p>
                  <ul class="list-none">${names}</ul>
                  ${waitHTML}
                </div>`;
            });

            container.innerHTML = blocks.join('') || '<p class="text-zinc-500 text-sm">No hay reservas.</p>';
          });
        },

        refreshAttendanceFilters(){
          const classFilter = document.getElementById('class-filter');
          const instructorFilter = document.getElementById('instructor-filter');
          if (!classFilter || !instructorFilter) return;
          const classTypes = new Set(['all']);
          const instructors = new Set(['all']);
          this.state.classes.forEach(cls=>{
            if (cls.type) classTypes.add(cls.type);
            else if (cls.category) classTypes.add(cls.category);
            if (cls.instructor) instructors.add(cls.instructor);
          });
          const classValue = classFilter.value || this.state.selectedClassType;
          const instructorValue = instructorFilter.value || this.state.selectedInstructor;
          classFilter.innerHTML = Array.from(classTypes).map(val=>{
            const safe = DOMPurify.sanitize(val);
            const label = val === 'all' ? 'Todas' : safe;
            const selected = val === classValue ? 'selected' : '';
            return `<option value="${safe}" ${selected}>${label}</option>`;
          }).join('');
          instructorFilter.innerHTML = Array.from(instructors).map(val=>{
            const safe = DOMPurify.sanitize(val);
            const label = val === 'all' ? 'Todos' : safe;
            const selected = val === instructorValue ? 'selected' : '';
            return `<option value="${safe}" ${selected}>${label}</option>`;
          }).join('');
          this.state.selectedClassType = classFilter.value;
          this.state.selectedInstructor = instructorFilter.value;
        },

        estimateClassRevenue(cls={}, quantity){
          const basePrice = Number(cls.price || this.DEFAULT_TICKET_PRICE || 120);
          return Math.round(Math.max(quantity,0) * basePrice);
        },

        calculateBookingVelocityScore(classId, seatsBooked){
          const tracker = this.state.analyticsTracker;
          if (!tracker || !tracker.bookingTimeline) return 0;
          const raw = tracker.bookingTimeline[classId] || [];
          if (!raw.length) return 0;
          const sorted = [...raw].sort((a,b)=>a-b);
          const first = sorted[0];
          const last = sorted[sorted.length-1];
          const hours = Math.max((last-first)/3600000, 1/12);
          const velocity = seatsBooked/Math.max(hours, 0.1);
          return Math.min(Math.round(velocity*15), 60);
        },

        calculateDaySnapshot({ day, base, classList, bookingsByClass, userStats, cancellationsByDay, aggregates }){
          const stats = userStats instanceof Map ? userStats : new Map();
          const snapshot = {
            ...base,
            booked: 0,
            totalCapacity: 0,
            utilizationRate: 0,
            revenue: 0,
            revenueTarget: 0,
            repeatBookings: 0,
            newMembers: 0,
            cancellations: cancellationsByDay?.[day] || 0,
            noShows: base.absent || 0,
            popularityScore: 0,
            instructorMetrics: {},
            peakHours: {},
            memberRetention: 0,
            details: { ...base.details, booked:{} }
          };
          let popularityAccumulator = 0;
          let classesConsidered = 0;
          const filterType = this.state.selectedClassType;
          const filterInstructor = this.state.selectedInstructor;
          const weekdayShort = this.formatWeekdayShortLabel(day);
          classList.forEach(cls=>{
            if (!cls) return;
            const matchesType = filterType === 'all'
              || cls.type === filterType
              || cls.category === filterType;
            const matchesInstructor = filterInstructor === 'all'
              || (cls.instructor === filterInstructor);
            if (!matchesType || !matchesInstructor) return;
            classesConsidered++;
            const liveBookings = this.state.bookingsMap.get(cls.id) || [];
            const storedBookings = bookingsByClass?.[cls.id] || [];
            const rosterSource = liveBookings.length ? liveBookings : storedBookings;
            const labelTime = cls.localTime || cls.time || '';
            const labelName = cls.name || 'Clase';
            const label = `${labelTime} - ${labelName}`.trim();
            const rosterNames = rosterSource.map(x=>DOMPurify.sanitize(x.userName || x.userEmail || x.userId || 'Anónimo'));
            if (rosterNames.length) snapshot.details.booked[label] = rosterNames;
            const capacity = Number(cls.capacity||0);
            snapshot.totalCapacity += capacity;
            snapshot.booked += rosterSource.length;
            snapshot.revenue += this.estimateClassRevenue(cls, rosterSource.length);
            snapshot.revenueTarget += this.estimateClassRevenue(cls, capacity);
            const hourLabel = labelTime ? labelTime.slice(0,5) : 'N/D';
            snapshot.peakHours[hourLabel] = (snapshot.peakHours[hourLabel]||0) + rosterSource.length;
            const instructor = cls.instructor || 'Sin asignar';
            if (!snapshot.instructorMetrics[instructor]){
              snapshot.instructorMetrics[instructor] = { classes:0, attendees:0, utilizationSum:0 };
            }
            snapshot.instructorMetrics[instructor].classes++;
            snapshot.instructorMetrics[instructor].attendees += rosterSource.length;
            const utilizationPct = capacity ? (rosterSource.length/Math.max(capacity,1))*100 : 0;
            snapshot.instructorMetrics[instructor].utilizationSum += utilizationPct;
            let classRepeats = 0;
            let classNew = 0;
            rosterSource.forEach(rec=>{
              const userKey = rec.userId || rec.userEmail || rec.userName || rec.id;
              const stat = stats.get ? stats.get(userKey) : undefined;
              if (!stat) return;
              if (stat.count>1 && stat.firstDate && stat.firstDate < day) classRepeats++;
              else if (stat.count===1 && stat.firstDate === day) classNew++;
            });
            snapshot.repeatBookings += classRepeats;
            snapshot.newMembers += classNew;
            const basePopularity = capacity ? (rosterSource.length/Math.max(capacity,1))*100 : rosterSource.length*5;
            const velocityScore = this.calculateBookingVelocityScore(cls.id, rosterSource.length);
            const classScore = Math.round(basePopularity + velocityScore);
            popularityAccumulator += classScore;
            if (aggregates?.classPopularity){
              if (!aggregates.classPopularity.has(cls.id)){
                aggregates.classPopularity.set(cls.id,{ id:cls.id, label, instructor, totalScore:0, occurrences:0, weekdays:new Set() });
              }
              const entry = aggregates.classPopularity.get(cls.id);
              if (!entry.weekdays || !(entry.weekdays instanceof Set)){
                entry.weekdays = new Set(entry.weekdays ? [].concat(entry.weekdays) : []);
              }
              entry.totalScore += classScore;
              entry.occurrences += 1;
              if (weekdayShort){
                entry.weekdays.add(weekdayShort);
              }
            }
          });
          if (classesConsidered>0){
            snapshot.popularityScore = Math.round(popularityAccumulator/classesConsidered);
            Object.values(snapshot.instructorMetrics).forEach(metrics=>{
              metrics.utilization = metrics.classes ? Math.round(metrics.utilizationSum/metrics.classes) : 0;
            });
          } else {
            snapshot.popularityScore = 0;
          }
          snapshot.utilizationRate = snapshot.totalCapacity>0 ? Math.round((snapshot.booked/Math.max(snapshot.totalCapacity,1))*100) : 0;
          if (snapshot.utilizationRate>85) snapshot.warning='Capacidad crítica';
          else if (snapshot.utilizationRate>60) snapshot.warning='Capacidad alta';
          else snapshot.warning='Capacidad estable';
          snapshot.memberRetention = snapshot.booked>0 ? Math.round((snapshot.repeatBookings/Math.max(snapshot.booked,1))*100) : 0;
          if (aggregates){
            aggregates.heatmap[day] = snapshot.peakHours;
            aggregates.totals.revenue += snapshot.revenue;
            aggregates.totals.target += snapshot.revenueTarget;
            aggregates.totals.repeat += snapshot.repeatBookings;
            aggregates.totals.newMembers += snapshot.newMembers;
            aggregates.totals.cancellations += snapshot.cancellations;
            aggregates.totals.noShows += snapshot.noShows;
            Object.entries(snapshot.instructorMetrics).forEach(([name,metrics])=>{
              if (!aggregates.instructorTotals[name]){
                aggregates.instructorTotals[name] = { classes:0, attendees:0, utilizationSum:0 };
              }
              aggregates.instructorTotals[name].classes += metrics.classes;
              aggregates.instructorTotals[name].attendees += metrics.attendees;
              aggregates.instructorTotals[name].utilizationSum += metrics.utilizationSum;
            });
          }
          return snapshot;
        },

        aggregateReportByPeriod(dataCache, period){
          const { report, labels } = dataCache;
          if (period === 'range' || period === 'daily'){
            return labels.map(l=>({ label:l.label, key:l.date, data: report[l.date] }));
          }
          const grouped = new Map();
          labels.forEach(l=>{
            const baseDate = new Date(`${l.date}T00:00:00-06:00`);
            if (Number.isNaN(baseDate.getTime())) return;
            let key = l.date;
            let labelTxt = l.label;
            if (period === 'weekly'){
              const monday = new Date(baseDate);
              const day = monday.getDay();
              const diff = day === 0 ? 6 : day-1;
              monday.setDate(monday.getDate()-diff);
              const sunday = new Date(monday);
              sunday.setDate(monday.getDate()+6);
              key = `${monday.toISOString().slice(0,10)}_${sunday.toISOString().slice(0,10)}`;
              labelTxt = `${this.dayShortFmt.format(monday)} - ${this.dayShortFmt.format(sunday)}`;
            } else if (period === 'monthly'){
              key = `${baseDate.getFullYear()}-${String(baseDate.getMonth()+1).padStart(2,'0')}`;
              labelTxt = baseDate.toLocaleString('es-MX',{ month:'short', year:'numeric' });
            }
            if (!grouped.has(key)){
              grouped.set(key,{ label:labelTxt, keys:[], data:{ attended:0, absent:0, booked:0, totalCapacity:0, revenue:0, revenueTarget:0, repeatBookings:0, newMembers:0, cancellations:0, noShows:0, popularityScore:0 } });
            }
            const bucket = grouped.get(key);
            bucket.keys.push(l.date);
            const dayData = report[l.date];
            ['attended','absent','booked','totalCapacity','revenue','revenueTarget','repeatBookings','newMembers','cancellations','noShows'].forEach(field=>{
              bucket.data[field] += dayData?.[field] || 0;
            });
            bucket.data.popularityScore += dayData?.popularityScore || 0;
          });
          return Array.from(grouped.values()).map(bucket=>{
            const count = bucket.keys.length || 1;
            bucket.data.popularityScore = Math.round(bucket.data.popularityScore/count);
            bucket.data.utilizationRate = bucket.data.totalCapacity>0 ? Math.round((bucket.data.booked/Math.max(bucket.data.totalCapacity,1))*100) : 0;
            bucket.data.memberRetention = bucket.data.booked>0 ? Math.round((bucket.data.repeatBookings/Math.max(bucket.data.booked,1))*100) : 0;
            return { label: bucket.label, key: bucket.keys[0], data: bucket.data };
          });
        },

        buildAttendanceAggregates({ labels, report, aggregateContext, userStats }){
          const popularity = Array.from(aggregateContext.classPopularity.values()).map(entry=>{
            const avgScore = entry.occurrences ? Math.round(entry.totalScore/entry.occurrences) : 0;
            const weekdayList = entry.weekdays instanceof Set
              ? Array.from(entry.weekdays)
              : Array.isArray(entry.weekdays)
                ? [...entry.weekdays]
                : [];
            weekdayList.sort((a,b)=>a.localeCompare(b,'es'));
            return { id: entry.id, label: entry.label, score: avgScore, instructor: entry.instructor, weekdays: weekdayList };
          }).sort((a,b)=>b.score-a.score);
          const instructorMetrics = {};
          Object.entries(aggregateContext.instructorTotals).forEach(([name,metrics])=>{
            instructorMetrics[name] = {
              classes: metrics.classes,
              attendees: metrics.attendees,
              avgUtilization: metrics.classes ? Math.round(metrics.utilizationSum/metrics.classes) : 0
            };
          });
          const totals = aggregateContext.totals;
          const retentionRate = Math.round((totals.repeat/Math.max(totals.repeat + totals.newMembers,1))*100);
          const revenueSeries = labels.map(l=>({
            date: l.date,
            revenue: report[l.date]?.revenue || 0,
            target: report[l.date]?.revenueTarget || 0
          }));
          const behavior = {
            cancellationTimeline: [...(this.state.analyticsTracker?.cancellationTimeline || [])],
            switches: [...(this.state.analyticsTracker?.switches || [])]
          };
          const bi = {
            lifetimeValue: this.calculateMemberLifetimeValue({ userStats }),
            classProfitability: this.analyzeClassProfitability(popularity, report),
            optimalScheduling: this.recommendOptimalScheduling(report),
            capacityVsDemand: this.calculateCapacityVsDemand(report),
            instructorUtilization: this.calculateInstructorUtilization(instructorMetrics)
          };
          return {
            totals,
            instructorMetrics,
            popularity,
            heatmap: aggregateContext.heatmap,
            retention: { newMembers: totals.newMembers, repeatMembers: totals.repeat, retentionRate },
            revenueSeries,
            behavior,
            bi
          };
        },

        destroyAttendanceCharts(){
          if (!this.state.attendanceCharts) this.state.attendanceCharts = {};
          Object.values(this.state.attendanceCharts).forEach(chart=>{
            try{ chart?.destroy?.(); }catch{}
          });
          this.state.attendanceCharts = {};
        },

        renderCapacityHeatmap(heatmapData){
          const container = document.getElementById('capacity-heatmap');
          if (!container) return;
          const dayEntries = Object.entries(heatmapData || {});
          if (!dayEntries.length){
            container.innerHTML = '<p class="text-zinc-500">Sin datos de horario.</p>';
            return;
          }
          const hours = new Set();
          dayEntries.forEach(([,hoursObj])=>{
            Object.keys(hoursObj || {}).forEach(h=>hours.add(h));
          });
          const hourList = Array.from(hours).sort();
          const maxVal = Math.max(...dayEntries.flatMap(([,hoursObj])=>Object.values(hoursObj || {})), 1);
          const columns = hourList.length + 1;
          const rows = [];
          const header = ['<div class="font-semibold">Día</div>', ...hourList.map(h=>`<div class="text-center">${DOMPurify.sanitize(h)}</div>`)];
          const gridStyle = `style="display:grid;grid-template-columns:repeat(${columns},minmax(0,1fr));gap:0.25rem;"`;
          rows.push(`<div ${gridStyle}>${header.join('')}</div>`);
          dayEntries.sort(([a],[b])=>a.localeCompare(b)).forEach(([day, hoursObj])=>{
            const labelDate = new Date(`${day}T00:00:00-06:00`);
            const dayLabel = Number.isNaN(labelDate.getTime()) ? day : this.dayShortFmt.format(labelDate);
            const cells = [`<div class="text-zinc-400">${DOMPurify.sanitize(dayLabel)}</div>`];
            hourList.forEach(h=>{
              const value = hoursObj?.[h] || 0;
              const intensity = Math.min(1, value/Math.max(maxVal,1));
              const bg = `rgba(129,140,248,${(0.15 + intensity*0.75).toFixed(2)})`;
              cells.push(`<div class="text-center rounded-sm" style="background:${bg}">${value}</div>`);
            });
            rows.push(`<div ${gridStyle}>${cells.join('')}</div>`);
          });
          container.innerHTML = rows.join('');
        },

        renderAttendanceDashboardFromCache(){
          const trendCtx = document.getElementById('attendanceTrendChart')?.getContext('2d');
          const revenueCtx = document.getElementById('revenueChart')?.getContext('2d');
          const retentionCtx = document.getElementById('retentionChart')?.getContext('2d');
          const popularityCtx = document.getElementById('popularityChart')?.getContext('2d');
          const details = document.getElementById('attendance-details');
          const loadingEl = document.getElementById('dashboard-loading');
          if (loadingEl) loadingEl.classList.add('hidden');
          if (!trendCtx || !details){ return; }
          const dataCache = this.state.attendanceData;
          if (!dataCache){
            details.innerHTML = `<div class="bg-zinc-900 p-3 rounded-md text-zinc-400">Cargando reporte… se actualizará automáticamente.</div>`;
            return;
          }
          this.injectBookingsIntoReport();
          const periodBuckets = this.aggregateReportByPeriod(dataCache, this.state.selectedPeriod);
          if (!periodBuckets.length){
            this.destroyAttendanceCharts();
            details.innerHTML = `<div class="bg-zinc-900 p-3 rounded-md text-zinc-400">No hay datos en el rango seleccionado.</div>`;
            this.renderCapacityHeatmap({});
            return;
          }
          const labels = periodBuckets.map(b=>b.label);
          const metrics = periodBuckets.map(b=>b.data);
          const selected = this.state.selectedMetrics || new Set();
          const datasets = [];
          if (selected.has('attended')){
            datasets.push({ label:'Asistencias', data: metrics.map(m=>m.attended||0), backgroundColor:'rgba(16,185,129,0.6)', stack:'counts' });
          }
          if (selected.has('absent')){
            datasets.push({ label:'Ausencias', data: metrics.map(m=>m.absent||0), backgroundColor:'rgba(244,63,94,0.6)', stack:'counts' });
          }
          if (selected.has('booked')){
            datasets.push({ label:'Reservas', data: metrics.map(m=>m.booked||0), backgroundColor:'rgba(59,130,246,0.6)', stack:'counts' });
          }
          if (selected.has('utilization')){
            datasets.push({ label:'Utilización %', data: metrics.map(m=>m.utilizationRate||0), type:'line', yAxisID:'y1', borderColor:'#a855f7', tension:0.2, fill:false, pointBackgroundColor:'#a855f7' });
          }
          if (selected.has('revenue')){
            datasets.push({ label:'Ingresos', data: metrics.map(m=>m.revenue||0), type:'line', yAxisID:'y2', borderColor:'#fbbf24', tension:0.2, fill:false, pointBackgroundColor:'#fbbf24' });
          }
          this.destroyAttendanceCharts();
          this.state.attendanceCharts.trend = new Chart(trendCtx, {
            type:'bar',
            data:{ labels, datasets },
            options:{
              responsive:true,
              scales:{
                x:{ stacked:true, ticks:{ color:'#d4d4d8' }, grid:{ color:'#3f3f46' } },
                y:{ stacked:true, ticks:{ color:'#a1a1aa' }, grid:{ color:'#3f3f46' } },
                y1:{ position:'right', beginAtZero:true, ticks:{ color:'#c4b5fd', callback:v=>v+'%' }, grid:{ drawOnChartArea:false } },
                y2:{ position:'right', beginAtZero:true, ticks:{ color:'#facc15', callback:v=>`$${v}` }, grid:{ drawOnChartArea:false } }
              },
              plugins:{ legend:{ labels:{ color:'#e4e4e7' } } }
            }
          });

          if (revenueCtx){
            const revenueSeries = dataCache.aggregates?.revenueSeries || [];
            const revenueLabels = revenueSeries.map(r=>{
              const dateObj = new Date(`${r.date}T00:00:00-06:00`);
              return Number.isNaN(dateObj.getTime()) ? (r.date || '') : this.dayShortFmt.format(dateObj);
            });
            this.state.attendanceCharts.revenue = new Chart(revenueCtx, {
              type:'bar',
              data:{
                labels: revenueLabels,
                datasets:[
                  { label:'Ingresos', data: revenueSeries.map(r=>r.revenue), backgroundColor:'rgba(34,197,94,0.7)' },
                  { label:'Meta', data: revenueSeries.map(r=>r.target), backgroundColor:'rgba(244,114,182,0.4)' }
                ]
              },
              options:{
                responsive:true,
                scales:{ x:{ ticks:{ color:'#d4d4d8' }, grid:{ color:'#3f3f46' } }, y:{ ticks:{ color:'#a1a1aa', callback:v=>`$${v}` }, grid:{ color:'#3f3f46' } } },
                plugins:{ legend:{ labels:{ color:'#e4e4e7' } } }
              }
            });
          }

          if (retentionCtx){
            const retention = dataCache.aggregates?.retention || { newMembers:0, repeatMembers:0, retentionRate:0 };
            this.state.attendanceCharts.retention = new Chart(retentionCtx, {
              type:'bar',
              data:{
                labels:['Nuevos','Recurrentes','Retención %'],
                datasets:[{
                  data:[retention.newMembers, retention.repeatMembers, retention.retentionRate],
                  backgroundColor:['rgba(59,130,246,0.6)','rgba(16,185,129,0.6)','rgba(250,204,21,0.6)']
                }]
              },
              options:{
                responsive:true,
                scales:{ x:{ ticks:{ color:'#d4d4d8' }, grid:{ color:'#3f3f46' } }, y:{ beginAtZero:true, ticks:{ color:'#a1a1aa' }, grid:{ color:'#3f3f46' } } },
                plugins:{ legend:{ display:false } }
              }
            });
          }

          if (popularityCtx){
            const topClasses = (dataCache.aggregates?.popularity || []).slice(0,8);
            const popularityLabels = topClasses.map(item=>{
              const days = Array.isArray(item.weekdays) ? item.weekdays.filter(Boolean) : [];
              const suffix = days.length ? ` (${days.join(', ')})` : '';
              return `${item.label}${suffix}`;
            });
            this.state.attendanceCharts.popularity = new Chart(popularityCtx, {
              type:'bar',
              data:{
                labels: popularityLabels,
                datasets:[{
                  label:'Popularidad',
                  data: topClasses.map(item=>item.score),
                  backgroundColor:'rgba(129,140,248,0.7)'
                }]
              },
              options:{
                indexAxis:'y',
                scales:{ x:{ ticks:{ color:'#d4d4d8' }, grid:{ color:'#3f3f46' } }, y:{ ticks:{ color:'#d4d4d8' }, grid:{ color:'#3f3f46' } } },
                plugins:{ legend:{ display:false } }
              }
            });
          }

          this.renderCapacityHeatmap(dataCache.aggregates?.heatmap || {});

          const renderList = (obj)=>{
            const names = Object.keys(obj||{}).sort();
            if (!names.length) return '<ul class="list-disc list-inside text-zinc-400"><li>Nadie</li></ul>';
            return names.map(n=>{
              const people = (obj[n]||[]).map(p=>`<li>${DOMPurify.sanitize(p)}</li>`).join('');
              return `
                <div class="font-semibold text-zinc-300 mt-1">${DOMPurify.sanitize(n)}:</div>
                <ul class="list-disc list-inside text-zinc-400">${people}</ul>
              `;
            }).join('');
          };

          details.innerHTML = dataCache.labels.map(l=>{
            const d = dataCache.report[l.date];
            const warnColor = d.utilizationRate>85?'text-rose-400': d.utilizationRate>60?'text-amber-400':'text-emerald-400';
            const peak = Object.entries(d.peakHours||{}).sort((a,b)=>b[1]-a[1])[0];
            const peakLabel = peak ? `${peak[0]} (${peak[1]} asistentes)` : '—';
            return `
              <div class="bg-zinc-900 p-3 rounded-md">
                <h4 class="font-bold text-lg mb-2">${DOMPurify.sanitize(l.label)}</h4>
                <div class="font-semibold text-blue-400">Reservaron (${d.booked||0})</div>
                ${renderList(d.details.booked)}
                <div class="text-sm mt-2">Capacidad total: ${d.totalCapacity||0}</div>
                <div class="text-sm">Ingresos: $${d.revenue||0} / Meta $${d.revenueTarget||0}</div>
                <div class="text-sm">Retención: ${d.memberRetention||0}%</div>
                <div class="${warnColor} text-sm">${DOMPurify.sanitize(d.warning||'')}</div>
                <div class="text-sm mt-1">Hora pico: ${DOMPurify.sanitize(peakLabel)}</div>
                <div class="font-semibold text-emerald-400 mt-2">Asistieron (${d.attended||0})</div>
                ${renderList(d.details.attended)}
                <div class="font-semibold text-rose-400 mt-2">Faltaron (${d.absent||0})</div>
                ${renderList(d.details.absent)}
              </div>
            `;
          }).join('');
        },

        // ====== ASISTENCIA (POLLING CADA 15 MIN) ======
        getDefaultAttendanceRange(){
          const today = this.dateHelper.today();
          const end = new Date(`${today}T00:00:00-06:00`);
          const start = new Date(end);
          start.setDate(start.getDate()-2);
          return { start: this.dateHelper.ymd(start), end: this.dateHelper.ymd(end) };
        },
        getSelectedAttendanceRange(){
          const def = this.getDefaultAttendanceRange();
          const sEl = document.getElementById('att-start-date');
          const eEl = document.getElementById('att-end-date');
          let start = sEl?.value;
          let end = eEl?.value;
          if (!start || !end || start > end){
            start = def.start;
            end = def.end;
            if (sEl) sEl.value = start;
            if (eEl) eEl.value = end;
          }
          return { start, end };
        },

        startAttendancePolling(){
          this.fetchAttendanceData(true);
          this.stopAttendancePolling();
          this.state.unsubCapacity = this.db.collection('bookings').onSnapshot(()=>{
            this.fetchAttendanceData(true);
          });
          this.state.attendanceTickTimer = setInterval(()=>{ this.updateAttendanceLegend(); }, 1000);
        },
        stopAttendancePolling(){
          if (this.state.unsubCapacity){ this.state.unsubCapacity(); this.state.unsubCapacity=null; }
          if (this.state.attendanceTickTimer){ clearInterval(this.state.attendanceTickTimer); this.state.attendanceTickTimer=null; }
        },

        async fetchAttendanceData(){
          const loadingEl = document.getElementById('dashboard-loading');
          if (loadingEl) loadingEl.classList.remove('hidden');
          const now = Date.now();
          const { start, end } = this.getSelectedAttendanceRange();
          const report = {};
          const labels = [];
          const aggregateContext = {
            classPopularity: new Map(),
            heatmap: {},
            instructorTotals: {},
            totals: { revenue:0, target:0, repeat:0, newMembers:0, cancellations:0, noShows:0 }
          };
          const userStatsMap = new Map();
          const cancellationsByDay = {};
          const startDate = new Date(`${start}T00:00:00-06:00`);
          const endDate = new Date(`${end}T00:00:00-06:00`);
          for (let dt = new Date(startDate); dt <= endDate; dt.setDate(dt.getDate()+1)){
            const clone = new Date(dt);
            const dayKey = this.dateHelper.ymd(clone);
            report[dayKey] = {
              attended:0, absent:0, booked:0, totalCapacity:0, utilizationRate:0, warning:'',
              details:{ attended:{}, absent:{}, booked:{} },
              revenue:0, revenueTarget:0, repeatBookings:0, newMembers:0,
              cancellations:0, noShows:0, popularityScore:0,
              instructorMetrics:{}, peakHours:{}, memberRetention:0
            };
            labels.push({ date: dayKey, label: this.dayShortFmt.format(clone) });
          }
          try {
            const [attendanceSnap, classesSnap, bookingsSnap] = await Promise.all([
              this.db.collection('attendance')
                .where('classDate','>=',start)
                .where('classDate','<=',end)
                .get(),
              this.db.collection('classes')
                .where('classDate','>=',start)
                .where('classDate','<=',end)
                .get(),
              this.db.collection('bookings')
                .where('classDate','>=',start)
                .where('classDate','<=',end)
                .get()
            ]);

            attendanceSnap.forEach(doc=>{
              const rec = doc.data();
              if (!rec.classDate || !report[rec.classDate]) return;
              const cat = rec.status==='attended' ? 'attended' : 'absent';
              report[rec.classDate][cat]++;
              const labelBase = rec.classTime ?? rec.className ?? '';
              const key = `${labelBase} - ${rec.className || ''}`.trim();
              if (!report[rec.classDate].details[cat][key]) report[rec.classDate].details[cat][key] = [];
              report[rec.classDate].details[cat][key].push(rec.userName || rec.userId || 'Anónimo');
            });

            const classesByDay = {};
            classesSnap.forEach(doc=>{
              const data = { id:doc.id, ...doc.data() };
              if (!data.classDate || !report[data.classDate]) return;
              if (data.classDate && data.time){
                const startAt = new Date(`${data.classDate}T${data.time}:00Z`);
                data.localDate = this.dateHelper.ymd(startAt);
                data.localTime = this.timeFmt.format(startAt);
              }
              if (!classesByDay[data.classDate]) classesByDay[data.classDate] = [];
              classesByDay[data.classDate].push(data);
            });

            const listenerClassesByDay = {};
            this.state.classes.forEach(cls=>{
              const day = cls.localDate || cls.classDate;
              if (!day || !report[day]) return;
              if (!listenerClassesByDay[day]) listenerClassesByDay[day] = [];
              listenerClassesByDay[day].push({ ...cls });
            });

            const bookingsByClass = {};
            bookingsSnap.forEach(doc=>{
              const data = { id:doc.id, ...doc.data() };
              if (!data.classId) return;
              if (!bookingsByClass[data.classId]) bookingsByClass[data.classId] = [];
              bookingsByClass[data.classId].push(data);
              const userKey = data.userId || data.userEmail || data.userName || data.id;
              if (!userStatsMap.has(userKey)){
                userStatsMap.set(userKey,{ count:0, firstDate:data.classDate || '', revenue:0, cancellations:0 });
              }
              const stat = userStatsMap.get(userKey);
              stat.count += 1;
              if (data.classDate && (!stat.firstDate || data.classDate < stat.firstDate)) stat.firstDate = data.classDate;
              stat.revenue += this.estimateClassRevenue({ price:data.price },1);
              if ((data.status && data.status==='cancelled') || data.cancelledAt){
                stat.cancellations = (stat.cancellations||0)+1;
                if (data.classDate){ cancellationsByDay[data.classDate] = (cancellationsByDay[data.classDate]||0)+1; }
              }
            });

            const effectiveClassesByDay = {};
            Object.keys(report).forEach(day=>{
              if (classesByDay[day]?.length){
                effectiveClassesByDay[day] = classesByDay[day];
              } else if (listenerClassesByDay[day]?.length){
                effectiveClassesByDay[day] = listenerClassesByDay[day];
              } else {
                effectiveClassesByDay[day] = [];
              }
            });

            Object.entries(effectiveClassesByDay).forEach(([day, classList])=>{
              const base = report[day];
              if (!base) return;
              report[day] = this.calculateDaySnapshot({
                day,
                base,
                classList,
                bookingsByClass,
                userStats: userStatsMap,
                cancellationsByDay,
                aggregates: aggregateContext
              });
            });

            const aggregates = this.buildAttendanceAggregates({ labels, report, aggregateContext, userStats: userStatsMap });

            this.state.attendanceData = {
              report,
              labels,
              classesByDay: effectiveClassesByDay,
              bookingsByClass,
              userStats: userStatsMap,
              cancellationsByDay,
              aggregates
            };
            this.state.attendanceLastAt = now;
            this.updateAttendanceLegend();
            this.renderAttendanceDashboardFromCache();
            this.updateCapacityGauge();
            console.log('BI resumen:', aggregates.bi);
          } catch(e){
            console.error('Error leyendo asistencia:', e);
          } finally {
            if (loadingEl) loadingEl.classList.add('hidden');
          }
        },

        updateAttendanceLegend(){
          const lastEl = document.getElementById('att-last');
          const nextEl = document.getElementById('att-next');
          if (!lastEl || !nextEl) return;
          if (this.state.attendanceLastAt){
            const fmt = new Intl.DateTimeFormat('es-MX',{timeZone:'America/Mexico_City',hour:'2-digit',minute:'2-digit'});
            lastEl.textContent = `Última actualización: ${fmt.format(new Date(this.state.attendanceLastAt))}`;
          } else lastEl.textContent = 'Última actualización: —';
          nextEl.textContent = 'Actualización en vivo';
        },

        updateCapacityGauge(){
          const fill = document.getElementById('capacity-gauge-fill');
          const trendEl = document.getElementById('capacity-trend');
          const alertEl = document.getElementById('capacity-alert');
          const compareEl = document.getElementById('capacity-compare');
          const projectionEl = document.getElementById('capacity-projection');
          if (!fill || !this.state.attendanceData) return;
          const today = this.dateHelper.today();
          const d = this.state.attendanceData.report[today];
          const fallbackRate = d ? Math.round((d.booked/Math.max(d.totalCapacity||0,1))*100) : 0;
          const rate = d ? (d.utilizationRate ?? fallbackRate) : 0;
          fill.style.width = Math.min(rate,100)+'%';
          fill.classList.remove('bg-emerald-500','bg-amber-500','bg-rose-500');
          if (rate>85) fill.classList.add('bg-rose-500');
          else if (rate>60) fill.classList.add('bg-amber-500');
          else fill.classList.add('bg-emerald-500');

          const projections = this.calculateCapacityProjections();
          if (trendEl && projections){
            const pct = Math.round((projections.growthRate||0)*100);
            trendEl.textContent = pct>0 ? `▲ ${pct}%` : pct<0 ? `▼ ${Math.abs(pct)}%` : 'Estable';
          }
          if (alertEl){
            alertEl.textContent = projections?.recommendation?.summary || (rate>90 ? 'Sobrecapacidad' : rate>80 ? 'Monitorear' : 'Normal');
          }
          if (compareEl){
            const prevDate = new Date(`${today}T00:00:00-06:00`);
            if (!Number.isNaN(prevDate.getTime())){
              prevDate.setDate(prevDate.getDate()-7);
              const prevKey = this.dateHelper.ymd(prevDate);
              const prevData = this.state.attendanceData.report[prevKey];
              const prevRate = prevData ? (prevData.utilizationRate ?? Math.round((prevData.booked/Math.max(prevData.totalCapacity||0,1))*100)) : 0;
              const diff = rate - prevRate;
              compareEl.textContent = `${diff>=0?'+':''}${diff}% vs semana pasada`;
            } else {
              compareEl.textContent = '—';
            }
          }
          if (projectionEl && projections){
            projectionEl.textContent = `${Math.round(projections.projectedUtilization||projections.averageUtilization||0)}% esperado`;
          }
        },

        calculateCapacityProjections(){
          const data = this.state.attendanceData;
          if (!data) return null;
          const entries = data.labels.map(l=>({ date:l.date, metrics: data.report[l.date] }));
          if (!entries.length) return null;
          const utilizations = entries.map(item=>{
            const m = item.metrics;
            return typeof m.utilizationRate === 'number'
              ? m.utilizationRate
              : Math.round((m.booked/Math.max(m.totalCapacity||0,1))*100);
          });
          const avg = utilizations.reduce((sum,val)=>sum+val,0)/(utilizations.length||1);
          const first = utilizations[0] || 0;
          const last = utilizations[utilizations.length-1] || 0;
          const growthRate = utilizations.length>1 ? ((last-first)/Math.max(first||1,1)) : 0;
          const dayPattern = this.calculateDayOfWeekPatterns(data.report);
          const seasonal = this.calculateSeasonalTrend(entries);
          const projectedUtilization = Math.round(avg * (1 + (growthRate/2)));
          const revenueForecast = this.forecastRevenue(data.aggregates?.revenueSeries || []);
          const recommendation = this.buildCapacityRecommendations({ avgUtil:avg, growthRate, dayPattern });
          return {
            averageUtilization: Math.round(avg),
            growthRate,
            projectedUtilization,
            topDays: dayPattern.topDays,
            seasonal,
            revenueForecast,
            recommendation
          };
        },

        calculateMemberLifetimeValue({ userStats }){
          const stats = userStats instanceof Map ? userStats : new Map();
          let members = 0;
          let revenue = 0;
          stats.forEach(stat=>{
            members++;
            revenue += stat.revenue || (stat.count * this.DEFAULT_TICKET_PRICE);
          });
          const estimatedLTV = members ? Math.round(revenue/members) : 0;
          return { estimatedLTV, members };
        },

        analyzeClassProfitability(popularity, report){
          const topClasses = (popularity || []).slice(0,5).map(item=>({ class:item.label, score:item.score }));
          const totalRevenue = Object.values(report || {}).reduce((sum,d)=>sum+(d.revenue||0),0);
          return { topClasses, totalRevenue };
        },

        recommendOptimalScheduling(report){
          const suggestions = [];
          let bestDay = null;
          let bestUtil = -1;
          let lowDay = null;
          let lowUtil = Infinity;
          Object.entries(report || {}).forEach(([date,d])=>{
            const util = d.utilizationRate || 0;
            if (util > bestUtil){ bestUtil = util; bestDay = date; }
            if (util < lowUtil){ lowUtil = util; lowDay = date; }
          });
          if (bestDay) suggestions.push(`Mantener horarios fuertes en ${bestDay} (${bestUtil}% de uso).`);
          if (lowDay && lowUtil < 50) suggestions.push(`Impulsar reservas para ${lowDay} (solo ${lowUtil}% de uso).`);
          return { suggestions };
        },

        calculateCapacityVsDemand(report){
          const values = Object.values(report || {});
          if (!values.length) return { status:'Sin datos', averageUtilization:0, capacityGap:0 };
          const average = values.reduce((sum,d)=>sum+(d.utilizationRate||0),0)/values.length;
          const gap = values.reduce((sum,d)=>sum + Math.max((d.totalCapacity||0) - (d.booked||0),0),0);
          const status = average>85 ? 'Alta demanda' : average<50 ? 'Capacidad ociosa' : 'Equilibrado';
          return { status, averageUtilization: Math.round(average), capacityGap: gap };
        },

        calculateInstructorUtilization(instructorMetrics){
          const entries = Object.entries(instructorMetrics || {});
          if (!entries.length) return { leaders:[], underutilized:[] };
          const sorted = entries.sort((a,b)=> (b[1].avgUtilization||0) - (a[1].avgUtilization||0));
          const leaders = sorted.slice(0,3).map(([name])=>name);
          const underutilized = sorted.filter(([,metrics])=> (metrics.avgUtilization||0) < 50).map(([name])=>name);
          return { leaders, underutilized };
        },

        calculateDayOfWeekPatterns(report){
          const map = {};
          Object.entries(report || {}).forEach(([date,d])=>{
            const base = new Date(`${date}T00:00:00-06:00`);
            if (Number.isNaN(base.getTime())) return;
            const dow = base.getDay();
            if (!map[dow]) map[dow] = { utilization:0, count:0 };
            map[dow].utilization += d.utilizationRate || 0;
            map[dow].count += 1;
          });
          const names = ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'];
          const averages = Object.entries(map).map(([dow,data])=>{
            const avg = data.count ? data.utilization/data.count : 0;
            return { day:names[dow], value: Math.round(avg) };
          }).sort((a,b)=>b.value-a.value);
          return { averages, topDays: averages.slice(0,2).map(item=>item.day) };
        },

        calculateSeasonalTrend(entries){
          if (!entries.length) return { trend:'Sin datos', change:0 };
          const half = Math.max(1, Math.floor(entries.length/2));
          const firstAvg = entries.slice(0,half).reduce((sum,item)=>sum+(item.metrics.utilizationRate||0),0)/half;
          const secondAvg = entries.slice(-half).reduce((sum,item)=>sum+(item.metrics.utilizationRate||0),0)/half;
          const diff = secondAvg - firstAvg;
          const trend = diff>3 ? 'Alza' : diff<-3 ? 'Baja' : 'Estable';
          return { trend, change: Math.round(diff) };
        },

        forecastRevenue(series){
          if (!Array.isArray(series) || !series.length) return 0;
          const revenues = series.map(item=>item.revenue || 0);
          const diffs = revenues.slice(1).map((value,idx)=> value - revenues[idx]);
          const avgDiff = diffs.length ? diffs.reduce((sum,val)=>sum+val,0)/diffs.length : 0;
          return Math.round((revenues[revenues.length-1] || 0) + avgDiff);
        },

        buildCapacityRecommendations({ avgUtil, growthRate, dayPattern }){
          const suggestions = [];
          if (avgUtil>85) suggestions.push('Agregar clases o ampliar cupos en horarios de alta demanda.');
          if (avgUtil<50) suggestions.push('Impulsar campañas de retención y promociones para elevar la ocupación.');
          if (growthRate>0.1) suggestions.push('Planear expansión de horarios ante el crecimiento sostenido.');
          if (growthRate<-0.1) suggestions.push('Investigar cancelaciones y ajustar oferta para recuperar demanda.');
          if (dayPattern?.topDays?.length){
            suggestions.push(`Mayor demanda en ${dayPattern.topDays.join(' y ')}.`);
          }
          return { summary: suggestions[0] || 'Seguimiento normal', suggestions };
        },

        // Update report with current bookings before rendering
        injectBookingsIntoReport(){
          const data = this.state.attendanceData;
          if (!data) return;
          const aggregateContext = {
            classPopularity: new Map(),
            heatmap: {},
            instructorTotals: {},
            totals: { revenue:0, target:0, repeat:0, newMembers:0, cancellations:0, noShows:0 }
          };
          const { report, classesByDay, bookingsByClass, userStats, cancellationsByDay } = data;
          Object.keys(report).forEach(day=>{
            const classList = (classesByDay && classesByDay[day]) || [];
            report[day] = this.calculateDaySnapshot({
              day,
              base: report[day],
              classList,
              bookingsByClass,
              userStats,
              cancellationsByDay,
              aggregates: aggregateContext
            });
          });
          data.aggregates = this.buildAttendanceAggregates({ labels: data.labels, report, aggregateContext, userStats });
        },

        exportCapacityReport(){
          const data = this.state.attendanceData;
          if (!data) return;
          const format = this.state.selectedExportFormat || 'capacity';
          const { report, aggregates, userStats } = data;
          const start = document.getElementById('att-start-date')?.value || 'inicio';
          const end = document.getElementById('att-end-date')?.value || 'fin';
          let rows = [];
          if (format === 'capacity'){
            rows = [['Fecha','Asistieron','Faltaron','Reservaron','Capacidad','Utilización %','Ingresos','Meta','Retención %']];
            Object.entries(report).forEach(([date,d])=>{
              rows.push([date,d.attended,d.absent,d.booked,d.totalCapacity,d.utilizationRate,d.revenue,d.revenueTarget,d.memberRetention]);
            });
          } else if (format === 'demographics'){
            rows = [['Usuario','Reservas','Primer ingreso','Ingresos estimados','Cancelaciones']];
            if (userStats instanceof Map){
              userStats.forEach((stat,key)=>{
                rows.push([key,stat.count,stat.firstDate||'',stat.revenue||0,stat.cancellations||0]);
              });
            }
          } else if (format === 'instructors'){
            rows = [['Instructor','Clases','Asistentes','Utilización promedio %']];
            Object.entries(aggregates?.instructorMetrics || {}).forEach(([name,metrics])=>{
              rows.push([name,metrics.classes,metrics.attendees,metrics.avgUtilization]);
            });
          } else if (format === 'revenue'){
            const projection = this.calculateCapacityProjections();
            rows = [['Fecha','Ingresos','Meta','Pronóstico %']];
            (aggregates?.revenueSeries || []).forEach(item=>{
              rows.push([item.date,item.revenue,item.target,projection?.projectedUtilization||0]);
            });
          } else if (format === 'optimization'){
            rows = [['Recomendación','Detalle']];
            this.buildOptimizationRows(aggregates).forEach(pair=>rows.push(pair));
          } else if (format === 'custom-range'){
            const totals = aggregates?.totals || {};
            rows = [['Indicador','Valor'],
              ['Ingresos totales', totals.revenue||0],
              ['Meta de ingresos', totals.target||0],
              ['Retención promedio %', aggregates?.retention?.retentionRate||0],
              ['Cancelaciones', totals.cancellations||0],
              ['No shows', totals.noShows||0],
              ['Periodo', `${start} a ${end}`]
            ];
          } else {
            return;
          }
          const filename = `reporte-${format}-${start}-a-${end}.csv`;
          this.downloadCSV(filename, rows);
        },

        downloadCSV(filename, rows){
          const csv = rows.map(row=>row.map(val=>`"${String(val ?? '').replace(/"/g,'""')}"`).join(',')).join('\n');
          const blob = new Blob([csv],{type:'text/csv'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          a.click();
          URL.revokeObjectURL(url);
        },

        buildOptimizationRows(aggregates){
          const rows = [];
          const bi = aggregates?.bi || {};
          const schedule = bi.optimalScheduling?.suggestions || [];
          const capacity = bi.capacityVsDemand?.status;
          const instructors = bi.instructorUtilization || {};
          schedule.forEach(text=>rows.push(['Horario', text]));
          if (capacity) rows.push(['Capacidad vs demanda', capacity]);
          if (Array.isArray(instructors.leaders) && instructors.leaders.length){
            rows.push(['Instructores top', instructors.leaders.join(' | ')]);
          }
          if (Array.isArray(instructors.underutilized) && instructors.underutilized.length){
            rows.push(['Instructores con espacio', instructors.underutilized.join(' | ')]);
          }
          if (!rows.length){
            rows.push(['Resumen','Sin recomendaciones registradas']);
          }
          return rows;
        },

        // --- MODAL / Asistencia ---
        isClassInProgressWindow(cls){
          if (!cls || !cls.classDate || !cls.time) return false;
          const start = new Date(`${cls.classDate}T${cls.time}:00Z`).getTime();
          const now = Date.now();
          const lower = now - (2*24*60*60*1000);
          const upper = now + (30*60*1000);
          return (start>=lower) && (start<=upper);
        },

        showCreateClassModal(){
          this.state.currentAttendance = {};
          this.state.selectedClass = null;
          document.getElementById('class-id').value = '';
          document.getElementById('class-name').value = '';
          document.getElementById('class-instructor').value = '';
          document.getElementById('class-time').value = '';
          document.getElementById('class-description').value = '';
          document.getElementById('class-date').value = this.dateHelper.today();
          document.getElementById('class-capacity').value = '15';
          document.getElementById('class-duration').value = '60';
          document.getElementById('class-enrolled').value = '0';
          document.getElementById('class-image').value = '';
          document.getElementById('manual-bookings-count').value = '';

          const timeInput = document.getElementById('class-time');
          if (timeInput){
            timeInput.readOnly = false;
            timeInput.classList.remove('cursor-not-allowed','opacity-60');
            timeInput.removeAttribute('aria-readonly');
          }
          const warning = document.getElementById('class-time-warning');
          if (warning){
            warning.textContent = '';
            warning.classList.add('hidden');
          }

          const tabDetails = document.getElementById('tab-details');
          if (tabDetails) tabDetails.onclick = () => this.switchTab('details');
          const tabAttendance = document.getElementById('tab-attendance');
          if (tabAttendance){
            tabAttendance.classList.add('hidden');
            tabAttendance.onclick = null;
          }
          this.switchTab('details');

          document.getElementById('modal-title').textContent = 'Crear Nueva Clase';
          document.getElementById('save-button').textContent = 'Crear Clase';
          document.getElementById('delete-button').style.display = 'none';

          document.getElementById('cancel-button').onclick = () => this.hideClassModal();
          document.getElementById('save-button').onclick = () => this.saveClass();

          document.getElementById('class-modal').classList.remove('hidden');
          document.getElementById('class-name').focus();
        },

        async createClass(){
          const data = {
            name: document.getElementById('class-name').value.trim(),
            instructor: document.getElementById('class-instructor').value.trim() || 'Por Asignar',
            time: document.getElementById('class-time').value.trim(),
            description: document.getElementById('class-description').value.trim(),
            classDate: document.getElementById('class-date').value.trim(),
            capacity: Number(document.getElementById('class-capacity').value) || 15,
            duration: Number(document.getElementById('class-duration').value) || 60,
            enrolledCount: 0,
            image: document.getElementById('class-image').value.trim()
          };

          if (!data.name || !data.time || !data.classDate){
            this.showToast({ title:'Campos requeridos', message:'Nombre, hora y fecha son obligatorios', variant:'error' });
            return;
          }

          const safeCapacity = Math.round(Math.min(30, Math.max(1, Number(data.capacity) || 15)));
          const safeDuration = Math.round(Math.min(120, Math.max(30, Number(data.duration) || 60)));
          data.capacity = safeCapacity;
          data.duration = safeDuration;

          const { startAt, endAt, classDate, timeUTC } = this._buildStartEnd(data.classDate, data.time, data.duration);

          if (!data.image){
            data.image = `https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(data.name)}`;
          }

          data.startAt = startAt;
          data.endAt = endAt;
          data.classDate = classDate;
          data.time = timeUTC;

          try{
            await this.db.collection('classes').add(data);
            this.showToast({ title:'Clase creada', message:`${data.name} creada exitosamente` });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'Error al crear', message:e.message, variant:'error' });
          }
        },

        async showClassModal(cls){
          this.state.currentAttendance = {};
          this.state.selectedClass = cls ? { ...cls } : null;
          const baseDate = (cls.classDate && cls.time) ? new Date(`${cls.classDate}T${cls.time}:00Z`) : null;
          const localTime = cls.localTime || (baseDate ? this.timeFmt.format(baseDate) : cls.time || '');
          const localDate = cls.localDate || (baseDate ? this.dateHelper.ymd(baseDate) : cls.classDate || '');
          document.getElementById('class-id').value = cls.id;
          document.getElementById('class-name').value = cls.name || '';
          document.getElementById('class-instructor').value = cls.instructor || '';
          document.getElementById('class-time').value = localTime;
          document.getElementById('class-description').value = cls.description || '';
          document.getElementById('class-date').value = localDate;
          document.getElementById('class-capacity').value = (cls.capacity ?? 15);
          document.getElementById('class-duration').value = (cls.duration ?? 60);
          const enrolledVal = Number.isFinite(cls.enrolledCount) ? cls.enrolledCount : (this.state.bookingsMap.get(cls.id)?.length || 0);
          document.getElementById('class-enrolled').value = enrolledVal;
          document.getElementById('class-image').value = cls.image || '';
          const manualInput = document.getElementById('manual-bookings-count');
          if (manualInput) manualInput.value = '';

          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          this.switchTab('details');
          tabD.onclick = () => this.switchTab('details');
          if (this.isClassInProgressWindow(cls)){
            tabA.classList.remove('hidden');
            tabA.onclick = () => this.switchTab('attendance');
            this.loadAttendeesForAttendance(cls);
          } else {
            tabA.classList.add('hidden'); tabA.onclick = null;
          }

          // Event handlers for modal buttons
          document.getElementById('delete-button').onclick = () => {
            if (confirm('¿Estás seguro de eliminar esta clase?')) {
              this.deleteClass();
            }
          };
          document.getElementById('cancel-button').onclick = () => this.hideClassModal();
          document.getElementById('save-button').onclick = () => this.saveClass();
          const modal = document.getElementById('class-modal');
          const saveBtnEl = document.getElementById('save-button');
          const timeEl = document.getElementById('class-time');
          if (timeEl){
            timeEl.readOnly = true;
            timeEl.classList.add('cursor-not-allowed','opacity-60');
          }
          if (modal) modal.classList.remove('hidden');
          saveBtnEl?.focus();
          await this.refreshClassTimeLock(cls);
          document.getElementById('modal-title').textContent = 'Editar Clase';
          document.getElementById('save-button').textContent = 'Guardar Cambios';
          document.getElementById('delete-button').style.display = 'block';
        },

        hideClassModal(){
          document.getElementById('class-modal').classList.add('hidden');
          this.state.selectedClass = null;
        },

        async refreshClassTimeLock(cls){
          const timeInput = document.getElementById('class-time');
          const warning = document.getElementById('class-time-warning');
          if (!timeInput) return;

          timeInput.readOnly = false;
          timeInput.classList.remove('cursor-not-allowed','opacity-60');
          timeInput.removeAttribute('aria-readonly');
          if (warning){
            warning.textContent = '';
            warning.classList.add('hidden');
          }

          if (!cls?.id){
            return;
          }

          try{
            const snap = await this.db.collection('attendance').where('classId','==',cls.id).limit(1).get();
            const hasAttendance = !snap.empty;
            if (hasAttendance){
              timeInput.value = cls.localTime || cls.time || '';
              timeInput.readOnly = true;
              timeInput.classList.add('cursor-not-allowed','opacity-60');
              timeInput.setAttribute('aria-readonly','true');
              if (warning){
                warning.textContent = 'Esta clase tiene asistencia registrada. La hora no se puede modificar.';
                warning.classList.remove('hidden');
              }
            }
          }catch(err){
            console.error('No se pudo verificar asistencia', err);
            timeInput.readOnly = true;
            timeInput.classList.add('cursor-not-allowed','opacity-60');
            timeInput.setAttribute('aria-readonly','true');
            if (warning){
              warning.textContent = 'No pudimos verificar la asistencia. Evita cambiar la hora.';
              warning.classList.remove('hidden');
            }
          }
        },

        switchTab(tab){
          const tabD = document.getElementById('tab-details');
          const tabA = document.getElementById('tab-attendance');
          const contD = document.getElementById('details-content');
          const contA = document.getElementById('attendance-content');
          const saveBtn = document.getElementById('save-button');
          if (tab==='details'){
            tabD.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','true');
            tabA.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','false');
            contD.classList.remove('hidden'); contA.classList.add('hidden');
            if (saveBtn) saveBtn.classList.remove('hidden');
          } else {
            tabA.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','true');
            tabD.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','false');
            contA.classList.remove('hidden'); contD.classList.add('hidden');
            if (saveBtn) saveBtn.classList.add('hidden');
          }
        },

        async loadAttendeesForAttendance(cls){
          const list = document.getElementById('attendance-list');
          const msg  = document.getElementById('attendance-status-message');
          const save = document.getElementById('save-attendance-btn');

          const currentBookings = this.state.bookingsMap.get(cls.id) || [];
          const attSnap = await this.db.collection('attendance').where('classId','==',cls.id).get();
          const existing = {};
          attSnap.forEach(doc=>{ const d=doc.data(); existing[d.userId] = d.status; });

          this.state.currentAttendance = {};
          currentBookings.forEach(b=>{
            if (existing[b.userId]){
              this.state.currentAttendance[b.userId] = { status: existing[b.userId], userName: b.userName };
            }
          });

          if (!currentBookings.length){
            msg.textContent = 'No hay usuarios inscritos en esta clase.';
            list.innerHTML=''; save.classList.add('hidden');
            return;
          }

          msg.textContent = `${currentBookings.length} usuarios inscritos.`;
          list.innerHTML = currentBookings.map(b=>{
            const st = existing[b.userId];
            const selA = st==='attended' ? 'selected-attended':'';
            const selF = st==='absent'   ? 'selected-absent':'';
            const safeName = DOMPurify.sanitize(b.userName || 'Anónimo');
            const safeId = DOMPurify.sanitize(b.userId);
            return `
              <div class="flex items-center justify-between bg-zinc-900 p-2 rounded-md">
                <span class="text-zinc-300">${safeName}</span>
                <div class="space-x-2" data-user-id="${safeId}" data-user-name="${safeName}">
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selA}" data-status="attended">Asistió</button>
                  <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selF}" data-status="absent">Faltó</button>
                </div>
              </div>`;
          }).join('');

          save.classList.remove('hidden');
          list.onclick = (e)=>{
            const btn = e.target.closest('.attendance-btn'); if(!btn) return;
            const parent = btn.parentElement;
            const { userId, userName } = parent.dataset;
            const { status } = btn.dataset;
            this.state.currentAttendance[userId] = { status, userName };
            parent.querySelectorAll('.attendance-btn').forEach(x=>x.classList.remove('selected-attended','selected-absent'));
            btn.classList.add(status==='attended'?'selected-attended':'selected-absent');
          };
          save.onclick = () => this.saveAttendance();
        },

        async saveAttendance(){
          const clsId = document.getElementById('class-id')?.value;
          const cls = this.state.selectedClass || this.state.classes.find(c=>c.id===clsId);
          if (!cls){
            this.showToast({ title:'Clase no disponible', message:'No pudimos cargar la clase para guardar asistencia.', variant:'error' });
            return;
          }
          const data = this.state.currentAttendance;
          if (!Object.keys(data).length){
            this.showToast({ title:'Sin cambios', message:'No marcaste asistencia', variant:'warn' });
            return;
          }
          const classDate = cls.classDate || cls.localDate || '';
          if (!classDate){
            this.showToast({ title:'Clase sin fecha', message:'No se pudo identificar la fecha de la clase.', variant:'error' });
            return;
          }
          let classTimeLocal = cls.localTime || '';
          if (!classTimeLocal && cls.time){
            const baseTime = new Date(`${classDate}T${cls.time}:00Z`);
            classTimeLocal = this.timeFmt.format(baseTime);
          }
          const batch = this.db.batch();
          Object.keys(data).forEach(uid=>{
            const rec = data[uid];
            const ref = this.db.collection('attendance').doc(`${classDate}_${cls.id}_${uid}`);
            batch.set(ref,{
              classId: cls.id, className: cls.name, classDate,
              classTime: classTimeLocal,
              userId: uid, userName: rec.userName, status: rec.status, recordedAt: new Date()
            },{ merge:true });
          });
          try{
            await batch.commit();
            this.showToast({ title:'Asistencia guardada' });
            this.fetchAttendanceData(true);
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'Error al guardar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Password reset ----
        async sendPasswordReset(){
          const input = document.getElementById('user-email-input');
          const email = input.value.trim();
          if (!email){ this.showToast({ title:'Falta correo', variant:'warn' }); return; }
          try{
            await this.auth.sendPasswordResetEmail(email);
            this.showToast({ title:'Correo enviado', message:`Revisa ${email}` });
            input.value='';
          }catch(e){
            this.showToast({ title:'No se pudo enviar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Buscar por nombre o correo ----
        async findUsersByQuery(){
          const input = document.getElementById('find-user-query-input');
          const raw = (input.value||'').trim();
          const q = this.normalizeStr(raw);
          const container = document.getElementById('user-details-container');
          const hint = document.getElementById('user-results-hint');

          container.innerHTML=''; container.classList.add('hidden'); hint.classList.add('hidden');
          if (!raw){ this.showToast({ title:'Falta texto de búsqueda', variant:'warn' }); return; }

          try{
            const results = [];

            if (raw.includes('@')) {
              // correo exacto
              const snap = await this.db.collection('users').where('emailLower','==',q).limit(10).get();
              snap.forEach(d=>results.push(d));
              if (!results.length){
                const snap2 = await this.db.collection('users').where('email','==',raw).limit(10).get();
                snap2.forEach(d=>results.push(d));
              }
            } else {
              // nombre (prefijo, si existe índice) o fallback local
              let triedPrefix=false;
              try{
                const start=q, end=q+'\uf8ff';
                const byName = await this.db.collection('users').orderBy('displayNameLower').startAt(start).endAt(end).limit(20).get();
                byName.forEach(d=>results.push(d));
                triedPrefix=true;
              }catch(_){ /* falta índice */ }

              if (!results.length){
                const page = await this.db.collection('users').limit(300).get();
                page.forEach(d=>{
                  const data=d.data()||{};
                  const emailL=this.normalizeStr(data.email||'');
                  const nameL=this.normalizeStr(data.displayName||'');
                  if (emailL.includes(q) || nameL.includes(q)) results.push(d);
                });
                if (!triedPrefix && results.length){
                  hint.textContent='Resultado por búsqueda local (sin índice). Considera guardar displayNameLower y crear índice.';
                  hint.classList.remove('hidden');
                }
              }
            }

            if (!results.length){
              this.showToast({ title:'Sin resultados', message:`No encontramos "${raw}"`, variant:'warn' });
              return;
            }

            this.state.userSearchResults = results;
            container.innerHTML = results.map((doc, idx)=> this.userCardHTML(doc, idx)).join('');
            container.classList.remove('hidden');
            this.wireUserCardButtons();
          }catch(e){
            this.showToast({ title:'Error al buscar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Listar primera página ----
        async listUsersPage(){
          const container = document.getElementById('user-details-container');
          const hint = document.getElementById('user-results-hint');
          container.innerHTML='';
          container.classList.add('hidden');
          hint.classList.add('hidden');

          try{
            const snap = await this.db.collection('users').get();
            if (snap.empty){
              this.showToast({ title:'Sin usuarios', variant:'warn' });
              return;
            }

            container.innerHTML = snap.docs.map(doc => {
              const data = doc.data() || {};
              const safeName = DOMPurify.sanitize(data.displayName || 'Usuario sin nombre');
              const safeEmail = DOMPurify.sanitize(data.email || '');
              return `
            <div class="p-4 bg-zinc-700/50 rounded-lg">
              <h4 class="font-bold">${safeName}</h4>
              <p class="text-sm text-zinc-400">${safeEmail}</p>
            </div>`;
            }).join('');
            container.classList.remove('hidden');
            hint.textContent = `Mostrando ${snap.size} usuarios.`;
            hint.classList.remove('hidden');
          }catch(e){
            this.showToast({ title:'Error listando', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Render tarjeta + cableado ----
        userCardHTML(userDoc, indexBase=0){
          const userData = userDoc.data() || {};
          const tokenEntries = userData.fcmTokens ? Object.entries(userData.fcmTokens) : [];
          const safeName = DOMPurify.sanitize(userData.displayName || 'Usuario sin nombre');
          const safeEmail = DOMPurify.sanitize(userData.email || '');
          const head = `
            <div class="p-4 bg-zinc-700/50 rounded-lg">
              <h4 class="font-bold">${safeName}</h4>
              <p class="text-sm text-zinc-400">${safeEmail}</p>
          `;
          if (!tokenEntries.length){
            return head + `<p class="text-sm text-zinc-400 mt-3">Sin dispositivos registrados.</p></div>`;
          }
          const bodies = tokenEntries.map(([token, rawMeta],i)=>{
            const safeToken = DOMPurify.sanitize(token);
            const displayToken = DOMPurify.sanitize(safeToken.substring(0,30));
            const safeUid = DOMPurify.sanitize(userDoc.id);
            const meta = rawMeta && typeof rawMeta === 'object' ? rawMeta : null;

            let registeredAtStr = '';
            if (meta?.registeredAt){
              const dateObj = meta.registeredAt.toDate ? meta.registeredAt.toDate() : new Date(meta.registeredAt);
              if (dateObj instanceof Date && !Number.isNaN(dateObj.getTime())){
                registeredAtStr = new Intl.DateTimeFormat('es-MX',{ dateStyle:'short', timeStyle:'short' }).format(dateObj);
              }
            }

            const metaRows = [];
            if (meta?.userAgent){
              const ua = DOMPurify.sanitize(String(meta.userAgent));
              metaRows.push(`<p class="text-xs text-zinc-400 break-words">UA: ${ua}</p>`);
            }
            if (meta?.platform){
              const platform = DOMPurify.sanitize(String(meta.platform));
              metaRows.push(`<p class="text-xs text-zinc-400">Plataforma: ${platform}</p>`);
            }
            if (registeredAtStr){
              const safeRegistered = DOMPurify.sanitize(registeredAtStr);
              metaRows.push(`<p class="text-xs text-zinc-500">Registrado: ${safeRegistered}</p>`);
            }
            const screenInfo = meta?.screen || meta?.screenResolution;
            if (screenInfo){
              const safeScreen = DOMPurify.sanitize(String(screenInfo));
              metaRows.push(`<p class="text-xs text-zinc-500">Pantalla: ${safeScreen}</p>`);
            }
            if (meta?.timezone){
              const safeTz = DOMPurify.sanitize(String(meta.timezone));
              metaRows.push(`<p class="text-xs text-zinc-500">Zona horaria: ${safeTz}</p>`);
            }
            if (meta?.browser){
              const safeBrowser = DOMPurify.sanitize(String(meta.browser));
              metaRows.push(`<p class="text-xs text-zinc-500">Navegador: ${safeBrowser}</p>`);
            }
            if (meta?.language){
              const safeLang = DOMPurify.sanitize(String(meta.language));
              metaRows.push(`<p class="text-xs text-zinc-500">Idioma: ${safeLang}</p>`);
            }
            if (!metaRows.length){
              metaRows.push('<p class="text-xs text-zinc-500">Sin metadata disponible.</p>');
            }

            return `
            <div class="token-row p-3 bg-zinc-900 rounded-lg border border-zinc-700 mt-3">
              <p class="text-xs text-zinc-400 font-mono break-all">Dispositivo ${i+1}: ${displayToken}...</p>
              <div class="mt-2 space-y-1">${metaRows.join('')}</div>
              <div class="mt-3 space-y-2">
                <input type="text" id="noti-title-${indexBase}_${i}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm" placeholder="Título de la notificación">
                <textarea id="noti-body-${indexBase}_${i}" class="w-full bg-zinc-700 text-white p-2 rounded-md text-sm h-16" placeholder="Cuerpo del mensaje"></textarea>
                <div class="flex gap-2">
                  <button data-token="${safeToken}" data-index="${indexBase}_${i}" data-uid="${safeUid}"
                          class="send-noti-btn flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-md text-sm">
                    Enviar a este Dispositivo
                  </button>
                  <button data-token="${safeToken}" data-uid="${safeUid}"
                          class="prune-token-btn px-3 bg-zinc-700 hover:bg-zinc-600 text-white font-semibold rounded-md text-sm">
                    Prune
                  </button>
                </div>
              </div>
            </div>
          `;}).join('');
          return head + `<div class="mt-4 space-y-4">${bodies}</div></div>`;
        },

        wireUserCardButtons(){
          document.querySelectorAll('.send-noti-btn').forEach(btn=>{
            btn.onclick = (event)=> this.sendDirectNotification(event);
          });
          document.querySelectorAll('.prune-token-btn').forEach(btn=>{
            btn.onclick = (event)=> this.pruneTokenManually(event);
          });
        },

        // ---- USERS: Lista negra ----
        async listBlacklistedUsers(){
          const container = document.getElementById('blacklisted-users-container');
          const feedback = document.getElementById('blacklisted-users-feedback');
          if (!container) return;

          const loadingHtml = '<div class="p-4 bg-zinc-900 rounded-lg text-sm text-zinc-400">Cargando usuarios…</div>';
          container.innerHTML = loadingHtml;
          if (feedback){
            feedback.textContent = 'Cargando usuarios bloqueados…';
            feedback.classList.remove('hidden');
          }

          try{
            const snap = await this.db.collection('users').where('blacklisted','==',true).get();
            if (snap.empty){
              container.innerHTML = '<div class="p-4 bg-zinc-900 rounded-lg text-sm text-zinc-400">No hay usuarios en lista negra.</div>';
              if (feedback){
                feedback.textContent = 'Sin usuarios bloqueados.';
                feedback.classList.remove('hidden');
              }
              this.state.blacklistedUsers = [];
              return;
            }

            this.state.blacklistedUsers = snap.docs;
            container.innerHTML = snap.docs.map(doc => this.blacklistCardHTML(doc)).join('');
            if (feedback){
              feedback.textContent = `Usuarios bloqueados: ${snap.size}`;
              feedback.classList.remove('hidden');
            }
            this.wireBlacklistButtons();
          }catch(e){
            container.innerHTML = '<div class="p-4 bg-zinc-900 rounded-lg text-sm text-rose-400">No se pudo cargar la lista negra.</div>';
            if (feedback){
              feedback.textContent = 'Error al cargar la lista negra.';
              feedback.classList.remove('hidden');
            }
            this.showToast({ title:'Error al listar lista negra', message:e.message, variant:'error' });
          }
        },

        blacklistCardHTML(userDoc){
          const data = userDoc.data() || {};
          const safeName = DOMPurify.sanitize(data.displayName || 'Usuario sin nombre');
          const safeEmail = DOMPurify.sanitize(data.email || 'Sin correo');
          const strikesRaw = Number(data.lateCancellations);
          const strikes = Number.isFinite(strikesRaw) ? Math.max(0, strikesRaw) : 0;
          const safeStrikes = DOMPurify.sanitize(String(strikes));
          let formattedDate = 'Sin fecha registrada';
          const rawDate = data.blacklistedAt;
          let dateObj = null;
          if (rawDate?.toDate) dateObj = rawDate.toDate();
          else if (rawDate instanceof Date) dateObj = rawDate;
          if (dateObj instanceof Date && !Number.isNaN(dateObj.getTime())){
            formattedDate = new Intl.DateTimeFormat('es-MX',{ dateStyle:'medium', timeStyle:'short', timeZone:'America/Mexico_City' }).format(dateObj);
          }
          const safeDate = DOMPurify.sanitize(formattedDate);
          const safeUid = DOMPurify.sanitize(userDoc.id);
          return `
            <div class="p-4 bg-zinc-700/50 rounded-lg border border-zinc-600/50 space-y-2" data-user-card="${safeUid}">
              <div>
                <h3 class="text-lg font-semibold">${safeName}</h3>
                <p class="text-sm text-zinc-300">${safeEmail}</p>
              </div>
              <p class="text-sm text-zinc-400">Strikes: ${safeStrikes} / 3</p>
              <p class="text-xs text-zinc-500">Fecha de bloqueo: ${safeDate}</p>
              <button data-action="whitelist-user" data-user-id="${safeUid}" class="mt-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-3 rounded-md text-sm">Rehabilitar Usuario</button>
            </div>`;
        },

        wireBlacklistButtons(){
          document.querySelectorAll('[data-action="whitelist-user"]').forEach(btn=>{
            btn.onclick = () => this.whitelistUser(btn.dataset.userId);
          });
        },

        async whitelistUser(userId){
          if (!userId) return;
          try{
            await this.db.collection('users').doc(userId).set({
              blacklisted: false,
              lateCancellations: 0,
              blacklistedAt: firebase.firestore.FieldValue.delete()
            }, { merge:true });
            this.showToast({ title:'Usuario rehabilitado', message:'El usuario ya puede reservar de nuevo.' });
            await this.listBlacklistedUsers();
          }catch(e){
            this.showToast({ title:'No se pudo rehabilitar', message:e.message, variant:'error' });
          }
        },

        // ---- USERS: Envío + AUTOPRUNE ----
        async sendDirectNotification(event){
          const btn = event.target;
          const { token, index, uid } = btn.dataset;
          const title = document.getElementById(`noti-title-${index}`)?.value.trim();
          const body  = document.getElementById(`noti-body-${index}`)?.value.trim();

          if (!title || !body){
            this.showToast({ title:'Faltan datos', message:'El título y el cuerpo son requeridos.', variant:'warn' });
            return;
          }

          btn.disabled = true;
          btn.textContent = 'Enviando...';

          try{
            if (this.auth.currentUser) await this.auth.currentUser.getIdToken(true);
            const send = this.functions.httpsCallable('sendDirectNotification');
            const result = await send({ token, title, body });

            if (result.data?.success){
              this.showToast({ title:'Notificación enviada', message:'Dispositivo notificado ✅' });
            } else {
              throw new Error(result.data?.error || 'El servidor devolvió un error.');
            }
          }catch(e){
            const msg = String(e?.message || e);
            this.showToast({ title:'Error al enviar', message: msg, variant:'error' });

            // Heurística de token inválido/no registrado
            const looksInvalid = /not[-\s]?registered|unregistered|invalid[-\s]?registration|registration[-\s]?token|mismatch/i.test(msg);
            if (looksInvalid && uid && token){
              const ok = confirm('Este token parece inválido. ¿Quieres eliminarlo del perfil del usuario?');
              if (ok){
                try{
                  await this.db.collection('users').doc(uid).set({
                    fcmTokens: { [token]: firebase.firestore.FieldValue.delete() }
                  }, { merge:true });
                  this.showToast({ title:'Token eliminado', message:'Se removió el token inválido.' });
                }catch(pruneErr){
                  this.showToast({ title:'No se pudo eliminar token', message: pruneErr.message, variant:'error' });
                }
              }
            }
          }finally{
            btn.disabled = false;
            btn.textContent = 'Enviar a este Dispositivo';
          }
        },

        async pruneTokenManually(event){
          const btn = event.target;
          const { token, uid } = btn.dataset;
          if (!uid || !token) return;
          const ok = confirm('¿Eliminar este token del usuario?');
          if (!ok) return;
          btn.disabled = true;
          try{
            await this.db.collection('users').doc(uid).set({
              fcmTokens: { [token]: firebase.firestore.FieldValue.delete() }
            }, { merge:true });
            this.showToast({ title:'Token eliminado' });
            const freshDoc = await this.db.collection('users').doc(uid).get();
            const idx = this.state.userSearchResults.findIndex(d=>d.id===uid);
            if (idx !== -1) this.state.userSearchResults[idx] = freshDoc;
            const card = btn.closest('.p-4');
            if (card){
              card.outerHTML = this.userCardHTML(freshDoc, idx === -1 ? 0 : idx);
              this.wireUserCardButtons();
            }
          }catch(e){
            this.showToast({ title:'No se pudo eliminar', message:e.message, variant:'error' });
          }finally{
            btn.disabled = false;
          }
        },

        // ---- AUTH ----
        login() {
            // 1. Get the Turnstile token from the widget
            const turnstileToken = turnstile.getResponse();

            const email = document.getElementById('email-input').value.trim();
            const pass  = document.getElementById('password-input').value;
            const errEl = document.getElementById('error-message');
            errEl.classList.add('hidden');

            // 2. Check if the token exists
            if (!turnstileToken) {
                errEl.textContent = 'Por favor, completa la verificación de seguridad.';
                errEl.classList.remove('hidden');
                return; // Stop the login attempt if no token
            }

            // 3. If token exists, proceed with Firebase auth
            this.auth.signInWithEmailAndPassword(email, pass).catch(err => {
                errEl.textContent = 'Error: ' + err.message;
                errEl.classList.remove('hidden');
                // Reset the widget if login fails so the user can try again
                turnstile.reset();
            });
        },
        logout(){
          this.stopCurrentTimeTicker();
          this.auth.signOut();
          this.showToast({ title:'Sesión cerrada' });
        },

        // ---- CRUD Clase ----
        async saveClass(){
          const id = document.getElementById('class-id').value.trim();

          if (!id){
            await this.createClass();
            return;
          }

          const name = document.getElementById('class-name').value.trim();
          const instructor = document.getElementById('class-instructor').value.trim();
          const description = document.getElementById('class-description').value.trim();
          const imageInput = document.getElementById('class-image').value.trim();
          const timeInputEl = document.getElementById('class-time');
          const timeInputValue = (timeInputEl?.value || '').trim();
          const dateInputEl = document.getElementById('class-date');
          const dateInputValue = (dateInputEl?.value || '').trim();
          const capacityRaw = Number(document.getElementById('class-capacity').value);
          const durationEl = document.getElementById('class-duration');
          const durationRaw = Number(durationEl?.value);
          const enrolledEl = document.getElementById('class-enrolled');

          try{
            const cls = this.state.classes.find(c=>c.id===id);
            if (!cls){
              this.showToast({ title:'Clase no encontrada', message:'No pudimos ubicar la clase seleccionada.', variant:'error' });
              return;
            }

            const baseDate = (cls.classDate && cls.time) ? new Date(`${cls.classDate}T${cls.time}:00Z`) : null;
            const currentDateLocal = cls.localDate || (baseDate ? this.dateHelper.ymd(baseDate) : '');
            let currentTimeLocal = cls.localTime || '';
            if (!currentTimeLocal && baseDate){
              currentTimeLocal = this.timeFmt.format(baseDate);
            }
            const originalDuration = Number(cls.duration || 60);

            const effectiveDate = dateInputValue || currentDateLocal;
            const effectiveTime = timeInputValue || currentTimeLocal;
            const capacityBase = Number.isFinite(capacityRaw) ? capacityRaw : Number(cls.capacity || 15) || 15;
            const durationBase = Number.isFinite(durationRaw) ? durationRaw : originalDuration || 60;
            const capacity = Math.max(1, Math.min(30, Math.round(capacityBase)));
            const duration = Math.max(30, Math.min(120, Math.round(durationBase)));

            if (!name || !effectiveTime || !effectiveDate){
              this.showToast({ title:'Campos requeridos', message:'Nombre, hora y fecha son obligatorios', variant:'error' });
              return;
            }

            const data = {
              name,
              instructor: instructor || 'Por Asignar',
              description,
              image: imageInput,
              capacity,
              duration
            };

            if (!data.image){
              data.image = cls.image || `https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(name)}`;
            }

            if (enrolledEl){
              const enrolledCount = Number(enrolledEl.value);
              if (Number.isFinite(enrolledCount)) data.enrolledCount = enrolledCount;
            }

            const wantsScheduleChange = (
              (effectiveDate && effectiveDate !== currentDateLocal) ||
              (effectiveTime && effectiveTime !== currentTimeLocal) ||
              (duration !== originalDuration)
            );

            let canApplyScheduleChange = wantsScheduleChange;

            if (wantsScheduleChange){
              try{
                const attSnap = await this.db.collection('attendance').where('classId','==',id).limit(1).get();
                if (!attSnap.empty){
                  canApplyScheduleChange = false;
                  if (timeInputEl) timeInputEl.value = currentTimeLocal;
                  if (dateInputEl) dateInputEl.value = currentDateLocal;
                  if (enrolledEl) enrolledEl.value = Number.isFinite(cls.enrolledCount) ? cls.enrolledCount : enrolledEl.value;
                  if (durationEl) durationEl.value = originalDuration;
                  await this.refreshClassTimeLock(cls);
                  this.showToast({ title:'Hora bloqueada', message:'Esta clase ya tiene asistencia registrada. No puedes cambiar la hora.', variant:'warn' });
                }
              }catch(err){
                console.error('Error validando asistencia antes de cambiar hora', err);
                canApplyScheduleChange = false;
                if (timeInputEl) timeInputEl.value = currentTimeLocal;
                if (dateInputEl) dateInputEl.value = currentDateLocal;
                if (durationEl) durationEl.value = originalDuration;
                await this.refreshClassTimeLock(cls);
                this.showToast({ title:'No se pudo verificar asistencia', message:'Guardamos los demás cambios, pero deja la hora igual.', variant:'warn' });
              }
            }

            if (canApplyScheduleChange){
              const { startAt, endAt, classDate, timeUTC } = this._buildStartEnd(effectiveDate, effectiveTime, duration);
              data.startAt = startAt;
              data.endAt = endAt;
              data.classDate = classDate;
              data.time = timeUTC;
            } else if (wantsScheduleChange){
              data.duration = originalDuration;
            }

            await this.db.collection('classes').doc(id).set(data,{ merge:true });
            this.showToast({ title:'Clase actualizada' });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'No se guardó', message:e.message, variant:'error' });
          }
        },

        async deleteClass(){
          const id = document.getElementById('class-id').value; if(!id) return;
          try{
            const snap = await this.db.collection('bookings').where('classId','==',id).get();
            const batch = this.db.batch();
            snap.forEach(doc=>batch.delete(doc.ref));
            await batch.commit();
            await this.db.collection('classes').doc(id).delete();
            this.showToast({ title:'Clase eliminada', message:`Se borraron ${snap.size} reservas` });
            this.hideClassModal();
          }catch(e){
            this.showToast({ title:'No se pudo eliminar', message:e.message, variant:'error' });
          }
        },

        async generateManualBookings(){
          const classId = document.getElementById('class-id').value.trim();
          const countInput = document.getElementById('manual-bookings-count');
          if (!countInput){
            this.showToast({
              title: 'Error',
              message: 'Campo de reservas manuales no disponible',
              variant: 'error'
            });
            return;
          }
          const count = parseInt(countInput.value) || 0;

          if (!classId){
            this.showToast({
              title: 'Error',
              message: 'Primero selecciona una clase',
              variant: 'error'
            });
            return;
          }

          if (count <= 0 || count > 30){
            this.showToast({
              title: 'Número inválido',
              message: 'Ingresa un número entre 1 y 30',
              variant: 'error'
            });
            return;
          }

          try{
            const cls = this.state.classes.find(c=>c.id===classId);
            if (!cls){
              this.showToast({
                title: 'Clase no encontrada',
                message: 'No se pudo encontrar la clase seleccionada',
                variant: 'error'
              });
              return;
            }

            const currentBookings = this.state.bookingsMap.get(classId) || [];
            const currentCount = currentBookings.length;
            const capacity = cls.capacity || 15;
            const enrolledCount = Number(cls.enrolledCount || 0);
            const occupancy = Math.max(currentCount, enrolledCount);

            const remainingSlots = Math.max(0, capacity - occupancy);
            if (occupancy + count > capacity || remainingSlots <= 0){
              this.showToast({
                title: 'Capacidad excedida',
                message: remainingSlots > 0 ? `Solo puedes agregar ${remainingSlots} reservas más` : 'La clase ya está llena',
                variant: 'error'
              });
              return;
            }

            const timestamp = firebase.firestore.Timestamp.now();
            const baseNow = Date.now();
            const classRef = this.db.collection('classes').doc(classId);

            const { updatedEnrolled } = await this.db.runTransaction(async transaction=>{
              const classSnap = await transaction.get(classRef);
              if (!classSnap.exists){
                throw new Error('CLASS_NOT_FOUND');
              }

              const classData = classSnap.data() || {};
              const classCapacity = Number(classData.capacity || 15);
              const currentEnrolled = Number(classData.enrolledCount || 0);
              const availableSlots = Math.max(0, classCapacity - currentEnrolled);

              if (currentEnrolled + count > classCapacity){
                const capacityError = new Error('CAPACITY_EXCEEDED');
                capacityError.remainingSlots = availableSlots;
                throw capacityError;
              }

              for (let i = 1; i <= count; i++){
                const bookingRef = this.db.collection('bookings').doc();
                const bookingData = {
                  classId: classId,
                  userId: `whatsapp-test-${baseNow}-${i}`,
                  userName: `Reserva WhatsApp #${i}`,
                  userEmail: `whatsapp-booking-${baseNow}-${i}@test.local`,
                  createdAt: timestamp,
                  status: 'confirmed',
                  isManualBooking: true
                };
                transaction.set(bookingRef, bookingData);
              }

              transaction.update(classRef, {
                enrolledCount: firebase.firestore.FieldValue.increment(count)
              });

              return { updatedEnrolled: currentEnrolled + count };
            });

            countInput.value = '';

            cls.enrolledCount = updatedEnrolled;
            this.renderAll();
            this.showToast({
              title: 'Reservas creadas',
              message: `Se crearon ${count} reservas manuales exitosamente`
            });
          }catch(error){
            console.error('Error creating manual bookings:', error);

            if (error && error.message === 'CAPACITY_EXCEEDED'){
              const allowed = Number(error.remainingSlots || 0);
              this.showToast({
                title: 'Capacidad excedida',
                message: allowed > 0 ? `Solo puedes agregar ${allowed} reservas más` : 'La clase ya está llena',
                variant: 'error'
              });
              return;
            }

            if (error && error.message === 'CLASS_NOT_FOUND'){
              this.showToast({
                title: 'Clase no encontrada',
                message: 'La clase se eliminó antes de crear las reservas',
                variant: 'error'
              });
              return;
            }

            this.showToast({
              title: 'Error',
              message: `No se pudieron crear las reservas: ${error.message}`,
              variant: 'error'
            });
          }
        },
      };

      AdminPanel.init();
    </script>
  </body>
</html>