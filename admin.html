<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Madness - Panel de Administrador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    :focus-visible { outline:2px solid #818cf8; outline-offset:2px; border-radius:.5rem; }
    .attendance-btn.selected-attended { background-color:#10b981; color:white; }
    .attendance-btn.selected-absent   { background-color:#f43f5e; color:white; }
    #toast-container { pointer-events:none; }
    .toast { pointer-events:auto; }
  </style>
</head>
<body class="bg-zinc-900 text-white">

  <!-- TOASTS -->
  <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] space-y-2" aria-live="polite" aria-atomic="true"></div>

  <!-- LOGIN -->
  <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-zinc-800 p-8 rounded-lg shadow-lg w-full max-w-sm">
      <h1 class="text-2xl font-bold text-center mb-6">Acceso de Administrador</h1>
      <input type="email" id="email-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Correo de Admin" autocomplete="email">
      <input type="password" id="password-input" class="w-full bg-zinc-700 text-white p-3 rounded-md mb-4" placeholder="Contrase√±a" autocomplete="current-password">
      <button id="login-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md">Entrar</button>
      <p id="error-message" class="text-rose-400 text-center mt-4 hidden"></p>
    </div>
  </div>

  <!-- PANEL -->
  <div id="admin-panel" class="hidden p-4 md:p-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Panel de Administraci√≥n</h1>
      <button id="logout-btn" class="text-rose-400 hover:text-rose-300 font-semibold">Cerrar Sesi√≥n</button>
    </div>

    <div class="mb-6 flex flex-wrap gap-3">
      <button id="gen-classes-btn" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-lg">
        <i data-lucide="calendar-check" class="inline-block -mt-1 mr-2"></i>Generar/Verificar Clases (Hoy/Ma√±ana)
      </button>
      <span id="panel-hint" class="text-zinc-400 self-center text-sm">Las clases nuevas se crean con <code>enrolledCount: 0</code>.</span>
    </div>

    <!-- HOY / MA√ëANA -->
    <div class="space-y-8">
      <section aria-labelledby="hoy-title">
        <h2 id="hoy-title" class="text-2xl font-bold mb-4 text-emerald-400 border-b border-zinc-700 pb-2">Clases de Hoy</h2>
        <div id="today-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
      </section>
      <section aria-labelledby="maniana-title">
        <h2 id="maniana-title" class="text-2xl font-bold mb-4 text-sky-400 border-b border-zinc-700 pb-2">Clases de Ma√±ana</h2>
        <div id="tomorrow-classes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pt-4"></div>
      </section>
    </div>

    <!-- RESERVAS -->
    <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="reservas-title">
      <h2 id="reservas-title" class="text-2xl font-bold mb-4">Reservas del D√≠a</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <h3 class="text-lg font-semibold text-emerald-400 mb-3 border-b border-zinc-700 pb-2">Hoy</h3>
          <div id="today-bookings-list" class="space-y-4 text-sm"></div>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-sky-400 mb-3 border-b border-zinc-700 pb-2">Ma√±ana</h3>
          <div id="tomorrow-bookings-list" class="space-y-4 text-sm"></div>
        </div>
      </div>
    </section>

    <!-- ASISTENCIA / PROYECCI√ìN -->
    <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="asistencia-title">
      <h2 id="asistencia-title" class="text-2xl font-bold mb-4">Reporte de Asistencia y Proyecci√≥n</h2>
      <div class="relative">
        <canvas id="attendanceChart"></canvas>
      </div>
      <div id="attendance-details" class="mt-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm"></div>
    </section>

    <!-- USUARIOS -->
    <section class="mt-8 p-6 bg-zinc-800 rounded-lg" aria-labelledby="usuarios-title">
      <h2 id="usuarios-title" class="text-2xl font-bold mb-4">Gesti√≥n de Usuarios</h2>
      <div>
        <label for="user-email-input" class="block text-sm font-medium text-zinc-300 mb-2">Reinicio de Contrase√±a</label>
        <div class="flex gap-2">
          <input type="email" id="user-email-input" class="flex-1 bg-zinc-700 text-white p-2 rounded-md" placeholder="Correo del usuario">
          <button id="send-reset-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Enviar</button>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL CLASE -->
  <div id="class-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
    <div class="bg-zinc-800 rounded-lg shadow-xl w-full max-w-lg p-6 space-y-4 max-h-screen overflow-y-auto"
         role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <h2 id="modal-title" class="text-2xl font-bold">Editar Clase</h2>
      <input type="hidden" id="class-id">
      
      <div class="border-b border-zinc-700">
        <nav class="flex space-x-4" aria-label="Tabs">
          <button id="tab-details" class="px-3 py-2 font-medium text-sm rounded-t-md" aria-selected="true">Detalles</button>
          <button id="tab-attendance" class="px-3 py-2 font-medium text-sm rounded-t-md hidden" aria-selected="false">Asistencia</button>
        </nav>
      </div>

      <div id="details-content">
        <input type="text" id="class-name" placeholder="Nombre de la clase" class="w-full bg-zinc-700 p-2 rounded mt-4">
        <input type="text" id="class-instructor" placeholder="Instructor" class="w-full bg-zinc-700 p-2 rounded mt-4">
        <div class="grid grid-cols-2 gap-4 mt-4">
          <input type="text" id="class-time" placeholder="Hora (ej. 18:00)" class="w-full bg-zinc-700 p-2 rounded">
          <input type="text" id="class-icon" placeholder="Emoji √çcono (üßò‚Äç‚ôÄÔ∏è)" class="w-full bg-zinc-700 p-2 rounded">
        </div>
        <textarea id="class-description" placeholder="Descripci√≥n" class="w-full bg-zinc-700 p-2 rounded h-24 mt-4"></textarea>
      </div>

      <div id="attendance-content" class="hidden">
        <div id="attendance-status-message" class="text-center text-zinc-400 p-4"></div>
        <div id="attendance-list" class="space-y-2"></div>
        <button id="save-attendance-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded mt-4 hidden">Guardar Asistencia</button>
      </div>

      <div class="flex justify-end gap-3 pt-2">
        <button id="delete-button" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-4 rounded">Eliminar</button>
        <button id="cancel-button" class="bg-zinc-600 hover:bg-zinc-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
        <button id="save-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
  const AdminPanel = {
    db:null, auth:null,
    state:{
      classes:[],                  // pr√≥ximas (hoy/ma√±ana)
      bookingsMap:new Map(),       // classId -> [{...booking}]
      weeklySchedule:{},
      currentAttendance:{},
      attendanceChartInstance:null,
      unsubClasses:null,
      unsubBookings:[],            // lista de unsubs por lote
    },

    // ---- FORMATTERS (punto 5)
    timeFmt: new Intl.DateTimeFormat('es-MX', { hour:'2-digit', minute:'2-digit' }),
    dayFmt:  new Intl.DateTimeFormat('es-MX', { weekday:'long', day:'2-digit', month:'short' }),

    dateHelper:{
      ymd(date){ const y=date.getFullYear(), m=String(date.getMonth()+1).padStart(2,'0'), d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; },
      today(){ return this.ymd(new Date()); },
      tomorrow(){ const t=new Date(); t.setDate(t.getDate()+1); return this.ymd(t); },
      yesterday(){ const t=new Date(); t.setDate(t.getDate()-1); return this.ymd(t); }
    },

    // ---- COVER IMG
    coverFor(name=''){
      const n = String(name).toLowerCase();
      if (n.includes('trx')) return 'images/trx.png';
      if (n.includes('yoga')) return 'images/yoga.png';
      if (n.includes('hiit')) return 'images/HIIT.png';
      if (n.includes('funcional') || n.includes('functional')) return 'images/functional.png';
      return `https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(name||'Clase')}`;
    },

    // ---- TOASTS (punto 8)
    showToast({title='Hecho', message='', variant='success', timeout=3000}){
      const color = variant==='error'?'rose': variant==='warn'?'amber':'emerald';
      const wrap = document.getElementById('toast-container');
      const el = document.createElement('div');
      el.className = 'toast max-w-md mx-auto bg-zinc-800 border border-zinc-700 rounded-xl p-4 shadow-lg flex items-start gap-3';
      el.innerHTML = `
        <div class="w-10 h-10 rounded-lg bg-${color}-500/20 text-${color}-300 flex items-center justify-center shrink-0">
          <i data-lucide="${variant==='error'?'alert-triangle':variant==='warn'?'alert-circle':'check'}" class="w-6 h-6"></i>
        </div>
        <div class="flex-1">
          <p class="font-semibold">${title}</p>
          ${message?`<p class="text-sm text-zinc-400 mt-0.5">${message}</p>`:''}
        </div>
        <button class="shrink-0 text-zinc-400 hover:text-zinc-200" aria-label="Cerrar notificaci√≥n"><i data-lucide="x" class="w-5 h-5"></i></button>`;
      wrap.appendChild(el);
      lucide.createIcons({ attrs:{ 'aria-hidden':'true' }});
      const close = ()=> el.remove();
      el.querySelector('button').addEventListener('click', close);
      if (timeout) setTimeout(close, timeout);
    },

    // ---- INIT / AUTH (punto 3)
    init(){
      const firebaseConfig = {
        apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
        authDomain: "madnessscheds.firebaseapp.com",
        projectId: "madnessscheds",
        storageBucket: "madnessscheds.firebasestorage.app",
        messagingSenderId: "788538690861",
        appId: "1:788538690861:web:ce19ead5929a8867c197a4"
      };
      firebase.initializeApp(firebaseConfig);
      this.db = firebase.firestore();
      this.auth = firebase.auth();

      document.getElementById('login-btn').onclick = ()=> this.login();
      document.getElementById('logout-btn').onclick = ()=> this.logout();
      document.getElementById('gen-classes-btn').onclick = ()=> this.generateDailyClasses();
      document.getElementById('send-reset-btn').onclick = ()=> this.sendPasswordReset();

      document.getElementById('delete-button').onclick = ()=> this.deleteClass();
      document.getElementById('cancel-button').onclick = ()=> this.hideClassModal();
      document.getElementById('save-button').onclick = ()=> this.saveClass();

    this.auth.onAuthStateChanged(async (user)=>{
    if (user){
        try {
        // Fuerza refresco del token para traer los √∫ltimos claims
        await user.getIdToken(true);
        const token = await user.getIdTokenResult();
        const isAdmin = !!(token.claims && token.claims.admin);

        if (isAdmin){
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            try{
            await this.loadWeeklyScheduleTemplate();
            this.listenClassesTodayTomorrow();
            this.showToast({title:'Conectado', message:`UID: ${user.uid}`});
            }catch(e){
            this.showToast({title:'Error al iniciar', message:e.message, variant:'error'});
            }
        } else {
            // Si no es admin, muestra un mensaje √∫til con su UID para asignar el claim
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('admin-panel').classList.add('hidden');
            this.showToast({
            title:'Acceso denegado',
            message:`El usuario ${user.email || user.uid} no tiene el claim admin. UID: ${user.uid}`,
            variant:'error'
            });
        }
        } catch (e){
        console.error(e);
        this.showToast({title:'Error verificando sesi√≥n', message:e.message, variant:'error'});
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('admin-panel').classList.add('hidden');
        }
    } else {
        document.getElementById('login-screen').classList.remove('hidden');
        document.getElementById('admin-panel').classList.add('hidden');
        this.teardownBookingsListeners();
        if (this.state.unsubClasses) this.state.unsubClasses();
    }
    });

      lucide.createIcons();
    },

    async loadWeeklyScheduleTemplate(){
      const snap = await this.db.collection('schedule_template').get();
      if (snap.empty) throw new Error('No existe la plantilla de horario.');
      snap.forEach(doc => { this.state.weeklySchedule[doc.id] = doc.data().classes || []; });
    },

    // ---- LISTENERS sin N+1 (punto 1)
    listenClassesTodayTomorrow(){
        const yesterday = this.dateHelper.yesterday();
        const today     = this.dateHelper.today();
        const tomorrow  = this.dateHelper.tomorrow();

        if (this.state.unsubClasses) this.state.unsubClasses();

        this.state.unsubClasses = this.db.collection('classes')
            .where('classDate','in',[yesterday, today, tomorrow]) // <-- incluye AYER
            .orderBy('classDate','asc')
            .orderBy('time','asc')
            .onSnapshot((snap)=>{
            this.state.classes = snap.docs.map(d=>({ id:d.id, ...d.data() }));
            this.mountBookingsListenersForVisibleClasses();
            this.renderAll();
            }, (err)=>{
            console.error(err);
            this.showToast({title:'Error listando clases', message:err.message, variant:'error'});
            });
    },

    teardownBookingsListeners(){
      this.state.unsubBookings.forEach(fn=>{ try{fn&&fn();}catch{} });
      this.state.unsubBookings = [];
      this.state.bookingsMap.clear();
    },

    mountBookingsListenersForVisibleClasses(){
        this.teardownBookingsListeners();
        const classIds = this.state.classes.map(c=>c.id);
        for (let i=0; i<classIds.length; i+=10){
            const batch = classIds.slice(i, i+10);
            const unsub = this.db.collection('bookings')
            .where('classId','in',batch)
            .onSnapshot((snap)=>{
                batch.forEach(cid=> this.state.bookingsMap.delete(cid));
                snap.docs.forEach(doc=>{
                const b = doc.data();
                const arr = this.state.bookingsMap.get(b.classId) || [];
                arr.push({ id:doc.id, ...b });
                this.state.bookingsMap.set(b.classId, arr);
                });
                this.renderAll();
            });
            this.state.unsubBookings.push(unsub);
        }
    },

    // ---- GENERACI√ìN (punto 1: enrolledCount=0)
    async generateDailyClasses(){
      if (!Object.keys(this.state.weeklySchedule).length){
        this.showToast({title:'Plantilla no cargada', variant:'warn'});
        return;
      }
      const today = new Date();
      const tomorrow = new Date(); tomorrow.setDate(today.getDate()+1);
      const days = [
        { dateStr:this.dateHelper.ymd(today),    dow: today.getDay() },
        { dateStr:this.dateHelper.ymd(tomorrow), dow: tomorrow.getDay() }
      ];

      const batch = this.db.batch();
      let created = 0;

      for (const d of days){
        const tpl = this.state.weeklySchedule[String(d.dow)] || [];
        if (!tpl.length) continue;

        const existingSnap = await this.db.collection('classes')
          .where('classDate','==', d.dateStr).get();
        const existingTimes = new Set(existingSnap.docs.map(x => x.data().time));

        for (const c of tpl){
          if (!existingTimes.has(c.time)){
            const ref = this.db.collection('classes').doc();

            const duration = Number(c.duration || 60);
            const start = new Date(`${d.dateStr}T${c.time}:00`);
            const end   = new Date(start.getTime() + duration*60000);

            batch.set(ref, {
              name: c.name,
              time: c.time,
              instructor: c.instructor || 'Por Asignar',
              duration,
              classDate: d.dateStr, // √∫til para filtros r√°pidos
              startAt: firebase.firestore.Timestamp.fromDate(start),
              endAt:   firebase.firestore.Timestamp.fromDate(end),
              capacity: Number(c.capacity || 15),
              enrolledCount: 0,
              description: `Clase de ${c.name}`,
              icon: 'üí™',
              image: this.coverFor(c.name)  // ‚Üê usa portada por nombre
            });
            created++;
          }
        }
      }

      if (created>0){
        await batch.commit();
        this.showToast({title:'Clases generadas', message:`Se crearon ${created} clases`});
      } else {
        this.showToast({title:'Horario al d√≠a', message:'No hay clases nuevas por crear', variant:'warn'});
      }
    },

    // ---- RENDER
    renderAll(){
      this.renderClassCards();
      this.renderDailyBookings();
      this.renderAttendanceChart();
    },

    isClassRunningNow(cls){
      if (!cls) return false;
      const start = cls.startAt?.toDate ? cls.startAt.toDate().getTime()
                                        : new Date(`${cls.classDate}T${cls.time}:00`).getTime();
      const end   = cls.endAt?.toDate ? cls.endAt.toDate().getTime()
                                      : start + (Number(cls.duration||60)*60000);
      const now = Date.now();
      return now>=start && now<=end;
    },

    renderClassCards(){
      const todayC = document.getElementById('today-classes-container');
      const tomorrowC = document.getElementById('tomorrow-classes-container');
      todayC.innerHTML = ''; tomorrowC.innerHTML = '';
      const sorted = [...this.state.classes].sort((a,b)=>(a.classDate+a.time).localeCompare(b.classDate+b.time));

      for (const cls of sorted){
        const isRunning = this.isClassRunningNow(cls);
        const style = isRunning ? 'bg-emerald-900 border border-emerald-600' : 'bg-zinc-800';
        const enrolled = Number(cls.enrolledCount || 0);
        const capacity = Number(cls.capacity || 0);

        const card = document.createElement('div');
        card.className = `p-4 rounded-lg shadow-md cursor-pointer hover:bg-zinc-700 transition-colors ${style}`;
        card.setAttribute('role','button');
        card.setAttribute('aria-label', `Editar ${cls.name} a las ${cls.time}`);
        card.onclick = ()=> this.showClassModal(cls);
        card.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xl font-bold">${cls.name}</p>
              <p class="text-sm text-zinc-400">${cls.instructor}</p>
            </div>
            <span class="text-2xl">${cls.icon || 'üí™'}</span>
          </div>
          <div class="mt-4 flex justify-between items-center text-sm">
            <span class="font-semibold">
              ${cls.startAt?.toDate ? new Intl.DateTimeFormat('es-MX',{hour:'2-digit',minute:'2-digit',hour12:false}).format(cls.startAt.toDate()) : cls.time}
              ${cls.endAt?.toDate ? '‚Äì' + new Intl.DateTimeFormat('es-MX',{hour:'2-digit',minute:'2-digit',hour12:false}).format(cls.endAt.toDate()) : ''}
            </span>
            <span class="font-bold ${enrolled>=capacity?'text-rose-400':'text-white'}">${enrolled} / ${capacity}</span>
          </div>`;
        if (cls.classDate === this.dateHelper.today()) todayC.appendChild(card);
        else if (cls.classDate === this.dateHelper.tomorrow()) tomorrowC.appendChild(card);
      }

      if (!todayC.children.length) todayC.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para hoy.</p>';
      if (!tomorrowC.children.length) tomorrowC.innerHTML = '<p class="text-zinc-500 col-span-full">No hay clases programadas para ma√±ana.</p>';
    },

    renderDailyBookings(){
        const todayList = document.getElementById('today-bookings-list');
        const tomList   = document.getElementById('tomorrow-bookings-list');
        todayList.innerHTML = ''; tomList.innerHTML = '';

        const byDate = { [this.dateHelper.today()]:[], [this.dateHelper.tomorrow()]:[] };
        this.state.classes.forEach(c => { if (byDate[c.classDate]) byDate[c.classDate].push(c); });

        const buildHTML = (classesArr)=>{
            const blocks = classesArr.map(cls=>{
            const attendees = (this.state.bookingsMap.get(cls.id) || []).map(b => b.userName || 'An√≥nimo');
            const enrolled = Number(cls.enrolledCount || 0);
            const cap = Number(cls.capacity || 0);
            const names = attendees.map(n => `<li class="text-zinc-400 ml-4">- ${n}</li>`).join('');
            return `<div class="mb-3"><p class="font-bold">${cls.time} - ${cls.name} (${enrolled} de ${cap})</p><ul class="list-none">${names}</ul></div>`;
            });
            return blocks.join('') || '<p class="text-zinc-500">No hay reservas.</p>';
        };

        todayList.innerHTML = buildHTML(byDate[this.dateHelper.today()]);
        tomList.innerHTML   = buildHTML(byDate[this.dateHelper.tomorrow()]);
    },

    async renderAttendanceChart(){
      const ctx = document.getElementById('attendanceChart')?.getContext('2d');
      const details = document.getElementById('attendance-details');
      if (!ctx || !details) return;

      const today = new Date();
      const d1 = new Date(); d1.setDate(today.getDate()-2);
      const d2 = new Date(); d2.setDate(today.getDate()-1);
      const d3 = today;
      const d4 = new Date(); d4.setDate(today.getDate()+1);

      const dates = {
        dayBefore: { date:this.dateHelper.ymd(d1), label:'Hace 2 d√≠as' },
        yesterday: { date:this.dateHelper.ymd(d2), label:'Ayer' },
        today:     { date:this.dateHelper.ymd(d3), label:'Hoy' },
        tomorrow:  { date:this.dateHelper.ymd(d4), label:'Ma√±ana' }
      };
      const labels = Object.values(dates).map(d=>d.label);
      const keys   = Object.keys(dates);

      // Asistencia (anteayer, ayer, hoy)
      const attSnap = await this.db.collection('attendance')
        .where('classDate','>=', dates.dayBefore.date)
        .where('classDate','<=', dates.today.date)
        .get();

      const report = {};
      Object.values(dates).forEach(d => { report[d.date] = { attended:0, absent:0, booked:0, details:{ attended:{}, absent:{}, booked:{} } }; });

      attSnap.forEach(doc=>{
        const r = doc.data();
        if (!report[r.classDate]) return;
        const cat = r.status==='attended' ? 'attended' : 'absent';
        report[r.classDate][cat]++;
        const key = `${r.className}`;
        if (!report[r.classDate].details[cat][key]) report[r.classDate].details[cat][key]=[];
        report[r.classDate].details[cat][key].push(r.userName);
      });

      // ‚Äî‚Äî Utilidad para construir reservas por fecha (incluye TODAS las clases del d√≠a)
        const buildBookedFor = (dateStr) => {
        const classesDay = this.state.classes.filter(c => c.classDate === dateStr);
        let booked = 0;
        const details = {};
        classesDay.forEach(c => {
            const arr = this.state.bookingsMap.get(c.id) || [];
            booked += arr.length;
            const label = `${c.time} - ${c.name}`;
            // Guardamos aunque est√© vac√≠o para que aparezca la clase con ":" aunque no haya nombres
            details[label] = arr.map(x => x.userName || 'An√≥nimo');
        });
        return { booked, details };
        };

        // Reservas HOY
        {
        const { booked, details } = buildBookedFor(dates.today.date);
        report[dates.today.date].booked = booked;
        report[dates.today.date].details.booked = details;
        }

        // Reservas MA√ëANA
        {
        const { booked, details } = buildBookedFor(dates.tomorrow.date);
        report[dates.tomorrow.date].booked = booked;
        report[dates.tomorrow.date].details.booked = details;
        }

      const attendedData = keys.map(k => report[dates[k].date].attended);
        const absentData   = keys.map(k => report[dates[k].date].absent);

        // Serie "Reservas Hoy": valores solo en HOY, 0 en otros d√≠as
        const bookedTodayData = keys.map(k => (k === 'today' ? report[dates.today.date].booked : 0));
        // Serie "Reservas Ma√±ana": valores solo en MA√ëANA, 0 en otros d√≠as
        const bookedTomorrowData = keys.map(k => (k === 'tomorrow' ? report[dates.tomorrow.date].booked : 0));

        if (this.state.attendanceChartInstance) this.state.attendanceChartInstance.destroy();
        this.state.attendanceChartInstance = new Chart(ctx, {
        type:'bar',
        data:{
            labels,
            datasets:[
            { label:'Asistieron',       data:attendedData,      backgroundColor:'rgba(16,185,129,.6)'  },
            { label:'Faltaron',         data:absentData,        backgroundColor:'rgba(244,63,94,.6)'  },
            { label:'Reservas Hoy',     data:bookedTodayData,   backgroundColor:'rgba(99,102,241,.6)' }, // indigo
            { label:'Reservas Ma√±ana',  data:bookedTomorrowData,backgroundColor:'rgba(59,130,246,.6)'  }  // blue
            ]
        },
        options:{
            scales:{
            y:{ beginAtZero:true, ticks:{ color:'#a1a1aa', stepSize:1 }, grid:{ color:'#3f3f46' } },
            x:{ ticks:{ color:'#a1a1aa' }, grid:{ color:'#3f3f46' } }
            },
            plugins:{ legend:{ labels:{ color:'#d4d4d8' } } }
        }
        });


      // Detalles
      const renderAttendanceList = (obj)=>{
        const names = Object.keys(obj).sort();
        if (!names.length) return '<ul class="list-disc list-inside text-zinc-400"><li>Nadie</li></ul>';
        return names.map(n => `
            <div class="font-semibold text-zinc-300 mt-1">${n}:</div>
            <ul class="list-disc list-inside text-zinc-400">${obj[n].map(p=>`<li>${p}</li>`).join('')}</ul>
        `).join('');
        };

        // Para "Reservaron": imprime TODAS las clases del d√≠a y si una clase no tiene nombres, muestra "Nadie"
        const renderBookedDetails = (obj)=>{
        const classNames = Object.keys(obj).sort();
        if (!classNames.length) return '<div class="text-zinc-400">No hay clases programadas.</div>';
        return classNames.map(label => {
            const people = obj[label] || [];
            const list = people.length ? people.map(p=>`<li>${p}</li>`).join('') : '<li>Nadie</li>';
            return `
            <div class="font-semibold text-zinc-300 mt-1">${label}:</div>
            <ul class="list-disc list-inside text-zinc-400">${list}</ul>
            `;
        }).join('');
        };


      details.innerHTML = keys.map(k=>{
  const d = report[dates[k].date];
  let content = '';

  if (k === 'today' || k === 'tomorrow'){
    content += `<div class="font-semibold text-blue-400">Reservaron (${d.booked})</div>${renderBookedDetails(d.details.booked)}`;
  }
  if (k !== 'tomorrow'){ // dayBefore, yesterday, today -> muestran asistencia hist√≥rica
    content += `
      <div class="font-semibold text-emerald-400 mt-2">Asistieron (${d.attended})</div>${renderAttendanceList(d.details.attended)}
      <div class="font-semibold text-rose-400 mt-2">Faltaron (${d.absent})</div>${renderAttendanceList(d.details.absent)}
    `;
  }

  return `<div class="bg-zinc-900 p-3 rounded-md"><h4 class="font-bold text-lg mb-2">${dates[k].label}</h4>${content}</div>`;
}).join('');


    },

    // ---- MODAL
    isClassInProgressWindow(cls){
      if (!cls) return false;
      const start = cls.startAt?.toDate ? cls.startAt.toDate().getTime()
                                        : new Date(`${cls.classDate}T${cls.time}:00`).getTime();
      const now   = Date.now();
      const lower = now - (15 * 60 * 60 * 1000); // 15h atr√°s
      const upper = now + (30 * 60 * 1000);      // 30m adelante
      return (start >= lower) && (start <= upper);
    },

    showClassModal(cls){
      this.state.currentAttendance = {};
      document.getElementById('class-id').value = cls.id;
      document.getElementById('class-name').value = cls.name || '';
      document.getElementById('class-instructor').value = cls.instructor || '';
      document.getElementById('class-time').value = cls.time || '';
      document.getElementById('class-icon').value = cls.icon || '';
      document.getElementById('class-description').value = cls.description || '';

      const tabD = document.getElementById('tab-details');
      const tabA = document.getElementById('tab-attendance');
      this.switchTab('details');
      tabD.onclick = ()=> this.switchTab('details');

      if (this.isClassInProgressWindow(cls)){
        tabA.classList.remove('hidden');
        tabA.onclick = ()=> this.switchTab('attendance');
        this.loadAttendeesForAttendance(cls);
      } else {
        tabA.classList.add('hidden');
        tabA.onclick = null;
      }

      const modal = document.getElementById('class-modal');
      modal.classList.remove('hidden');
      // foco accesible
      document.getElementById('save-button').focus();
    },

    hideClassModal(){
      document.getElementById('class-modal').classList.add('hidden');
    },

    switchTab(tab){
      const tabD = document.getElementById('tab-details');
      const tabA = document.getElementById('tab-attendance');
      const contD= document.getElementById('details-content');
      const contA= document.getElementById('attendance-content');
      if (tab==='details'){
        tabD.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','true');
        tabA.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','false');
        contD.classList.remove('hidden'); contA.classList.add('hidden');
      } else {
        tabA.classList.add('border-b-2','border-indigo-500','text-indigo-400'); tabA.setAttribute('aria-selected','true');
        tabD.classList.remove('border-b-2','border-indigo-500','text-indigo-400'); tabD.setAttribute('aria-selected','false');
        contA.classList.remove('hidden'); contD.classList.add('hidden');
      }
    },

    async loadAttendeesForAttendance(cls){
      const list = document.getElementById('attendance-list');
      const msg  = document.getElementById('attendance-status-message');
      const save = document.getElementById('save-attendance-btn');

      const currentBookings = this.state.bookingsMap.get(cls.id) || [];

      const attSnap = await this.db.collection('attendance').where('classId','==', cls.id).get();
      const existing = {};
      attSnap.forEach(doc => {
        const d = doc.data();
        existing[d.userId] = d.status;
      });

      this.state.currentAttendance = {};
      currentBookings.forEach(b=>{
        if (existing[b.userId]){
          this.state.currentAttendance[b.userId] = { status: existing[b.userId], userName: b.userName };
        }
      });

      if (!currentBookings.length){
        msg.textContent = 'No hay usuarios inscritos en esta clase.';
        list.innerHTML = '';
        save.classList.add('hidden');
        return;
      }

      msg.textContent = `${currentBookings.length} usuarios inscritos.`;
      list.innerHTML = currentBookings.map(b=>{
        const st = existing[b.userId];
        const selA = st==='attended' ? 'selected-attended':'';
        const selF = st==='absent'   ? 'selected-absent':'';
        return `
          <div class="flex items-center justify-between bg-zinc-900 p-2 rounded-md">
            <span class="text-zinc-300">${b.userName || 'An√≥nimo'}</span>
            <div class="space-x-2" data-user-id="${b.userId}" data-user-name="${b.userName||'An√≥nimo'}">
              <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selA}" data-status="attended">Asisti√≥</button>
              <button class="attendance-btn border border-zinc-600 px-3 py-1 text-xs rounded-md ${selF}" data-status="absent">Falt√≥</button>
            </div>
          </div>`;
      }).join('');
      save.classList.remove('hidden');

      list.onclick = (e)=>{
        const btn = e.target.closest('.attendance-btn'); if (!btn) return;
        const parent = btn.parentElement;
        const { userId, userName } = parent.dataset;
        const { status } = btn.dataset;
        this.state.currentAttendance[userId] = { status, userName };
        parent.querySelectorAll('.attendance-btn').forEach(x=>x.classList.remove('selected-attended','selected-absent'));
        btn.classList.add(status==='attended'?'selected-attended':'selected-absent');
      };

      save.onclick = ()=> this.saveAttendance(cls);
    },

    async saveAttendance(cls){
      const data = this.state.currentAttendance;
      if (!Object.keys(data).length){
        this.showToast({title:'Sin cambios', message:'No marcaste asistencia', variant:'warn'});
        return;
      }
      const batch = this.db.batch();
      Object.keys(data).forEach(uid=>{
        const rec = data[uid];
        const ref = this.db.collection('attendance').doc(`${cls.classDate}_${cls.id}_${uid}`);
        batch.set(ref, {
          classId: cls.id,
          className: cls.name,
          classDate: cls.classDate,
          userId: uid,
          userName: rec.userName,
          status: rec.status,
          recordedAt: new Date()
        }, { merge:true });
      });
      try{
        await batch.commit();
        this.showToast({title:'Asistencia guardada'});
        this.hideClassModal();
      }catch(e){
        this.showToast({title:'Error al guardar', message:e.message, variant:'error'});
      }
    },

    // ---- USERS
    async sendPasswordReset(){
      const input = document.getElementById('user-email-input');
      const email = input.value.trim();
      if (!email) { this.showToast({title:'Falta correo', variant:'warn'}); return; }
      try{
        await this.auth.sendPasswordResetEmail(email);
        this.showToast({title:'Correo enviado', message:`Revisa ${email}`});
        input.value='';
      }catch(e){
        this.showToast({title:'No se pudo enviar', message:e.message, variant:'error'});
      }
    },

    // ---- AUTH
    login(){
        const email = document.getElementById('email-input').value.trim();
        const pass  = document.getElementById('password-input').value;
        const errEl = document.getElementById('error-message');
        errEl.classList.add('hidden');
        this.auth.signInWithEmailAndPassword(email, pass).catch(err=>{
            // Mensajes comunes
            const hint = err.code === 'auth/operation-not-allowed'
            ? 'Activa Email/Password en Firebase Console ‚Üí Authentication ‚Üí Sign-in method.'
            : err.code === 'auth/user-not-found'
            ? 'El usuario no existe o el email est√° mal escrito.'
            : err.code === 'auth/wrong-password'
            ? 'Contrase√±a incorrecta.'
            : '';
            errEl.textContent = 'Error: ' + err.message + (hint ? ' ‚Äî ' + hint : '');
            errEl.classList.remove('hidden');
        });
    },


    // ---- CRUD Clase (sin tocar enrolledCount manualmente)
    async saveClass(){
      const id = document.getElementById('class-id').value;
      if (!id) return;

      const newTime = document.getElementById('class-time').value;
      const data = {
        name: document.getElementById('class-name').value,
        instructor: document.getElementById('class-instructor').value,
        time: newTime,
        icon: document.getElementById('class-icon').value,
        description: document.getElementById('class-description').value,
      };

      try{
        const snap = await this.db.collection('classes').doc(id).get();
        if (snap.exists){
          const cur = snap.data();
          const classDate = cur.classDate;
          const duration  = Number(cur.duration || 60);
          const start     = new Date(`${classDate}T${(newTime || cur.time)}:00`);
          const end       = new Date(start.getTime() + duration*60000);
          data.startAt = firebase.firestore.Timestamp.fromDate(start);
          data.endAt   = firebase.firestore.Timestamp.fromDate(end);
        }

        await this.db.collection('classes').doc(id).set(data, { merge:true });
        this.showToast({title:'Clase actualizada'});
        this.hideClassModal();
      }catch(e){
        this.showToast({title:'No se guard√≥', message:e.message, variant:'error'});
      }
    },

    async deleteClass(){
      const id = document.getElementById('class-id').value;
      if (!id) return;
      // Modal sencillo de confirmaci√≥n con toast
      try{
        // Borra reservas relacionadas y luego la clase
        //updating for actions
        const snap = await this.db.collection('bookings').where('classId','==', id).get();
        const batch = this.db.batch();
        snap.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        await this.db.collection('classes').doc(id).delete();
        this.showToast({title:'Clase eliminada', message:`Se borraron ${snap.size} reservas`});
        this.hideClassModal();
      }catch(e){
        this.showToast({title:'No se pudo eliminar', message:e.message, variant:'error'});
      }
    },
  };

  AdminPanel.init();
  </script>
</body>
</html>