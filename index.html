<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Madness - Reserva de Clases</title>

  <!-- Tailwind + Lucide + Fuente -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#18181b">
  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="./images/icon-192x192.png">

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .transition-all { transition: all 0.3s ease-in-out; }
    .spinner { border-top-color: #6366f1; }
  </style>
</head>
<body class="bg-zinc-900 text-white antialiased">

  <!-- App -->
  <div id="app-container" class="h-screen flex-col overflow-hidden bg-zinc-900 hidden">
    <main id="main-content" class="flex-1 overflow-y-auto pb-32 no-scrollbar"></main>

    <!-- NavBar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-zinc-800/80 backdrop-blur-lg border-t border-zinc-700 z-[30]">
      <div id="nav-bar" class="flex justify-around h-20 max-w-md mx-auto">
        <button data-screen="classes" class="nav-button active-nav flex-1 flex flex-col items-center justify-center text-indigo-400">
          <i data-lucide="calendar-days" class="w-6 h-6 mb-1"></i><span class="text-xs font-medium">Clases</span>
        </button>
        <button data-screen="profile" class="nav-button flex-1 flex flex-col items-center justify-center text-zinc-400">
          <i data-lucide="user-circle" class="w-6 h-6 mb-1"></i><span class="text-xs font-medium">Perfil</span>
        </button>
      </div>
    </nav>
  </div>

  <!-- Auth -->
  <div id="auth-container" class="h-screen flex-col p-8 justify-center bg-zinc-900 hidden"></div>

  <!-- Loading -->
  <div id="loading-spinner" class="fixed inset-0 bg-zinc-900 flex items-center justify-center z-50">
    <div class="spinner animate-spin rounded-full h-16 w-16 border-4 border-zinc-700"></div>
  </div>

  <!-- Modal -->
  <div id="generic-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-6 hidden z-50">
    <div id="modal-content" class="bg-zinc-800 rounded-2xl p-6 text-center space-y-6 max-w-sm w-full mx-auto transition-all transform scale-95 opacity-0"></div>
  </div>

  <!-- FABs globales (WhatsApp / Instagram) -->
  <div id="social-fabs"
       class="fixed right-4 flex flex-col gap-3 z-[70] pointer-events-auto"
       style="bottom: calc(env(safe-area-inset-bottom, 0px) + 5rem);">
    <!-- WhatsApp -->
    <a href="https://wa.me/5215539887713" target="_blank" rel="noopener noreferrer"
       class="bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-lg flex items-center justify-center">
      <i data-lucide="message-circle" class="w-6 h-6"></i>
    </a>
    <!-- Instagram -->
    <a href="https://instagram.com/madness_crosstrainingmx" target="_blank" rel="noopener noreferrer"
       class="bg-gradient-to-tr from-pink-500 via-red-500 to-yellow-500 hover:opacity-90 text-white rounded-full p-4 shadow-lg flex items-center justify-center">
      <i data-lucide="camera" class="w-6 h-6"></i>
    </a>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Config Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
      authDomain: "madnessscheds.firebaseapp.com",
      projectId: "madnessscheds",
      storageBucket: "madnessscheds.firebasestorage.app",
      messagingSenderId: "788538690861",
      appId: "1:788538690861:web:ce19ead5929a8867c197a4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const dateHelper = {
      getYYYYMMDD(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      },
      get today() { return this.getYYYYMMDD(new Date()); },
      get tomorrow() { const d = new Date(); d.setDate(d.getDate() + 1); return this.getYYYYMMDD(d); }
    };

    function formatStartsIn(cls) {
      if (!cls || !cls.classDate || !cls.time) return '';
      const start = new Date(`${cls.classDate}T${cls.time}:00`);
      const duration = Number(cls.duration || 60);
      const end = new Date(start.getTime() + duration*60000);
      const now = new Date();
      const isToday = cls.classDate === dateHelper.today;

      if (isToday && now < start) {
        const diffMin = Math.max(0, Math.round((start - now)/60000));
        if (diffMin === 0) return 'En breve';
        const h = Math.floor(diffMin/60), m = diffMin % 60;
        return h > 0 ? `Empieza en ${h}h ${m}m` : `Empieza en ${m} min`;
      }
      if (isToday && now >= start && now <= end) return 'En curso';
      if (isToday && now > end) return 'Finalizada';
      return '';
    }

    let state = {
      currentUser: null,
      classes: [],
      myBookings: [],
      myWaitlist: [],             // clases donde estoy en lista de espera
      currentScreen: 'classes',   // 'classes' | 'profile' | 'classDetails'
      classesTab: 'schedule',     // 'schedule' | 'bookings' dentro de 'classes'
      scheduleFilter: 'today',    // 'today' | 'tomorrow'
      selectedClassId: null
    };

    // Soporte para shortcuts del manifest (?screen=..., ?tab=...)
    const _params = new URLSearchParams(location.search);
    const _screen = _params.get('screen');
    if (_screen && ['classes','profile'].includes(_screen)) state.currentScreen = _screen;
    const _tab = _params.get('tab');
    if (_tab && ['schedule','bookings'].includes(_tab)) state.classesTab = _tab;

    const mainContent   = document.getElementById('main-content');
    const authContainer = document.getElementById('auth-container');
    const appContainer  = document.getElementById('app-container');
    const loadingSpinner= document.getElementById('loading-spinner');
    const navBar        = document.getElementById('nav-bar');
    const fabs          = document.getElementById('social-fabs');

    let unsubClasses = null;
    let unsubMyBookings = null;
    let unsubMyWaitlist = null;

    auth.onAuthStateChanged(async user => {
      loadingSpinner.classList.remove('hidden');
      if (user) {
        state.currentUser = user;
        authContainer.style.display = 'none';
        appContainer.style.display = 'flex';
        await initializeApp();
      } else {
        state.currentUser = null;
        cleanupListeners();
        appContainer.style.display = 'none';
        authContainer.style.display = 'flex';
        renderAuthScreen();
        loadingSpinner.classList.add('hidden');
      }
    });

    function cleanupListeners(){
      if (unsubClasses)   { try{unsubClasses();}catch{};   unsubClasses=null; }
      if (unsubMyBookings){ try{unsubMyBookings();}catch{};unsubMyBookings=null; }
      if (unsubMyWaitlist){ try{unsubMyWaitlist();}catch{};unsubMyWaitlist=null; }
    }

    function renderAuthScreen(isLogin = true) {
      authContainer.innerHTML = `
        <div class="w-full max-w-md mx-auto">
          <h1 class="text-4xl font-bold text-white mb-2">Madness - Reserva de clases</h1>
          <p class="text-zinc-400 mb-8">${isLogin ? 'Inicia sesión para continuar' : 'Crea una cuenta para empezar'}</p>
          <div class="space-y-4">
            <input type="email" id="email-input" placeholder="Correo electrónico" class="w-full bg-zinc-800 text-white p-3 rounded-md border border-zinc-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
            <input type="password" id="password-input" placeholder="Contraseña" class="w-full bg-zinc-800 text-white p-3 rounded-md border border-zinc-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
          </div>
          <button id="auth-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md mt-6">${isLogin ? 'Iniciar Sesión' : 'Registrarse'}</button>
          <p class="text-center text-zinc-400 mt-6">${isLogin ? '¿No tienes cuenta?' : '¿Ya tienes cuenta?'} <a id="auth-toggle" href="#" class="font-semibold text-indigo-400 hover:underline">${isLogin ? 'Regístrate' : 'Inicia Sesión'}</a></p>
        </div>`;
      document.getElementById('auth-button').onclick = () => app.handleAuth(isLogin);
      document.getElementById('auth-toggle').onclick = (e) => { e.preventDefault(); renderAuthScreen(!isLogin); };
      lucide.createIcons();
    }

    async function initializeApp() {
      unsubClasses = db.collection('classes')
        .where('classDate', '>=', dateHelper.today)
        .orderBy('classDate', 'asc')
        .orderBy('time', 'asc')
        .onSnapshot((snapshot) => {
          state.classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          render();
        }, (err)=> console.error('Error clases:', err));

      unsubMyBookings = db.collection('bookings')
        .where('userId', '==', state.currentUser.uid)
        .onSnapshot((snapshot) => {
          state.myBookings = snapshot.docs.map(doc => (doc.data().classId));
          render();
        }, (err)=> console.error('Error mis reservas:', err));

      unsubMyWaitlist = db.collection('waitlist')
        .where('userId', '==', state.currentUser.uid)
        .onSnapshot((snapshot) => {
          state.myWaitlist = snapshot.docs.map(doc => (doc.data().classId));
          render();
        }, (err)=> console.error('Error waitlist:', err));

      render();
      loadingSpinner.classList.add('hidden');
    }

    function render() {
      let content = '';
      if (state.currentScreen === 'classes') {
        content = getClassesScreenHTML();
      } else if (state.currentScreen === 'profile') {
        content = getProfileScreenHTML();
      } else if (state.currentScreen === 'classDetails') {
        content = getClassDetailsScreenHTML(state.selectedClassId);
      }
      mainContent.innerHTML = `<div class="max-w-md mx-auto">${content}</div>`;
      updateNavButtons();
      lucide.createIcons();
    }

    function getClassesScreenHTML() {
      return `
        <div class="p-6 space-y-6">
          <header>
            <h1 class="text-3xl font-bold tracking-tight">Clases</h1>
            <p class="text-zinc-400">Reserva, cancela o únete a lista de espera.</p>
          </header>

          <!-- Tabs internas -->
          <div class="flex space-x-2 bg-zinc-800 p-1 rounded-lg">
            <button data-action="set-tab" data-tab="schedule" class="flex-1 py-2 text-sm font-semibold rounded-md ${state.classesTab === 'schedule' ? 'bg-indigo-600 text-white' : ''}">Horario</button>
            <button data-action="set-tab" data-tab="bookings" class="flex-1 py-2 text-sm font-semibold rounded-md ${state.classesTab === 'bookings' ? 'bg-indigo-600 text-white' : ''}">Mis reservas</button>
          </div>

          ${state.classesTab === 'schedule' ? getScheduleInnerHTML() : getBookingsInnerHTML()}
        </div>`;
    }

    function getScheduleInnerHTML() {
      const targetDate = state.scheduleFilter === 'today' ? dateHelper.today : dateHelper.tomorrow;
      let filtered = state.classes.filter(cls => cls.classDate === targetDate);

      if (state.scheduleFilter === 'today') {
        const now = new Date();
        filtered = filtered.filter(cls => {
          const classStartTime = new Date(`${dateHelper.today}T${cls.time}:00`);
          const cutoffTime = new Date(classStartTime.getTime() + 5 * 60000);
          return now <= cutoffTime;
        });
      }

      const cards = filtered.length
        ? filtered.map(cls => {
            const enrolled = Number(cls.enrolledCount || 0);
            const availableSpots = Number(cls.capacity || 0) - enrolled;
            const isBooked = state.myBookings.includes(cls.id);
            const isWaitlisted = state.myWaitlist.includes(cls.id);

            let badgeHTML = `<span class="text-xs bg-emerald-500/50 text-emerald-300 px-2 py-1 rounded-md">¡Hay cupo!</span>`;
            if (isBooked) {
              badgeHTML = `<span class="text-xs bg-indigo-500/50 text-indigo-300 px-2 py-1 rounded-md">Reservada</span>`;
            } else if (availableSpots <= 0) {
              badgeHTML = isWaitlisted
                ? `<span class="text-xs bg-amber-500/50 text-amber-300 px-2 py-1 rounded-md">En lista</span>`
                : `<span class="text-xs bg-rose-500/50 text-rose-300 px-2 py-1 rounded-md">Llena</span>`;
            }

            const si = formatStartsIn(cls);
            const siHTML = si ? `<p class="text-xs mt-1 ${si==='En curso'?'text-amber-300': (si==='Finalizada'?'text-zinc-400':'text-amber-300')}">${si}</p>` : '';

            return `
              <div data-action="navigate-details" data-class-id="${cls.id}" class="bg-zinc-800 rounded-2xl p-4 flex items-center space-x-4 cursor-pointer hover:bg-zinc-700">
                <div>
                  <p class="font-bold text-lg">${cls.name}</p>
                  <p class="text-zinc-400 text-sm">con ${cls.instructor}</p>
                  <p class="text-sm mt-1 text-emerald-400">${cls.time} hrs</p>
                  ${siHTML}
                </div>
                <div class="flex-1 text-right">${badgeHTML}</div>
              </div>`;
          }).join('')
        : `<div class="bg-zinc-800 rounded-2xl p-5 text-center text-zinc-400">No hay más clases por ${state.scheduleFilter === 'today' ? 'hoy' : 'mañana'}.</div>`;

      return `
        <div class="space-y-4">
          <div class="flex space-x-2 bg-zinc-800 p-1 rounded-lg">
            <button data-action="set-filter" data-filter="today" class="flex-1 py-2 text-sm font-semibold rounded-md ${state.scheduleFilter === 'today' ? 'bg-indigo-600 text-white' : ''}">Hoy</button>
            <button data-action="set-filter" data-filter="tomorrow" class="flex-1 py-2 text-sm font-semibold rounded-md ${state.scheduleFilter === 'tomorrow' ? 'bg-indigo-600 text-white' : ''}">Mañana</button>
          </div>
          ${cards}
        </div>`;
    }

    function getBookingsInnerHTML() {
      // Próximas reservas (todas las futuras que existan en state.classes)
      const myBooked = state.myBookings
        .map(id => state.classes.find(c => c.id === id))
        .filter(Boolean)
        .sort((a,b) => (a.classDate + a.time).localeCompare(b.classDate + b.time));

      // Tus listas de espera
      const myWaitClasses = state.myWaitlist
        .map(id => state.classes.find(c => c.id === id))
        .filter(Boolean)
        .sort((a,b) => (a.classDate + a.time).localeCompare(b.classDate + b.time));

      const bookedHTML = myBooked.length
        ? myBooked.map(cls => {
            const si = formatStartsIn(cls);
            const siHTML = si ? `<p class="text-xs mt-1 ${si==='En curso'?'text-amber-300': (si==='Finalizada'?'text-zinc-400':'text-amber-300')}">${si}</p>` : '';
            return `
              <div class="bg-zinc-800 rounded-2xl p-4 flex items-center space-x-4">
                <div>
                  <p class="font-bold text-lg">${cls.name}</p>
                  <p class="text-zinc-400 text-sm">${cls.classDate} a las ${cls.time}</p>
                  ${siHTML}
                </div>
                <div class="flex-1 text-right">
                  <button data-action="cancel-booking" data-class-id="${cls.id}" class="text-xs text-rose-400 hover:text-rose-300">Cancelar</button>
                </div>
              </div>`;
          }).join('')
        : `<div class="bg-zinc-800 rounded-2xl p-5 text-center text-zinc-400">No tienes clases reservadas.</div>`;

      const waitHTML = myWaitClasses.length
        ? myWaitClasses.map(cls => {
            const si = formatStartsIn(cls);
            const siHTML = si ? `<p class="text-xs mt-1 ${si==='En curso'?'text-amber-300': (si==='Finalizada'?'text-zinc-400':'text-amber-300')}">${si}</p>` : '';
            return `
              <div class="bg-zinc-800 rounded-2xl p-4 flex items-center justify-between">
                <div>
                  <p class="font-bold text-lg">${cls.name}</p>
                  <p class="text-zinc-400 text-sm">${cls.classDate} a las ${cls.time}</p>
                  ${siHTML}
                </div>
                <button data-action="leave-waitlist" data-class-id="${cls.id}" class="text-xs text-amber-300 hover:text-amber-200">Salir</button>
              </div>`;
          }).join('')
        : `<div class="bg-zinc-800 rounded-2xl p-5 text-center text-zinc-400">No estás en lista de espera.</div>`;

      return `
        <div class="space-y-6">
          <div>
            <h2 class="text-xl font-semibold mb-3">Tus reservas</h2>
            ${bookedHTML}
          </div>
          <div class="pt-2 border-t border-zinc-700">
            <h2 class="text-xl font-semibold mb-3">Tus listas de espera</h2>
            ${waitHTML}
          </div>
        </div>`;
    }

    function getProfileScreenHTML() {
      return `
        <div class="p-6 space-y-6">
          <header class="text-center space-y-4">
            <img src="${state.currentUser.photoURL || `https://placehold.co/100x100/18181b/ffffff?text=${(state.currentUser.displayName || state.currentUser.email).charAt(0).toUpperCase()}`}" class="w-24 h-24 rounded-full mx-auto border-4 border-zinc-700" alt="avatar">
            <div><h1 class="text-2xl font-bold">${state.currentUser.displayName || state.currentUser.email}</h1></div>
          </header>
          <div class="bg-zinc-800 rounded-2xl p-4 divide-y divide-zinc-700">
            <a href="#" data-action="edit-name" class="flex items-center justify-between py-3"><span>Editar Nombre</span><i data-lucide="chevron-right" class="w-5 h-5 text-zinc-500"></i></a>
            <a href="#" data-action="logout" class="flex items-center justify-between py-3 text-rose-400"><span>Cerrar Sesión</span><i data-lucide="log-out" class="w-5 h-5"></i></a>
          </div>
        </div>`;
    }

    function getClassDetailsScreenHTML(classId) {
      const cls = state.classes.find(c => c.id === classId);
      if (!cls) return getClassesScreenHTML();

      const enrolled = Number(cls.enrolledCount || 0);
      const availableSpots = Number(cls.capacity || 0) - enrolled;
      const isBooked = state.myBookings.includes(cls.id);
      const isWaitlisted = state.myWaitlist.includes(cls.id);

      let buttonHTML = '';
      if (isBooked) {
        buttonHTML = `<button class="w-full bg-zinc-700 text-zinc-400 font-bold py-4 rounded-xl" disabled>Ya estás inscrito</button>`;
      } else if (availableSpots > 0) {
        buttonHTML = `<button data-action="confirm-booking" data-class-id="${cls.id}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl">Reservar Ahora</button>`;
      } else {
        buttonHTML = isWaitlisted
          ? `<button data-action="leave-waitlist" data-class-id="${cls.id}" class="w-full bg-amber-900 hover:bg-amber-800 text-amber-200 font-bold py-4 rounded-xl">Salir de la lista de espera</button>`
          : `<button data-action="join-waitlist" data-class-id="${cls.id}" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 rounded-xl">Unirme a la lista de espera</button>`;
      }

      const si = formatStartsIn(cls);
      const siHTML = si ? `<div class="text-sm ${si==='En curso'?'text-amber-300': (si==='Finalizada'?'text-zinc-400':'text-amber-300')}">${si}</div>` : '';

      return `
        <div>
          <div class="relative">
            <img src="${cls.image}" class="w-full h-64 object-cover" alt="${cls.name}">
            <button data-action="navigate" data-screen="classes" class="absolute top-6 left-6 bg-black/50 p-2 rounded-full text-white"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
          </div>
          <div class="p-6 space-y-4 pb-40">
            <h1 class="text-3xl font-bold">${cls.name}</h1>
            <div class="text-zinc-400 leading-relaxed">${cls.description || ''}</div>
            ${siHTML}
            <div class="bg-zinc-800 p-4 rounded-xl flex justify-between items-center">
              <span class="font-semibold text-lg">Estado</span>
              <span class="text-2xl font-bold ${availableSpots > 0 ? 'text-emerald-400' : 'text-rose-400'}">${availableSpots > 0 ? '¡Hay cupo!' : 'Llena'}</span>
            </div>
          </div>
          <div class="p-6 fixed bottom-20 left-0 right-0 max-w-md mx-auto bg-zinc-900">${buttonHTML}</div>
        </div>`;
    }

    const app = {
      handleAuth: (isLogin) => {
        const email = document.getElementById('email-input').value;
        const pass  = document.getElementById('password-input').value;
        if (!email || !pass) { alert("Por favor, ingresa correo y contraseña."); return; }
        loadingSpinner.classList.remove('hidden');
        const p = isLogin ? auth.signInWithEmailAndPassword(email, pass) : auth.createUserWithEmailAndPassword(email, pass);
        p.catch(err => { alert(err.message); loadingSpinner.classList.add('hidden'); });
      },
      logout: () => auth.signOut(),
      editUserName: (event) => {
        event.preventDefault();
        const newName = prompt("Ingresa tu nombre y apellido:", state.currentUser.displayName || "");
        if (newName && newName.trim() !== "") {
          loadingSpinner.classList.remove('hidden');
          state.currentUser.updateProfile({ displayName: newName.trim() }).then(() => {
            render();
            loadingSpinner.classList.add('hidden');
          }).catch(err => { alert("Error: " + err.message); loadingSpinner.classList.add('hidden'); });
        }
      },
      navigateTo: (screen, data = {}) => {
        state.currentScreen = screen;
        if (data.classId) state.selectedClassId = data.classId;
        render();
      },
      setClassesTab: (tab) => {
        state.classesTab = tab;
        render();
      },
      setScheduleFilter: (filter) => {
        state.scheduleFilter = filter;
        render();
      },

      // Reservar (transacción + IDs determinísticos)
      confirmBooking: async (classId) => {
        const uid = state.currentUser.uid;
        const classRef   = db.collection('classes').doc(classId);
        const bookingRef = db.collection('bookings').doc(`${classId}_${uid}`);
        const waitRef    = db.collection('waitlist').doc(`${classId}_${uid}`);

        try {
          await db.runTransaction(async (tx) => {
            const [classSnap, bookingSnap] = await Promise.all([ tx.get(classRef), tx.get(bookingRef) ]);
            if (!classSnap.exists) throw new Error('La clase ya no existe.');
            if (bookingSnap.exists) throw new Error('Ya tienes reserva para esta clase.');
            const cls = classSnap.data();
            const enrolled = Number(cls.enrolledCount || 0);
            const capacity = Number(cls.capacity || 0);
            if (enrolled >= capacity) throw new Error('Clase llena.');

            tx.set(bookingRef, {
              classId,
              userId: uid,
              userName: state.currentUser.displayName || state.currentUser.email,
              classDate: cls.classDate,
              time: cls.time,
              className: cls.name,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            tx.update(classRef, { enrolledCount: firebase.firestore.FieldValue.increment(1) });

            // si estaba en waitlist, quitarlo
            tx.delete(waitRef);
          });
          showModal({ success: true, title: '¡Reserva Exitosa!' });
        } catch (err) {
          alert(`No se pudo reservar\n\n${err.message}`);
        }
      },

      // Cancelar (transacción + decremento seguro)
      cancelBooking: async (classId) => {
        const uid = state.currentUser.uid;
        const classRef   = db.collection('classes').doc(classId);
        const bookingRef = db.collection('bookings').doc(`${classId}_${uid}`);

        try {
          await db.runTransaction(async (tx) => {
            const [bookingSnap, classSnap] = await Promise.all([ tx.get(bookingRef), tx.get(classRef) ]);
            if (!bookingSnap.exists) throw new Error('No tienes reserva para esta clase.');
            tx.delete(bookingRef);
            if (classSnap.exists) {
              const enrolled = Number(classSnap.data().enrolledCount || 0);
              if (enrolled > 0) {
                tx.update(classRef, { enrolledCount: firebase.firestore.FieldValue.increment(-1) });
              }
            }
          });
          showModal({ success: false, title: 'Cancelación Exitosa' });
        } catch (err) {
          alert(`No se pudo cancelar\n\n${err.message}`);
        }
      },

      // Waitlist
      joinWaitlist: async (classId) => {
        const uid = state.currentUser.uid;
        const waitRef = db.collection('waitlist').doc(`${classId}_${uid}`);
        const classRef = db.collection('classes').doc(classId);

        try {
          await db.runTransaction(async (tx) => {
            const [wSnap, cSnap] = await Promise.all([ tx.get(waitRef), tx.get(classRef) ]);
            if (!cSnap.exists) throw new Error('La clase ya no existe.');
            if (wSnap.exists)  throw new Error('Ya estás en la lista de espera.');
            const cls = cSnap.data();
            tx.set(waitRef, {
              classId,
              userId: uid,
              userName: state.currentUser.displayName || state.currentUser.email,
              classDate: cls.classDate,
              time: cls.time,
              className: cls.name,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          });
          showModal({ success:true, title:'Te uniste a la lista de espera' });
        } catch (err) {
          alert(`No se pudo unir a la lista\n\n${err.message}`);
        }
      },

      leaveWaitlist: async (classId) => {
        const uid = state.currentUser.uid;
        try {
          await db.collection('waitlist').doc(`${classId}_${uid}`).delete();
          showModal({ success:false, title:'Saliste de la lista de espera' });
        } catch (err) {
          alert(`No se pudo salir de la lista\n\n${err.message}`);
        }
      },
    };

    // Delegación de eventos
    function handleInteraction(e) {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      const { action, screen, tab, filter, classId } = target.dataset;

      switch (action) {
        case 'navigate': app.navigateTo(screen); break;
        case 'navigate-details': app.navigateTo('classDetails', { classId }); break;
        case 'set-tab': app.setClassesTab(tab); break;
        case 'set-filter': app.setScheduleFilter(filter); break;
        case 'edit-name': app.editUserName(e); break;
        case 'logout': app.logout(); break;

        case 'confirm-booking':
          target.disabled = true; app.confirmBooking(classId).finally(()=> target.disabled = false); break;
        case 'cancel-booking':
          target.disabled = true; app.cancelBooking(classId).finally(()=> target.disabled = false); break;

        case 'join-waitlist':
          target.disabled = true; app.joinWaitlist(classId).finally(()=> target.disabled = false); break;
        case 'leave-waitlist':
          target.disabled = true; app.leaveWaitlist(classId).finally(()=> target.disabled = false); break;
      }
    }
    mainContent.addEventListener('click', handleInteraction);
    navBar.addEventListener('click', e => {
      const target = e.target.closest('.nav-button');
      if (target) app.navigateTo(target.dataset.screen);
    });

    // Modal helpers (ocultamos FABs cuando esté abierto)
    const genericModal = document.getElementById('generic-modal');
    const modalContent = document.getElementById('modal-content');
    function showModal({ success, title }) {
      if (fabs) fabs.classList.add('opacity-0','pointer-events-none');
      modalContent.innerHTML = `
        <div class="w-16 h-16 ${success ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'} rounded-full flex items-center justify-center mx-auto">
          <i data-lucide="${success ? 'check' : 'trash-2'}" class="w-10 h-10"></i>
        </div>
        <h2 class="text-2xl font-bold">${title}</h2>
        <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg mt-4">Entendido</button>`;
      genericModal.classList.remove('hidden');
      setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10);
      document.getElementById('modal-close-btn').onclick = hideModal;
      lucide.createIcons();
    }
    function hideModal() {
      modalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        genericModal.classList.add('hidden');
        if (fabs) fabs.classList.remove('opacity-0','pointer-events-none');
        // tras reservar/cancelar, vuelve a Clases
        app.navigateTo(state.currentScreen === 'classDetails' ? 'classes' : state.currentScreen);
      }, 200);
    }

    function updateNavButtons() {
      const navButtons = navBar.querySelectorAll('.nav-button');
      navButtons.forEach(button => {
        const isActive = button.dataset.screen === state.currentScreen;
        button.classList.toggle('active-nav', isActive);
        button.classList.toggle('text-indigo-400', isActive);
        button.classList.toggle('text-zinc-400', !isActive);
      });
    }

    // Asegura íconos para FABs al cargar
    lucide.createIcons();
  });
  </script>

  <!-- Service Worker (sin offline, no-op ok) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('./service-worker.js', { scope: './' })
          .catch(err => console.error('SW fail', err));
      });
    }
  </script>
</body>
</html>
