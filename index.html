<!DOCTYPE html>
<html lang="es">
Â  <head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
Â  Â  <title>Madness - Reserva de Clases</title>

Â  Â  Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <script src="https://unpkg.com/lucide@latest"></script>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  Â  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

Â  Â  Â  Â  <link rel="manifest" href="./manifest.json">
Â  Â  <meta name="theme-color" content="#18181b">

Â  Â  Â  Â  <meta name="apple-mobile-web-app-capable" content="yes">
Â  Â  <meta name="mobile-web-app-capable" content="yes">
Â  Â  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
Â  Â  <link rel="apple-touch-icon" href="./images/icon-192x192.png">

Â  Â  <style>
Â  Â  Â  body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
Â  Â  Â  .no-scrollbar::-webkit-scrollbar { display: none; }
Â  Â  Â  .transition-all { transition: all 0.3s ease-in-out; }
Â  Â  Â  .spinner { border-top-color: #6366f1; }
Â  Â  </style>
Â  </head>
Â  <body class="bg-zinc-900 text-white antialiased">
Â  Â  Â  Â  <div id="app-container" class="h-screen flex-col overflow-hidden bg-zinc-900 hidden">
Â  Â  Â  <main id="main-content" class="flex-1 overflow-y-auto pb-32 no-scrollbar"></main>
Â  Â  Â  Â  Â  Â  <nav class="fixed bottom-0 left-0 right-0 bg-zinc-800/80 backdrop-blur-lg border-t border-zinc-700 z-[30]">
Â  Â  Â  Â  <div id="nav-bar" class="flex justify-around h-20 max-w-md mx-auto">
Â  Â  Â  Â  Â  <button data-screen="agenda" class="nav-button active-nav flex-1 flex flex-col items-center justify-center text-indigo-400">
Â  Â  Â  Â  Â  Â  <i data-lucide="calendar-days" class="w-6 h-6 mb-1"></i>
Â  Â  Â  Â  Â  Â  <span class="text-xs font-medium">Agenda</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  <button data-screen="profile" class="nav-button flex-1 flex flex-col items-center justify-center text-zinc-400">
Â  Â  Â  Â  Â  Â  <i data-lucide="user-circle" class="w-6 h-6 mb-1"></i>
Â  Â  Â  Â  Â  Â  <span class="text-xs font-medium">Perfil</span>
Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  Â  </nav>
Â  Â  </div>

Â  Â  Â  Â  <div id="auth-container" class="h-screen flex-col p-8 justify-center bg-zinc-900 hidden"></div>

Â  Â  Â  Â  <div id="loading-spinner" class="fixed inset-0 bg-zinc-900 flex items-center justify-center z-50">
Â  Â  Â  <div class="spinner animate-spin rounded-full h-16 w-16 border-4 border-zinc-700"></div>
Â  Â  </div>

Â  Â  Â  Â  <div id="generic-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-6 hidden z-50">
Â  Â  Â  <div id="modal-content" class="bg-zinc-800 rounded-2xl p-6 text-center space-y-6 max-w-sm w-full mx-auto transition-all transform scale-95 opacity-0"></div>
Â  Â  </div>

Â  Â  Â  Â  <div id="toast" role="status" tabindex="0" class="fixed bottom-4 left-1/2 -translate-x-1/2 transform bg-zinc-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity z-[100]"></div>

Â  Â  Â  Â  <div id="social-fabs" class="fixed right-4 flex flex-col gap-3 z-[70] pointer-events-auto" style="bottom: calc(env(safe-area-inset-bottom, 0px) + 5rem);">
Â  Â  Â  <a href="https://wa.me/5215539887713" target="_blank" rel="noopener noreferrer" class="bg-green-500 hover:bg-green-600 text-white rounded-full p-4 shadow-lg flex items-center justify-center">
Â  Â  Â  Â  <i data-lucide="message-circle" class="w-6 h-6"></i>
Â  Â  Â  </a>
Â  Â  Â  <a href="https://instagram.com/madness_crosstrainingmx" target="_blank" rel="noopener noreferrer" class="bg-gradient-to-tr from-pink-500 via-red-500 to-yellow-500 hover:opacity-90 text-white rounded-full p-4 shadow-lg flex items-center justify-center">
Â  Â  Â  Â  <i data-lucide="camera" class="w-6 h-6"></i>
Â  Â  Â  </a>
Â  Â  </div>

Â  Â  Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-messaging-compat.js"></script>
Â  Â  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-functions-compat.js"></script>

Â  Â  <script>
Â  Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  Â  // ---- Firebase config
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  apiKey: "AIzaSyBvvPDDlWsRqV4LdmNeZBuLfBn8k3_mI2A",
Â  Â  Â  Â  Â  authDomain: "madnessscheds.firebaseapp.com",
Â  Â  Â  Â  Â  projectId: "madnessscheds",
Â  Â  Â  Â  Â  storageBucket: "madnessscheds.firebasestorage.app",
Â  Â  Â  Â  Â  messagingSenderId: "788538690861",
Â  Â  Â  Â  Â  appId: "1:788538690861:web:ce19ead5929a8867c197a4"
Â  Â  Â  Â  };
Â  Â  Â  Â  firebase.initializeApp(firebaseConfig);

Â  Â  Â  Â  const db = firebase.firestore();
Â  Â  Â  Â  const auth = firebase.auth();
Â  Â  Â  Â  const messaging = firebase.messaging();
Â  Â  Â  Â  const functionsSvc = firebase.app().functions('us-central1');
Â  Â  Â  Â  const cancelBookingCallable = functionsSvc.httpsCallable('cancelBooking');

Â  Â  Â  Â  // ---- Enable client cache (multi-tab safe)
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  await firebase.firestore().enablePersistence({ synchronizeTabs: true });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.warn('Persistence not enabled:', e && e.code);
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---- Helpers (fechas, UI, etc.)
Â  Â  Â  Â  const MX_TZ = 'America/Mexico_City';
Â  Â  Â  Â  const ymdFmt = new Intl.DateTimeFormat('en-CA',{ timeZone: MX_TZ, year:'numeric', month:'2-digit', day:'2-digit' });
Â  Â  Â  Â  const timeFmt = new Intl.DateTimeFormat('es-MX',{ timeZone: MX_TZ, hour:'2-digit', minute:'2-digit', hour12:false });
Â  Â  Â  Â  const dateHelper = {
Â  Â  Â  Â  Â  getYYYYMMDD(date){ return ymdFmt.format(date); },
Â  Â  Â  Â  Â  get today(){ return this.getYYYYMMDD(new Date()); },
Â  Â  Â  Â  Â  get tomorrow(){ return this.getYYYYMMDD(new Date(Date.now()+86400000)); },
Â  Â  Â  Â  Â  human(ymd){
Â  Â  Â  Â  Â  Â  const dt=new Date(`${ymd}T00:00:00Z`);
Â  Â  Â  Â  Â  Â  return dt.toLocaleDateString('es-MX',{ timeZone: MX_TZ, weekday:'long',day:'2-digit',month:'short' });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  const timeHelper = {
Â  Â  Â  Â  Â  range(ymd, hhmm, durationMin=60){
Â  Â  Â  Â  Â  Â  const start=new Date(`${ymd}T${hhmm}:00Z`);
Â  Â  Â  Â  Â  Â  const end=new Date(start.getTime()+Number(durationMin||60)*60000);
Â  Â  Â  Â  Â  Â  return `${timeFmt.format(start)}â€“${timeFmt.format(end)}`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  const asDate = (x) => x?.toDate ? x.toDate() : new Date(x);
Â  Â  Â  Â  const FIFTEEN_MINUTES_MS = 15 * 60 * 1000;
Â  Â  Â  Â  const TWO_HOURS_MS = 2 * 60 * 60 * 1000;

Â  Â  Â  Â  function timeUntilLabel(ymd, hhmm){
Â  Â  Â  Â  Â  if(!ymd||!hhmm) return '';
Â  Â  Â  Â  Â  const start=new Date(`${ymd}T${hhmm}:00Z`).getTime();
Â  Â  Â  Â  Â  const now=Date.now();
Â  Â  Â  Â  Â  const diff=start-now;
Â  Â  Â  Â  Â  if (diff>4*60*60*1000) return '';
Â  Â  Â  Â  Â  const min=Math.round(diff/60000);
Â  Â  Â  Â  Â  if (min<=-120) return 'finalizada';
Â  Â  Â  Â  Â  if (min<0) return 'en curso';
Â  Â  Â  Â  Â  if (min===0) return 'empieza ahora';
Â  Â  Â  Â  Â  if (min<60) return `empieza en ${min} min`;
Â  Â  Â  Â  Â  const h=Math.floor(min/60), r=min%60;
Â  Â  Â  Â  Â  return r===0 ? `empieza en ${h} h` : `empieza en ${h} h ${r} min`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const coverHelper = {
Â  Â  Â  Â  Â  byName(name=''){
Â  Â  Â  Â  Â  Â  const n=name.toLowerCase();
Â  Â  Â  Â  Â  Â  if (n.includes('trx')) return 'images/trx.png';
Â  Â  Â  Â  Â  Â  if (n.includes('yoga')) return 'images/yoga.png';
Â  Â  Â  Â  Â  Â  if (n.includes('hiit')) return 'images/HIIT.png';
Â  Â  Â  Â  Â  Â  if (n.includes('capoeira')) return 'images/capoeira.png';
Â  Â  Â  Â  Â  Â  if (n.includes('funcional')||n.includes('functional')) return 'images/functional.png';
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  forClassName(name, fallbackText){
Â  Â  Â  Â  Â  Â  return this.byName(name)||`https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(fallbackText||name||'Clase')}`;
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  forClass(cls){
Â  Â  Â  Â  Â  Â  return this.byName(cls.name)||cls.image||`https://placehold.co/400x250/1f2937/ffffff?text=${encodeURIComponent(cls.name)}`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // ---- Estado
Â  Â  Â  Â  let state = {
Â  Â  Â  Â  Â  currentUser: null,
Â  Â  Â  Â  Â  classes: [],
Â  Â  Â  Â  Â  myBookings: [],
Â  Â  Â  Â  Â  waitlistEntries: [],
Â  Â  Â  Â  Â  currentScreen: 'agenda',
Â  Â  Â  Â  Â  scheduleFilter: 'today',
Â  Â  Â  Â  Â  selectedClassId: null,
Â  Â  Â  Â  Â  isTotalPass: false,
Â  Â  Â  Â  Â  cancellationStrikes: 0
Â  Â  Â  Â  };

Â  Â  Â  Â  // ---- Render batching
Â  Â  Â  Â  let renderQueued=false;
Â  Â  Â  Â  function scheduleRender(){
Â  Â  Â  Â  Â  if (renderQueued) return;
Â  Â  Â  Â  Â  renderQueued=true;
Â  Â  Â  Â  Â  requestAnimationFrame(()=>{ renderQueued=false; render(); });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Screen via querystring
Â  Â  Â  Â  const _params = new URLSearchParams(location.search);
Â  Â  Â  Â  const _screen = _params.get('screen');
Â  Â  Â  Â  if (_screen && ['agenda','profile','classDetails'].includes(_screen)) state.currentScreen=_screen;

Â  Â  Â  Â  // DOM refs
Â  Â  Â  Â  const mainContent = document.getElementById('main-content');
Â  Â  Â  Â  const authContainer = document.getElementById('auth-container');
Â  Â  Â  Â  const appContainer = document.getElementById('app-container');
Â  Â  Â  Â  const loadingSpinner = document.getElementById('loading-spinner');
Â  Â  Â  Â  const navBar = document.getElementById('nav-bar');
Â  Â  Â  Â  const toastEl = document.getElementById('toast');
Â  Â  Â  Â  let toastTimeout;
Â  Â  Â  Â  function showToast(message, type = 'info', opts = {}) {
Â  Â  Â  Â  Â  if (!toastEl) return;
Â  Â  Â  Â  Â  const { html = false, duration = 3000 } = opts;
Â  Â  Â  Â  Â  if (html) toastEl.innerHTML = message; else toastEl.textContent = message;
Â  Â  Â  Â  Â  toastEl.classList.remove('opacity-0', 'bg-green-600', 'bg-red-600', 'bg-zinc-800');
Â  Â  Â  Â  Â  const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-zinc-800';
Â  Â  Â  Â  Â  toastEl.classList.add(color, 'opacity-100');
Â  Â  Â  Â  Â  toastEl.focus();
Â  Â  Â  Â  Â  clearTimeout(toastTimeout);
Â  Â  Â  Â  Â  toastTimeout = setTimeout(() => {
Â  Â  Â  Â  Â  Â  toastEl.classList.remove('opacity-100');
Â  Â  Â  Â  Â  Â  toastEl.classList.add('opacity-0');
Â  Â  Â  Â  Â  }, duration);
Â  Â  Â  Â  }
Â  Â  Â  Â  window.showToast = showToast;

Â  Â  Â  Â  // Firestore listeners
Â  Â  Â  Â  let unsubClasses=null, unsubMyBookings=null, unsubWaitlist=null, unsubUser=null, listenersAttached=false;
Â  Â  Â  Â  function detachListeners(){
Â  Â  Â  Â  Â  if (unsubClasses){ try{unsubClasses();}catch{}; unsubClasses=null; }
Â  Â  Â  Â  Â  if (unsubMyBookings){ try{unsubMyBookings();}catch{}; unsubMyBookings=null; }
Â  Â  Â  Â  Â  if (unsubWaitlist){ try{unsubWaitlist();}catch{}; unsubWaitlist=null; }
Â  Â  Â  Â  Â  if (unsubUser){ try{unsubUser();}catch{}; unsubUser=null; }
Â  Â  Â  Â  Â  listenersAttached=false;
Â  Â  Â  Â  }
Â  Â  Â  Â  function attachAgendaListeners(){
Â  Â  Â  Â  Â  if (listenersAttached || !state.currentUser) return;
Â  Â  Â  Â  Â  const nowMinus5 = new Date(Date.now()-5*60*1000);
Â  Â  Â  Â  Â  unsubClasses = db.collection('classes').where('startAt','>=',nowMinus5).orderBy('startAt','asc').limit(100)
Â  Â  Â  Â  Â  Â  .onSnapshot(snap=>{
Â  Â  Â  Â  Â  Â  Â  state.classes = snap.docs.map(d=>({id:d.id,...d.data()}));
Â  Â  Â  Â  Â  Â  Â  scheduleRender();
Â  Â  Â  Â  Â  Â  }, err=>console.error('Error clases:', err));
Â  Â  Â  Â  Â  unsubMyBookings = db.collection('bookings').where('userId','==',state.currentUser.uid)
Â  Â  Â  Â  Â  Â  .onSnapshot(snap=>{
Â  Â  Â  Â  Â  Â  Â  state.myBookings = snap.docs.map(d=>({id:d.id,...d.data()}));
Â  Â  Â  Â  Â  Â  Â  scheduleRender();
Â  Â  Â  Â  Â  Â  }, err=>console.error('Error mis reservas:', err));
Â  Â  Â  Â  Â  unsubWaitlist = db.collection('waitlists')
Â  Â  Â  Â  Â  Â  .where('userId', '==', state.currentUser.uid)
Â  Â  Â  Â  Â  Â  .onSnapshot(snap => {
Â  Â  Â  Â  Â  Â  Â  state.waitlistEntries = snap.docs.map(d=>({id:d.id,...d.data()}));
Â  Â  Â  Â  Â  Â  Â  scheduleRender();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  unsubUser = db.collection('users').doc(state.currentUser.uid)
Â  Â  Â  Â  Â  Â  .onSnapshot(doc => {
Â  Â  Â  Â  Â  Â  Â  const data = doc.data() || {};
Â  Â  Â  Â  Â  Â  Â  state.isTotalPass = !!data.totalPass;
Â  Â  Â  Â  Â  Â  Â  const strikesRaw = Number(data.lateCancellations);
Â  Â  Â  Â  Â  Â  Â  state.cancellationStrikes = Number.isFinite(strikesRaw) && strikesRaw > 0 ? strikesRaw : 0;
Â  Â  Â  Â  Â  Â  Â  scheduleRender();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  listenersAttached=true;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===============================
Â  Â  Â  Â  //Â  FCM: registrar SW y mantener token fresco
Â  Â  Â  Â  // ===============================
Â  Â  Â  Â  const VAPID_KEY = 'BDkzQqJ9a_NQssIIP6Pu-HQ1sxCOIwUiDW6OxCdKtvCmrSZMXpcjO-hdETrkPKycj-CfLSf75cskOC6HfHmYWRw';
Â  Â  Â  Â  const LS_KEY = 'fcm:lastToken';

Â  Â  Â  Â  async function registerSW() {
Â  Â  Â  Â  Â  // Asegura scope correcto en GitHub Pages
Â  Â  Â  Â  Â  const reg = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
Â  Â  Â  Â  Â  try { await reg.update(); } catch {}
Â  Â  Â  Â  Â  // Guarda para getToken
Â  Â  Â  Â  Â  window._msgSW = reg;
Â  Â  Â  Â  Â  return reg;
Â  Â  Â  Â  }

Â  Â  Â  Â  function isPushSupported(){
Â  Â  Â  Â  Â  return typeof firebase.messaging.isSupported === 'function' && firebase.messaging.isSupported();
Â  Â  Â  Â  }

Â  Â  Â  Â  function buildDeviceMetadata(){
Â  Â  Â  Â  Â  const metadata = {
Â  Â  Â  Â  Â  Â  userAgent: navigator.userAgent || 'unknown',
Â  Â  Â  Â  Â  Â  platform: navigator.platform || 'unknown',
Â  Â  Â  Â  Â  Â  registeredAt: new Date()
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  const screenObj = window?.screen;
Â  Â  Â  Â  Â  if (screenObj?.width && screenObj?.height){
Â  Â  Â  Â  Â  Â  metadata.screen = `${screenObj.width}x${screenObj.height}`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
Â  Â  Â  Â  Â  Â  if (tz) metadata.timezone = tz;
Â  Â  Â  Â  Â  }catch{}
Â  Â  Â  Â  Â  const language = navigator.language || (navigator.languages && navigator.languages[0]);
Â  Â  Â  Â  Â  if (language) metadata.language = language;
Â  Â  Â  Â  Â  if (navigator.vendor) metadata.browser = navigator.vendor;
Â  Â  Â  Â  Â  return metadata;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function saveToken(uid, token, prevToken){
Â  Â  Â  Â  Â  if (!uid || !token) return;
Â  Â  Â  Â  Â  const ref = db.collection('users').doc(uid);
Â  Â  Â  Â  Â  const deviceMetadata = buildDeviceMetadata();
Â  Â  Â  Â  Â  const update = { fcmTokens: { [token]: deviceMetadata }, fcmUpdatedAt: new Date() };
Â  Â  Â  Â  Â  if (prevToken && prevToken !== token){
Â  Â  Â  Â  Â  Â  update.fcmTokens[prevToken] = firebase.firestore.FieldValue.delete();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  await ref.set(update, { merge:true });
Â  Â  Â  Â  Â  localStorage.setItem(LS_KEY, token);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function removeToken(uid, token){
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  await db.collection('users').doc(uid).set({
Â  Â  Â  Â  Â  Â  Â  fcmTokens: { [token]: firebase.firestore.FieldValue.delete() },
Â  Â  Â  Â  Â  Â  Â  fcmUpdatedAt: new Date()
Â  Â  Â  Â  Â  Â  }, { merge:true });
Â  Â  Â  Â  Â  }catch{}
Â  Â  Â  Â  Â  if (localStorage.getItem(LS_KEY) === token) localStorage.removeItem(LS_KEY);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function ensureFreshFcmToken(uid){
Â  Â  Â  Â  Â  if (!isPushSupported()) return; // navegador no soporta
Â  Â  Â  Â  Â  // Permiso
Â  Â  Â  Â  Â  let perm = Notification.permission;
Â  Â  Â  Â  Â  if (perm === 'default') perm = await Notification.requestPermission();
Â  Â  Â  Â  Â  if (perm !== 'granted'){
Â  Â  Â  Â  Â  Â  const prev = localStorage.getItem(LS_KEY);
Â  Â  Â  Â  Â  Â  if (uid && prev) await removeToken(uid, prev);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // SW listo
Â  Â  Â  Â  Â  const reg = window._msgSW || await registerSW();
Â  Â  Â  Â  Â  // Token actual
Â  Â  Â  Â  Â  const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
Â  Â  Â  Â  Â  if (!token) return;
Â  Â  Â  Â  Â  const prev = localStorage.getItem(LS_KEY);
Â  Â  Â  Â  Â  const prevToken = prev && prev !== token ? prev : undefined;
Â  Â  Â  Â  Â  await saveToken(uid, token, prevToken);
Â  Â  Â  Â  }

Â  Â  Â  Â  // BotÃ³n manual (expuesto en perfil)
Â  Â  Â  Â  async function ensurePushPermissionAndToken(user){
Â  Â  Â  Â  Â  if (!user) throw new Error('No user session');
Â  Â  Â  Â  Â  if (!isPushSupported()) throw new Error('Push no soportado en este navegador');
Â  Â  Â  Â  Â  const perm = await Notification.requestPermission();
Â  Â  Â  Â  Â  if (perm !== 'granted') throw new Error('Permiso no concedido');
Â  Â  Â  Â  Â  const reg = window._msgSW || await registerSW();
Â  Â  Â  Â  Â  const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
Â  Â  Â  Â  Â  if (!token) throw new Error('No se obtuvo token FCM');
Â  Â  Â  Â  Â  const prev = localStorage.getItem(LS_KEY);
Â  Â  Â  Â  Â  await saveToken(user.uid, token, prev);
Â  Â  Â  Â  Â  // Foreground handler opcional
Â  Â  Â  Â  Â  messaging.onMessage((payload) => {
Â  Â  Â  Â  Â  Â  const title = payload.notification?.title || payload.data?.title || 'NotificaciÃ³n';
Â  Â  Â  Â  Â  Â  const bodyÂ  = payload.notification?.bodyÂ  || payload.data?.bodyÂ  || '';
Â  Â  Â  Â  Â  Â  showToast(`${title}${body ? ': ' + body : ''}`);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  return token;
Â  Â  Â  Â  }
Â  Â  Â  Â  window.ensurePushPermissionAndToken = ensurePushPermissionAndToken; // Ãºtil para consola

Â  Â  Â  Â  // Limpieza si el usuario revoca permisos despuÃ©s
Â  Â  Â  Â  if (navigator.permissions?.query){
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const status = await navigator.permissions.query({ name: 'notifications' });
Â  Â  Â  Â  Â  Â  status.onchange = async () => {
Â  Â  Â  Â  Â  Â  Â  if (status.state !== 'granted'){
Â  Â  Â  Â  Â  Â  Â  Â  const uid = auth.currentUser?.uid;
Â  Â  Â  Â  Â  Â  Â  Â  const prev = localStorage.getItem(LS_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  if (uid && prev) await removeToken(uid, prev);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Notificaciones desactivadas. <a href="#" class="underline" id="re-enable-notifs">Permitir de nuevo</a>', 'error', { html: true });
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('re-enable-notifs')?.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  const ua = navigator.userAgent.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  let url = 'chrome://settings/content/notifications';
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ua.includes('firefox')) url = 'about:preferences#privacy';
Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (ua.includes('edg')) url = 'edge://settings/content/notifications';
Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(url, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  try{ gtag('event', 'notification_permission_disabled'); }catch{ console.log('notification_permission_disabled'); }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }catch{}
Â  Â  Â  Â  }
Â  Â  Â  Â  // ===============================

Â  Â  Â  Â  // ---- Auth gate
Â  Â  Â  Â  auth.onAuthStateChanged(async user => {
Â  Â  Â  Â  Â  loadingSpinner.classList.remove('hidden');
Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  // Crea doc de usuario si no existe
Â  Â  Â  Â  Â  Â  const userRef = db.collection('users').doc(user.uid);
Â  Â  Â  Â  Â  Â  const docSnap = await userRef.get();
Â  Â  Â  Â  Â  Â  const existingData = docSnap.exists ? docSnap.data() : {};
Â  Â  Â  Â  Â  Â  state.isTotalPass = !!existingData.totalPass;
Â  Â  Â  Â  Â  Â  const strikesRaw = Number(existingData.lateCancellations);
Â  Â  Â  Â  Â  Â  state.cancellationStrikes = Number.isFinite(strikesRaw) && strikesRaw > 0 ? strikesRaw : 0;

Â  Â  Â  Â  Â  Â  if (!docSnap.exists){
Â  Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  await userRef.set({
Â  Â  Â  Â  Â  Â  Â  Â  Â  email: user.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  displayName: user.displayName || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  photoURL: user.photoURL || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error creando perfil:', e);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Hubo un problema al configurar tu perfil. Intenta de nuevo.');
Â  Â  Â  Â  Â  Â  Â  Â  auth.signOut();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  state.currentUser = user;
Â  Â  Â  Â  Â  Â  authContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  appContainer.style.display = 'flex';

Â  Â  Â  Â  Â  Â  // ðŸ”” REFRESCA TOKEN EN CADA SESIÃ“N
Â  Â  Â  Â  Â  Â  try { await registerSW(); await ensureFreshFcmToken(user.uid); } catch(e){ console.warn('FCM token refresh failed:', e?.message||e); }
Â  Â  Â  Â  Â  Â  // TambiÃ©n al volver a la pestaÃ±a (una vez)
Â  Â  Â  Â  Â  Â  document.addEventListener('visibilitychange', async () => {
Â  Â  Â  Â  Â  Â  Â  if (document.visibilityState === 'visible' && auth.currentUser) {
Â  Â  Â  Â  Â  Â  Â  Â  try { await ensureFreshFcmToken(auth.currentUser.uid); } catch {}
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, { once:true });

Â  Â  Â  Â  Â  Â  if (state.currentScreen === 'agenda') attachAgendaListeners();
Â  Â  Â  Â  Â  Â  scheduleRender();
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  state.currentUser = null;
Â  Â  Â  Â  Â  Â  detachListeners();
Â  Â  Â  Â  Â  Â  appContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  authContainer.style.display = 'flex';
Â  Â  Â  Â  Â  Â  renderAuthScreen();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  loadingSpinner.classList.add('hidden');
Â  Â  Â  Â  });

Â  Â  Â  Â  // ---- UI (auth / render / acciones) â€” *tu lÃ³gica original con mÃ­nimos cambios* ----
Â  Â  Â  Â  function renderAuthScreen(isLogin=true){
Â  Â  Â  Â  Â  authContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="w-full max-w-md mx-auto">
Â  Â  Â  Â  Â  Â  Â  <h1 class="text-4xl font-bold text-white mb-2">Madness - Reserva de clases</h1>
Â  Â  Â  Â  Â  Â  Â  <p class="text-zinc-400 mb-8">${isLogin ? 'Inicia sesiÃ³n para continuar' : 'Crea una cuenta para empezar'}</p>
Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="email-input" placeholder="Correo electrÃ³nico" class="w-full bg-zinc-800 text-white p-3 rounded-md border border-zinc-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="password-input" placeholder="ContraseÃ±a" class="w-full bg-zinc-800 text-white p-3 rounded-md border border-zinc-700 focus:ring-2 focus:ring-indigo-500 focus:outline-none">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="turnstile-widget"></div>

Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button id="auth-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-md mt-6">${isLogin ? 'Iniciar SesiÃ³n' : 'Registrarse'}</button>
Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-zinc-400 mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  ${isLogin ? 'Â¿No tienes cuenta?' : 'Â¿Ya tienes cuenta?'}
Â  Â  Â  Â  Â  Â  Â  Â  <a id="auth-toggle" href="#" class="font-semibold text-indigo-400 hover:underline">${isLogin ? 'RegÃ­strate' : 'Inicia SesiÃ³n'}</a>
Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. ADDED: Manually render the widget after the HTML is on the page
Â  Â  Â  Â  Â  Â  const authButton = document.getElementById('auth-button');
Â  Â  Â  Â  Â  Â  const widgetContainer = document.getElementById('turnstile-widget');

Â  Â  Â  Â  Â  Â  // Disable the button until Turnstile is fully ready to avoid ReferenceErrors on slow networks
Â  Â  Â  Â  Â  Â  authButton.disabled = true;

Â  Â  Â  Â  Â  Â  const enableAuthButton = () => { authButton.disabled = false; };

Â  Â  Â  Â  Â  Â  const renderTurnstileWhenReady = () => {
Â  Â  Â  Â  Â  Â  Â  if (!widgetContainer || widgetContainer.dataset.rendered === '1'){
Â  Â  Â  Â  Â  Â  Â  Â  enableAuthButton();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  const api = window.turnstile;
Â  Â  Â  Â  Â  Â  Â  if (api?.render){
Â  Â  Â  Â  Â  Â  Â  Â  api.render(widgetContainer, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  sitekey: '0x4AAAAAABwCDMFGoF_Z-wjY'
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  widgetContainer.dataset.rendered = '1';
Â  Â  Â  Â  Â  Â  Â  Â  enableAuthButton();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  // Retry shortly after to give the async script time to load before enabling auth
Â  Â  Â  Â  Â  Â  Â  setTimeout(renderTurnstileWhenReady, 250);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  renderTurnstileWhenReady();

Â  Â  Â  Â  Â  Â  authButton.onclick = () => app.handleAuth(isLogin);
Â  Â  Â  Â  Â  Â  document.getElementById('auth-toggle').onclick = (e)=>{ e.preventDefault(); renderAuthScreen(!isLogin); };
Â  Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  // Render principal
Â  Â  Â  Â  function render(){
Â  Â  Â  Â  Â  const screen = state.currentScreen;
Â  Â  Â  Â  Â  let content = '';
Â  Â  Â  Â  Â  if (screen === 'agenda') content = getAgendaScreenHTML();
Â  Â  Â  Â  Â  else if (screen === 'profile') content = getProfileScreenHTML();
Â  Â  Â  Â  Â  else if (screen === 'classDetails') content = getClassDetailsScreenHTML(state.selectedClassId);
Â  Â  Â  Â  Â  mainContent.innerHTML = `<div class="max-w-md mx-auto">${content}</div>`;
Â  Â  Â  Â  Â  updateNavButtons();
Â  Â  Â  Â  Â  lucide.createIcons();

Â  Â  Â  Â  Â  const btn = document.getElementById('enablePush');
Â  Â  Â  Â  Â  if (btn){
Â  Â  Â  Â  Â  Â  btn.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  const user = firebase.auth().currentUser;
Â  Â  Â  Â  Â  Â  Â  Â  if (!user) return showToast('Inicia sesiÃ³n primero', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  if (!isPushSupported()) return showToast('Este navegador no soporta notificaciones push.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  await ensurePushPermissionAndToken(user);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Notificaciones activadas âœ…', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  scheduleRender();
Â  Â  Â  Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Enable push failed:', e);
Â  Â  Â  Â  Â  Â  Â  Â  showToast(e.message || 'No se pudo activar notificaciones', 'error');
Â  Â  Â  Â  Â  Â  Â  }finally{
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const tpToggle = document.getElementById('totalpass-toggle');
Â  Â  Â  Â  Â  if (tpToggle){
Â  Â  Â  Â  Â  Â  tpToggle.onchange = async e => {
Â  Â  Â  Â  Â  Â  Â  const checked = e.target.checked;
Â  Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  Â  await db.collection('users').doc(state.currentUser.uid).set({ totalPass: checked }, { merge: true });
Â  Â  Â  Â  Â  Â  Â  Â  state.isTotalPass = checked;
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Preferencia guardada', 'success');
Â  Â  Â  Â  Â  Â  Â  }catch(err){
Â  Â  Â  Â  Â  Â  Â  Â  showToast('No se pudo guardar', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  e.target.checked = !checked;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- AGENDA (igual que tu implementaciÃ³n, con mÃ­nimos cambios)
Â  Â  Â  Â  function getAgendaScreenHTML(){
Â  Â  Â  Â  Â  const now = Date.now();
Â  Â  Â  Â  Â  const strikesRaw = Number(state.cancellationStrikes);
Â  Â  Â  Â  Â  const strikeCount = Number.isFinite(strikesRaw) && strikesRaw > 0 ? Math.min(strikesRaw, 3) : 0;
Â  Â  Â  Â  Â  const strikeMessage = strikeCount >= 3
Â  Â  Â  Â  Â  Â  ? 'Llegaste al lÃ­mite de 3 strikes. Tu cuenta queda bloqueada temporalmente.'
Â  Â  Â  Â  Â  Â  : strikeCount === 2
Â  Â  Â  Â  Â  Â  Â  ? 'EstÃ¡s a 1 strike del bloqueo. Cancela con tiempo.'
Â  Â  Â  Â  Â  Â  Â  : strikeCount === 1
Â  Â  Â  Â  Â  Â  Â  Â  ? 'Tienes 1 strike. Cancela con mÃ¡s de 2 horas de anticipaciÃ³n.'
Â  Â  Â  Â  Â  Â  Â  Â  : 'Evita cancelar tarde para no llegar a 3 strikes.';
Â  Â  Â  Â  Â  const upcoming = state.myBookings.filter(Boolean).filter(b=>{
Â  Â  Â  Â  Â  Â  const startObj = b.startAt ? asDate(b.startAt) : new Date(`${b.classDate}T${b.time||'00:00'}:00Z`);
Â  Â  Â  Â  Â  Â  const relatedClass = state.classes.find(cls=>cls.id===b.classId);
Â  Â  Â  Â  Â  Â  const durationRaw = b.duration ?? relatedClass?.duration;
Â  Â  Â  Â  Â  Â  const durationValue = Number(durationRaw);
Â  Â  Â  Â  Â  Â  const durationMinutes = Number.isFinite(durationValue) && durationValue>0 ? durationValue : 60;
Â  Â  Â  Â  Â  Â  const endTime = startObj.getTime() + durationMinutes*60000;
Â  Â  Â  Â  Â  Â  return now <= endTime;
Â  Â  Â  Â  Â  }).sort((a,b)=>{
Â  Â  Â  Â  Â  Â  const ta = a.startAt ? asDate(a.startAt).getTime() : new Date(`${a.classDate}T${a.time||'00:00'}:00Z`).getTime();
Â  Â  Â  Â  Â  Â  const tb = b.startAt ? asDate(b.startAt).getTime() : new Date(`${b.classDate}T${b.time||'00:00'}:00Z`).getTime();
Â  Â  Â  Â  Â  Â  return ta - tb;
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  const reservasHTML = upcoming.length ? upcoming.map(b=>{
Â  Â  Â  Â  Â  Â  const startObj = b.startAt ? asDate(b.startAt) : new Date(`${b.classDate}T${b.time||'00:00'}:00Z`);
Â  Â  Â  Â  Â  Â  const ymdUTC = b.classDate || startObj.toISOString().slice(0,10);
Â  Â  Â  Â  Â  Â  const hhmmUTC = b.time || startObj.toISOString().slice(11,16);
Â  Â  Â  Â  Â  Â  const hhmm = timeFmt.format(startObj);
Â  Â  Â  Â  Â  Â  const ymdLocal = dateHelper.getYYYYMMDD(startObj);
Â  Â  Â  Â  Â  Â  const dayText = ymdLocal===dateHelper.today ? 'Hoy' : ymdLocal===dateHelper.tomorrow ? 'MaÃ±ana' : dateHelper.human(ymdLocal);
Â  Â  Â  Â  Â  Â  const cover = coverHelper.forClassName(b.className, b.className);
Â  Â  Â  Â  Â  Â  const timeStatus = timeUntilLabel(ymdUTC, hhmmUTC);
Â  Â  Â  Â  Â  Â  const showCancelButton = timeStatus !== 'en curso';
Â  Â  Â  Â  Â  Â  const safeClassName = DOMPurify.sanitize(b.className || '');
Â  Â  Â  Â  Â  Â  const safeDayText = DOMPurify.sanitize(dayText);
Â  Â  Â  Â  Â  Â  const safeClassId = DOMPurify.sanitize(b.classId);
Â  Â  Â  Â  Â  Â  const safeTimeStatus = DOMPurify.sanitize(timeStatus);
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  <div class="bg-zinc-800 rounded-2xl p-4 flex items-center justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${cover}" alt="${safeClassName}" class="w-16 h-16 rounded-lg object-cover bg-zinc-700" loading="lazy" decoding="async">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg">${safeClassName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-zinc-400 text-sm">${safeDayText} â€¢ ${hhmm}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-emerald-400 text-xs mt-0.5">${safeTimeStatus}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  ${showCancelButton ? `<button data-action="cancel-booking" data-class-id="${safeClassId}" class="text-xs text-rose-400 hover:text-rose-300">Cancelar</button>` : ''}
Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  }).join('') : `<div class="bg-zinc-800 rounded-2xl p-5 text-center text-zinc-400">No tienes reservas prÃ³ximas.</div>`;

Â  Â  Â  Â  Â  let completadasHTML = '';
Â  Â  Â  Â  Â  if (state.isTotalPass) {
Â  Â  Â  Â  Â  Â  const today = dateHelper.today;
Â  Â  Â  Â  Â  Â  const completed = state.myBookings
Â  Â  Â  Â  Â  Â  Â  .filter(Boolean)
Â  Â  Â  Â  Â  Â  Â  .map(booking => {
Â  Â  Â  Â  Â  Â  Â  Â  const startObj = booking.startAt
Â  Â  Â  Â  Â  Â  Â  Â  Â  ? asDate(booking.startAt)
Â  Â  Â  Â  Â  Â  Â  Â  Â  : (booking.classDate ? new Date(`${booking.classDate}T${booking.time||'00:00'}:00Z`) : null);
Â  Â  Â  Â  Â  Â  Â  Â  if (!startObj) return null;
Â  Â  Â  Â  Â  Â  Â  Â  const ymdLocal = dateHelper.getYYYYMMDD(startObj);
Â  Â  Â  Â  Â  Â  Â  Â  if (ymdLocal !== today) return null;
Â  Â  Â  Â  Â  Â  Â  Â  const relatedClass = state.classes.find(cls => cls.id === booking.classId);
Â  Â  Â  Â  Â  Â  Â  Â  const durationRaw = Number(booking.duration || relatedClass?.duration || 60);
Â  Â  Â  Â  Â  Â  Â  Â  const duration = Number.isFinite(durationRaw) && durationRaw > 0 ? durationRaw : 60;
Â  Â  Â  Â  Â  Â  Â  Â  if (Date.now() <= startObj.getTime() + duration * 60000) return null;
Â  Â  Â  Â  Â  Â  Â  Â  return { booking, startObj, relatedClass };
Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  .filter(Boolean)
Â  Â  Â  Â  Â  Â  Â  .sort((a, b) => b.startObj.getTime() - a.startObj.getTime());

Â  Â  Â  Â  Â  Â  Â  completadasHTML = completed.length ? completed.map(({ booking, startObj, relatedClass }) => {
Â  Â  Â  Â  Â  Â  Â  Â  const className = booking.className || relatedClass?.name || '';
Â  Â  Â  Â  Â  Â  Â  Â  const cover = relatedClass ? coverHelper.forClass(relatedClass) : coverHelper.forClassName(className, className);
Â  Â  Â  Â  Â  Â  Â  Â  const safeClassName = DOMPurify.sanitize(className);
Â  Â  Â  Â  Â  Â  Â  Â  const hhmm = timeFmt.format(startObj);
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-zinc-800 rounded-2xl p-4 flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${cover}" alt="${safeClassName}" class="w-16 h-16 rounded-lg object-cover bg-zinc-700" loading="lazy" decoding="async">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg">${safeClassName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-zinc-400 text-sm">Hoy â€¢ ${hhmm}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  }).join('') : `<div class="bg-zinc-800 rounded-2xl p-5 text-center text-zinc-400">AÃºn no terminas clases hoy.</div>`;

Â  Â  Â  Â  Â  Â  Â  const singleTokenButton = completed.length > 0 ?
Â  Â  Â  Â  Â  Â  Â  Â  `<button data-action="send-totalpass-daily" class="w-full mt-4 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 rounded-lg">Enviar Token del DÃ­a</button>` : '';

Â  Â  Â  Â  Â  Â  Â  completadasHTML += singleTokenButton;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const targetYMD = state.scheduleFilter==='today' ? dateHelper.today : dateHelper.tomorrow;
Â  Â  Â  Â  Â  const filtered = state.classes
Â  Â  Â  Â  Â  Â  .filter(cls=>{
Â  Â  Â  Â  Â  Â  Â  const start = cls.startAt?.toDate ? cls.startAt.toDate() : new Date(`${cls.classDate}T${cls.time}:00Z`);
Â  Â  Â  Â  Â  Â  Â  const ymd = dateHelper.getYYYYMMDD(start);
Â  Â  Â  Â  Â  Â  Â  return ymd===targetYMD;
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .filter(cls=>{
Â  Â  Â  Â  Â  Â  Â  if (state.scheduleFilter!=='today') return true;
Â  Â  Â  Â  Â  Â  Â  const start = cls.startAt?.toDate ? cls.startAt.toDate() : new Date(`${cls.classDate}T${cls.time}:00Z`);
Â  Â  Â  Â  Â  Â  Â  const durationValue = Number(cls.duration);
Â  Â  Â  Â  Â  Â  Â  const durationMinutes = Number.isFinite(durationValue) && durationValue>0 ? durationValue : 60;
Â  Â  Â  Â  Â  Â  Â  const endTime = start.getTime() + durationMinutes*60000;
Â  Â  Â  Â  Â  Â  Â  return now <= endTime;
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  .sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  const startA = a.startAt?.toDate ? a.startAt.toDate() : new Date(`${a.classDate}T${a.time}:00Z`);
Â  Â  Â  Â  Â  Â  Â  const startB = b.startAt?.toDate ? b.startAt.toDate() : new Date(`${b.classDate}T${b.time}:00Z`);
Â  Â  Â  Â  Â  Â  Â  return startA.getTime() - startB.getTime();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  const horarioHTML = filtered.length ? filtered.map(cls=>{
Â  Â  Â  Â  Â  Â  const enrolled = Number(cls.enrolledCount||0);
Â  Â  Â  Â  Â  Â  const available = Number(cls.capacity||0)-enrolled;
Â  Â  Â  Â  Â  Â  const isBooked = state.myBookings.some(b=>b.classId===cls.id);
Â  Â  Â  Â  Â  Â  const waitEntry = state.waitlistEntries.find(w=>w.classId===cls.id); // check if user already in waitlist
Â  Â  Â  Â  Â  Â  const notified = waitEntry && waitEntry.notifiedAt && (!waitEntry.expiresAt || asDate(waitEntry.expiresAt).getTime()>Date.now()); // notified users can book even if class shows full
Â  Â  Â  Â  Â  Â  const safeId = DOMPurify.sanitize(cls.id);
Â  Â  Â  Â  Â  Â  let badge = `<span class="text-xs bg-emerald-500/50 text-emerald-300 px-2 py-1 rounded-md">Â¡Hay cupo!</span>`;
Â  Â  Â  Â  Â  Â  if (isBooked) {
Â  Â  Â  Â  Â  Â  Â  badge = `<span class="text-xs bg-indigo-500/50 text-indigo-300 px-2 py-1 rounded-md">Reservada</span>`;
Â  Â  Â  Â  Â  Â  } else if (available<=0 && !notified) {
Â  Â  Â  Â  Â  Â  Â  // class full: show join or leave waitlist options
Â  Â  Â  Â  Â  Â  Â  if (waitEntry) {
Â  Â  Â  Â  Â  Â  Â  Â  const pos = DOMPurify.sanitize(String(waitEntry.position||1));
Â  Â  Â  Â  Â  Â  Â  Â  badge = `<div><p class=\"text-xs text-amber-400\">PosiciÃ³n ${pos}</p><button data-action=\"leave-waitlist\" data-class-id=\"${safeId}\" class=\"mt-1 text-xs text-rose-400 hover:text-rose-300\">Salir</button></div>`;
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  badge = `<button data-action=\"join-waitlist\" data-class-id=\"${safeId}\" class=\"text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded-md\">Unirse a lista de espera</button>`;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else if (available<=0 && notified) {
Â  Â  Â  Â  Â  Â  Â  // user has been notified of a free spot
Â  Â  Â  Â  Â  Â  Â  badge = `<span class="text-xs bg-amber-500/50 text-amber-300 px-2 py-1 rounded-md">Tu turno</span>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const ymdUTC = cls.classDate || targetYMD;
Â  Â  Â  Â  Â  Â  const hhmmUTC = cls.time || cls.startAt.toDate().toISOString().slice(11,16);
Â  Â  Â  Â  Â  Â  const hhmm = timeFmt.format(new Date(`${ymdUTC}T${hhmmUTC}:00Z`));
Â  Â  Â  Â  Â  Â  const safeName = DOMPurify.sanitize(cls.name || '');
Â  Â  Â  Â  Â  Â  const safeInstructor = DOMPurify.sanitize(cls.instructor || '');
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  <div data-action="navigate-details" data-class-id="${safeId}" class="bg-zinc-800 rounded-2xl p-4 flex items-center gap-4 cursor-pointer hover:bg-zinc-700">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${coverHelper.forClass(cls)}" alt="${safeName}" class="w-16 h-16 rounded-lg object-cover bg-zinc-700" loading="lazy" decoding="async">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-lg">${safeName}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-zinc-400 text-sm">con ${safeInstructor}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm mt-1 text-emerald-400">${hhmm} hrs</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-emerald-300 text-xs mt-0.5">${timeUntilLabel(ymdUTC, hhmmUTC)}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-right">${badge}</div>
Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  }).join('') : `<div class="bg-zinc-800 rounded-2xl p-5 text-center text-zinc-400">No hay mÃ¡s clases por ${state.scheduleFilter==='today'?'hoy':'maÃ±ana'}.</div>`;

Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="p-6 space-y-8">
Â  Â  Â  Â  Â  Â  Â  <header>
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold tracking-tight">Tu Agenda</h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-zinc-400">Tus reservas prÃ³ximas y el horario.</p>
Â  Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  Â  <section aria-labelledby="mis-reservas">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="mis-reservas" class="text-xl font-semibold mb-3">Tus Reservas</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">${reservasHTML}</div>
Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  Â  ${state.isTotalPass ? `
Â  Â  Â  Â  Â  Â  Â  <section aria-labelledby="clases-completadas">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="clases-completadas" class="text-xl font-semibold mb-3">Clases Terminadas Hoy</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">${completadasHTML}</div>
Â  Â  Â  Â  Â  Â  Â  </section>` : ''}
Â  Â  Â  Â  Â  Â  Â  <section aria-labelledby="horario">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between mb-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="horario" class="text-xl font-semibold">Horario</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex space-x-2 bg-zinc-800 p-1 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="set-filter" data-filter="today" class="px-3 py-1 text-sm font-semibold rounded-md ${state.scheduleFilter==='today'?'bg-indigo-600 text-white':''}">Hoy</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="set-filter" data-filter="tomorrow" class="px-3 py-1 text-sm font-semibold rounded-md ${state.scheduleFilter==='tomorrow'?'bg-indigo-600 text-white':''}">MaÃ±ana</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">${horarioHTML}</div>
Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  Â  <section aria-labelledby="cancel-strikes">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="cancel-strikes" class="text-xl font-semibold mb-3">Strikes por cancelaciÃ³n</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-zinc-800 rounded-2xl p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-3xl font-bold text-rose-400">${strikeCount}/3</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-zinc-400 mt-2">${strikeMessage}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function getProfileScreenHTML(){
Â  Â  Â  Â  Â  const safeDisplay = DOMPurify.sanitize(state.currentUser.displayName || '');
Â  Â  Â  Â  Â  const safeEmail = DOMPurify.sanitize(state.currentUser.email || '');
Â  Â  Â  Â  Â  const nameForText = safeDisplay || safeEmail;
Â  Â  Â  Â  Â  const placeholder = (nameForText.charAt(0) || 'U').toUpperCase();
Â  Â  Â  Â  Â  // true if push notifications are allowed and token saved
Â  Â  Â  Â  Â  const pushEnabled = Notification.permission==='granted' && localStorage.getItem(LS_KEY);
Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div class="p-6 space-y-6">
Â  Â  Â  Â  Â  Â  Â  <header class="text-center space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${state.currentUser.photoURL || `https://placehold.co/100x100/18181b/ffffff?text=${placeholder}`}" class="w-24 h-24 rounded-full mx-auto border-4 border-zinc-700">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-bold">${nameForText}</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-zinc-400">${safeEmail}</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  Â  <div class="bg-zinc-800 rounded-2xl p-4 divide-y divide-zinc-700">
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" data-action="edit-name" class="flex items-center justify-between py-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Editar Nombre</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="chevron-right" class="w-5 h-5 text-zinc-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  <label for="totalpass-toggle" class="flex items-center justify-between py-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Usuario TotalPass</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="totalpass-toggle" class="w-5 h-5 accent-indigo-600" ${state.isTotalPass?'checked':''}>
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="enablePush" class="flex items-center justify-between w-full py-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Notificaciones Push</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="${pushEnabled?'bell-ring':'bell-off'}" class="w-5 h-5 ${pushEnabled?'text-emerald-400':'text-zinc-500'}"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="chevron-right" class="w-5 h-5 text-zinc-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" data-action="logout" class="flex items-center justify-between py-3 text-rose-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Cerrar SesiÃ³n</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="log-out" class="w-5 h-5"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function getClassDetailsScreenHTML(classId){
Â  Â  Â  Â  Â  const cls = state.classes.find(c=>c.id===classId);
Â  Â  Â  Â  Â  if (!cls) return getAgendaScreenHTML();
Â  Â  Â  Â  Â  const enrolled = Number(cls.enrolledCount||0);
Â  Â  Â  Â  Â  const availableSpots = Number(cls.capacity||0)-enrolled;
Â  Â  Â  Â  Â  const isBooked = state.myBookings.some(b=>b.classId===cls.id);
Â  Â  Â  Â  Â  const waitEntry = state.waitlistEntries.find(w=>w.classId===cls.id); // user's waitlist entry if any
Â  Â  Â  Â  Â  const notified = waitEntry && waitEntry.notifiedAt && (!waitEntry.expiresAt || asDate(waitEntry.expiresAt).getTime()>Date.now()); // true if user has active waitlist notification
Â  Â  Â  Â  Â  const durationMin = Number(cls.duration||60);
Â  Â  Â  Â  Â  const ymdUTC = cls.classDate || cls.startAt.toDate().toISOString().slice(0,10);
Â  Â  Â  Â  Â  const hhmmUTC = cls.time || cls.startAt.toDate().toISOString().slice(11,16);
Â  Â  Â  Â  Â  const timeRange = timeHelper.range(ymdUTC, hhmmUTC, durationMin);
Â  Â  Â  Â  Â  const safeName = DOMPurify.sanitize(cls.name || '');
Â  Â  Â  Â  Â  const safeDesc = DOMPurify.sanitize(cls.description || '');
Â  Â  Â  Â  Â  const safeId = DOMPurify.sanitize(cls.id);
Â  Â  Â  Â  Â  // default booking button
Â  Â  Â  Â  Â  let buttonHTML = `<button data-action="confirm-booking" data-class-id="${safeId}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl">Reservar Ahora</button>`;
Â  Â  Â  Â  Â  if (isBooked) {
Â  Â  Â  Â  Â  Â  // already have a booking
Â  Â  Â  Â  Â  Â  buttonHTML = `<button class="w-full bg-zinc-700 text-zinc-400 font-bold py-4 rounded-xl" disabled>Ya estÃ¡s inscrito</button>`;
Â  Â  Â  Â  Â  } else if (availableSpots<=0 && !notified) {
Â  Â  Â  Â  Â  Â  // class is full: either join waitlist or allow leaving
Â  Â  Â  Â  Â  Â  if (waitEntry) {
Â  Â  Â  Â  Â  Â  Â  const pos = DOMPurify.sanitize(String(waitEntry.position||1));
Â  Â  Â  Â  Â  Â  Â  buttonHTML = `<div class="space-y-2"><p class="text-center text-sm">PosiciÃ³n en lista de espera: ${pos}</p><button data-action="leave-waitlist" data-class-id="${safeId}" class="w-full bg-rose-800 text-rose-400 font-bold py-4 rounded-xl">Salir de la lista de espera</button></div>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  buttonHTML = `<button data-action="join-waitlist" data-class-id="${safeId}" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-xl">Unirse a lista de espera</button>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <div class="relative">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="${coverHelper.forClass(cls)}" class="w-full h-64 object-cover" alt="${safeName}">
Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="navigate" data-screen="agenda" class="absolute top-6 left-6 bg-black/50 p-2 rounded-full text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="arrow-left" class="w-6 h-6"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="p-6 space-y-4 pb-40">
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold">
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${safeName}
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="block text-lg font-semibold text-zinc-300 mt-1">${timeRange}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-zinc-400 leading-relaxed">${safeDesc}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-zinc-800 p-4 rounded-xl flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-semibold text-lg">Estado</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-2xl font-bold ${availableSpots>0?'text-emerald-400':'text-rose-400'}">${availableSpots>0?'Â¡Hay cupo!':'Llena'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="p-6 fixed bottom-20 left-0 right-0 max-w-md mx-auto bg-zinc-900">
Â  Â  Â  Â  Â  Â  Â  Â  ${buttonHTML}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const app = {
Â  Â  Â  Â  Â  handleAuth: (isLogin)=>{
Â  Â  Â  Â  Â  Â  const turnstileApi = window.turnstile;
Â  Â  Â  Â  Â  Â  if (!turnstileApi || typeof turnstileApi.getResponse !== 'function'){
Â  Â  Â  Â  Â  Â  Â  alert('La verificaciÃ³n de seguridad se estÃ¡ inicializando. Intenta de nuevo en unos segundos.');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const turnstileToken = turnstileApi.getResponse();
Â  Â  Â  Â  Â  Â  const email = document.getElementById('email-input').value;
Â  Â  Â  Â  Â  Â  const passÂ  = document.getElementById('password-input').value;
Â  Â  Â  Â  Â  Â  if (!turnstileToken) {
Â  Â  Â  Â  Â  Â  Â  alert('Por favor, completa la verificaciÃ³n de seguridad.');Â Â 
Â  Â  Â  Â  Â  Â  Â  return;Â Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (!email || !pass){ alert('Por favor, ingresa correo y contraseÃ±a.'); return; }
Â  Â  Â  Â  Â  Â  loadingSpinner.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  const p = isLogin ? auth.signInWithEmailAndPassword(email,pass) : auth.createUserWithEmailAndPassword(email,pass);
Â  Â  Â  Â  Â  Â  p.catch(err=>{ alert(err.message); loadingSpinner.classList.add('hidden'); });
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  logout: ()=> auth.signOut(),
Â  Â  Â  Â  Â  editUserName: (event)=>{
Â  Â  Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  Â  Â  const newName = prompt('Ingresa tu nombre y apellido:', state.currentUser.displayName || '');
Â  Â  Â  Â  Â  Â  if (newName && newName.trim()!==''){
Â  Â  Â  Â  Â  Â  Â  loadingSpinner.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  state.currentUser.updateProfile({ displayName: newName.trim() })
Â  Â  Â  Â  Â  Â  Â  Â  .then(()=>{ scheduleRender(); loadingSpinner.classList.add('hidden'); })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(err=>{ alert('Error: '+err.message); loadingSpinner.classList.add('hidden'); });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  navigateTo: (screen, data={})=>{
Â  Â  Â  Â  Â  Â  if (screen==='agenda') attachAgendaListeners(); else detachListeners();
Â  Â  Â  Â  Â  Â  state.currentScreen = screen;
Â  Â  Â  Â  Â  Â  if (data.classId) state.selectedClassId = data.classId;
Â  Â  Â  Â  Â  Â  render();
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  setScheduleFilter: (filter)=>{ state.scheduleFilter=filter; render(); },
Â  Â  Â  Â  Â  confirmBooking: async (classId)=>{
Â  Â  Â  Â  Â  Â  const uid = state.currentUser.uid;
Â  Â  Â  Â  Â  Â  const classRef = db.collection('classes').doc(classId);
Â  Â  Â  Â  Â  Â  const bookingRef = db.collection('bookings').doc(`${classId}_${uid}`);
Â  Â  Â  Â  Â  Â  const userRef = db.collection('users').doc(uid);
Â  Â  Â  Â  Â  Â  const waitRef = db.collection('waitlists').doc(`${classId}_${uid}`);
Â  Â  Â  Â  Â  Â  const waitEntry = state.waitlistEntries.find(w=>w.classId===classId); // user's waitlist entry
Â  Â  Â  Â  Â  Â  const notified = waitEntry && waitEntry.notifiedAt && (!waitEntry.expiresAt || asDate(waitEntry.expiresAt).getTime()>Date.now()); // valid notification
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  await db.runTransaction(async tx=>{
Â  Â  Â  Â  Â  Â  Â  Â  const [classSnap, bookingSnap, userSnap, waitSnap] = await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  Â  tx.get(classRef), tx.get(bookingRef), tx.get(userRef), tx.get(waitRef)
Â  Â  Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â  Â  Â  if (!classSnap.exists) throw new Error('La clase ya no existe.');
Â  Â  Â  Â  Â  Â  Â  Â  if (bookingSnap.exists) throw new Error('Ya tienes reserva para esta clase.');
Â  Â  Â  Â  Â  Â  Â  Â  const userData = userSnap.exists ? userSnap.data() : {};
Â  Â  Â  Â  Â  Â  Â  Â  if (userData.blacklisted === true) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Tu cuenta estÃ¡ en revisiÃ³n por cancelaciones tardÃ­as. EscrÃ­benos para apoyarte.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const lastCancelAt = userData.lastCancelAt ? asDate(userData.lastCancelAt) : null;
Â  Â  Â  Â  Â  Â  Â  Â  if (lastCancelAt && Date.now() - lastCancelAt.getTime() < FIFTEEN_MINUTES_MS) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Debes esperar 15 minutos despuÃ©s de cancelar para reservar de nuevo.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const cls = classSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  const enrolled = Number(cls.enrolledCount||0);
Â  Â  Â  Â  Â  Â  Â  Â  const capacity = Number(cls.capacity||0);
Â  Â  Â  Â  Â  Â  Â  Â  if (enrolled>=capacity && !notified) throw new Error('Clase llena.');
Â  Â  Â  Â  Â  Â  Â  Â  let startDateObj = cls.startAt?.toDate ? cls.startAt.toDate() : (cls.startAt ? new Date(cls.startAt) : null);
Â  Â  Â  Â  Â  Â  Â  Â  if (!startDateObj || isNaN(startDateObj.getTime())){
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cls.classDate){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const hhmm = cls.time || '00:00';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startDateObj = new Date(`${cls.classDate}T${hhmm}:00Z`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!startDateObj || isNaN(startDateObj.getTime())){
Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('La clase no tiene horario vÃ¡lido.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  const startAtTs = cls.startAt?.toDate ? cls.startAt : firebase.firestore.Timestamp.fromDate(startDateObj);
Â  Â  Â  Â  Â  Â  Â  Â  const classDate = cls.classDate || dateHelper.getYYYYMMDD(startDateObj);
Â  Â  Â  Â  Â  Â  Â  Â  const time = cls.time || timeFmt.format(startDateObj);
Â  Â  Â  Â  Â  Â  Â  Â  tx.set(bookingRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  classId, userId: uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  userName: state.currentUser.displayName || state.currentUser.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  startAt: startAtTs, classDate, time, className: cls.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  tx.update(classRef, { enrolledCount: firebase.firestore.FieldValue.increment(1) });
Â  Â  Â  Â  Â  Â  Â  Â  if (waitSnap.exists) tx.delete(waitRef);
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  if (waitEntry){
Â  Â  Â  Â  Â  Â  Â  Â  const q = await db.collection('waitlists')
Â  Â  Â  Â  Â  Â  Â  Â  Â  .where('classId','==',classId)
Â  Â  Â  Â  Â  Â  Â  Â  Â  .where('position','>',waitEntry.position||0)
Â  Â  Â  Â  Â  Â  Â  Â  Â  .get(); // entries behind user
Â  Â  Â  Â  Â  Â  Â  Â  const batch = db.batch();
Â  Â  Â  Â  Â  Â  Â  Â  q.forEach(doc=> batch.update(doc.ref,{ position: (doc.data().position||1)-1 })); // shift positions up
Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  showModal({ success:true, title:'Â¡Reserva Exitosa!' });
Â  Â  Â  Â  Â  Â  }catch(err){ alert(`No se pudo reservar\n\n${err.message}`); }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  cancelBooking: async (classId)=>{
Â  Â  Â  Â  Â  Â  const uid = state.currentUser.uid;
Â  Â  Â  Â  Â  Â  if (!classId) return;

Â  Â  Â  Â  Â  Â  const userRef = db.collection('users').doc(uid);

Â  Â  Â  Â  Â  Â  const isValidDate = (value) => value instanceof Date && !Number.isNaN(value.getTime());
Â  Â  Â  Â  Â  Â  const resolveStartDate = (bookingData, classData) => {
Â  Â  Â  Â  Â  Â  Â  if (bookingData?.startAt) {
Â  Â  Â  Â  Â  Â  Â  Â  const fromBooking = asDate(bookingData.startAt);
Â  Â  Â  Â  Â  Â  Â  Â  if (isValidDate(fromBooking)) return fromBooking;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  if (classData?.startAt) {
Â  Â  Â  Â  Â  Â  Â  Â  const fromClass = asDate(classData.startAt);
Â  Â  Â  Â  Â  Â  Â  Â  if (isValidDate(fromClass)) return fromClass;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  const dateStr = bookingData?.classDate || classData?.classDate;
Â  Â  Â  Â  Â  Â  Â  const timeStr = bookingData?.time || classData?.time;
Â  Â  Â  Â  Â  Â  Â  if (dateStr && timeStr) {
Â  Â  Â  Â  Â  Â  Â  Â  const parsed = new Date(`${dateStr}T${timeStr}:00Z`);
Â  Â  Â  Â  Â  Â  Â  Â  if (isValidDate(parsed)) return parsed;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const localBooking = state.myBookings.find(b=>b.classId===classId);
Â  Â  Â  Â  Â  Â  const localClass = state.classes.find(cls=>cls.id===classId);
Â  Â  Â  Â  Â  Â  const estimatedStart = resolveStartDate(localBooking, localClass);
Â  Â  Â  Â  Â  Â  const startValid = isValidDate(estimatedStart);
Â  Â  Â  Â  Â  Â  const looksLate = startValid ? (estimatedStart.getTime() - Date.now()) <= TWO_HOURS_MS : true;

Â  Â  Â  Â  Â  Â  let currentLateCount = 0;
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  const userSnap = await userRef.get();
Â  Â  Â  Â  Â  Â  Â  if (userSnap.exists) currentLateCount = Number(userSnap.data()?.lateCancellations || 0);
Â  Â  Â  Â  Â  Â  }catch(err){ console.warn('No se pudo leer lateCancellations:', err); }

Â  Â  Â  Â  Â  Â  const upcomingStrike = Math.min(currentLateCount + 1, 3);
Â  Â  Â  Â  Â  Â  const confirmMessage = looksLate
Â  Â  Â  Â  Â  Â  Â  ? `Cancelar a menos de 2 horas suma un strike (${upcomingStrike}/3). Si llegas a 3 tu cuenta serÃ¡ bloqueada temporalmente. Â¿Deseas continuar?`
Â  Â  Â  Â  Â  Â  Â  : 'Si cancelas deberÃ¡s esperar 15 minutos para volver a reservar. Â¿Deseas continuar?';
Â  Â  Â  Â  Â  Â  if (!confirm(confirmMessage)) return;

Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  const response = await cancelBookingCallable({ classId });
Â  Â  Â  Â  Â  Â  Â  const data = response?.data || {};
Â  Â  Â  Â  Â  Â  Â  const becameBlacklisted = data.becameBlacklisted === true;
Â  Â  Â  Â  Â  Â  Â  const recordedLateStrike = data.recordedLateStrike === true;
Â  Â  Â  Â  Â  Â  Â  const resultingLateCount = Number.isFinite(Number(data.resultingLateCount))
Â  Â  Â  Â  Â  Â  Â  Â  ? Number(data.resultingLateCount)
Â  Â  Â  Â  Â  Â  Â  Â  : currentLateCount;

Â  Â  Â  Â  Â  Â  Â  showModal({ success:false, title:'CancelaciÃ³n Exitosa' });

Â  Â  Â  Â  Â  Â  Â  if (becameBlacklisted) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Llegaste a 3 strikes por cancelaciones tardÃ­as. Tu cuenta fue bloqueada temporalmente.', 'error');
Â  Â  Â  Â  Â  Â  Â  } else if (recordedLateStrike) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`CancelaciÃ³n tardÃ­a registrada. Strikes: ${resultingLateCount}/3`, 'error');
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  state.cancellationStrikes = Number.isFinite(resultingLateCount) && resultingLateCount > 0 ? resultingLateCount : 0;
Â  Â  Â  Â  Â  Â  Â  scheduleRender();
Â  Â  Â  Â  Â  Â  }catch(err){
Â  Â  Â  Â  Â  Â  Â  const errMessage = err?.details?.message || err?.message || 'Error desconocido.';
Â  Â  Â  Â  Â  Â  Â  alert(`No se pudo cancelar\n\n${errMessage}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  joinWaitlist: async (classId)=>{
Â  Â  Â  Â  Â  Â  const uid = state.currentUser.uid;
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  await db.collection('waitlists').doc(`${classId}_${uid}`).set({
Â  Â  Â  Â  Â  Â  Â  Â  classId, userId: uid,
Â  Â  Â  Â  Â  Â  Â  Â  createdAt: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  showToast('Unido a la lista de espera', 'success');
Â  Â  Â  Â  Â  Â  }catch(err){ alert(`No se pudo unir a la lista de espera\n\n${err.message}`); }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  leaveWaitlist: async (classId)=>{
Â  Â  Â  Â  Â  Â  const uid = state.currentUser.uid;
Â  Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  Â  await db.collection('waitlists').doc(`${classId}_${uid}`).delete();
Â  Â  Â  Â  Â  Â  Â  showToast('Saliste de la lista de espera');
Â  Â  Â  Â  Â  Â  }catch(err){ alert(`No se pudo salir de la lista de espera\n\n${err.message}`); }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  function handleInteraction(e){
Â  Â  Â  Â  Â  const target = e.target.closest('[data-action]');
Â  Â  Â  Â  Â  if (!target) return;
Â  Â  Â  Â  Â  const { action, screen, filter, classId } = target.dataset;
Â  Â  Â  Â  Â  switch(action){
Â  Â  Â  Â  Â  Â  case 'navigate': app.navigateTo(screen); break;
Â  Â  Â  Â  Â  Â  case 'navigate-details': app.navigateTo('classDetails',{classId}); break;
Â  Â  Â  Â  Â  Â  case 'set-filter': app.setScheduleFilter(filter); break;
Â  Â  Â  Â  Â  Â  case 'edit-name': app.editUserName(e); break;
Â  Â  Â  Â  Â  Â  case 'logout': app.logout(); break;
Â  Â  Â  Â  Â  Â  case 'confirm-booking': target.disabled=true; app.confirmBooking(classId).finally(()=>target.disabled=false); break;
Â  Â  Â  Â  Â  Â  case 'cancel-booking': target.disabled=true; app.cancelBooking(classId).finally(()=>target.disabled=false); break;
Â  Â  Â  Â  Â  Â  case 'join-waitlist': target.disabled=true; app.joinWaitlist(classId).finally(()=>target.disabled=false); break;
Â  Â  Â  Â  Â  Â  case 'leave-waitlist': target.disabled=true; app.leaveWaitlist(classId).finally(()=>target.disabled=false); break;

Â  Â  Â  Â  Â  Â  /* RESUELTO: usar deep-link + fallback web y confirmaciÃ³n modal
Â  Â  Â  Â  Â  Â  Â  Â Mantiene el nombre de acciÃ³n existente: send-totalpass-daily */
Â  Â  Â  Â  Â  Â  case 'send-totalpass-daily': {
Â  Â  Â  Â  Â  Â  Â  const classInfo = state.classes.find(c=>c.id===classId) || state.myBookings.find(b=>b.classId===classId);
Â  Â  Â  Â  Â  Â  Â  const className = classInfo?.name || classInfo?.className || '';

Â  Â  Â  Â  Â  Â  Â  showModal({
Â  Â  Â  Â  Â  Â  Â  Â  title: 'Â¿Abrir WhatsApp?',
Â  Â  Â  Â  Â  Â  Â  Â  message: 'Se abrirÃ¡ WhatsApp para enviar tu cÃ³digo de TotalPass.',
Â  Â  Â  Â  Â  Â  Â  Â  buttons: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  { text: 'Cancelar', primary: false, callback: null },
Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'Abrir WhatsApp',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  primary: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  callback: () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const baseMsg = 'Hola! Aqui te mando mi codigo de TotalPass: ';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const txt = className ? `${baseMsg} (${className})` : baseMsg;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const message = encodeURIComponent(txt);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Deep link a la app nativa
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const deepLink = `whatsapp://send?phone=5215539887713&text=${message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback a web si la app no abre
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const webLinkÂ  = `https://api.whatsapp.com/send?phone=5215539887713&text=${message}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const visibilityHandler = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.removeEventListener('visibilitychange', visibilityHandler);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(fallbackTimer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fallbackTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.visibilityState === 'visible') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = webLink;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 600);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.addEventListener('visibilitychange', visibilityHandler);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = deepLink;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('WhatsApp abierto para enviar token', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  document.addEventListener('click', handleInteraction);
Â  Â  Â  Â  navBar.addEventListener('click', e=>{
Â  Â  Â  Â  Â  const target = e.target.closest('.nav-button');
Â  Â  Â  Â  Â  if (target) app.navigateTo(target.dataset.screen);
Â  Â  Â  Â  });

Â  Â  Â  Â  const genericModal = document.getElementById('generic-modal');
Â  Â  Â  Â  const modalContent = document.getElementById('modal-content');

Â  Â  Â  Â  function showModal({success, title, message, buttons}){
Â  Â  Â  Â  Â  const fabs = document.getElementById('social-fabs');
Â  Â  Â  Â  Â  if (fabs) fabs.classList.add('opacity-0','pointer-events-none');
Â  Â  Â  Â  Â  const safeTitle = DOMPurify.sanitize(title);
Â  Â  Â  Â  Â  const safeMessage = message ? DOMPurify.sanitize(message) : '';

Â  Â  Â  Â  Â  if (!buttons) {
Â  Â  Â  Â  Â  Â  modalContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <div class="w-16 h-16 ${success?'bg-emerald-500/20 text-emerald-400':'bg-rose-500/20 text-rose-400'} rounded-full flex items-center justify-center mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="${success?'check':'trash-2'}" class="w-10 h-10"></i>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold">${safeTitle}</h2>
Â  Â  Â  Â  Â  Â  Â  ${safeMessage ? `<p class="text-zinc-400">${safeMessage}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg mt-4">Entendido</button>`;
Â  Â  Â  Â  Â  Â  document.getElementById('modal-close-btn').onclick = hideModal;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const buttonsHTML = buttons.map((btn, index) =>
Â  Â  Â  Â  Â  Â  Â  `<button id="modal-btn-${index}" class="flex-1 ${btn.primary ? 'bg-indigo-600 text-white' : 'bg-zinc-700 text-zinc-300'} font-semibold py-3 rounded-lg">${DOMPurify.sanitize(btn.text)}</button>`
Â  Â  Â  Â  Â  Â  ).join('');

Â  Â  Â  Â  Â  Â  modalContent.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <div class="w-16 h-16 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  <i data-lucide="message-circle" class="w-10 h-10"></i>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold">${safeTitle}</h2>
Â  Â  Â  Â  Â  Â  Â  ${safeMessage ? `<p class="text-zinc-400">${safeMessage}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-3 mt-4">${buttonsHTML}</div>`;

Â  Â  Â  Â  Â  Â  buttons.forEach((btn, index) => {
Â  Â  Â  Â  Â  Â  Â  document.getElementById(`modal-btn-${index}`).onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (btn.callback) btn.callback();
Â  Â  Â  Â  Â  Â  Â  Â  hideModal();
Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  genericModal.classList.remove('hidden');
Â  Â  Â  Â  Â  setTimeout(()=>modalContent.classList.remove('scale-95','opacity-0'),10);
Â  Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  Â  }
Â  Â  Â  Â  function hideModal(){
Â  Â  Â  Â  Â  const fabs = document.getElementById('social-fabs');
Â  Â  Â  Â  Â  modalContent.classList.add('scale-95','opacity-0');
Â  Â  Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  Â  Â  genericModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (fabs) fabs.classList.remove('opacity-0','pointer-events-none');
Â  Â  Â  Â  Â  Â  app.navigateTo(state.currentScreen==='classDetails'?'agenda':state.currentScreen);
Â  Â  Â  Â  Â  },200);
Â  Â  Â  Â  }
Â  Â  Â  Â  function updateNavButtons(){
Â  Â  Â  Â  Â  const navButtons = navBar.querySelectorAll('.nav-button');
Â  Â  Â  Â  Â  navButtons.forEach(btn=>{
Â  Â  Â  Â  Â  Â  const isActive = btn.dataset.screen===state.currentScreen;
Â  Â  Â  Â  Â  Â  btn.classList.toggle('active-nav', isActive);
Â  Â  Â  Â  Â  Â  btn.classList.toggle('text-indigo-400', isActive);
Â  Â  Â  Â  Â  Â  btn.classList.toggle('text-zinc-400', !isActive);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // Ãconos
Â  Â  Â  Â  lucide.createIcons();
Â  Â  Â  });
Â  Â  </script>

Â  Â  Â  Â  <script>
Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  window.addEventListener('load', async () => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const reg = await navigator.serviceWorker.register('/service-worker.js', { scope: '/' });
Â  Â  Â  Â  Â  Â  window._msgSW = reg;
Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error('SW fail', err);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  </script>
Â  </body>
</html>